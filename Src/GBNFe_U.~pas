{$I ACBr.inc}
unit GBNFe_U;

interface

uses
 ShellAPi, IniFiles, Windows, Messages, SysUtils, Variants, DBGrids,
 Classes, Graphics, Controls, Forms, Dialogs, StdCtrls, ExtCtrls,
 Buttons, ComCtrls, OleCtrls, SHDocVw, DB, DBTables, Grids, pcnConversaoNFe,
 ACBrNFe, ACBrUtil, Menus, Mask, pcnConversao,
 ToolWin, dxExEdtr, dxDBTLCl, dxGrClms, dxDBCtrl, dxDBGrid, dxTL,
 dxCntner, dxEditor, dxEdLib, dxDBELib, OleServer, ExcelXP, dxDBEdtr,
 RxLookup, DBCtrls, RpDefine, RpRender, RpRenderCanvas, RpRenderPreview,
 ImgList, IdMessage, IdBaseComponent, IdComponent, IdTCPConnection,
 IdTCPClient, IdMessageClient, IdSMTP, IdMailBox, RpRave, DateUtil,
 AppEvnts, dxTLClms, ACBrBase, ACBrMDFe, ACBrDFe, ZDataset,
 ACBrNFeDANFEClass, ACBrNFeDANFeESCPOS, ACBrPosPrinter, ACBrNFeDANFEFR,
 frxClass, ACBrECFVirtual, ACBrECFVirtualBuffer, ACBrECFVirtualPrinter,
 ACBrECFVirtualNFCe, ACBrMail, ACBrDANFCeFortesFr, ACBrNFeDANFeRLClass,
 ACBrDANFCeFortesFrA4, ACBrMDFeDAMDFeClass, ACBrMDFeDAMDFeRLClass, Printers,
 IdHTTP, ClipBrd, WinInet, IdFTP, Excel97; //, XPMan;

type
 TWebControl = class(TWebBrowser)
end;

type
  TFrGBNFe = class(TForm)
    Panel2: TPanel;
    Panel3: TPanel;
    Panel5: TPanel;
    StatusBar1: TStatusBar;
    Panel6: TPanel;
    Panel7: TPanel;
    BitBtn1: TBitBtn;
    BitBtn2: TBitBtn;
    BitBtn4: TBitBtn;
    BitBtn5: TBitBtn;
    BitBtn6: TBitBtn;
    BitBtn7: TBitBtn;
    BitBtn9: TBitBtn;
    PageControl1: TPageControl;
    TabSheet1: TTabSheet;
    TabSheet2: TTabSheet;
    TabSheet3: TTabSheet;
    TabSheet4: TTabSheet;
    MemoResp: TMemo;
    Panel9: TPanel;
    BitBtn12: TBitBtn;
    BitBtn11: TBitBtn;
    BitBtn13: TBitBtn;
    SaveDialog1: TSaveDialog;
    ExcelApplication1: TExcelApplication;
    Panel8: TPanel;
    BitBtn10: TBitBtn;
    BitBtn14: TBitBtn;
    Panel4: TPanel;
    GroupBox1: TGroupBox;
    GroupBox9: TGroupBox;
    RadioButton1: TRadioButton;
    RadioButton3: TRadioButton;
    RadioGroup1: TRadioGroup;
    WBResposta: TWebBrowser;
    MemoLog: TMemo;
    trvwNFe: TTreeView;
    Timer1: TTimer;
    ImageList1: TImageList;
    GroupBox2: TGroupBox;
    ACBrNFe1: TACBrNFe;
    GroupBox3: TGroupBox;
    Label1: TLabel;
    GroupBox7: TGroupBox;
    Label12: TLabel;
    dxDateEdit1: TdxDateEdit;
    dxDateEdit2: TdxDateEdit;
    Panel10: TPanel;
    dxSpinEdit2: TdxSpinEdit;
    PopupMenu2: TPopupMenu;
    Excluinota1: TMenuItem;
    PopupMenu3: TPopupMenu;
    PopupMenu1: TPopupMenu;
    PopupMenu4: TPopupMenu;
    N2: TMenuItem;
    OpenDialog1: TOpenDialog;
    SelecionarTudo1: TMenuItem;
    MarcaDesmarcaTodos1: TMenuItem;
    N5: TMenuItem;
    MarcaDesmarcaTodos2: TMenuItem;
    N6: TMenuItem;
    MarcaDesmarcaTodos3: TMenuItem;
    DesmarcarTudo1: TMenuItem;
    DesmarcarTodas1: TMenuItem;
    DesmarcarTodas2: TMenuItem;
    DesmarcarTodas3: TMenuItem;
    N7: TMenuItem;
    IdSMTP: TIdSMTP;
    IdMessage: TIdMessage;
    HeaderControl1: THeaderControl;
    BitBtn3: TBitBtn;
    TabSheet5: TTabSheet;
    memoRespWS: TMemo;
    dxSpinEdit1: TdxSpinEdit;
    GroupBox4: TGroupBox;
    dxSpinEdit3: TdxSpinEdit;
    MovepPendentes1: TMenuItem;
    Panel1: TPanel;
    SpeedButton1: TSpeedButton;
    Image1: TImage;
    Panel11: TPanel;
    dxTLPend: TdxTreeList;
    dxTLCPendCheckSel: TdxTreeListCheckColumn;
    dxTLCPendMaskDes: TdxTreeListMaskColumn;
    dxTLCPendMaskCnpjCpf: TdxTreeListMaskColumn;
    dxTLCPendMaskCod: TdxTreeListMaskColumn;
    dxTLCPendMaskSer: TdxTreeListMaskColumn;
    dxTLCPendDateDemi: TdxTreeListDateColumn;
    dxTLCPendSpinNot: TdxTreeListSpinColumn;
    dxTLCPendCurrencyVal: TdxTreeListCurrencyColumn;
    dxTLCPendMaskSit: TdxTreeListMaskColumn;
    dxTLCPendMaskPro: TdxTreeListMaskColumn;
    dxTLCPendMaskRec: TdxTreeListMaskColumn;
    dxTLCPendMaskCha: TdxTreeListMaskColumn;
    dxTLCont: TdxTreeList;
    dxTLCContCheckSel: TdxTreeListCheckColumn;
    dxTLCContMaskDes: TdxTreeListMaskColumn;
    dxTLCContMaskCnpjCpf: TdxTreeListMaskColumn;
    dxTLCContMaskCod: TdxTreeListMaskColumn;
    dxTLCContMaskSer: TdxTreeListMaskColumn;
    dxTLCContDateDemi: TdxTreeListDateColumn;
    dxTLCContSpinNot: TdxTreeListSpinColumn;
    dxTLCContCurrencyVal: TdxTreeListCurrencyColumn;
    dxTLCContMaskSit: TdxTreeListMaskColumn;
    dxTLCContMaskPro: TdxTreeListMaskColumn;
    dxTLCContMaskRec: TdxTreeListMaskColumn;
    dxTLCContMaskCha: TdxTreeListMaskColumn;
    dxTLTrans: TdxTreeList;
    dxTLCTransCheckSel: TdxTreeListCheckColumn;
    dxTLCTransMaskDes: TdxTreeListMaskColumn;
    dxTLCTransMaskCnpjCpf: TdxTreeListMaskColumn;
    dxTLCTransMaskCod: TdxTreeListMaskColumn;
    dxTLCTransMaskSer: TdxTreeListMaskColumn;
    dxTLCTransDateDemi: TdxTreeListDateColumn;
    dxTLCTransSpinNot: TdxTreeListSpinColumn;
    dxTLCTransCurrencyVal: TdxTreeListCurrencyColumn;
    dxTLCTransMaskSit: TdxTreeListMaskColumn;
    dxTLCTransMaskPro: TdxTreeListMaskColumn;
    dxTLCTransMaskRec: TdxTreeListMaskColumn;
    dxTLCTransMaskCha: TdxTreeListMaskColumn;
    dxTLDeneg: TdxTreeList;
    dxTLCDenegCheckSel: TdxTreeListCheckColumn;
    dxTLCDenegMaskDes: TdxTreeListMaskColumn;
    dxTLCDenegMaskCnpjCpf: TdxTreeListMaskColumn;
    dxTLCDenegMaskCod: TdxTreeListMaskColumn;
    dxTLCDenegMaskSer: TdxTreeListMaskColumn;
    dxTLCDenegDateDemi: TdxTreeListDateColumn;
    dxTLCDenegSpinNot: TdxTreeListSpinColumn;
    dxTLCDenegCurrencyVal: TdxTreeListCurrencyColumn;
    dxTLCDenegMaskSit: TdxTreeListMaskColumn;
    dxTLCDenegMaskPro: TdxTreeListMaskColumn;
    dxTLCDenegMaskRec: TdxTreeListMaskColumn;
    dxTLCDenegMaskCha: TdxTreeListMaskColumn;
    dxTLCanc: TdxTreeList;
    dxTLCCancCheckSel: TdxTreeListCheckColumn;
    dxTLCCancMaskDes: TdxTreeListMaskColumn;
    dxTLCCancMaskCnpjCpf: TdxTreeListMaskColumn;
    dxTLCCancMaskCod: TdxTreeListMaskColumn;
    dxTLCCancMaskSer: TdxTreeListMaskColumn;
    dxTLCCancDateDemi: TdxTreeListDateColumn;
    dxTLCCancSpinNot: TdxTreeListSpinColumn;
    dxTLCCancCurrencyVal: TdxTreeListCurrencyColumn;
    dxTLCCancMaskSit: TdxTreeListMaskColumn;
    dxTLCCancMaskPro: TdxTreeListMaskColumn;
    dxTLCCancMaskRec: TdxTreeListMaskColumn;
    dxTLCCancMaskCha: TdxTreeListMaskColumn;
    dxTLInut: TdxTreeList;
    dxTLCInutDateDemi: TdxTreeListDateColumn;
    dxTLCInutMaskSerie: TdxTreeListMaskColumn;
    dxTLCInutMaskNota: TdxTreeListMaskColumn;
    dxTLCInutMaskJustificativa: TdxTreeListMaskColumn;
    dxTLCInutMaskAno: TdxTreeListMaskColumn;
    dxTLCInutMaskModelo: TdxTreeListMaskColumn;
    ConsultaWeb5inu: TMenuItem;
    ExcluirxmlsTemp2: TMenuItem;
    ExcluirxmlsTemp3: TMenuItem;
    ExcluirxmlsTemp4: TMenuItem;
    BitBtn15: TBitBtn;
    SpeedButton2: TSpeedButton;
    BitBtn16: TBitBtn;
    ACBrMail1: TACBrMail;
    dxTLCTransMaskMod: TdxTreeListMaskColumn;
    dxTLCCancMaskMod: TdxTreeListMaskColumn;
    dxTLCContMaskMod: TdxTreeListMaskColumn;
    dxTLCDenegMaskMod: TdxTreeListMaskColumn;
    dxTLCPendMaskMod: TdxTreeListMaskColumn;
    ACBrNFeDANFeRL1: TACBrNFeDANFeRL;
    ACBrNFeDANFCeFortes1: TACBrNFeDANFCeFortes;
    RadioGroup2: TRadioGroup;
    ACBrNFeDANFCeFortesA41: TACBrNFeDANFCeFortesA4;
    ACBrNFeDANFEFR1: TACBrNFeDANFEFR;
    ACBrECFVirtualNFCe1: TACBrECFVirtualNFCe;
    ACBrNFeDANFeESCPOS1: TACBrNFeDANFeESCPOS;
    acbrmdfdmdfrl1: TACBrMDFeDAMDFeRL;
    N8: TMenuItem;
    ConsultaWeb2: TMenuItem;
    N1: TMenuItem;
    ConsultaWeb1: TMenuItem;
    N3: TMenuItem;
    CopiaNChaveClipBoard1: TMenuItem;
    N4: TMenuItem;
    CopiaNChavereadeTransferncia1: TMenuItem;
    ExcluirxmlsTemp5: TMenuItem;
    MenuItem2: TMenuItem;
    ConsultaWeb5: TMenuItem;
    MenuItem4: TMenuItem;
    MenuItem5: TMenuItem;
    MenuItem6: TMenuItem;
    MenuItem7: TMenuItem;
    MenuItem8: TMenuItem;
    PopupMenu5: TPopupMenu;
    btn1: TBitBtn;
    btn2: TSpeedButton;
    mm1: TMainMenu;
    BitBtn8: TBitBtn;
    ExcluirxmlsTemp1Excluinota2: TMenuItem;
    idftp1: TIdFTP;
    acbrpsprntr1: TACBrPosPrinter;
    btn3: TBitBtn;
    PopupMenu6: TPopupMenu;
    ConsultaWeb5EnviaEmailParaDestinatrios6: TMenuItem;
    IdHttp1: TIdHTTP;

    Procedure geraenvianf(Sender: TObject);
    Procedure grava_xml_no_banco;

    procedure BitBtn10Click(Sender: TObject);
    procedure BitBtn14Click(Sender: TObject);
    procedure BitBtn13Click(Sender: TObject);
    procedure RadioGroup1Click(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure ACBrNFe1GerarLog(const Mensagem: String);
    procedure ACBrNFe1StatusChange(Sender: TObject);
    procedure BitBtn1Click(Sender: TObject);
    procedure FormKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure Timer1Timer(Sender: TObject);
    procedure Destinatrio1Click(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure dxDateEdit2Exit(Sender: TObject);
    procedure BitBtn2Click(Sender: TObject);
    procedure BitBtn8Click(Sender: TObject);
    procedure Excluinota1Click(Sender: TObject);
    procedure BitBtn9Click(Sender: TObject);
    procedure BitBtn11Click(Sender: TObject);
    procedure MenuItem2Click(Sender: TObject);
    procedure ConsultarnotaemFSDA1Click(Sender: TObject);
    procedure BitBtn4Click(Sender: TObject);
    procedure BitBtn5Click(Sender: TObject);
    procedure BitBtn7Click(Sender: TObject);
    procedure BitBtn6Click(Sender: TObject);
    procedure dxSpinEdit2Exit(Sender: TObject);
    procedure SelecionarTudo1Click(Sender: TObject);
    procedure MarcaDesmarcaTodos1Click(Sender: TObject);
    procedure MarcaDesmarcaTodos2Click(Sender: TObject);
    procedure DesmarcarTudo1Click(Sender: TObject);
    procedure DesmarcarTodas1Click(Sender: TObject);
    procedure DesmarcarTodas2Click(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure BitBtn12Click(Sender: TObject);
    procedure SpeedButton1Click(Sender: TObject);
    procedure BitBtn3Click(Sender: TObject);
    procedure MovepPendentes1Click(Sender: TObject);
    procedure dxTLPendExit(Sender: TObject);
    procedure dxTLContEditing(Sender: TObject; Node: TdxTreeListNode;
      var Allow: Boolean);
    procedure dxTLContExit(Sender: TObject);
    procedure dxTLContClick(Sender: TObject);
    procedure dxTLPendClick(Sender: TObject);
    procedure dxTLTransClick(Sender: TObject);
    procedure dxTLTransEditing(Sender: TObject; Node: TdxTreeListNode;
      var Allow: Boolean);
    procedure dxTLTransExit(Sender: TObject);
    procedure dxTLDenegClick(Sender: TObject);
    procedure dxTLDenegEditing(Sender: TObject; Node: TdxTreeListNode;
      var Allow: Boolean);
    procedure dxTLDenegExit(Sender: TObject);
    procedure dxTLCancClick(Sender: TObject);
    procedure dxTLCancEditing(Sender: TObject; Node: TdxTreeListNode;
      var Allow: Boolean);
    procedure dxTLCancExit(Sender: TObject);
    procedure ConsultaWeb5inuClick(Sender: TObject);
    procedure trvwNFeExit(Sender: TObject);
    procedure BitBtn15Click(Sender: TObject);
    procedure SpeedButton2Click(Sender: TObject);
    procedure BitBtn16Click(Sender: TObject);
    procedure dxTLTransCustomDrawCell(Sender: TObject; ACanvas: TCanvas;
      ARect: TRect; ANode: TdxTreeListNode; AColumn: TdxTreeListColumn;
      ASelected, AFocused, ANewItemRow: Boolean; var AText: String;
      var AColor: TColor; AFont: TFont; var AAlignment: TAlignment;
      var ADone: Boolean);
    procedure dxTLCancCustomDrawCell(Sender: TObject; ACanvas: TCanvas;
      ARect: TRect; ANode: TdxTreeListNode; AColumn: TdxTreeListColumn;
      ASelected, AFocused, ANewItemRow: Boolean; var AText: String;
      var AColor: TColor; AFont: TFont; var AAlignment: TAlignment;
      var ADone: Boolean);
    procedure dxTLContCustomDrawCell(Sender: TObject; ACanvas: TCanvas;
      ARect: TRect; ANode: TdxTreeListNode; AColumn: TdxTreeListColumn;
      ASelected, AFocused, ANewItemRow: Boolean; var AText: String;
      var AColor: TColor; AFont: TFont; var AAlignment: TAlignment;
      var ADone: Boolean);
    procedure dxTLDenegCustomDrawCell(Sender: TObject; ACanvas: TCanvas;
      ARect: TRect; ANode: TdxTreeListNode; AColumn: TdxTreeListColumn;
      ASelected, AFocused, ANewItemRow: Boolean; var AText: String;
      var AColor: TColor; AFont: TFont; var AAlignment: TAlignment;
      var ADone: Boolean);
    procedure dxTLInutCustomDrawCell(Sender: TObject; ACanvas: TCanvas;
      ARect: TRect; ANode: TdxTreeListNode; AColumn: TdxTreeListColumn;
      ASelected, AFocused, ANewItemRow: Boolean; var AText: String;
      var AColor: TColor; AFont: TFont; var AAlignment: TAlignment;
      var ADone: Boolean);
    procedure dxTLPendCustomDrawCell(Sender: TObject; ACanvas: TCanvas;
      ARect: TRect; ANode: TdxTreeListNode; AColumn: TdxTreeListColumn;
      ASelected, AFocused, ANewItemRow: Boolean; var AText: String;
      var AColor: TColor; AFont: TFont; var AAlignment: TAlignment;
      var ADone: Boolean);
    procedure RadioGroup2Click(Sender: TObject);
    procedure ConsultaWeb2Click(Sender: TObject);
    procedure ConsultaWeb1Click(Sender: TObject);
    procedure CopiaNChaveClipBoard1Click(Sender: TObject);
    procedure MarcaDesmarcaTodos3Click(Sender: TObject);
    procedure DesmarcarTodas3Click(Sender: TObject);
    procedure MenuItem5Click(Sender: TObject);
    procedure MenuItem6Click(Sender: TObject);
    procedure dxSpinEdit1Exit(Sender: TObject);
    procedure btn1MouseDown(Sender: TObject; Button: TMouseButton;
      Shift: TShiftState; X, Y: Integer);
    procedure BitBtn2MouseDown(Sender: TObject; Button: TMouseButton;
      Shift: TShiftState; X, Y: Integer);
    procedure btn2Click(Sender: TObject);
    procedure BitBtn1MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure BitBtn2MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure BitBtn5MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure BitBtn6MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure BitBtn7MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure btn1MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure BitBtn8MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure BitBtn9MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure BitBtn11MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure BitBtn13MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure BitBtn4MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure BitBtn15MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure BitBtn3MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure BitBtn16MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure btn3MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure BitBtn10MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure BitBtn14MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure BitBtn12MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure GroupBox2MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure GroupBox3MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure GroupBox9MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure GroupBox4MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure GroupBox1MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure GroupBox7MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure Panel7MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure dxTLCancMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure dxTLContMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure dxTLDenegMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure dxTLInutMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure dxTLPendMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure dxTLTransMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure ConsultaWeb5EnviaEmailParaDestinatrios1Click(
      Sender: TObject);
    procedure ConsultaWeb5EnviaEmailParaDestinatrios6Click(
      Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
    function StrZero( cString: String; iInteger: Integer ): String;
    function fIniPen() : boolean;                                               // função que prepara a query de nfe pendentes
    function EnDecrypt(StrValue : String; Chave: Word) : String;                // Encrypta e Decrypta senha
    function fUniMap(PServer, PLetra, PSenha :Pchar): Boolean;                  // procedure que compartilha pasta de um outro micro e mapeia com uma letra
    function fDesRed(Letra:Pchar; Forcada:boolean): String;                     // função disconecta uma unidade mapeada via
    function fGetTempDir: String;                                               // função que trata da criação dos DirXX.MB e os cria localmente
    function GetBuildInfo:string;                                               // function que retorna a versão do aplicativo
    function OnlyNumbers(var sTexto : String; sRetorno : String = 'N'): String; // Retorna uma string numerica com somente numeros
    function fConsiste (locErr, cdloj1, cdloj2, demi1, demi2, nnf1, nnf2, ser1,
                        ser2, chv1, chv2 :String) : Boolean;                    // Função de consistência para evitar duplicidade de nota
    function fGravaCCe ( nNF : Variant; cStat, xMotivo : String ) : Boolean;    // Verifica existência da CCe em uma nota fiscal, Grava e retorna status
    function fCancelaCCe( Codigo_loja, nNF, dEmi: String ) : Boolean;           // Cancela CCe com o Status (580)
    function TamArq( const Arquivo: string ): Integer;                          // Retorna o tamanhoa de um arquivo em bytes
    function AnoBi(Ano: Integer): Boolean;                                      // Calcula o o ano é bi-sexto
    function fLerGer(): Boolean;                                                // Procedure de leitura do gerente
    function fGraGer(): Boolean;                                                // Procedure de gravação da chave no gerente Gerpa, Sisa ou Sisag
    function fVerPAG(iCodNot, iCodEmp, iCodPed: Integer): Boolean;              // Verifica permissão administrativa do gerpa
    function fCanCAP(iCodNot, iCodEmp, iCodPed, iCodMot: Integer): Boolean;     // Efetua o Cancelamento Administrativo do PEDIDO
    function fVerBDG(): Boolean;                                                // Abre o banco de dados gerente relativo e verifica a conecção
    function fVrfInuNot(iCodEmp, iCodNot, iModNot, iSerNot: Integer): Boolean;  // Veririca a existencia do pedido para o cancelamento na inutilização

    procedure pImpr();                                                          // Chama a procedure de impressão
    procedure MarcaBloco( dxTLPend : TdxTreeList; blMarca : Boolean; blTodos : Boolean = False ); // Marca bloco de seleção TreeList
    Procedure pAtribSel( dxTL : TdxTreeList; dxTLCDem : TdxTreeListDateColumn ;
                                             dxTLCNot : TdxTreeListSpinColumn ;
                                             dxTLCMod : TdxTreeListMaskColumn ;
                                             dxTLCSer : TdxTreeListMaskColumn ;
                                             ZQ :  TZQuery );                   // Procedure de atribuição de seleção nas querys
    Procedure pAtuTL( dxTL : TdxTreeList; dxTLCSel  :  TdxTreeListCheckColumn ;
                                          dxTLCDes  :  TdxTreeListMaskColumn ;
                                          dxTLCCpf  :  TdxTreeListMaskColumn ;
                                          dxTLCCod  :  TdxTreeListMaskColumn ;
                                          dxTLCMod  :  TdxTreeListMaskColumn ;
                                          dxTLCSer  :  TdxTreeListMaskColumn ;
                                          dxTLCDem  :  TdxTreeListDateColumn ;
                                          dxTLCNot  :  TdxTreeListSpinColumn ;
                                          dxTLCVal  :  TdxTreeListCurrencyColumn ;
                                          dxTLCSit  :  TdxTreeListMaskColumn ;
                                          dxTLCPro  :  TdxTreeListMaskColumn ;
                                          dxTLCRec  :  TdxTreeListMaskColumn ;
                                          dxTLCCha  :  TdxTreeListMaskColumn ;
                                          ZQ :  TZQuery );                      // Atualiza dados das TreeLest
    procedure GravarConfiguracao ;
    procedure LerConf1;
    procedure LerConf2;                                                         // Ler os dados dos parâmetros
    procedure LoadXML(MyMemo: TMemo; MyWebBrowser: TWebBrowser);
    procedure LoadXML1(MyMemo: TMemo; MyWebBrowser: TWebBrowser);
    procedure LoadXML2(MyMemo: TMemo; MyWebBrowser: TWebBrowser);
    procedure pAtuNFe();                                                        // Função que le os arquivos textos e Atualiza nfe
    procedure pAtuNFeT();                                                       // Procedure que le os arquivos textos e Atualiza nfe
    procedure pLerEmp();                                                        // Procedure que lê o arquivo empresa
    procedure pVerPas();                                                        // Verifica a existencia das pastas e se não existirem ele as cria
    procedure pAtrCam();                                                        // Atribui caminhos do ini nas variáveis padrão e executavel
    Procedure TransmiteCCe();                                                   // Transmite CCe
    Procedure ConsultaCCe();                                                    // Consulta CCe
    Procedure EnviaEmailCCe();                                                  // Reencia emails da CCe
    procedure pGravaNFe(locErr, c01, c02, c03, c04, c05, c06, c07, c08, c09, c10, c11, c12: String;
                                p01, p02, p03, p04, p05, p06, p07, p08, p09, p10, p11, p12: Variant;
                                Consiste                                                  : Boolean); // Procedure que grava NFe.
    procedure pEnviaEmailCan();                                                 // Procedure envia email de cancelamento
    procedure VerifCert();                                                      // Verifica o vencimento do certificado digital
    procedure GravarIni();                                                      // Grava o arquivo ini na pasta empresa setando qual certificado digital usar
    procedure LerIni();                                                         // Ler o arquivo ini na pasta empresa setando qual certificado digital usar
    procedure GravarNSU();                                                      // Grava o arquivo GBNFe.ini o NSU da manifestação
    procedure LerNSU();                                                         // Ler o arquivo GBNFe.ini o NSU da manifestação
    procedure GravarEMI();                                                      // Grava no arquivo GBNFe.ini o EMI da manifestação
    procedure LerEMI();                                                         // Ler o arquivo GBNFe.ini o EMI da manifestação
    procedure GravarPesXML();                                                   // Grava no arquivo ini o caminho de pesquisa dos xmls
    procedure LerPesXML();                                                      // Ler no arquivo ini o caminho de pesquisa dos xmls
    procedure Copia_Xml_PathLog(var Aux, TpNot : String);                       // Copia o arquivo xml pra pasta Log
    procedure pDefineRel();                                                     // Define o tipo de relatório Danfe Nfe ou NFCe Fortes Report
    procedure pDefineRelFR();                                                   // Define o tipo de relatório Danfe Nfe ou NFCe Fast Report
    procedure pEliminaXml(var Cha, TpNot : String);                             // Elimina os xmls quando a situação for null
    procedure pCopiaNChave(var ZQ: TZQuery);                                    // Copia o numero da chave da nota para a área de transferência - ZQ = Qurery.
    procedure pCopiaNChaveMDFe(var ZQ: TZQuery);                                // Copia o numero da chave da nota manifestada MDFe para a área de transferência - ZQ = Qurery.
    procedure pPegaChaveCW(var ZQ: TZQuery ; var UFCW : String);                // Pega a chave e consulta no web sefaz, UF
    procedure pPegaChaveCWM(var ZQ: TZQuery);                                   // Pega a chave de nota do manifesto e consulta no web sefaz
    procedure pExcluiXmlErro(M, S, N : String);                                 // Proc que exclui os xml da nota - M = Modelo, S = Série, N = Nota

  end;

 //-----------------------------------------------------------------------------
 // by Edson Lima - 2016-6-30T1142
 // Funções e procedures globais
 //-----------------------------------------------------------------------------

 function fValidaEmail( CampoEmail: String ): Boolean;                          // Valida o campo de email com o '@' e o '.'

 //-----------------------------------------------------------------------------

const

 // by Edson Lima ; Constante para atribuição do sistema (NOME DA EMPRESA DESENVOLVEDORA) acbr by Edson Lima
 // Texto Encapsulado [ Desenvolvido por GB Informática Ltda - (62) 3203-6532 ]
 gSistema   : String = chr(71)+chr(66)+chr(32)+chr(73)+chr(110)+chr(102)+chr(111)+
                       chr(114)+chr(109)+chr(225)+chr(116)+chr(105)+chr(99)+chr(97)+
                       chr(32)+chr(76)+chr(116)+chr(100)+chr(97)+chr(32)+chr(45)+chr(32)+
                       chr(40)+chr(54)+chr(50)+chr(41)+chr(32)+chr(51)+chr(50)+chr(48)+
                       chr(51)+chr(45)+chr(54)+chr(53)+chr(51)+chr(50)+
                       chr(32)+chr(101)+chr(32)+chr(49)+chr(50)+chr(55)+chr(49)+
                       chr(32)+chr(101)+chr(32)+chr(52)+chr(53)+chr(49)+chr(53)+
                       chr(32)+chr(101)+chr(32)+chr(52)+chr(48)+chr(57)+chr(51);

 // Dados da empresa GB Informática para impressão na NFe

 c_desc_Evento: String = 'Carta de Correção';
 c_tpEvento   : String = '110110';
 c_xCondUso   : String = 'A Carta de Correção é disciplinada pelo § 1º-A do'     +
                         'art. 7º do Convênio S/N, de 15 de dezembro de 1970'    +
                         'e pode ser utilizada para regularização de erro'       +
                         'ocorrido na emissão de documento fiscal, desde que'    +
                         'o erro não esteja relacionado com: I - as variáveis'   +
                         'que determinam o valor do imposto tais como: base'     +
                         'de cálculo, alíquota, diferença de preço, quantidade,' +
                         'valor da operação ou da prestação; II - a correção de' +
                         'dados cadastrais que implique mudança do'              +
                         'remetente ou do destinatário; III - a data de emissão' +
                         'ou de saída.';

var
 FrGBNFe: TFrGBNFe;

var

 // Variáveis globais
 xAux, vAux                                                               : String;          // xAux e vAux para Query
 gCamPad,        gCamExe,        gCamRep,     gCamSch,          gCamTxt   : String;          // Recebe os caminhos Padrão, Exe, Rap, Schemas e Txt
 gCamXml,        gCamPdf,        gCamLog,     gCamBak,          gCamDoc   : String;          // Recebe os caminhos Xml, Pdf, Log, Bak e Doc
 gCodEmp,        gUsu,           gNivel,      gInstancias,      gDriExe   : String;          // Codigo da empresa, Usuário, Nível de Acesso e Instãncias
 gExpress,       gOpcao,         gNNF,        gCdloja_Consiste, gNomXML   : String;          // Parâmetros Express, Opção, Num da Nota e Código da loja p/consistência
 gCamXmlI,       gCamCert,       gSenMst                                  : String;          // Recebe o caminho dos, GBNFe.Ini, e a Senha Master - gSenMst, XmlI - Importação de nfe
 gdEmi_Consiste, gNNF_Consiste,  gSerie_Consiste, gChave_Consiste         : String;          // Data da emissão, número da nota, serie e chave todas p/consistência
 gAtuCon                                                                  : Boolean = False; // verifica se houve atualização na consulta de exclusão
 gMostraXML                                                               : Boolean = False; // Limpa o treeview - Mostra o xml
 gVerCon                                                                  : Boolean = False; // verifica se tem nota pendente em contingência FSDA
 gVerEpe                                                                  : Boolean = False; // verifica se tem nota pendente em contingência OFFL
 gAtuFSD                                                                  : Boolean = False; // Permite a atualização de fsda
 gDuplic                                                                  : Boolean = False; // Decide se envia email ou não
 gDatConA                                                                 : tDate;           // Data da ultima contigência fsda
 gDatConB                                                                 : tDate;           // Data da ultima contigência fsda
 gCntTmp                                                                  : Integer;         // Contador de tempo pra limpar a Mensagem da StatusBar
 gExcluir                                                                 : Boolean = False; // Excluir durante consulta
 gDeuErrConsiste                                                          : Boolean = False; // Responde se deu erro na consistência
 gDeuErrXml                                                               : Boolean = False; // Responde se deu erro no xml
 gReConsulta                                                              : Boolean = False; // Re Consulta a nfe em fsda movida das transmitidas
 gOpImpr                                                                  : Boolean = False; // Seta false para opção de impressão
 gUltNSU, gTP, gDL, gRN, gRS                                              : String;          // Global para continuar processo de manifesto, NSU e os Totalizadores
 gGauge, gGauMa, gPSCert, gCEIni, gTpNot, gModelo, gSerie                 : Integer;         // Global para continuar processo gouge do manifesto: Gauge. - gPSCert para indicar se usa o 1º ou o segundo certificado digital - Tipo de Nota - Modelo de Nota
 gAutorizado                                                              : Boolean = False; // Define autorização se senha estiver correta
 gAbortar                                                                 : Boolean = False; // Global para abortar rotinas
 gVerifCert                                                               : Boolean = False; // Mostra mensagens do certificado
 gImportXML                                                               : Boolean = False; // Libera o modo de importação do xml
 gClEx                                                                    : Boolean = False; // Define se foi clic ou exit
 gDowAuto                                                                 : Boolean = False; // Define a variável global de download automático
 gCamPesXML                                                               : String;          // Caminho de importação do xml
 gItem, gmr                                                               : Integer;         // Guarda a ultima posição do botão de seleção que foi selecionado no "tipo de evento";
 gSelField                                                                : Boolean = False; // Define a variável global de seleção de registros
 gItemSel                                                                 : Boolean = False; // Define estado inicial de item selecionado no manifesto
 gDataEmi                                                                 : tDate;           // Data usada para localizar os arquivos xml em uma operação
 gAnoMes                                                                  : String;          // String para pegar o ano e mês de uma variável qualquer
 gTN                                                                      : String;          // Tipo de Nota
 gTcDgXml                                                                 : Boolean = False; // Tecla digitada na rotina de bd xml
 gXmlNaoEncontrado                                                        : Boolean = False; // Verifica false xml encontrado, true xml não encortrado
 gEdtCodEmp                                                               : Boolean = False; // Seta o readonly do codigo da empresa false = permite alterar e true = inibe
 gGeraXML                                                                 : Boolean = False; // Seta o geraxml para false;
 gExcTmp                                                                  : Boolean = False; // Seta o exctmp para true;
 gCpt                                                                     : Integer = 1;     // 1=FortesReport, 2 = FastReport, Rave
 gAtualiza                                                                : Boolean = False; // Permite a verificação de atualização na entrada do sistema;
 gCnpj                                                                    : string;          // Contém o cnpj do emitente
 gDBERP                                                                   : string;          // Deverá conter o nome do Sistema Gerente Integrado, Gerpa, Sisa ou Sisag
 gCodMtC, gCodMtD, gCodMtI                                                : Integer;         // Deve conter os Códigos de cancelamento, denegação e inutuilização
 gNomMtC, gNomMtD, gNomMtI                                                : string;          // Deve conter os Nomes   do cancelamento, denegação e inutuilização
 gChvNFe                                                                  : string;          // Chave da nota
 gCd_Emp                                                                  : Integer;         // Codigo da loja
 gCodPed                                                                  : Integer;         // Codigo do Pedido no gerente gerpa, sisa ou sisag

 // Variáveis migradas
 _nota                                                                    : string[15];
 _demi                                                                    : tdate;
 _chave                                                                   : string[60];
 _linhas                                                                  : integer;
 _tipo_emissao                                                            : string[15];
 xjustificativa                                                           : string;
 _tpemissao                                                               : string[1];

 ipQtdPsq, ilCodEmp                                                       : Integer;
 spCampos, spCond, spOrdem, tpTabPsq                                      : String;
 spResult                                                                 : Array of Variant;

implementation

uses {$IFNDEF ACBrNFeOpenSSL} ACBrCAPICOM_TLB, JwaWinCrypt, ACBrMSXML2_TLB,  {$ENDIF}
     FrPar_U, FrInut_U, FrNFeInut_U, DMNFe_U, ufrmStatus, ACBrNFeNotasFiscais,
     FrBackup_U, FrCCe_U, FrBuscaNota_U, FrXML_U, FrManif_U,
     FrBuscaChave_U, FrConsManif_U, FrImportXML_U, ACBrDFeSSL, FrConWeb_U,
     pcnNFe, ZAbstractRODataset, ZStoredProcedure, FrContab_U,
  ACBrNFeWebServices, pcnRetConsSitNFe, pcnRetEnvEventoNFe, pcnEventoNFe,
  FrEmail_U;

{$R *.dfm}

//------------------------------------------------------------------------------
//------ Gera e envia o arquivo xml
//------------------------------------------------------------------------------
procedure TFrGBNFe.geraenvianf(Sender: TObject);
var
 aux, xAux, vCon      : string;
 i, c, iCodPed        : integer;
 vCfop                : string;
 vCnpjEmit, vCnpjCert : string;
begin

 vCfop := '';

 aux := '';
 aux := dxSpinEdit1.Text + ',' + '''' + _nota + '''' + ',' + '''';
 aux := aux + FormatDateTime('yyyy/mm/dd', _demi) + '''' + ',';
 aux := aux + '''' + IntToStr(gModelo) + '''' + ',';
 aux := aux + '''' + IntToStr(gSerie)  + '''';

 DMNFe.ZQuery1.Close;
 DMNFe.ZQuery1.SQL.Clear;
 DMNFe.ZQuery1.SQL.Add( 'exec sp_le_nfe ' + aux );
 DMNFe.ZQuery1.open;

 vMens := '';

 // Verificando se não foi localizada nenhuma nota
 if DMNFe.ZQuery1.IsEmpty then
  begin

   Application.Messagebox('Não foi encontrado nenhuma nota!','Atenção!',mb_iconstop+mb_ok);
   Exit;

  end

 else

  begin
   DMNFe.ZQuery1.First;
   While not DMNFe.ZQuery1.eof do
    begin
     ACBrNFe1.NotasFiscais.Clear;

     with ACBrNFe1.NotasFiscais.Add.NFe do
      begin

       vAux := _nota;

       //infNFe.ID     := vAux;
       Ide.natOp     := DMNFe.ZQuery1['nfe_natOp'];
       Ide.nNF       := StrToInt(DMNFe.ZQuery1['nfe_nnf']);
       Ide.cNF       := StrToInt(DMNFe.ZQuery1['nfe_nnf']);
       Ide.modelo    := StrToInt(DMNFe.ZQuery1['nfe_Modelo']);
       gModelo       := StrToInt(DMNFe.ZQuery1['nfe_Modelo']);
       gSerie        := StrToInt(DMNFe.ZQuery1['nfe_Serie']);

       if ( (Trim(DMNFe.ZQuery1['nfe_serie']) = '') or (DMNFe.ZQuery1['nfe_serie'] = null) ) then
        begin
         Ide.serie        :=  1;
         gSerie_Consiste  := '1';
         gSerie           := 1;
        end
       else
        Ide.serie     := StrToInt(DMNFe.ZQuery1['nfe_serie']);

       xAux := '';
       xAux := dxSpinEdit1.Text + ',' + '''' + VarToStr(DMNFe.ZQuery1['nfe_nnf']) + '''' + ',' + '''' + _tpemissao + '''' + ',' + '''';
       xAux := xAux + FormatDateTime('yyyy/mm/dd', VarToDateTime(DMNFe.ZQuery1['nfe_demi'])) + '''' + ',' + '''';
       xAux := xAux + IntToStr(gModelo) + '''' + ',' + '''';
       xAux := xAux + VarToStr(DMNFe.ZQuery1['nfe_Serie']) + '''';

       DMNFe.ZQuery7.Close;
       DMNFe.ZQuery7.SQL.Clear;
       DMNFe.ZQuery7.SQL.Add( 'exec sp_calcula_digito_chave ' + xAux );
       DMNFe.ZQuery7.open;

       // by Edson Lima 2015-12-9T1007 - trunk2 novo
       xAux := '';
       if not DMNFe.ZQuery7.IsEmpty then
        xAux := vartostr(DMNFe.ZQuery7['chave']);

       xAux := trim(gCamLog) + trim(xAux) + '-nfe.xml';

       if (gModelo = 65) then
        Ide.dEmi := (DMNFe.ZQuery1['nfe_DatNFCe'])
       else
        Ide.dEmi := (DMNFe.ZQuery1['nfe_demi']);

       gDataEmi := Ide.dEmi;                                                    // by Edson Lima 2015-10-14T1107 - trunk2 novo

       if ( gCpt = 1 ) then
        pDefineRel()                                                            // Define o tipo de Relatório FortesReport
       else
        pDefineRelFR();                                                         // Define o tipo de Relatório FastReport

       if ((vartostr(DMNFe.ZQuery1['nfe_dSaiEnt']) <> '') and (DMNFe.ZQuery1['nfe_dSaiEnt'] > StrToDateTime('31/12/2012'))) then
        Ide.dSaiEnt := DMNFe.ZQuery1['nfe_dSaiEnt']
       else
        Ide.dSaiEnt   := Date;                                                  // By Edson ; 2014/3/7T1405 ; Inserido nesta data referente a implementação da ver3.10

       If FrPar.rgTipoAmb.ItemIndex = 0 then
        Ide.tpAmb := taProducao
       else
        Ide.tpAmb := taHomologacao;

       Ide.tpNF       := tnSaida;

       if vartostr(DMNFe.ZQuery1['nfe_tpNF']) = '0' then
        Ide.tpNF      := tnEntrada;

       // by Edson Lima ; 2015-4-1T1251 ; [ idDest ]----------------------------
       DMNFe.ZqryGeral.Close;
       DMNFe.ZqryGeral.SQL.Clear;
       DMNFe.ZqryGeral.SQL.Add( 'Select top 1 cfop                              ' );
       DMNFe.ZqryGeral.SQL.Add( 'from nfe_itens                                 ' );
       DMNFe.ZqryGeral.SQL.Add( 'where cfop = ''5667''                          ' );
       DMNFe.ZqryGeral.SQL.Add( 'and   codigo_loja = :parm1                     ' );
       DMNFe.ZqryGeral.SQL.Add( 'and   demi        = :parm2                     ' );
       DMNFe.ZqryGeral.SQL.Add( 'and   nnf         = :parm3                     ' );
       DMNFe.ZqryGeral.SQL.Add( 'and   modelo      = :parm4                     ' );
       DMNFe.ZqryGeral.Params[0].AsInteger := dxSpinEdit1.intValue;
       DMNFe.ZqryGeral.Params[1].AsString  := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery1['nfe_demi']);
       DMNFe.ZqryGeral.Params[2].AsString  := DMNFe.ZQuery1['nfe_nnf'];
       DMNFe.ZqryGeral.Params[3].AsString  := DMNFe.ZQuery1['nfe_modelo'];
       DMNFe.ZqryGeral.Open;

       if (DMNFe.ZqryGeral['cfop'] <> null) then
        vCfop := DMNFe.ZqryGeral['cfop'];

       if      ( DMNFe.ZQuery4['uf'] =  DMNFe.ZQuery1['des_uf'] ) then
        Ide.idDest := doInterna
       else if ( DMNFe.ZQuery4['uf'] <> DMNFe.ZQuery1['des_uf'] ) then
        begin
         if vCfop = '5667' then
          begin
           Ide.idDest := doInterna
          end
         else
          Ide.idDest := doInterestadual
        end
       else if ( DMNFe.ZQuery1['des_uf'] = 'EX' ) then
        Ide.idDest := doExterior;

       //-----------------------------------------------------------------------
       // by Edson Lima ; 2016-1-22T1019 ; Indica operação com Consumidor Final
       // e do Indicador de presença do comprador no estabelecimento comercial
       // ou no momento da operação e o indicador da forma de pagamento
       //-----------------------------------------------------------------------

       // indFinal

       if not ( DMNFe.ZQuery1['nfe_indFinal'] = null ) then
        begin

         case (StrToInt(DMNFe.ZQuery1['nfe_indFinal'])) of
          0:    Ide.indFinal := cfNao;
          1:    Ide.indFinal := cfConsumidorFinal;
          else  Ide.indFinal := cfNao;
         end;

        end;

       // indPres

       if not ( DMNFe.ZQuery1['nfe_indPres'] = null ) then
        begin

         case (StrToInt(DMNFe.ZQuery1['nfe_indPres'])) of
          0:    Ide.indPres := pcNao;
          1:    Ide.indPres := pcPresencial;
          2:    Ide.indPres := pcInternet;
          3:    Ide.indPres := pcTeleatendimento;
          4:    Ide.indPres := pcEntregaDomicilio;
          9:    Ide.indPres := pcOutros;
          else  Ide.indPres := pcOutros;
         end;

        end;

       // indPag

       if not ( DMNFe.ZQuery1['nfe_indpag'] = null ) then
        begin

         case (StrToInt(DMNFe.ZQuery1['nfe_indpag'])) of
          1:    Ide.indPag := ipVista;
          2:    Ide.indPag := ipPrazo;
          3:    Ide.indPag := ipOutras;
          else  Ide.indPag := ipOutras;
         end;

        end;

       //-----------------------------------------------------------------------

       if (gModelo = 65) then
        begin
         Ide.tpImp     := tiNFCe;
         Ide.indFinal  := cfConsumidorFinal;
         Ide.indPres   := pcPresencial;
         Ide.indPag    := ipVista;
        end
       else if (gModelo = 55) then
        begin
         Ide.tpImp     := tiRetrato;
        end;

       Ide.tpEmis    := teNORMAL;

       ACBrNFe1.Configuracoes.Geral.FormaEmissao := teNORMAL;

       if ((_tipo_emissao = 'fsda') and (gModelo = 55)) then
        begin
         ACBrNFe1.Configuracoes.Geral.FormaEmissao := teFSDA;
         Ide.tpEmis                                := teFSDA;

         if vartostr(DMNFe.ZQuery1['nfe_demi']) <> '' then
          Ide.dhCont                               := DMNFe.ZQuery1['nfe_demi']
         else
          Ide.dhCont := Date;

         Ide.xJust                                 := xJustificativa;
        end
       else if ((_tipo_emissao = 'OffL') and (gModelo = 65)) then
        begin
         ACBrNFe1.Configuracoes.Geral.FormaEmissao := teOffLine;
         Ide.tpEmis                                := teOffLine;

         if vartostr(DMNFe.ZQuery1['nfe_DatNFCe']) <> '' then
          Ide.dhCont                             := DMNFe.ZQuery1['nfe_DatNFCe']
         else
          Ide.dhCont := Date;

         Ide.xJust                                 := xJustificativa;

        end;

       //**********************************************************************
       // by Edson ; 20/6/2012 ; 08:45 ; Marca a nota com ENVI antes de enviar*
       if _tipo_emissao = 'normal' then
        begin
         // by Edson Lima ; 2013/03/12 ; 14:23 ; Se não tiver data_hora_recebimento
         // grava a data atual, caso contrario mantém: Centralizar os updates em um só lugar
         if (VarToStr(DMNFe.ZQuery1['nfe_data_hora_recebimento']) = '') then
          pGravaNFe('001', 'situacao', 'motivo', 'data_hora_recebimento', '', '', '', '', 'codigo_loja', 'demi', 'nnf', 'serie', 'chave_nfe',
                    'ENVI', 'Tentativa de envio sem sucesso', FormatDateTime('yyyy/mm/dd hh:nn:ss', Date()), '', '', '', '', dxSpinEdit1.IntValue, FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery1['nfe_demi']), DMNFe.ZQuery1['nfe_nnf'], DMNFe.ZQuery1['nfe_serie'], '', true)
         else
          pGravaNFe('001', 'situacao', 'motivo', '', '', '', '', '', 'codigo_loja', 'demi', 'nnf', 'serie', 'chave_nfe',
                    'ENVI', 'Tentativa de envio sem sucesso', '', '', '', '', '', dxSpinEdit1.IntValue, FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery1['nfe_demi']), DMNFe.ZQuery1['nfe_nnf'], DMNFe.ZQuery1['nfe_serie'], '', true);
        end;
       //**********************************************************************

       Ide.cUF       := strtoint(DMNFe.ZQuery4['codigo_uf']);
       Ide.cMunFG    := StrToInt(DMNFe.ZQuery4['codigo_municipio']);

       if DMNFe.ZQuery1['nfe_finalidade'] = 1 then Ide.finNFe := fnNormal;
       if DMNFe.ZQuery1['nfe_finalidade'] = 2 then Ide.finNFe := fnComplementar;
       if DMNFe.ZQuery1['nfe_finalidade'] = 3 then Ide.finNFe := fnAjuste;
       // by Edson Lima ; 2015-4-1T1328 ; linha imcluida para Devolução
       if DMNFe.ZQuery1['nfe_finalidade'] = 4 then Ide.finNFe := fnDevolucao;

       DMNFe.ZQuery2.Close;
       DMNFe.ZQuery2.SQL.Clear;
       DMNFe.ZQuery2.SQL.Add( 'Select                                                                                             ' );
       DMNFe.ZQuery2.SQL.Add( 't1.*                                                                                               ' );
       DMNFe.ZQuery2.SQL.Add( 'from nfe_referenciada_mod1 t1                                                                      ' );
       DMNFe.ZQuery2.SQL.Add( 'inner join nfe t2 on t1.codigo_loja = t2.codigo_loja and t1.nnf = t2.nnf and t1.demi = t2.demi and ' );
       DMNFe.ZQuery2.SQL.Add( '                     t1.modelo = t2.modelo                                                         ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.codigo_loja = :parm1                                                                      ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.demi        = :parm2                                                                      ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.nnf         = :parm3                                                                      ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.modelo      = :parm4                                                                      ' );
       DMNFe.ZQuery2.Params[0].AsInteger := dxSpinEdit1.intValue;
       DMNFe.ZQuery2.Params[1].AsString  := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery1['nfe_demi']);
       DMNFe.ZQuery2.Params[2].AsString  := DMNFe.ZQuery1['nfe_nnf'];
       DMNFe.ZQuery2.Params[3].AsString  := DMNFe.ZQuery1['nfe_modelo'];
       DMNFe.ZQuery2.Open;
       if not DMNFe.ZQuery2.IsEmpty then
        begin
         DMNFe.ZQuery2.First;
         While not DMNFe.ZQuery2.eof do
          begin
           with Ide.NFref.Add do
            begin

             // By Edson Lima ; 2015-4-2T0938 ; linha incluida
             if (strtoint(DMNFe.ZQuery2['modelo']) = 55) then
               RefNFe         := DMNFe.ZQuery2['chave_nfe']
             else             // Modelo 1/1A
              begin
               RefNF.cUF      := strtoint(DMNFe.ZQuery2['uf']);
               RefNF.AAMM     := DMNFe.ZQuery2['aamm'];
               RefNF.CNPJ     := DMNFe.ZQuery2['cnpj'];
               RefNF.modelo   := strtoint(DMNFe.ZQuery2['mod']);
               RefNF.serie    := strtoint(DMNFe.ZQuery2['Ser']);
               RefNF.nNF      := strtoint(DMNFe.ZQuery2['r_nnf']);
              end;

            end;

         DMNFe.ZQuery2.next;
        end;
       end;

       //nfe_referenciada_prural
       DMNFe.ZQuery2.Close;
       DMNFe.ZQuery2.SQL.Clear;
       DMNFe.ZQuery2.SQL.Add( 'Select                                                         ' );
       DMNFe.ZQuery2.SQL.Add( 't1.*                                                           ' );
       DMNFe.ZQuery2.SQL.Add( 'from nfe_referenciada_prural t1                                ' );
       DMNFe.ZQuery2.SQL.Add( 'inner join nfe t2 on t1.codigo_loja = t2.codigo_loja and t1.nnf = t2.nnf and t1.demi = t2.demi and t1.modelo = t2.modelo ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.codigo_loja = :parm1                                  ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.demi        = :parm2                                  ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.nnf         = :parm3                                  ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.modelo      = :parm4                                  ' );
       DMNFe.ZQuery2.Params[0].AsInteger := dxSpinEdit1.intValue;
       DMNFe.ZQuery2.Params[1].AsString  := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery1['nfe_demi']);
       DMNFe.ZQuery2.Params[2].AsString  := DMNFe.ZQuery1['nfe_nnf'];
       DMNFe.ZQuery2.Params[3].AsString  := DMNFe.ZQuery1['nfe_modelo'];
       DMNFe.ZQuery2.Open;
       if not DMNFe.ZQuery2.IsEmpty then begin
         DMNFe.ZQuery2.First;
         While not DMNFe.ZQuery2.eof do begin
          with Ide.NFref.Add do
           begin

            RefNFP.cUF     := strtoint(DMNFe.ZQuery2['uf']);
            RefNFP.AAMM    := DMNFe.ZQuery2['aamm'];
            RefNFP.CNPJCPF := DMNFe.ZQuery2['cnpj'];
            RefNFP.IE      := DMNFe.ZQuery2['insc_estadual'];
            RefNFP.modelo  := DMNFe.ZQuery2['mod'];
            RefNFP.serie   := strtoint(DMNFe.ZQuery2['Ser']);
            RefNFP.nNF     := strtoint(DMNFe.ZQuery2['r_nnf']);
           end;

          DMNFe.ZQuery2.next;
         end;
       end;

       //nfe_referenciada_cupon
       DMNFe.ZQuery2.Close;
       DMNFe.ZQuery2.SQL.Clear;
       DMNFe.ZQuery2.SQL.Add( 'Select                                                                                                                    ' );
       DMNFe.ZQuery2.SQL.Add( 't1.*                                                                                                                      ' );
       DMNFe.ZQuery2.SQL.Add( 'from nfe_referenciada_cupon t1                                                                                            ' );
       DMNFe.ZQuery2.SQL.Add( 'inner join nfe t2 on t1.codigo_loja = t2.codigo_loja and t1.nnf = t2.nnf and t1.demi = t2.demi and t1.modelo = t2.modelo  ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.codigo_loja = :parm1                                                                                             ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.demi        = :parm2                                                                                             ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.nnf         = :parm3                                                                                             ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.modelo      = :parm4                                                                                             ' );
       DMNFe.ZQuery2.Params[0].AsInteger := dxSpinEdit1.intValue;
       DMNFe.ZQuery2.Params[1].AsString  := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery1['nfe_demi']);
       DMNFe.ZQuery2.Params[2].AsString  := DMNFe.ZQuery1['nfe_nnf'];
       DMNFe.ZQuery2.Params[3].AsString  := DMNFe.ZQuery1['nfe_modelo'];
       DMNFe.ZQuery2.Open;
       if not DMNFe.ZQuery2.IsEmpty then begin
         DMNFe.ZQuery2.First;
         While not DMNFe.ZQuery2.eof do begin
           with Ide.NFref.Add do
             begin
               if DMNFe.ZQuery2['mod'] = ''   then RefECF.modelo  := ECFModRefVazio;
               if DMNFe.ZQuery2['mod'] = '2B' then RefECF.modelo  := ECFModRef2B;
               if DMNFe.ZQuery2['mod'] = '2C' then RefECF.modelo  := ECFModRef2C;
               if DMNFe.ZQuery2['mod'] = '2D' then RefECF.modelo  := ECFModRef2D;
               RefECF.nECF    := DMNFe.ZQuery2['ecf'];
               RefECF.ncoo    := DMNFe.ZQuery2['coo'];
             end;

           DMNFe.ZQuery2.next;
         end;
       end;

       Emit.CNPJCPF           := DMNFe.ZQuery1['emi_cnpj'];
       Emit.IE                := DMNFe.ZQuery1['emi_insc_estadual'];
       FrGBNFe.ACBrNFe1.SSL.NumeroSerie := DMNFe.ZQuery1['emi_Certificado_NumSerie'];
       FrGBNFe.ACBrNFe1.SSL.CarregarCertificado;

       vCnpjEmit := ( Copy(Trim(DMNFe.ZQuery4['cnpj']), 1, 8) );
       vCnpjCert := ( Copy(Trim(FrGBNFe.ACBrNFe1.SSL.CertCNPJ), 1, 8) );
       if ( vCnpjEmit <> vCnpjCert ) then
        Application.Messagebox('Obs: O CNPJ do emitente está diferente do' + chr(13) +
                               'CNPJ do certificado digital que foi setado' + chr(13) +
                               'no parametros do emissor!','Atenção!',mb_iconstop+mb_ok);

       // by Edson Lima ; 2013/02/25 ; 09:48 - Condição criada nesta data
       if (DMNFe.ZQuery1['des_uf'] = DMNFe.ZQuery4['ufSbt']) then
        if ( vCfop <> '5667' ) then
         Emit.IEST             := vartostr(DMNFe.ZQuery4['insc_estadual_subs']);

       Emit.xNome             := DMNFe.ZQuery4['razao_social'];
       Emit.xFant             := DMNFe.ZQuery4['nome_fantasia'];
       Emit.EnderEmit.fone    := DMNFe.ZQuery4['fone'];
       Emit.EnderEmit.CEP     := StrToInt(DMNFe.ZQuery4['cep']);
       Emit.EnderEmit.xLgr    := DMNFe.ZQuery4['endereco'];
       if ((DMNFe.ZQuery4['numero'] = null) or (DMNFe.ZQuery4['numero'] = '')) then
        Emit.EnderEmit.nro     := '0'
       else
        Emit.EnderEmit.nro     := DMNFe.ZQuery4['numero'];
       if (DMNFe.ZQuery4['complemento'] = null) then
        Emit.EnderEmit.xCpl    := ''
       else
        Emit.EnderEmit.xCpl    := DMNFe.ZQuery4['complemento'];
       Emit.EnderEmit.xBairro := DMNFe.ZQuery4['bairro'];
       Emit.EnderEmit.cMun    := StrToInt(DMNFe.ZQuery4['codigo_municipio']);
       Emit.EnderEmit.xMun    := DMNFe.ZQuery4['municipio'];
       Emit.EnderEmit.UF      := DMNFe.ZQuery4['uf'];
       Emit.enderEmit.cPais   := strtoint(DMNFe.ZQuery4['codigo_pais']);//1058;
       Emit.enderEmit.xPais   := DMNFe.ZQuery4['nome_pais'];//'BRASIL';

       if DMNFe.ZQuery4['regime_tributario'] = 1 then
        Emit.CRT  := crtSimplesNacional;
       if DMNFe.ZQuery4['regime_tributario'] = 2 then
        Emit.CRT  := crtSimplesExcessoReceita;
       if DMNFe.ZQuery4['regime_tributario'] = 3 then
        Emit.CRT  := crtRegimeNormal;

       if Ide.tpAmb = taHomologacao then

        begin
         if (DMNFe.ZQuery1['des_uf'] = 'EX') then

          Dest.CNPJCPF           := ''

         else

          begin

           if gModelo = 65 then

            begin

             Dest.CNPJCPF           := OnlyNumber('99999999/0001-91');

             if ( (Trim(DMNFe.ZQuery1['des_bairro']) = '') or (DMNFe.ZQuery1['des_bairro'] = null) ) then
              Dest.EnderDest.xBairro := 'Centro'
             else
              Dest.EnderDest.xBairro := DMNFe.ZQuery1['des_bairro'];

             if ( (Trim(DMNFe.ZQuery1['des_endereco']) = '') or (DMNFe.ZQuery1['des_endereco'] = null) ) then
              begin
               Dest.EnderDest.CEP     := strtoint(DMNFe.ZQuery1['des_cep']);
               Dest.EnderDest.xLgr    := 'Rua';
               Dest.EnderDest.nro     := '';
               Dest.EnderDest.xCpl    := '';
               Dest.EnderDest.cMun    := strtoint(DMNFe.ZQuery1['des_codigo_municipio']);
               Dest.EnderDest.xMun    := DMNFe.ZQuery1['des_municipio'];
               Dest.EnderDest.UF      := DMNFe.ZQuery1['des_uf'];
               Dest.EnderDest.Fone    := DMNFe.ZQuery1['des_fone'];;
              end;

            end

           else    // Caso 55 em homologação

            begin
             Dest.CNPJCPF           := '99999999/0001-91';

             Dest.CNPJCPF           := DMNFe.ZQuery1['des_cnpj'];
             Dest.EnderDest.CEP     := strtoint(DMNFe.ZQuery1['des_cep']);
             Dest.EnderDest.xLgr    := DMNFe.ZQuery1['des_endereco'];
             Dest.EnderDest.nro     := DMNFe.ZQuery1['des_numero'];
             Dest.EnderDest.xCpl    := '';
             Dest.EnderDest.xBairro := DMNFe.ZQuery1['des_bairro'];
             Dest.EnderDest.cMun    := strtoint(DMNFe.ZQuery1['des_codigo_municipio']);
             Dest.EnderDest.xMun    := DMNFe.ZQuery1['des_municipio'];
             Dest.EnderDest.UF      := DMNFe.ZQuery1['des_uf'];
             Dest.EnderDest.Fone    := DMNFe.ZQuery1['des_fone'];
            end;

          end;

        end

       else     // Caso Produção

        begin

         if (DMNFe.ZQuery1['des_uf'] = 'EX') then

           Dest.CNPJCPF           := ''

         else if gModelo = 65 then

          begin
           if ( (Trim(DMNFe.ZQuery1['des_cnpj']) = '')               or
                (Trim(DMNFe.ZQuery1['des_cnpj']) = '00000000000')    or
                (Trim(DMNFe.ZQuery1['des_cnpj']) = '00000000000000') or
                (DMNFe.ZQuery1['des_cnpj'] = null) ) then
            Dest.CNPJCPF           := OnlyNumber('99999999/0001-91')
           else
            Dest.CNPJCPF           := OnlyNumber(DMNFe.ZQuery1['des_cnpj']);

           if ( (Trim(DMNFe.ZQuery1['des_bairro']) = '') or (DMNFe.ZQuery1['des_bairro'] = null) ) then
            Dest.EnderDest.xBairro := 'Centro'
           else
            Dest.EnderDest.xBairro := DMNFe.ZQuery1['des_bairro'];

           if ( (Trim(DMNFe.ZQuery1['des_endereco']) = '') or (DMNFe.ZQuery1['des_endereco'] = null) ) then
            begin
             Dest.EnderDest.CEP     := strtoint(DMNFe.ZQuery1['des_cep']);
             Dest.EnderDest.xLgr    := 'Rua';
             Dest.EnderDest.nro     := '';
             Dest.EnderDest.xCpl    := '';
             Dest.EnderDest.cMun    := strtoint(DMNFe.ZQuery1['des_codigo_municipio']);
             Dest.EnderDest.xMun    := DMNFe.ZQuery1['des_municipio'];
             Dest.EnderDest.UF      := DMNFe.ZQuery1['des_uf'];
             Dest.EnderDest.Fone    := DMNFe.ZQuery1['des_fone'];;
            end;

          end

          else  // Caso do Modelo = 55

           begin
            Dest.CNPJCPF           := DMNFe.ZQuery1['des_cnpj'];
            Dest.EnderDest.CEP     := strtoint(DMNFe.ZQuery1['des_cep']);
            Dest.EnderDest.xLgr    := DMNFe.ZQuery1['des_endereco'];
            Dest.EnderDest.nro     := DMNFe.ZQuery1['des_numero'];
            Dest.EnderDest.xCpl    := '';
            Dest.EnderDest.xBairro := DMNFe.ZQuery1['des_bairro'];
            Dest.EnderDest.cMun    := strtoint(DMNFe.ZQuery1['des_codigo_municipio']);
            Dest.EnderDest.xMun    := DMNFe.ZQuery1['des_municipio'];
            Dest.EnderDest.UF      := DMNFe.ZQuery1['des_uf'];
            Dest.EnderDest.Fone    := DMNFe.ZQuery1['des_fone'];
           end
         end;

       // by Edson Lima ; 2016-1-22T1019 ; Indicador da Ie do Destimatário
       if not ( DMNFe.ZQuery1['des_indIEDest'] = null ) then
        begin

         case (StrToInt(DMNFe.ZQuery1['des_indIEDest'])) of
          1:   // Contribuinte normal
           begin

            Dest.IE := DMNFe.ZQuery1['des_insc_estadual'];
            Dest.indIEDest := inContribuinte;

           end;
          2:   // Contribuinte isento - CNPJ e IE isento
           begin

            Dest.IE := '';
            Dest.indIEDest := inIsento;

           end;
          9:  // Não Contribuinte - CPF ou CNPJ sem IE
           begin

            if (gModelo = 65) then
             Dest.IE := ''
            else if ((gModelo = 55) and (Trim(DMNFe.ZQuery1['des_insc_estadual']) = 'ISENTO') ) then
             Dest.IE := ''
            else
             Dest.IE := DMNFe.ZQuery1['des_insc_estadual'];

            Dest.indIEDest := inNaoContribuinte;

           end;
         end;
        end;

       if Ide.tpAmb = taHomologacao then
        Dest.xNome             := 'NF-E EMITIDA EM AMBIENTE DE HOMOLOGACAO - SEM VALOR FISCAL'
       else
        Dest.xNome             := DMNFe.ZQuery1['des_razao_social'];

       Dest.ISUF              := DMNFe.ZQuery1['des_suframa'];
       Dest.EnderDest.cPais   := strtoint(DMNFe.ZQuery1['des_codigo_pais']);    //1058;
       Dest.EnderDest.xPais   := DMNFe.ZQuery1['des_nome_pais'];                //'BRASIL';

       // By Edson Lima - 2016-6-30T1143 - Verifica o email do destinatário
       if not fValidaEmail(DMNFe.ZQuery1['des_email']) then
        begin
         Application.Messagebox('Campo de email do destinatário inválido! ','Atenção!',mb_iconstop+mb_ok);
         exit;
        end;

       Dest.Email             := DMNFe.ZQuery1['des_email'];                    // by Edson ; 2013/03/19 ; 08:37 ; Implementado nesta dada

       //informações complementares
       DMNFe.ZQuery2.Close;
       DMNFe.ZQuery2.SQL.Clear;
       DMNFe.ZQuery2.SQL.Add( 'Select                                                                  ' );
       DMNFe.ZQuery2.SQL.Add( 't1.*                                                                    ' );
       DMNFe.ZQuery2.SQL.Add( 'from nfe_informacoes t1                                                 ' );
       DMNFe.ZQuery2.SQL.Add( 'inner join nfe t2 on t1.codigo_loja = t2.codigo_loja and t1.nnf = t2.nnf and t1.demi = t2.demi and t1.modelo = t2.modelo ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.codigo_loja = :parm1                                  ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.demi        = :parm2                                  ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.nnf         = :parm3                                  ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.modelo      = :parm4                                  ' );
       DMNFe.ZQuery2.Params[0].AsInteger := dxSpinEdit1.intValue;
       DMNFe.ZQuery2.Params[1].AsString  := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery1['nfe_demi']);
       DMNFe.ZQuery2.Params[2].AsString  := DMNFe.ZQuery1['nfe_nnf'];
       DMNFe.ZQuery2.Params[3].AsString  := DMNFe.ZQuery1['nfe_modelo'];
       DMNFe.ZQuery2.Open;
       if not DMNFe.ZQuery2.IsEmpty then begin
         DMNFe.ZQuery2.First;
         While not DMNFe.ZQuery2.eof do begin
           with InfAdic.obsCont.Add do
             begin
               xCampo     := trim( vartostr(DMNFe.ZQuery2['inf_campo']) );
               xTexto     := trim( vartostr(DMNFe.ZQuery2['inf_complementar']) );
             end;
           DMNFe.ZQuery2.next;
         end;
       end;

       InfAdic.infCpl := trim(vartostr(DMNFe.ZQuery1['nfe_inf_complementar']));
       InfAdic.infAdFisco := trim(vartostr(DMNFe.ZQuery1['nfe_inf_fisco']));

       //duplicatas
       DMNFe.ZQuery2.Close;
       DMNFe.ZQuery2.SQL.Clear;
       DMNFe.ZQuery2.SQL.Add( 'Select                                                                 ' );
       DMNFe.ZQuery2.SQL.Add( 't1.num_duplicata, cast(t1.dvenc as datetime) as dvenc, t1.valor,       ' );
       DMNFe.ZQuery2.SQL.Add( 't1.tPag, t1.cCnpj, t1.tBand, t1.cAut                                   ' );
       DMNFe.ZQuery2.SQL.Add( 'from nfe_duplicatas t1                                                 ' );
       DMNFe.ZQuery2.SQL.Add( 'inner join nfe t2 on t1.codigo_loja = t2.codigo_loja and t1.nnf = t2.nnf and t1.demi = t2.demi and t1.modelo = t2.modelo  ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.codigo_loja = :parm1                                  ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.demi        = :parm2                                  ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.nnf         = :parm3                                  ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.modelo      = :parm4                                  ' );
       DMNFe.ZQuery2.SQL.Add( 'Order by t1.dvenc                                              ' );
       DMNFe.ZQuery2.Params[0].AsInteger := dxSpinEdit1.intValue;
       DMNFe.ZQuery2.Params[1].AsString  := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery1['nfe_demi']);
       DMNFe.ZQuery2.Params[2].AsString  := DMNFe.ZQuery1['nfe_nnf'];
       DMNFe.ZQuery2.Params[3].AsString  := DMNFe.ZQuery1['nfe_modelo'];
       DMNFe.ZQuery2.Open;
       if not DMNFe.ZQuery2.IsEmpty then begin
         DMNFe.ZQuery2.First;
         While not DMNFe.ZQuery2.eof do
          begin
           if (gModelo = 55) then
            begin

             with Cobr.Dup.Add do
              begin
               nDup    := DMNFe.ZQuery2['num_duplicata'];
               dVenc   := DMNFe.ZQuery2['dvenc'];
               vDup    := DMNFe.ZQuery2['valor'];
               if vDup = 0 then vDup := DMNFe.ZQuery1['nfe_total_nf'];          // Provisório até corrigir no Gerpa ; by Edson ; 04-10-2012 ; 08:30
              end;
            end;

           if (gModelo = 65) then
            begin
             with pag.Add do
              begin                                                // PAGAMENTOS apenas para NFC-e
               if (DMNFe.ZQuery2['tPag'] = null) then
                tPag := fpDinheiro
               else
                begin
                 case StrToInt(DMNFe.ZQuery2['tPag']) of
                  01 : tPag := fpDinheiro;
                  02 : tPag := fpCheque;
                  03 : tPag := fpCartaoCredito;
                  04 : tPag := fpCartaoDebito;
                  05 : tPag := fpCreditoLoja;
                  10 : tPag := fpValeAlimentacao;
                  11 : tPag := fpValeRefeicao;
                  12 : tPag := fpValePresente;
                  13 : tPag := fpValeCombustivel;
                  99 : tPag := fpOutro;
                 end;
                end;

               vPag  := DMNFe.ZQuery2['valor'];

               if ((DMNFe.ZQuery2['tPag'] = '03') or (DMNFe.ZQuery2['tPag'] = '04')) then
                begin

                 cnpj  := DMNFe.ZQuery2['cCnpj'];

                  case StrToInt(DMNFe.ZQuery2['tBand']) of
                   01 : tBand := bcVisa;
                   02 : tBand := bcMasterCard;
                   03 : tBand := bcAmericanExpress;
                   04 : tBand := bcSorocred;
                   10 : tBand := bcOutros;
                  end;

                 cAut := DMNFe.ZQuery2['cAut'];

                end;
               end;
            end;
           DMNFe.ZQuery2.next;
          end;
       end;

       //transportador
       Transp.Transporta.CNPJCPF           := DMNFe.ZQuery1['tra_cnpj'];
       Transp.Transporta.xEnder            := DMNFe.ZQuery1['tra_endereco'];
       Transp.Transporta.xMun              := DMNFe.ZQuery1['tra_municipio'];
       Transp.Transporta.UF                := DMNFe.ZQuery1['tra_uf'];
       Transp.Transporta.IE                := DMNFe.ZQuery1['tra_insc_estadual'];
       Transp.Transporta.xNome             := DMNFe.ZQuery1['tra_razao_social'];

       if vartostr(DMNFe.ZQuery1['nfe_tipo_frete']) = '0' then Transp.modFrete:= mfContaEmitente;
       if vartostr(DMNFe.ZQuery1['nfe_tipo_frete']) = '1' then Transp.modFrete:= mfContaDestinatario;
       if vartostr(DMNFe.ZQuery1['nfe_tipo_frete']) = '2' then Transp.modFrete:= mfContaTerceiros;
       if vartostr(DMNFe.ZQuery1['nfe_tipo_frete']) = '9' then Transp.modFrete:= mfSemFrete;

       //volume
       with Transp.Vol.Add do
        begin
         qVol               := DMNFe.ZQuery1['vol_qtd_volume'];
         if qVol = 0 then   // Provisório até corrigir no Gerpa ; by Edson ; 04-10-2012 ; 08:30
          qVol              := 1;
         Esp                := DMNFe.ZQuery1['vol_especie'];
         Marca              := DMNFe.ZQuery1['vol_marca'];
         nVol               := DMNFe.ZQuery1['vol_numero_volume'];
         PesoL              := DMNFe.ZQuery1['vol_peso_liquido'];
         PesoB              := DMNFe.ZQuery1['vol_peso_bruto'];
       end;

       //veículo
       Transp.veicTransp.placa           := trim(DMNFe.ZQuery1['vei_placa']);
       Transp.veicTransp.uf              := DMNFe.ZQuery1['vei_uf'];
       Transp.veicTransp.rntc            := DMNFe.ZQuery1['vei_rntc'];

       //***********************************************************************
       // ITENS
       //***********************************************************************
       //itens de notas
       DMNFe.ZQuery2.Close;
       DMNFe.ZQuery2.SQL.Clear;
       DMNFe.ZQuery2.SQL.Add( 'Select                                                 ' );
       DMNFe.ZQuery2.SQL.Add( 't1.*                                                 ' );
       DMNFe.ZQuery2.SQL.Add( 'from nfe_itens t1                                                 ' );
       DMNFe.ZQuery2.SQL.Add( 'inner join nfe t2 on t1.codigo_loja = t2.codigo_loja and t1.nnf = t2.nnf and t1.demi = t2.demi and t1.modelo = t2.modelo ' );
       DMNFe.ZQuery2.SQL.Add( 'where t2.codigo_loja = :parm1                                  ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.demi        = :parm2                                  ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.nnf         = :parm3                                  ' );
       DMNFe.ZQuery2.SQL.Add( 'and   t2.modelo      = :parm4                                  ' );
       DMNFe.ZQuery2.SQL.Add( 'Order by t1.sequencia                                  ' );
       DMNFe.ZQuery2.Params[0].AsInteger := dxSpinEdit1.intValue;
       DMNFe.ZQuery2.Params[1].AsString  := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery1['nfe_demi']);
       DMNFe.ZQuery2.Params[2].AsString  := DMNFe.ZQuery1['nfe_nnf'];
       DMNFe.ZQuery2.Params[3].AsString  := DMNFe.ZQuery1['nfe_modelo'];
       DMNFe.ZQuery2.Open;

       if not DMNFe.ZQuery2.IsEmpty then begin
         DMNFe.ZQuery2.First;
          While not DMNFe.ZQuery2.eof do begin
             with Det.Add do begin
               infAdProd     := vartostr(DMNFe.ZQuery2['inf_adicional']);
               Prod.nItem    := DMNFe.ZQuery2['sequencia'];
               Prod.CFOP     := DMNFe.ZQuery2['cfop'];
               Prod.cEAN     := vartostr(DMNFe.ZQuery2['EAN']);
               Prod.cEANtrib := vartostr(DMNFe.ZQuery2['cEANtrib']);

               if ((DMNFe.ZQuery2['xPed'] <> null) and ( DMNFe.ZQuery2['xPed'] <> '')) then
                Prod.xPed     := VarToStr(DMNFe.ZQuery2['xPed']);               // by EL ; 2014/12/05T1043

               if ((DMNFe.ZQuery2['nItemPed'] <> null) and ( DMNFe.ZQuery2['nItemPed'] <> '')) then
                Prod.nItemPed := VarToStr(DMNFe.ZQuery2['nItemPed']);           // by EL ; 2014/12/01T0920

               if vartostr(DMNFe.ZQuery2['vl_ii']) <> '' then                   // Produtos
                begin
                 Imposto.II.vII := DMNFe.ZQuery2['vl_ii'];
                end
               else
                Imposto.II.vII := 0;

               if (DMNFe.ZQuery2['cfop'] = '1651') or (DMNFe.ZQuery2['cfop'] = '1652') or
                  (DMNFe.ZQuery2['cfop'] = '1653') or (DMNFe.ZQuery2['cfop'] = '1658') or
                  (DMNFe.ZQuery2['cfop'] = '1659') or (DMNFe.ZQuery2['cfop'] = '1660') or
                  (DMNFe.ZQuery2['cfop'] = '1661') or (DMNFe.ZQuery2['cfop'] = '1662') or
                  (DMNFe.ZQuery2['cfop'] = '1663') or (DMNFe.ZQuery2['cfop'] = '1664') or
                  (DMNFe.ZQuery2['cfop'] = '2651') or (DMNFe.ZQuery2['cfop'] = '2652') or
                  (DMNFe.ZQuery2['cfop'] = '2653') or (DMNFe.ZQuery2['cfop'] = '2658') or
                  (DMNFe.ZQuery2['cfop'] = '2659') or (DMNFe.ZQuery2['cfop'] = '2660') or
                  (DMNFe.ZQuery2['cfop'] = '2661') or (DMNFe.ZQuery2['cfop'] = '2662') or
                  (DMNFe.ZQuery2['cfop'] = '2663') or (DMNFe.ZQuery2['cfop'] = '2664') or
                  (DMNFe.ZQuery2['cfop'] = '3651') or (DMNFe.ZQuery2['cfop'] = '3652') or
                  (DMNFe.ZQuery2['cfop'] = '3653') or (DMNFe.ZQuery2['cfop'] = '5651') or
                  (DMNFe.ZQuery2['cfop'] = '5652') or (DMNFe.ZQuery2['cfop'] = '5653') or
                  (DMNFe.ZQuery2['cfop'] = '5654') or (DMNFe.ZQuery2['cfop'] = '5655') or
                  (DMNFe.ZQuery2['cfop'] = '5656') or (DMNFe.ZQuery2['cfop'] = '5657') or
                  (DMNFe.ZQuery2['cfop'] = '5658') or (DMNFe.ZQuery2['cfop'] = '5659') or
                  (DMNFe.ZQuery2['cfop'] = '5660') or (DMNFe.ZQuery2['cfop'] = '5661') or
                  (DMNFe.ZQuery2['cfop'] = '5662') or (DMNFe.ZQuery2['cfop'] = '5663') or
                  (DMNFe.ZQuery2['cfop'] = '5664') or (DMNFe.ZQuery2['cfop'] = '5665') or
                  (DMNFe.ZQuery2['cfop'] = '5666') or (DMNFe.ZQuery2['cfop'] = '5667') or
                  (DMNFe.ZQuery2['cfop'] = '6651') or (DMNFe.ZQuery2['cfop'] = '6652') or
                  (DMNFe.ZQuery2['cfop'] = '6653') or (DMNFe.ZQuery2['cfop'] = '6654') or
                  (DMNFe.ZQuery2['cfop'] = '6655') or (DMNFe.ZQuery2['cfop'] = '6656') or
                  (DMNFe.ZQuery2['cfop'] = '6657') or (DMNFe.ZQuery2['cfop'] = '6658') or
                  (DMNFe.ZQuery2['cfop'] = '6659') or (DMNFe.ZQuery2['cfop'] = '6660') or
                  (DMNFe.ZQuery2['cfop'] = '6661') or (DMNFe.ZQuery2['cfop'] = '6662') or
                  (DMNFe.ZQuery2['cfop'] = '6663') or (DMNFe.ZQuery2['cfop'] = '6664') or
                  (DMNFe.ZQuery2['cfop'] = '6665') or (DMNFe.ZQuery2['cfop'] = '6666') or
                  (DMNFe.ZQuery2['cfop'] = '6667') or (DMNFe.ZQuery2['cfop'] = '7651') or
                  (DMNFe.ZQuery2['cfop'] = '7654') or (DMNFe.ZQuery2['cfop'] = '7667') then
                begin
                 with Prod.comb do
                  begin
                   if (VarToStr(DMNFe.ZQuery2['CodSIMP']) <> '') then
                    begin
                     cProdANP := StrToInt(VarToStr(DMNFe.ZQuery2['CodSIMP']));

                     // Rotina pra UFcons ; by Edson Lima ; 2015-4-28T1016------
                     if (vCfop = '5667') then
                      UFcons     := DMNFe.ZQuery4['uf']
                     else
                      UFcons   := DMNFe.ZQuery1['des_uf'];

                     //---------------------------------------------------------

                    end
                   else
                    begin
                     cProdANP := 999999999;
                     UFcons   := DMNFe.ZQuery1['des_uf'];
                    end;

                   //CODIF    := '';
                   //qTemp    := 0;

                   //CIDE.qBCprod   := 0 ;
                   //CIDE.vAliqProd := 0 ;
                   //CIDE.vCIDE     := 0 ;

                   //ICMS.vBCICMS   := 0 ;
                   //ICMS.vICMS     := 0 ;
                   //ICMS.vBCICMSST := 0 ;
                   //ICMS.vICMSST   := 0 ;

                   //ICMSInter.vBCICMSSTDest := 0 ;
                   //ICMSInter.vICMSSTDest   := 0 ;

                   //ICMSCons.vBCICMSSTCons := 0 ;
                   //ICMSCons.vICMSSTCons   := 0 ;
                   //ICMSCons.UFcons        := '' ;

                  end;
                end;

               Prod.cProd    := DMNFe.ZQuery2['codigo_item'];
               Prod.xProd    := DMNFe.ZQuery2['descricao'];
               Prod.qCom     := strtofloat(DMNFe.ZQuery2['qtd']);
               Prod.uCom     := DMNFe.ZQuery2['unidade'];
               if not (DMNFe.ZQuery2['CEST'] = null) then
                Prod.CEST    := DMNFe.ZQuery2['CEST'];
               Prod.vProd    := DMNFe.ZQuery2['pr_total'];
               Prod.vUnCom   := DMNFe.ZQuery2['pr_unitario'];
               Prod.qTrib    := DMNFe.ZQuery2['qtd'];
               Prod.uTrib    := DMNFe.ZQuery2['unidade'];
               Prod.vUnTrib  := DMNFe.ZQuery2['pr_unitario'];
               Prod.NCM      := DMNFe.ZQuery2['ncm'];
               Prod.vDesc    := DMNFe.ZQuery2['vl_desconto'];

               // by Edson Lima ; 2013/03/15 ; 10:36 ; condição incluida "o tipo desta classe deve ter sido modificada de ACBr"
               if (VarToStr(DMNFe.ZQuery2['ind_total']) <> '') then
                Prod.IndTot   := DMNFe.ZQuery2['ind_total'];

               Prod.vFrete   := DMNFe.ZQuery2['vl_frete'];
               Prod.vSeg     := DMNFe.ZQuery2['vl_seguro'];
               Prod.vOutro   := DMNFe.ZQuery2['vl_outros'];

               //itens de notas-DI
               DMNFe.ZQuery8.Close;
               DMNFe.ZQuery8.SQL.Clear;
               DMNFe.ZQuery8.SQL.Add( 'Select                                                 ' );
               DMNFe.ZQuery8.SQL.Add( 't1.*                                                 ' );
               DMNFe.ZQuery8.SQL.Add( 'from nfe_itens_DI t1                                                 ' );
               DMNFe.ZQuery8.SQL.Add( 'inner join nfe_itens t2 on t1.codigo_loja = t2.codigo_loja and t1.nnf = t2.nnf and t1.demi = t2.demi and t1.sequencia = t2.sequencia and t1.modelo = t2.modelo ' );
               DMNFe.ZQuery8.SQL.Add( 'where t2.codigo_loja = :parm1                                  ' );
               DMNFe.ZQuery8.SQL.Add( 'and   t2.demi        = :parm2                                  ' );
               DMNFe.ZQuery8.SQL.Add( 'and   t2.nnf         = :parm3                                  ' );
               DMNFe.ZQuery8.SQL.Add( 'and   t2.sequencia   = :parm4                                  ' );
               DMNFe.ZQuery8.SQL.Add( 'and   t2.modelo      = :parm5                                  ' );
               DMNFe.ZQuery8.SQL.Add( 'Order by t1.sequencia                                  ' );
               DMNFe.ZQuery8.Params[0].AsInteger := dxSpinEdit1.intValue;
               DMNFe.ZQuery8.Params[1].AsString  := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery1['nfe_demi']);
               DMNFe.ZQuery8.Params[2].AsString  := DMNFe.ZQuery1['nfe_nnf'];
               DMNFe.ZQuery8.Params[3].AsInteger := DMNFe.ZQuery2['sequencia'];
               DMNFe.ZQuery8.Params[4].AsString  := DMNFe.ZQuery1['nfe_modelo'];
               DMNFe.ZQuery8.Open;

               if not DMNFe.ZQuery8.IsEmpty then begin
                 DMNFe.ZQuery8.First;
                 While not DMNFe.ZQuery8.eof do begin
                     with Prod.DI.Add do begin
                       cExportador   := DMNFe.ZQuery8['codigo_exportador'];
                       dDesemb       := DMNFe.ZQuery8['data_desembaraco'];
                       UFDesemb      := DMNFe.ZQuery8['uf_desembaraco'];
                       xLocDesemb    := DMNFe.ZQuery8['local_desembaraco'];
                       dDi           := DMNFe.ZQuery8['data_DI'];
                       nDi           := DMNFe.ZQuery8['numero_di'];

                       //itens de notas-ADI
                       DMNFe.ZQuery9.Close;
                       DMNFe.ZQuery9.SQL.Clear;
                       DMNFe.ZQuery9.SQL.Add( 'Select                                                 ' );
                       DMNFe.ZQuery9.SQL.Add( 't1.*                                                 ' );
                       DMNFe.ZQuery9.SQL.Add( 'from nfe_itens_DI_ADI t1                                                 ' );
                       DMNFe.ZQuery9.SQL.Add( 'inner join nfe_itens_DI t2 on t1.codigo_loja = t2.codigo_loja and t1.nnf = t2.nnf and t1.demi = t2.demi and t1.sequencia = t2.sequencia and t1.numero_di = t2.numero_di and t1.modelo = t2.modelo ' );
                       DMNFe.ZQuery9.SQL.Add( 'where t2.codigo_loja = :parm1                                  ' );
                       DMNFe.ZQuery9.SQL.Add( 'and   t2.demi        = :parm2                                  ' );
                       DMNFe.ZQuery9.SQL.Add( 'and   t2.nnf         = :parm3                                  ' );
                       DMNFe.ZQuery9.SQL.Add( 'and   t2.sequencia   = :parm4                                  ' );
                       DMNFe.ZQuery9.SQL.Add( 'and   t2.numero_di   = :parm5                                  ' );
                       DMNFe.ZQuery9.SQL.Add( 'and   t2.modelo      = :parm6                                  ' );
                       DMNFe.ZQuery9.SQL.Add( 'Order by t1.sequencia                                  ' );
                       DMNFe.ZQuery9.Params[0].AsInteger := dxSpinEdit1.intValue;
                       DMNFe.ZQuery9.Params[1].AsString  := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery1['nfe_demi']);
                       DMNFe.ZQuery9.Params[2].AsString  := DMNFe.ZQuery1['nfe_nnf'];
                       DMNFe.ZQuery9.Params[3].AsInteger := DMNFe.ZQuery2['sequencia'];
                       DMNFe.ZQuery9.Params[4].AsString  := DMNFe.ZQuery8['numero_di'];
                       DMNFe.ZQuery9.Params[5].AsString  := DMNFe.ZQuery1['nfe_modelo'];
                       DMNFe.ZQuery9.Open;

                       if not DMNFe.ZQuery9.IsEmpty then begin
                         DMNFe.ZQuery9.First;
                         While not DMNFe.ZQuery9.eof do begin
                             with adi.Add do begin
                               vDescDI       := DMNFe.ZQuery9['valor_desconto'];
                               cFabricante   := DMNFe.ZQuery9['codigo_fabricante'];
                               nSeqAdi       := DMNFe.ZQuery9['sequencia_ADI'];
                               nAdicao       := DMNFe.ZQuery9['numero_ADI'];
                             end;
                           DMNFe.ZQuery9.next;
                         end;
                       end;

                     end;
                   DMNFe.ZQuery8.next;
                 end;
               end;

               // by Edson Lima ; lei da transparencia de impostos
               if DMNFe.ZQuery2['vTotTrib'] = null then
                Imposto.vTotTrib := 0
               else
                Imposto.vTotTrib := DMNFe.ZQuery2['vTotTrib'];                  // Produtos

               // by Edson Lima ; 2016-10-11 ; Valor do ICMS desonerado
               with Imposto.ICMS do
                begin
                 if not (DMNFe.ZQuery2['vICMSDeson'] = null) then
                  begin
                   vICMSDeson     := DMNFe.ZQuery2['vICMSDeson'];
                   motDesICMS     := DMNFe.ZQuery2['motDesICMS'];
                  end;
                end;

               // by Edson Lima ; 2016-10-11 ; partilha do ICMS e fundo de probreza
               with Imposto.ICMSUFDest do
                begin
                 if (DMNFe.ZQuery2['vBCUFDest'] = null) then
                  vBCUFDest      := 0
                 else
                  vBCUFDest      := DMNFe.ZQuery2['vBCUFDest'];
                 if (DMNFe.ZQuery2['pFCPUFDest'] = null) then
                  pFCPUFDest     := 0
                 else
                  pFCPUFDest     := DMNFe.ZQuery2['pFCPUFDest'];
                 if (DMNFe.ZQuery2['pICMSUFDest'] = null) then
                  pICMSUFDest    := 0
                 else
                  pICMSUFDest    := DMNFe.ZQuery2['pICMSUFDest'];
                 if (DMNFe.ZQuery2['pICMSInter'] = null) then
                  pICMSInter     := 0
                 else
                  pICMSInter     := DMNFe.ZQuery2['pICMSInter'];
                 if (DMNFe.ZQuery2['pICMSInterPart'] = null) then
                  pICMSInterPart := 0
                 else
                  pICMSInterPart := DMNFe.ZQuery2['pICMSInterPart'];
                 if (DMNFe.ZQuery2['vFCPUFDest'] = null) then
                  vFCPUFDest     := 0
                 else
                  vFCPUFDest     := DMNFe.ZQuery2['vFCPUFDest'];
                 if (DMNFe.ZQuery2['vICMSUFDest'] = null) then
                  vICMSUFDest    := 0
                 else
                  vICMSUFDest    := DMNFe.ZQuery2['vICMSUFDest'];
                 if (DMNFe.ZQuery2['vICMSUFRemet'] = null) then
                  vICMSUFRemet   := 0
                 else
                  vICMSUFRemet   := DMNFe.ZQuery2['vICMSUFRemet'];
                end;

               with Imposto.ICMS do
                begin

                 orig   := oeNacional;

                 if DMNFe.ZQuery4['regime_tributario'] <> 1 then
                  begin
                   if length(trim(DMNFe.ZQuery2['cst'])) = 3 then
                    begin
                     if copy(vartostr(DMNFe.ZQuery2['cst']),1,1) = '1' then orig   := oeEstrangeiraImportacaoDireta;
                     if copy(vartostr(DMNFe.ZQuery2['cst']),1,1) = '2' then orig   := oeEstrangeiraAdquiridaBrasil;

                     // linhas inseridas by Edson Lima ; 2015-2-26T1046
                     if copy(vartostr(DMNFe.ZQuery2['cst']),1,1) = '3' then orig   := oeNacionalConteudoImportacaoSuperior40;
                     if copy(vartostr(DMNFe.ZQuery2['cst']),1,1) = '4' then orig   := oeNacionalProcessosBasicos;
                     if copy(vartostr(DMNFe.ZQuery2['cst']),1,1) = '5' then orig   := oeNacionalConteudoImportacaoInferiorIgual40;
                     if copy(vartostr(DMNFe.ZQuery2['cst']),1,1) = '6' then orig   := oeEstrangeiraImportacaoDiretaSemSimilar;
                     if copy(vartostr(DMNFe.ZQuery2['cst']),1,1) = '7' then orig   := oeEstrangeiraAdquiridaBrasilSemSimilar;
                     if copy(vartostr(DMNFe.ZQuery2['cst']),1,1) = '8' then orig   := oeNacionalConteudoImportacaoSuperior70;
                     //------------------------------------------------
                    end;

                   CST    := cst00;

                   if length(trim(DMNFe.ZQuery2['cst'])) = 3 then
                    begin
                     if copy(vartostr(DMNFe.ZQuery2['cst']),2,2) = '10' then CST    := cst10;
                     if copy(vartostr(DMNFe.ZQuery2['cst']),2,2) = '20' then CST    := cst20;
                     if copy(vartostr(DMNFe.ZQuery2['cst']),2,2) = '30' then CST    := cst30;
                     if copy(vartostr(DMNFe.ZQuery2['cst']),2,2) = '40' then CST    := cst40;
                     if copy(vartostr(DMNFe.ZQuery2['cst']),2,2) = '41' then CST    := cst41;
                     if copy(vartostr(DMNFe.ZQuery2['cst']),2,2) = '50' then CST    := cst50;
                     if copy(vartostr(DMNFe.ZQuery2['cst']),2,2) = '51' then CST    := cst51;
                     if copy(vartostr(DMNFe.ZQuery2['cst']),2,2) = '60' then CST    := cst60;
                     if copy(vartostr(DMNFe.ZQuery2['cst']),2,2) = '70' then CST    := cst70;
                     if copy(vartostr(DMNFe.ZQuery2['cst']),2,2) = '80' then CST    := cst80;             // Incluido by Edson Lima ; 18/12/2012 ; 15:22
                     if copy(vartostr(DMNFe.ZQuery2['cst']),2,2) = '81' then CST    := cst81;             // Incluido by Edson Lima ; 18/12/2012 ; 15:22
                     if copy(vartostr(DMNFe.ZQuery2['cst']),2,2) = '90' then CST    := cst90;
                     if copy(vartostr(DMNFe.ZQuery2['cst']),2,2) = '91' then CST    := cstICMSOutraUF;    // Incluido by Edson Lima ; 18/12/2012 ; 15:22
                     if copy(vartostr(DMNFe.ZQuery2['cst']),2,2) = '92' then CST    := cstICMSSN;         // Incluido by Edson Lima ; 18/12/2012 ; 15:22
                    end;
                  end
                 else
                  begin
                   CST    := cst41;

                   if DMNFe.ZQuery2['cst'] = '101' then CSOSN    := csosn101;
                   if DMNFe.ZQuery2['cst'] = '102' then CSOSN    := csosn102;
                   if DMNFe.ZQuery2['cst'] = '103' then CSOSN    := csosn103;
                   if DMNFe.ZQuery2['cst'] = '201' then CSOSN    := csosn201;
                   if DMNFe.ZQuery2['cst'] = '202' then CSOSN    := csosn202;
                   if DMNFe.ZQuery2['cst'] = '203' then CSOSN    := csosn203;
                   if DMNFe.ZQuery2['cst'] = '300' then CSOSN    := csosn300;
                   if DMNFe.ZQuery2['cst'] = '400' then CSOSN    := csosn400;
                   if DMNFe.ZQuery2['cst'] = '500' then CSOSN    := csosn500;
                   if DMNFe.ZQuery2['cst'] = '900' then CSOSN    := csosn900;
                  end;

                 modBC    := dbiValorOperacao;
                 pICMS    := DMNFe.ZQuery2['pc_icms'];
                 vICMS    := DMNFe.ZQuery2['vl_icms'];
                 vBC      := DMNFe.ZQuery2['base_calculo_icms'];
                 pRedBC   := DMNFe.ZQuery2['reducao_icms'];
                 vBCST    := DMNFe.ZQuery2['base_icms_st'];
                 vICMSST  := DMNFe.ZQuery2['vl_icms_st'];
                 pICMSST  := DMNFe.ZQuery2['pc_icms_st'];

                 //showmessage(vartostr(query2['base_calculo_icms']));

                end;

               with Imposto.IPI do begin
                 CST   := ipi00;
                 // Incluido by Edson Lima ; 18/12/2012 ; 15:05 --------
                 if DMNFe.ZQuery2['ipi_cst'] = '00' then CST    := ipi00;
                 if DMNFe.ZQuery2['ipi_cst'] = '01' then CST    := ipi01;
                 if DMNFe.ZQuery2['ipi_cst'] = '02' then CST    := ipi02;
                 if DMNFe.ZQuery2['ipi_cst'] = '03' then CST    := ipi03;
                 if DMNFe.ZQuery2['ipi_cst'] = '04' then CST    := ipi04;
                 if DMNFe.ZQuery2['ipi_cst'] = '05' then CST    := ipi05;
                 if DMNFe.ZQuery2['ipi_cst'] = '49' then CST    := ipi49;
                 if DMNFe.ZQuery2['ipi_cst'] = '50' then CST    := ipi50;
                 if DMNFe.ZQuery2['ipi_cst'] = '51' then CST    := ipi51;
                 if DMNFe.ZQuery2['ipi_cst'] = '52' then CST    := ipi52;
                 if DMNFe.ZQuery2['ipi_cst'] = '53' then CST    := ipi53;
                 if DMNFe.ZQuery2['ipi_cst'] = '54' then CST    := ipi54;
                 if DMNFe.ZQuery2['ipi_cst'] = '55' then CST    := ipi55;
                 if DMNFe.ZQuery2['ipi_cst'] = '99' then CST    := ipi99;
                 //-----------------------------------------------------

                 pIPI  := DMNFe.ZQuery2['pc_ipi'];
                 vIPI  := DMNFe.ZQuery2['vl_ipi'];
                 vBC   := DMNFe.ZQuery2['base_calculo_ipi'];
               end;
               with Imposto.PIS do
                begin
                // posicionado by Edson Lima ; 20/11/2012 ; 14:44
                CST    := pis01;
                if DMNFe.ZQuery2['pis_cst'] = '01' then CST    := pis01;
                if DMNFe.ZQuery2['pis_cst'] = '02' then CST    := pis02;
                if DMNFe.ZQuery2['pis_cst'] = '03' then CST    := pis03;
                if DMNFe.ZQuery2['pis_cst'] = '04' then CST    := pis04;
                if DMNFe.ZQuery2['pis_cst'] = '05' then CST    := pis05;
                if DMNFe.ZQuery2['pis_cst'] = '06' then CST    := pis06;
                if DMNFe.ZQuery2['pis_cst'] = '07' then CST    := pis07;
                if DMNFe.ZQuery2['pis_cst'] = '08' then CST    := pis08;
                if DMNFe.ZQuery2['pis_cst'] = '09' then CST    := pis09;
                if DMNFe.ZQuery2['pis_cst'] = '49' then CST    := pis49;
                if DMNFe.ZQuery2['pis_cst'] = '50' then CST    := pis50;
                if DMNFe.ZQuery2['pis_cst'] = '51' then CST    := pis51;
                if DMNFe.ZQuery2['pis_cst'] = '52' then CST    := pis52;
                if DMNFe.ZQuery2['pis_cst'] = '53' then CST    := pis53;
                if DMNFe.ZQuery2['pis_cst'] = '54' then CST    := pis54;
                if DMNFe.ZQuery2['pis_cst'] = '55' then CST    := pis55;
                if DMNFe.ZQuery2['pis_cst'] = '56' then CST    := pis56;
                if DMNFe.ZQuery2['pis_cst'] = '60' then CST    := pis60;
                if DMNFe.ZQuery2['pis_cst'] = '61' then CST    := pis61;
                if DMNFe.ZQuery2['pis_cst'] = '62' then CST    := pis62;
                if DMNFe.ZQuery2['pis_cst'] = '63' then CST    := pis63;
                if DMNFe.ZQuery2['pis_cst'] = '64' then CST    := pis64;
                if DMNFe.ZQuery2['pis_cst'] = '65' then CST    := pis65;
                if DMNFe.ZQuery2['pis_cst'] = '66' then CST    := pis66;
                if DMNFe.ZQuery2['pis_cst'] = '67' then CST    := pis67;
                if DMNFe.ZQuery2['pis_cst'] = '70' then CST    := pis70;
                if DMNFe.ZQuery2['pis_cst'] = '71' then CST    := pis71;
                if DMNFe.ZQuery2['pis_cst'] = '72' then CST    := pis72;
                if DMNFe.ZQuery2['pis_cst'] = '73' then CST    := pis73;
                if DMNFe.ZQuery2['pis_cst'] = '74' then CST    := pis74;
                if DMNFe.ZQuery2['pis_cst'] = '75' then CST    := pis75;
                if DMNFe.ZQuery2['pis_cst'] = '98' then CST    := pis98;
                if DMNFe.ZQuery2['pis_cst'] = '99' then CST    := pis99;

                vBC    := DMNFe.ZQuery2['pis_base_calculo'];
                pPis   := DMNFe.ZQuery2['pis_percentual'];
                vPis   := DMNFe.ZQuery2['pis_valor'];
               end;

               with Imposto.COFINS do
                begin

                 // posicionado by Edson Lima ; 20/11/2012 ; 14:44
                 CST    := cof01;
                 if DMNFe.ZQuery2['cofins_cst'] = '01' then CST    := cof01;
                 if DMNFe.ZQuery2['cofins_cst'] = '02' then CST    := cof02;
                 if DMNFe.ZQuery2['cofins_cst'] = '03' then CST    := cof03;
                 if DMNFe.ZQuery2['cofins_cst'] = '04' then CST    := cof04;
                 if DMNFe.ZQuery2['cofins_cst'] = '05' then CST    := cof05;
                 if DMNFe.ZQuery2['cofins_cst'] = '06' then CST    := cof06;
                 if DMNFe.ZQuery2['cofins_cst'] = '07' then CST    := cof07;
                 if DMNFe.ZQuery2['cofins_cst'] = '08' then CST    := cof08;
                 if DMNFe.ZQuery2['cofins_cst'] = '09' then CST    := cof09;
                 if DMNFe.ZQuery2['cofins_cst'] = '49' then CST    := cof49;
                 if DMNFe.ZQuery2['cofins_cst'] = '50' then CST    := cof50;
                 if DMNFe.ZQuery2['cofins_cst'] = '51' then CST    := cof51;
                 if DMNFe.ZQuery2['cofins_cst'] = '52' then CST    := cof52;
                 if DMNFe.ZQuery2['cofins_cst'] = '53' then CST    := cof53;
                 if DMNFe.ZQuery2['cofins_cst'] = '54' then CST    := cof54;
                 if DMNFe.ZQuery2['cofins_cst'] = '55' then CST    := cof55;
                 if DMNFe.ZQuery2['cofins_cst'] = '56' then CST    := cof56;
                 if DMNFe.ZQuery2['cofins_cst'] = '60' then CST    := cof60;
                 if DMNFe.ZQuery2['cofins_cst'] = '61' then CST    := cof61;
                 if DMNFe.ZQuery2['cofins_cst'] = '62' then CST    := cof62;
                 if DMNFe.ZQuery2['cofins_cst'] = '63' then CST    := cof63;
                 if DMNFe.ZQuery2['cofins_cst'] = '64' then CST    := cof64;
                 if DMNFe.ZQuery2['cofins_cst'] = '65' then CST    := cof65;
                 if DMNFe.ZQuery2['cofins_cst'] = '66' then CST    := cof66;
                 if DMNFe.ZQuery2['cofins_cst'] = '67' then CST    := cof67;
                 if DMNFe.ZQuery2['cofins_cst'] = '70' then CST    := cof70;
                 if DMNFe.ZQuery2['cofins_cst'] = '71' then CST    := cof71;
                 if DMNFe.ZQuery2['cofins_cst'] = '72' then CST    := cof72;
                 if DMNFe.ZQuery2['cofins_cst'] = '73' then CST    := cof73;
                 if DMNFe.ZQuery2['cofins_cst'] = '74' then CST    := cof74;
                 if DMNFe.ZQuery2['cofins_cst'] = '75' then CST    := cof75;
                 if DMNFe.ZQuery2['cofins_cst'] = '98' then CST    := cof98;
                 if DMNFe.ZQuery2['cofins_cst'] = '99' then CST    := cof99;

                 vBC       := DMNFe.ZQuery2['cofins_base_calculo'];
                 pCofins   := DMNFe.ZQuery2['cofins_percentual'];
                 vCofins   := DMNFe.ZQuery2['cofins_valor'];
               end;
             end;
           DMNFe.ZQuery2.next;
         end;

         // ACBrNFe1.NotasFiscais.Add.NFe.Det.Add.imposto.pis.CST

         Total.ICMSTot.vBC        := DMNFe.ZQuery1['nfe_base_calculo_icms'];
         Total.ICMSTot.vICMS      := DMNFe.ZQuery1['nfe_vl_icms'];
         Total.ICMSTot.vNF        := DMNFe.ZQuery1['nfe_total_nf'];
         Total.ICMSTot.vProd      := DMNFe.ZQuery1['nfe_total_produtos'];
         total.icmstot.vBCST      := DMNFe.ZQuery1['nfe_base_calculo_st'];
         total.icmstot.vST        := DMNFe.ZQuery1['nfe_vl_st'];
         total.icmstot.vFrete     := DMNFe.ZQuery1['nfe_vl_frete'];
         total.icmstot.vSeg       := DMNFe.ZQuery1['nfe_vl_seguro'];
         total.icmstot.vDesc      := DMNFe.ZQuery1['nfe_vl_desconto'];
         total.icmstot.vIpi       := DMNFe.ZQuery1['nfe_vl_ipi'];
         total.icmstot.vPis       := DMNFe.ZQuery1['nfe_vl_pis'];
         total.icmstot.vCofins    := DMNFe.ZQuery1['nfe_vl_cofins'];
         total.icmstot.vOutro     := DMNFe.ZQuery1['nfe_vl_outros'];

         // by Edson Lima
         if vartostr(DMNFe.ZQuery1['nfe_vl_ii']) <> '' then                     // Nota
          begin
           total.ICMSTot.vII      := DMNFe.ZQuery1['nfe_vl_ii'];
          end;

         // by Edson Lima ; 2016-3-22 ; lei da transparencia de impostos
         if DMNFe.ZQuery1['vTotTrib'] = null then
          Total.ICMSTot.vTotTrib := 0
         else
          Total.ICMSTot.vTotTrib := DMNFe.ZQuery1['vTotTrib'];                  // Nota

         // by Edson Lima ; 2016-10-11 ; valor do ICMS Desonerado
         if not (DMNFe.ZQuery1['nfe_vICMSDeson'] = null) then
          Total.ICMSTot.vICMSDeson   := DMNFe.ZQuery1['nfe_vICMSDeson'];        // by Edson Lima ; 11/10/2016

         // by Edson Lima ; 2016-3-22 ; partilha do icms e fundo de probreza
         if DMNFe.ZQuery1['nfe_vFCPUFDest'] = null then
          Total.ICMSTot.vFCPUFDest   := 0
         else
          Total.ICMSTot.vFCPUFDest   := DMNFe.ZQuery1['nfe_vFCPUFDest'];
         if DMNFe.ZQuery1['nfe_vICMSUFDest'] = null then
          Total.ICMSTot.vICMSUFDest  := 0
         else
          Total.ICMSTot.vICMSUFDest  := DMNFe.ZQuery1['nfe_vICMSUFDest'];
         if DMNFe.ZQuery1['nfe_vICMSUFRemet'] = null then
          Total.ICMSTot.vICMSUFRemet := 0
         else
          Total.ICMSTot.vICMSUFRemet := DMNFe.ZQuery1['nfe_vICMSUFRemet'];

       end;
      end;

      //------------------------------------------------------------------------
      // CONTINGÊNCIA
      //------------------------------------------------------------------------
      if ((_tipo_emissao = 'fsda') or (_tipo_emissao = 'OffL')) then
       begin

        //1- Normal, 2-Contingência FS, 3-Contingência SCAN, 4-EPEC e 5-Contingência FSDA. 9-OFFL

        if (gModelo = 55) then
         _tpemissao := '5'
        else if (gModelo = 65) then
         _tpemissao := '9';

        aux := '';
        aux := dxSpinEdit1.Text + ',' + '''' + VarToStr(DMNFe.ZQuery1['nfe_nnf']) + '''' + ',' + '''' + _tpemissao + '''' + ',' + '''';
        aux := aux + FormatDateTime('yyyy/mm/dd', VarToDateTime(DMNFe.ZQuery1['nfe_demi'])) + '''' + ',' + '''';
        Aux := Aux + IntToStr(gModelo) + '''' + ',' + '''';
        Aux := Aux + VarToStr(DMNFe.ZQuery1['nfe_Serie']) + '''';

        DMNFe.ZQuery7.Close;
        DMNFe.ZQuery7.SQL.Clear;
        DMNFe.ZQuery7.SQL.Add( 'exec sp_calcula_digito_chave ' + aux );
        DMNFe.ZQuery7.open;

        Aux := '';
        if not DMNFe.ZQuery7.IsEmpty then
         Aux := vartostr(DMNFe.ZQuery7['chave']);

        //----------------------------------------------------------------------
        // by Edson Lima ; 2017-1-5T1027 ; Atribuição de dados nas variáveis do
        //                                 gerente
        //----------------------------------------------------------------------
        gChvNFe := aux;
        gCd_Emp := DMNFe.ZQuery1['nfe_codigo_loja'];
        if ( DMNFe.ZQuery1['nfe_CodPed'] <> null ) then
         gCodPed := DMNFe.ZQuery1['nfe_CodPed']
        else
         gCodPed := 0;
        //----------------------------------------------------------------------

        // by Edson ; 2013-10-8T1031 ; Variável Global Chave criada para contestar gravação;
        gChave_Consiste  := Aux;

        if (gModelo = 65) then
         gTN              := '\NFCe\'                                           // by Edson Lima 2015-10-14T1107 - trunk2 novo ; Global utilizado para setar o nome da pasta
        else
         gTN              := '\NFe\';                                           // by Edson Lima 2015-10-14T1107 - trunk2 novo ; Global utilizado para setar o nome da pasta

        ACBrNFe1.NotasFiscais.Validar;

        try
         Copia_Xml_PathLog(Aux, gTN);                                           // by Edson Lima 2015-10-14T1107 - trunk2 novo

         //vCon := trim(gCamLog) + trim(Aux) + '-nfe.xml';                        // 2016-1-20T1415 - Implementado para resolber mensagem de não envio para sefaz
         //ACBrNFe1.NotasFiscais.Clear;                                           // 2016-1-20T1415 - Implementado para resolber mensagem de não envio para sefaz
         //ACBrNFe1.NotasFiscais.LoadFromFile(vCon);                              // 2016-1-20T1415 - Implementado para resolber mensagem de não envio para sefaz
         //ACBrNFe1.Consultar;                                                    // 2016-1-20T1415 - Implementado para resolber mensagem de não envio para sefaz

         if ( gCpt = 1 ) then
          pDefineRel()                                                          // Define o tipo de Relatório FortesReport
         else
          pDefineRelFR();                                                       // Define o tipo de Relatório FastReport

         pImpr();

         ACBrNFe1.NotasFiscais.GravarXML();                                     // trunk2 - Antes => ACBrNFe1.NotasFiscais.SaveToFile(); //Salva os XMLs para posterior envio do XML.

         _chave := aux;

         // by Edson Lima ; 2013/03/12 ; 14:23 ; Atualiza a nfe no update centralizado
         pGravaNFe('003', 'data_hora_recebimento',   'chave_nfe', 'situacao', 'motivo',
                   'CalcHoraNFCe', '', '', 'codigo_loja', 'demi', 'nnf', 'serie', 'chave_nfe',
                   FormatDateTime('yyyy/mm/dd hh:nn:ss', Date()),
                   Aux,
                   AnsiUpperCase(_tipo_emissao),
                   ACBrNFe1.WebServices.EnvEvento.xMotivo,    // trunk2 - Antes =>  ACBrNFe1.WebServices.EnviarDPEC.xMotivo,
                   'N',
                   '',
                   '',
                   dxSpinEdit1.intValue,
                   FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery1['nfe_demi']),
                   DMNFe.ZQuery1['nfe_nnf'],
                   DMNFe.ZQuery1['nfe_serie'],
                   Aux, true);

        except

         MemoResp.Lines.Text   := UTF8Encode(ACBrNFe1.WebServices.Retorno.RetWS);
         MemoLog.Lines.Text    := UTF8Encode(ACBrNFe1.WebServices.Retorno.Msg);
         memoRespWS.Lines.Text := UTF8Encode(ACBrNFe1.WebServices.Retorno.RetornoWS);
         LoadXML(MemoResp, WBResposta);

        end;
       end;

      //------------------------------------------------------------------------
      // NORMAL
      //------------------------------------------------------------------------
      if _tipo_emissao = 'normal' then
       begin

        // By Edson ; 2013-10-9T1024 ; rotina incluida para calc.e verif.da chave
        _tpemissao := '1';

        aux := '';
        aux := dxSpinEdit1.Text + ',' + '''' + VarToStr(DMNFe.ZQuery1['nfe_nnf']) + '''' + ',' + '''' + _tpemissao + '''' + ',' + '''';
        aux := aux + FormatDateTime('yyyy/mm/dd', VarToDateTime(DMNFe.ZQuery1['nfe_demi'])) + '''' + ',' + '''';
        aux := aux + IntToStr(gModelo) + '''' + ',' + '''';
        aux := aux + VarToStr(DMNFe.ZQuery1['nfe_Serie']) + '''';

        DMNFe.ZQuery7.Close;
        DMNFe.ZQuery7.SQL.Clear;
        DMNFe.ZQuery7.SQL.Add( 'exec sp_calcula_digito_chave ' + aux );
        DMNFe.ZQuery7.open;

        Aux := '';
        if not DMNFe.ZQuery7.IsEmpty then
          Aux := vartostr(DMNFe.ZQuery7['chave']);

        //----------------------------------------------------------------------
        // by Edson Lima ; 2017-1-5T1027 ; Atribuição de dados nas variáveis do
        //                                 gerente
        //----------------------------------------------------------------------
        gChvNFe := aux;
        gCd_Emp := DMNFe.ZQuery1['nfe_codigo_loja'];
        if ( DMNFe.ZQuery1['nfe_CodPed'] <> null ) then
         gCodPed := DMNFe.ZQuery1['nfe_CodPed']
        else
         gCodPed := 0;
        //----------------------------------------------------------------------

        // by Edson ; 2013-10-8T1031 ; Variável Global Chave criada para contestar gravação;
        gChave_Consiste  := Aux;

        if (StrToInt(DMNFe.ZQuery1['nfe_modelo']) = 65) then
         gTN              := '\NFCe\'                                           // by Edson Lima 2015-10-14T1107 - trunk2 novo ; Global utilizado para setar o nome da pasta
        else
         gTN              := '\NFe\';                                           // by Edson Lima 2015-10-14T1107 - trunk2 novo ; Global utilizado para setar o nome da pasta

        ACBrNFe1.NotasFiscais.Validar;
        Copia_Xml_PathLog(Aux, gTN);                                            // by Edson Lima 2015-10-14T1107 - trunk2 novo

        // Criado para tirar a tarja vermelha da danfe e desativado pq estava zerando o xml da pasta log
        //vCon := trim(gCamLog) + trim(Aux) + '-nfe.xml';                         // 2016-1-20T1415 - Implementado para resolber mensagem de não envio para sefaz
        //ACBrNFe1.NotasFiscais.Clear;                                            // 2016-1-20T1415 - Implementado para resolber mensagem de não envio para sefaz
        //ACBrNFe1.NotasFiscais.LoadFromFile(vCon);                               // 2016-1-20T1415 - Implementado para resolber mensagem de não envio para sefaz
        //ACBrNFe1.Consultar;                                                     // 2016-1-20T1415 - Implementado para resolber mensagem de não envio para sefaz

        if ( gCpt = 1 ) then
         pDefineRel()                                                           // Define o tipo de Relatório FortesReport
        else
         pDefineRelFR();                                                        // Define o tipo de Relatório FastReport

        //grava o numero do protocolo e o numero do recibo
        if not gGeraXml then
         begin
          try // by Edson Lima ; 2013/02/26 ; 08:26 ; try inserido para obter retorno de erros abortado no ACBR
           if (ACBrNFe1.Enviar(0)) then
            begin
             // by Edson Lima ; 2013/03/12 ; 14:23 ; Atualiza a nfe no update centralizado
             pGravaNFe('004', 'protocolo', 'recibo',                 'chave_nfe', 'situacao',
                       'motivo', 'data_hora_recebimento',  'CalcHoraNFCe',     'codigo_loja',
                       'demi',      'nnf',                    'serie', 'chave_nfe',
                       ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[0].nProt,
                       ACBrNFe1.WebServices.Retorno.NFeRetorno.nRec,
                       ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[0].chNFe,
                       ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[0].cStat,
                       ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[0].xMotivo,
                       FormatDateTime('yyyy/mm/dd hh:nn:ss', ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[0].dhRecbto),
                       'N',
                       dxSpinEdit1.intValue,
                       FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery1['nfe_demi']),
                       DMNFe.ZQuery1['nfe_nnf'],
                       DMNFe.ZQuery1['nfe_serie'],
                       ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[0].chNFe, true);

             //-----------------------------------------------------------------
             // by Edson Lima ; 2017-1-5T1054 ; Grava a chave no pedido do gerente
             if ( (vartostr(ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[0].cStat) = '100') or
                  (vartostr(ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[0].cStat) = '150') ) then
              fGraGer();
             //-----------------------------------------------------------------

             memoLog.Clear;
             MemoResp.Lines.Text   := UTF8Encode(ACBrNFe1.WebServices.Retorno.RetWS);
             MemoLog.Lines.Text    := UTF8Encode(ACBrNFe1.WebServices.Retorno.Msg);
             memoRespWS.Lines.Text := UTF8Encode(ACBrNFe1.WebServices.Retorno.RetornoWS);
             LoadXML(MemoResp, WBResposta);

            end

           else

            begin

             ACBrNFe1.WebServices.Retorno.Recibo := ACBrNFe1.WebServices.Enviar.Recibo;
             ACBrNFe1.WebServices.Retorno.Executar;
             for i := 0 to ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Count-1 do
              begin
               // by Edson Lima ; 2013/03/12 ; 14:23 ; Atualiza a nfe no update centralizado
               pGravaNFe('005',    'protocolo', 'recibo',   'chave_nfe',    'situacao',
                         'motivo', 'data_hora_recebimento', 'CalcHoraNFCe', 'codigo_loja',
                         'demi',   'nnf',       'serie',    'chave_nfe',
                         ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[i].nProt,
                         ACBrNFe1.WebServices.Retorno.NFeRetorno.nRec,
                         ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[i].chNFe,
                         ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[i].cStat,
                         ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[i].xMotivo,
                         FormatDateTime('yyyy/mm/dd hh:nn:ss', ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[i].dhRecbto),
                         'N',
                         dxSpinEdit1.intValue,
                         FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery1['nfe_demi']),
                         DMNFe.ZQuery1['nfe_nnf'],
                         DMNFe.ZQuery1['nfe_serie'],
                         ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[0].chNFe, true);

              end;

             memoLog.Clear;
             MemoResp.Lines.Text   := UTF8Encode(ACBrNFe1.WebServices.Retorno.RetWS);
             MemoLog.Lines.Text    := UTF8Encode(ACBrNFe1.WebServices.Retorno.Msg);
             memoRespWS.Lines.Text := UTF8Encode(ACBrNFe1.WebServices.Retorno.RetornoWS);
             LoadXML(MemoResp, WBResposta);

            end;

          Except

           //-------------------------------------------------------------------
           // Caso a exceção seja por denegação
           //-------------------------------------------------------------------
           if (vartostr(ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[i].xMotivo) =
              'Rejeicao: NF-e esta denegada na base de dados da Secretaria de Fazenda Estadual')  or
              (vartostr(ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[i].xMotivo) =
              'Uso Denegado : Irregularidade fiscal do destinatario')                             or
              (vartostr(ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[i].cStat) = '301')  or
              (vartostr(ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[i].cStat) = '302')  or
              (vartostr(ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[i].cStat) = '110')  or
              (vartostr(ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[i].cStat) = '205')  then
            begin

             //-----------------------------------------------------------------
             // by Edson Lima ; 2017-1-5T1054 ; Grava a chave no pedido do gerente
              fGraGer();
             //-----------------------------------------------------------------

             gExcluir := True;                                                  // Seta variável global para ler somente um registro
             BitBtn8Click(Sender);                                              // Força um click na consulta
             gExcluir := False;                                                 // Seta variável global para ler vários registros
             iCodPed := gCodPed;

             //-----------------------------------------------------------------
             // by Edson Lima ; 2017-1-13T1358
             // Cancelamento do pedido no gerente da nota denegada
             //-----------------------------------------------------------------
             // Verifica a precisão administrativa do gerente para cancelamento
             // de nota denegada
             //-----------------------------------------------------------------
             if iCodPed <> 0 then
              begin

               if ( fVerPAG(StrToInt(gNNF_Consiste), dxSpinEdit1.IntValue, iCodPed) ) then
                begin

                 //-------------------------------------------------------------
                 // Efetua o Cancelamento Administrativo do PEDIDO da nota Denegada
                 //-------------------------------------------------------------
                 if iCodPed <> 0 then
                  begin
                   if not ( fCanCAP(StrToInt(gNNF_Consiste), dxSpinEdit1.IntValue, iCodPed, gCodMtD) ) then
                    Application.MessageBox(PChar('Nota denegada, mas o pedido não foi cancelado!'), 'Atenção', MB_ICONINFORMATION );
                  end
                 else
                  Application.MessageBox(PChar('Número do pedido não informado! Nota cancelada, mas Pedido não!'), 'Atenção', MB_ICONINFORMATION );
                 //-------------------------------------------------------------

                end
               else
                Application.MessageBox(PChar('Nota denegada, mas o pedido não foi cancelado!'), 'Atenção', MB_ICONINFORMATION );

              end
             else
              Application.MessageBox(PChar('Número do pedido não informado!'), 'Atenção', MB_ICONINFORMATION );
             //-----------------------------------------------------------------

            end;

            memoLog.Clear;
            MemoResp.Lines.Text   := UTF8Encode(ACBrNFe1.WebServices.Retorno.RetWS);
            MemoLog.Lines.Text    := UTF8Encode(ACBrNFe1.WebServices.Retorno.Msg);
            memoRespWS.Lines.Text := UTF8Encode(ACBrNFe1.WebServices.Retorno.RetornoWS);
            LoadXML(MemoResp, WBResposta);

          end;

         end;

        memoLog.Clear;
        MemoResp.Lines.Text   := UTF8Encode(ACBrNFe1.WebServices.Retorno.RetWS);
        MemoLog.Lines.Text    := UTF8Encode(ACBrNFe1.WebServices.Retorno.Msg);
        memoRespWS.Lines.Text := UTF8Encode(ACBrNFe1.WebServices.Retorno.RetornoWS);
        LoadXML(MemoResp, WBResposta);

       end;// fim do envio normal

      Copia_Xml_PathLog(Aux, gTN);                                              // by Edson Lima 2015-10-14T1107 - trunk2 novo

      ACBrNFe1.NotasFiscais.Clear;
      DMNFe.ZQuery1.next;
     end;

  end;

end;

//------------------------------------------------------------------------------

procedure TFrGBNFe.grava_xml_no_banco;
var
 vXml1,  vXml2,  vXml3,  vXml4,  vXml5  : String;
 vXml6,  vXml7,  vXml8,  vXml9,  vXml10 : String;
 vXml11, vXml12, vXml13, vXml14, vXml15 : String;
 vXml16, vXml17, vXml18, vXml19, vXml20 : string;
 vXml21, vXml22, vXml23, vXml24, vXml25 : string;
 vXml26, vXml27, vXml28, vXml29, vXml30 : string;
 vXml31, vXml32, vXml33, vXml34, vXml35 : string;
 vXml36, vXml37, vXml38, vXml39, vXml40 : string;
 vXml41, pXml                           : String;
 i, y                                   : integer;
 z                                      : real;

begin
 with ACBrNFe1.NotasFiscais.Items[0].NFe do
  begin

   //grava xml da nfe
   try
    vXml1 := '';
    vXml2 := '';
    vXml3 := '';
    vXml4 := '';
    vXml5 := '';
    vXml6 := '';
    vXml7 := '';
    vXml8 := '';
    vXml9 := '';
    vXml10 := '';
    vXml11 := '';
    vXml12 := '';
    vXml13 := '';
    vXml14 := '';
    vXml15 := '';
    vXml16 := '';
    vXml17 := '';
    vXml18 := '';
    vXml19 := '';
    vXml20 := '';
    vXml21 := '';
    vXml22 := '';
    vXml23 := '';
    vXml24 := '';
    vXml25 := '';
    vXml26 := '';
    vXml27 := '';
    vXml28 := '';
    vXml29 := '';
    vXml30 := '';
    vXml31 := '';
    vXml32 := '';
    vXml33 := '';
    vXml34 := '';
    vXml35 := '';
    vXml36 := '';
    vXml37 := '';
    vXml38 := '';
    vXml39 := '';
    vXml40 := '';
    vXml41 := '';

    pXml := Trim(ACBrNFe1.NotasFiscais.Items[0].XML);

    z := (Int(Length(pXml) / 8000));
    if z < 9 then
     y := StrToInt(copy(FloatToStr(z), 1, 1))
    else if ( (z > 9) and (z < 100) ) then
     y := StrToInt(copy(FloatToStr(z), 1, 2))
    else
     y := StrToInt(copy(FloatToStr(z), 1, 3));

    while ( y >= 0 ) do
     begin

      if ( (y > 0) and (Length(pXml) > 8000) ) then
       begin
        for i := 1 to 8000 do
         begin
          vXml1 := (vXml1 + pXml[i]);
         end;
       end
      else if ( y = 0) then
       begin
        for i := 1 to (Length(pXml)) do
         begin
          vXml1 := (vXml1 + pXml[i]);
         end;
       end;

      if ( (y > 1) and (Length(pXml) > 16000) ) then
       begin
        for i := 8001 to 16000 do
         begin
          vXml2 := (vXml2 + pXml[i]);
         end;
       end
      else if ( y = 1 ) then
       begin
        for i := 8001 to (Length(pXml)) do
         begin
          vXml2 := (vXml2 + pXml[i]);
         end;
       end;

      if ( (y > 2) and (Length(pXml) > 24000) ) then
       begin
        for i := 16001 to 24000 do
         begin
          vXml3 := (vXml3 + pXml[i]);
         end;
       end
      else if ( y = 2 ) then
       begin
        for i := 16001 to (Length(pXml)) do
         begin
          vXml3 := (vXml3 + pXml[i]);
         end;
       end;

      if ( (y > 3) and (Length(pXml) > 32000) ) then
       begin
        for i := 24001 to 32000 do
         begin
          vXml4 := (vXml4 + pXml[i]);
         end;
       end
      else if ( y = 3 ) then
       begin
        for i := 24001 to (Length(pXml)) do
         begin
          vXml4 := (vXml4 + pXml[i]);
         end;
       end;

      if ( (y > 4) and (Length(pXml) > 40000) ) then
       begin
        for i := 32001 to 40000 do
         begin
          vXml5 := (vXml5 + pXml[i]);
         end;
       end
      else if ( y = 4 ) then
       begin
        for i := 32001 to (Length(pXml)) do
         begin
          vXml5 := (vXml5 + pXml[i]);
         end;
       end;

      if ( (y > 5) and (Length(pXml) > 48000) ) then
       begin
        for i := 40001 to 48000 do
         begin
          vXml6 := (vXml6 + pXml[i]);
         end;
       end
      else if ( y = 5 ) then
       begin
        for i := 40001 to (Length(pXml)) do
         begin
          vXml6 := (vXml6 + pXml[i]);
         end;
       end;

      if ( (y > 6) and (Length(pXml) > 56000) ) then
       begin
        for i := 48001 to 56000 do
         begin
          vXml7 := (vXml7 + pXml[i]);
         end;
       end
      else if ( y = 6 ) then
       begin
        for i := 48001 to (Length(pXml)) do
         begin
          vXml7 := (vXml7 + pXml[i]);
         end;
       end;

      if ( (y > 7) and (Length(pXml) > 64000) ) then
       begin
        for i := 56001 to 64000 do
         begin
          vXml8 := (vXml8 + pXml[i]);
         end;
       end
      else if ( y = 7 ) then
       begin
        for i := 56001 to (Length(pXml)) do
         begin
          vXml8 := (vXml8 + pXml[i]);
         end;
       end;

      if ( (y > 8) and (Length(pXml) > 72000) ) then
       begin
        for i := 64001 to 72000 do
         begin
          vXml9 := (vXml9 + pXml[i]);
         end;
       end
      else if ( y = 8 ) then
       begin
        for i := 64001 to (Length(pXml)) do
         begin
          vXml9 := (vXml9 + pXml[i]);
         end;
       end;

      if ( (y > 9) and (Length(pXml) > 80000) ) then
       begin
        for i := 72001 to 80000 do
         begin
          vXml10 := (vXml10 + pXml[i]);
         end;
       end
      else if ( y = 9 ) then
       begin
        for i := 72001 to (Length(pXml)) do
         begin
          vXml10 := (vXml10 + pXml[i]);
         end;
       end;

      if ( (y > 10) and (Length(pXml) > 88000) ) then
       begin
        for i := 80001 to 88000 do
         begin
          vXml11 := (vXml11 + pXml[i]);
         end;
       end
      else if ( y = 10 ) then
       begin
        for i := 80001 to (Length(pXml)) do
         begin
          vXml11 := (vXml11 + pXml[i]);
         end;
       end;

      if ( (y > 11) and (Length(pXml) > 96000) ) then
       begin
        for i := 88001 to 96000 do
         begin
          vXml12 := (vXml12 + pXml[i]);
         end;
       end
      else if ( y = 11 ) then
       begin
        for i := 88001 to (Length(pXml)) do
         begin
          vXml12 := (vXml12 + pXml[i]);
         end;
       end;

      if ( (y > 12) and (Length(pXml) > 104000) ) then
       begin
        for i := 96001 to 104000 do
         begin
          vXml13 := (vXml13 + pXml[i]);
         end;
       end
      else if ( y = 12 ) then
       begin
        for i := 96001 to (Length(pXml)) do
         begin
          vXml13 := (vXml13 + pXml[i]);
         end;
       end;

      if ( (y > 13) and (Length(pXml) > 112000) ) then
       begin
        for i := 104001 to 112000 do
         begin
          vXml14 := (vXml14 + pXml[i]);
         end;
       end
      else if ( y = 13 ) then
       begin
        for i := 104001 to (Length(pXml)) do
         begin
          vXml14 := (vXml14 + pXml[i]);
         end;
       end;

      if ( (y > 14) and (Length(pXml) > 120000) ) then
       begin
        for i := 112001 to 120000 do
         begin
          vXml15 := (vXml15 + pXml[i]);
         end;
       end
      else if ( y = 14 ) then
       begin
        for i := 112001 to (Length(pXml)) do
         begin
          vXml15 := (vXml15 + pXml[i]);
         end;
       end;

      if ( (y > 15) and (Length(pXml) > 128000) ) then
       begin
        for i := 120001 to 128000 do
         begin
          vXml16 := (vXml16 + pXml[i]);
         end;
       end
      else if ( y = 15 ) then
       begin
        for i := 120001 to (Length(pXml)) do
         begin
          vXml16 := (vXml16 + pXml[i]);
         end;
       end;

      if ( (y > 16) and (Length(pXml) > 136000) ) then
       begin
        for i := 128001 to 136000 do
         begin
          vXml17 := (vXml17 + pXml[i]);
         end;
       end
      else if ( y = 16 ) then
       begin
        for i := 128001 to (Length(pXml)) do
         begin
          vXml17 := (vXml17 + pXml[i]);
         end;
       end;

      if ( (y > 17) and (Length(pXml) > 144000) ) then
       begin
        for i := 136001 to 144000 do
         begin
          vXml18 := (vXml18 + pXml[i]);
         end;
       end
      else if ( y = 17 ) then
       begin
        for i := 136001 to (Length(pXml)) do
         begin
          vXml18 := (vXml18 + pXml[i]);
         end;
       end;

      if ( (y > 18) and (Length(pXml) > 152000) ) then
       begin
        for i := 144001 to 152000 do
         begin
          vXml19 := (vXml19 + pXml[i]);
         end;
       end
      else if ( y = 18 ) then
       begin
        for i := 144001 to (Length(pXml)) do
         begin
          vXml19 := (vXml19 + pXml[i]);
         end;
       end;

      if ( (y > 19) and (Length(pXml) > 160000) ) then
       begin
        for i := 152001 to 160000 do
         begin
          vXml20 := (vXml20 + pXml[i]);
         end;
       end
      else if ( y = 19 ) then
       begin
        for i := 152001 to (Length(pXml)) do
         begin
          vXml20 := (vXml20 + pXml[i]);
         end;
       end;

      if ( (y > 20) and (Length(pXml) > 168000) ) then
       begin
        for i := 160001 to 168000 do
         begin
          vXml21 := (vXml21 + pXml[i]);
         end;
       end
      else if ( y = 20 ) then
       begin
        for i := 160001 to (Length(pXml)) do
         begin
          vXml21 := (vXml21 + pXml[i]);
         end;
       end;

      if ( (y > 21) and (Length(pXml) > 176000) ) then
       begin
        for i := 168001 to 176000 do
         begin
          vXml22 := (vXml22 + pXml[i]);
         end;
       end
      else if ( y = 21 ) then
       begin
        for i := 168001 to (Length(pXml)) do
         begin
          vXml22 := (vXml22 + pXml[i]);
         end;
       end;

      if ( (y > 22) and (Length(pXml) > 184000) ) then
       begin
        for i := 176001 to 184000 do
         begin
          vXml23 := (vXml23 + pXml[i]);
         end;
       end
      else if ( y = 22 ) then
       begin
        for i := 176001 to (Length(pXml)) do
         begin
          vXml23 := (vXml23 + pXml[i]);
         end;
       end;

      if ( (y > 23) and (Length(pXml) > 192000) ) then
       begin
        for i := 184001 to 192000 do
         begin
          vXml24 := (vXml24 + pXml[i]);
         end;
       end
      else if ( y = 23 ) then
       begin
        for i := 184001 to (Length(pXml)) do
         begin
          vXml24 := (vXml24 + pXml[i]);
         end;
       end;

      if ( (y > 24) and (Length(pXml) > 200000) ) then
       begin
        for i := 192001 to 200000 do
         begin
          vXml25 := (vXml25 + pXml[i]);
         end;
       end
      else if ( y = 24 ) then
       begin
        for i := 192001 to (Length(pXml)) do
         begin
          vXml25 := (vXml25 + pXml[i]);
         end;
       end;

      if ( (y > 25) and (Length(pXml) > 208000) ) then
       begin
        for i := 200001 to 208000 do
         begin
          vXml26 := (vXml26 + pXml[i]);
         end;
       end
      else if ( y = 25 ) then
       begin
        for i := 200001 to (Length(pXml)) do
         begin
          vXml26 := (vXml26 + pXml[i]);
         end;
       end;

      if ( (y > 26) and (Length(pXml) > 216000) ) then
       begin
        for i := 208001 to 216000 do
         begin
          vXml27 := (vXml27 + pXml[i]);
         end;
       end
      else if ( y = 26 ) then
       begin
        for i := 208001 to (Length(pXml)) do
         begin
          vXml27 := (vXml27 + pXml[i]);
         end;
       end;

      if ( (y > 27) and (Length(pXml) > 224000) ) then
       begin
        for i := 216001 to 224000 do
         begin
          vXml28 := (vXml28 + pXml[i]);
         end;
       end
      else if ( y = 27 ) then
       begin
        for i := 216001 to (Length(pXml)) do
         begin
          vXml28 := (vXml28 + pXml[i]);
         end;
       end;

      if ( (y > 28) and (Length(pXml) > 232000) ) then
       begin
        for i := 224001 to 232000 do
         begin
          vXml29 := (vXml29 + pXml[i]);
         end;
       end
      else if ( y = 28 ) then
       begin
        for i := 224001 to (Length(pXml)) do
         begin
          vXml29 := (vXml29 + pXml[i]);
         end;
       end;

      if ( (y > 29) and (Length(pXml) > 240000) ) then
       begin
        for i := 232001 to 2400000 do
         begin
          vXml30 := (vXml30 + pXml[i]);
         end;
       end
      else if ( y = 29 ) then
       begin
        for i := 232001 to (Length(pXml)) do
         begin
          vXml30 := (vXml30 + pXml[i]);
         end;
       end;

      if ( (y > 30) and (Length(pXml) > 248000) ) then
       begin
        for i := 240001 to 248000 do
         begin
          vXml31 := (vXml31 + pXml[i]);
         end;
       end
      else if ( y = 30 ) then
       begin
        for i := 240001 to (Length(pXml)) do
         begin
          vXml31 := (vXml31 + pXml[i]);
         end;
       end;

      if ( (y > 31) and (Length(pXml) > 256000) ) then
       begin
        for i := 248001 to 256000 do
         begin
          vXml32 := (vXml32 + pXml[i]);
         end;
       end
      else if ( y = 31 ) then
       begin
        for i := 248001 to (Length(pXml)) do
         begin
          vXml32 := (vXml32 + pXml[i]);
         end;
       end;

      if ( (y > 32) and (Length(pXml) > 264000) ) then
       begin
        for i := 256001 to 264000 do
         begin
          vXml33 := (vXml33 + pXml[i]);
         end;
       end
      else if ( y = 32 ) then
       begin
        for i := 256001 to (Length(pXml)) do
         begin
          vXml33 := (vXml33 + pXml[i]);
         end;
       end;

      if ( (y > 33) and (Length(pXml) > 272000) ) then
       begin
        for i := 264001 to 272000 do
         begin
          vXml34 := (vXml34 + pXml[i]);
         end;
       end
      else if ( y = 33 ) then
       begin
        for i := 264001 to (Length(pXml)) do
         begin
          vXml34 := (vXml34 + pXml[i]);
         end;
       end;

      if ( (y > 34) and (Length(pXml) > 280000) ) then
       begin
        for i := 272001 to 280000 do
         begin
          vXml35 := (vXml35 + pXml[i]);
         end;
       end
      else if ( y = 34 ) then
       begin
        for i := 272001 to (Length(pXml)) do
         begin
          vXml35 := (vXml35 + pXml[i]);
         end;
       end;

      if ( (y > 35) and (Length(pXml) > 288000) ) then
       begin
        for i := 280001 to 288000 do
         begin
          vXml36 := (vXml36 + pXml[i]);
         end;
       end
      else if ( y = 35 ) then
       begin
        for i := 280001 to (Length(pXml)) do
         begin
          vXml36 := (vXml36 + pXml[i]);
         end;
       end;

      if ( (y > 36) and (Length(pXml) > 296000) ) then
       begin
        for i := 288001 to 296000 do
         begin
          vXml37 := (vXml37 + pXml[i]);
         end;
       end
      else if ( y = 36 ) then
       begin
        for i := 288001 to (Length(pXml)) do
         begin
          vXml37 := (vXml37 + pXml[i]);
         end;
       end;

      if ( (y > 37) and (Length(pXml) > 304000) ) then
       begin
        for i := 296001 to 304000 do
         begin
          vXml38 := (vXml38 + pXml[i]);
         end;
       end
      else if ( y = 37 ) then
       begin
        for i := 296001 to (Length(pXml)) do
         begin
          vXml38 := (vXml38 + pXml[i]);
         end;
       end;

      if ( (y > 38) and (Length(pXml) > 312000) ) then
       begin
        for i := 304001 to 312000 do
         begin
          vXml39 := (vXml39 + pXml[i]);
         end;
       end
      else if ( y = 38 ) then
       begin
        for i := 304001 to (Length(pXml)) do
         begin
          vXml39 := (vXml39 + pXml[i]);
         end;
       end;

      if ( (y > 39) and (Length(pXml) > 320000) ) then
       begin
        for i := 312001 to 320000 do
         begin
          vXml40 := (vXml40 + pXml[i]);
         end;
       end
      else if ( y = 39 ) then
       begin
        for i := 312001 to (Length(pXml)) do
         begin
          vXml40 := (vXml40 + pXml[i]);
         end;
       end;

      if ( y = 40 ) then
       begin
        for i := 320001 to (Length(pXml)) do
         begin
          vXml41 := (vXml41 + pXml[i]);
         end;
       end;

      y := -1;

     end;

    DMNFe.ZQuery2.DisableControls;
    DMNFe.ZQuery2.Close;
    DMNFe.ZQuery2.SQL.Clear;
    DMNFe.ZQuery2.SQL.Add( 'insert into nfe_xml (                                       ' );
    DMNFe.ZQuery2.SQL.Add( 'origem,                                                     ' );
    DMNFe.ZQuery2.SQL.Add( 'codigo_loja,                                                ' );
    DMNFe.ZQuery2.SQL.Add( 'dEmi,                                                       ' );
    DMNFe.ZQuery2.SQL.Add( 'nNF,                                                        ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota,                                                   ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota1,                                                  ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota2,                                                  ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota3,                                                  ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota4,                                                  ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota5,                                                  ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota6,                                                  ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota7,                                                  ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota8,                                                  ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota9,                                                  ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota10,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota11,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota12,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota13,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota14,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota15,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota16,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota17,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota18,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota19,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota20,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota21,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota22,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota23,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota24,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota25,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota26,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota27,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota28,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota29,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota30,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota31,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota32,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota33,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota34,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota35,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota36,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota37,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota38,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota39,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'xml_nota40)                                                 ' );
    DMNFe.ZQuery2.SQL.Add( 'values (                                                    ' );
    DMNFe.ZQuery2.SQL.Add( ':origem,                                                    ' );
    DMNFe.ZQuery2.SQL.Add( ':codigo_loja,                                               ' );
    DMNFe.ZQuery2.SQL.Add( ':dEmi,                                                      ' );
    DMNFe.ZQuery2.SQL.Add( ':nNF,                                                       ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota,                                                  ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota1,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota2,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota3,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota4,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota5,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota6,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota7,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota8,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota9,                                                 ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota10,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota11,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota12,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota13,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota14,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota15,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota16,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota17,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota18,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota19,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota20,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota21,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota22,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota23,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota24,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota25,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota26,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota27,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota28,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota29,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota30,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota31,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota32,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota33,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota34,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota35,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota36,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota37,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota38,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota39,                                                ' );
    DMNFe.ZQuery2.SQL.Add( ':xml_nota40)                                                ' );
    DMNFe.ZQuery2.Params[0].AsString    := 'IMPORTA';
    DMNFe.ZQuery2.Params[1].AsInteger   := dxSpinEdit1.intValue;
    DMNFe.ZQuery2.Params[2].AsString    := FormatDateTime('yyyy/mm/dd', Ide.dEmi);
    DMNFe.ZQuery2.Params[3].AsString    := vartostr(Ide.nNF);
    DMNFe.ZQuery2.Params[4].AsMemo      := vXml1;
    DMNFe.ZQuery2.Params[5].AsMemo      := vXml2;
    DMNFe.ZQuery2.Params[6].AsMemo      := vXml3;
    DMNFe.ZQuery2.Params[7].AsMemo      := vXml4;
    DMNFe.ZQuery2.Params[8].AsMemo      := vXml5;
    DMNFe.ZQuery2.Params[9].AsMemo      := vXml6;
    DMNFe.ZQuery2.Params[10].AsMemo     := vXml7;
    DMNFe.ZQuery2.Params[11].AsMemo     := vXml8;
    DMNFe.ZQuery2.Params[12].AsMemo     := vXml9;
    DMNFe.ZQuery2.Params[13].AsMemo     := vXml10;
    DMNFe.ZQuery2.Params[14].AsMemo     := vXml11;
    DMNFe.ZQuery2.Params[15].AsMemo     := vXml12;
    DMNFe.ZQuery2.Params[16].AsMemo     := vXml13;
    DMNFe.ZQuery2.Params[17].AsMemo     := vXml14;
    DMNFe.ZQuery2.Params[18].AsMemo     := vXml15;
    DMNFe.ZQuery2.Params[19].AsMemo     := vXml16;
    DMNFe.ZQuery2.Params[20].AsMemo     := vXml17;
    DMNFe.ZQuery2.Params[21].AsMemo     := vXml18;
    DMNFe.ZQuery2.Params[22].AsMemo     := vXml19;
    DMNFe.ZQuery2.Params[23].AsMemo     := vXml20;
    DMNFe.ZQuery2.Params[24].AsMemo     := vXml21;
    DMNFe.ZQuery2.Params[25].AsMemo     := vXml22;
    DMNFe.ZQuery2.Params[26].AsMemo     := vXml23;
    DMNFe.ZQuery2.Params[27].AsMemo     := vXml24;
    DMNFe.ZQuery2.Params[28].AsMemo     := vXml25;
    DMNFe.ZQuery2.Params[29].AsMemo     := vXml26;
    DMNFe.ZQuery2.Params[30].AsMemo     := vXml27;
    DMNFe.ZQuery2.Params[31].AsMemo     := vXml28;
    DMNFe.ZQuery2.Params[32].AsMemo     := vXml29;
    DMNFe.ZQuery2.Params[33].AsMemo     := vXml30;
    DMNFe.ZQuery2.Params[34].AsMemo     := vXml31;
    DMNFe.ZQuery2.Params[35].AsMemo     := vXml32;
    DMNFe.ZQuery2.Params[36].AsMemo     := vXml33;
    DMNFe.ZQuery2.Params[37].AsMemo     := vXml34;
    DMNFe.ZQuery2.Params[38].AsMemo     := vXml35;
    DMNFe.ZQuery2.Params[39].AsMemo     := vXml36;
    DMNFe.ZQuery2.Params[40].AsMemo     := vXml37;
    DMNFe.ZQuery2.Params[41].AsMemo     := vXml38;
    DMNFe.ZQuery2.Params[42].AsMemo     := vXml39;
    DMNFe.ZQuery2.Params[43].AsMemo     := vXml40;
    DMNFe.ZQuery2.Params[44].AsMemo     := vXml41;

    try
     DMNFe.ZConnection1.StartTransaction;
     DMNFe.ZQuery2.ExecSQL;
    except
     DMNFe.ZConnection1.Rollback;
     Application.Messagebox('ERRO: Não inseriu o XML da nfe no banco de dados !','Atenção!',mb_iconstop+mb_ok);
     exit;
    end;
    DMNFe.ZQuery2.Close;
   finally
    DMNFe.ZQuery2.EnableControls;
   end;

   //final - grava xml da nfe
  end;

end;

//------------------------------------------------------------------------------

procedure TFrGBNFe.BitBtn10Click(Sender: TObject);
begin
 if ( FrPar = nil ) then
   FrPar := TFrPar.Create(Application);
 FrPar.ShowModal;
 FrPar.BringToFront;
end;

procedure TFrGBNFe.BitBtn14Click(Sender: TObject);
begin
 // by Edson Lima ; 8.5.2012 ; 10:07 ; Chama a retina de backup
 if ( FrBackup = nil ) then
   FrBackup := TFrBackup.Create(Application);
 FrBackup.ShowModal;
 FrBackup.BringToFront;
end;

procedure TFrGBNFe.BitBtn13Click(Sender: TObject);
begin
 if ( FrInut = nil ) then
   FrInut := TFrInut.Create(Application);
 FrInut.ShowModal;
 FrInut.BringToFront;

 /// By Edson Lima 14.9.2012 ; 10:10 - Atualiza grade
 pAtuNFe();
end;

procedure TFrGBNFe.RadioGroup1Click(Sender: TObject);
var
  aux : string;
begin

 if not fIniPen() then exit;   // by EL 14.2.2012 -> função de coleta de dados

 aux := '';
 aux := dxSpinEdit1.text + ',' + '''' + FormatDateTime('yyyy/mm/dd', dxDateEdit1.Date) + ''''+ ',';
 aux := aux + '''' + FormatDateTime('yyyy/mm/dd', dxDateEdit2.Date) + '''' + ',';
 aux := aux + '''' + dxSpinEdit2.Text + '''' + ',';
 aux := aux + '''' + dxSpinEdit3.Text + '''' + ',';
 aux := aux + '''' + IntToStr(RadioGroup2.ItemIndex) + '''';

 pAtuNFe();

 Case RadioGroup1.ItemIndex of
 0:                                                          // by EL 14.2.2012 ->  PENDENTES
  begin
  // Desabilita os botõesde envio
  GroupBox9.Enabled    := True;
  RadioButton1.Enabled := True;
  RadioButton3.Enabled := True;
  RadioButton1.Checked := True;
  RadioButton3.Checked := False;
  BitBtn2.Enabled      := True;
  Btn1.Enabled         := True;
  BitBtn11.Enabled     := False;
  BitBtn9.Enabled      := False;
  BitBtn8.Enabled      := True;
  BitBtn7.Enabled      := False;
  BitBtn6.Enabled      := False;
  BitBtn5.Enabled      := True;
  BitBtn4.Enabled      := True;
  BitBtn3.Enabled      := True;
  BitBtn13.Enabled     := True;
  dxSpinEdit2.Enabled  := False;
  dxSpinEdit3.Enabled  := False;
  dxDateEdit1.Enabled  := False;
  dxDateEdit2.Enabled  := False;
  Panel10.Caption      := 'P E N D E N T E S  -  N O R M A L';
  dxTLPend.BringToFront;
  end;
 1:
  begin
   // Desabilita os botõesde envio
   GroupBox9.Enabled    := False;
   RadioButton1.Enabled := True;
   RadioButton3.Enabled := True;
   RadioButton1.Checked := False;
   RadioButton3.Checked := True;
   BitBtn2.Enabled      := True;
   Btn1.Enabled         := True;
   BitBtn11.Enabled     := False;
   BitBtn9.Enabled      := True;
   BitBtn8.Enabled      := True;
   BitBtn7.Enabled      := False;
   BitBtn6.Enabled      := False;
   BitBtn5.Enabled      := True;
   BitBtn4.Enabled      := True;
   BitBtn3.Enabled      := True;
   BitBtn13.Enabled     := True;
   dxSpinEdit2.Enabled  := False;
   dxSpinEdit3.Enabled  := False;
   dxDateEdit1.Enabled  := False;
   dxDateEdit2.Enabled  := False;
   Panel10.Caption      := 'P E N D E N T E S  -  C O N T I N G Ê N C I A S';
   dxTLCont.BringToFront;
  end;
 2:
  begin
   // Desabilita os botõesde envio
   GroupBox9.Enabled    := False;
   RadioButton1.Enabled := False;
   RadioButton3.Enabled := False;
   BitBtn2.Enabled      := False;
   Btn1.Enabled         := False;
   BitBtn11.Enabled     := True;
   BitBtn9.Enabled      := True;
   BitBtn8.Enabled      := True;
   BitBtn7.Enabled      := True;
   BitBtn6.Enabled      := True;
   BitBtn5.Enabled      := True;
   BitBtn4.Enabled      := True;
   BitBtn3.Enabled      := True;
   BitBtn13.Enabled     := True;
   dxSpinEdit2.Enabled  := True;
   dxSpinEdit3.Enabled  := True;
   dxDateEdit1.Enabled  := True;
   dxDateEdit2.Enabled  := True;
   Panel10.Caption      := 'T R A N S M I T I D A S';
   dxTLTrans.BringToFront;
  end;
 3:
  begin
   // Desabilita os botõesde envio
   GroupBox9.Enabled    := False;
   RadioButton1.Enabled := False;
   RadioButton3.Enabled := False;
   BitBtn2.Enabled      := False;
   Btn1.Enabled         := False;
   BitBtn11.Enabled     := False;
   BitBtn9.Enabled      := False;
   BitBtn8.Enabled      := False;
   BitBtn7.Enabled      := False;
   BitBtn6.Enabled      := False;
   BitBtn5.Enabled      := True;
   BitBtn4.Enabled      := True;
   BitBtn3.Enabled      := True;
   BitBtn13.Enabled     := True;
   dxSpinEdit2.Enabled  := True;
   dxSpinEdit3.Enabled  := True;
   dxDateEdit1.Enabled  := False;
   dxDateEdit2.Enabled  := False;
   Panel10.Caption := 'D E N E G A D A S';
   dxTLDeneg.BringToFront;
  end;
 4:
  begin
   // Desabilita os botõesde envio
   GroupBox9.Enabled    := False;
   RadioButton1.Enabled := False;
   RadioButton3.Enabled := False;
   BitBtn2.Enabled      := False;
   Btn1.Enabled         := False;
   BitBtn11.Enabled     := False;
   BitBtn9.Enabled      := False;
   BitBtn8.Enabled      := False;
   BitBtn7.Enabled      := False;
   BitBtn6.Enabled      := True;
   BitBtn5.Enabled      := True;
   BitBtn4.Enabled      := True;
   BitBtn3.Enabled      := True;
   BitBtn13.Enabled     := True;
   dxSpinEdit2.Enabled  := True;
   dxSpinEdit3.Enabled  := True;
   dxDateEdit1.Enabled  := True;
   dxDateEdit2.Enabled  := True;
   Panel10.Caption := 'C A N C E L A D A S';
   dxTLCanc.BringToFront;
  end;
 5:
  begin
   // Desabilita os botõesde envio
   GroupBox9.Enabled    := False;
   RadioButton1.Enabled := False;
   RadioButton3.Enabled := False;
   BitBtn2.Enabled      := False;
   Btn1.Enabled         := False;
   BitBtn11.Enabled     := False;
   BitBtn9.Enabled      := False;
   BitBtn8.Enabled      := False;
   BitBtn7.Enabled      := False;
   BitBtn6.Enabled      := False;
   BitBtn5.Enabled      := True;
   BitBtn4.Enabled      := True;
   BitBtn3.Enabled      := True;
   BitBtn13.Enabled     := True;
   dxSpinEdit2.Enabled  := False;
   dxSpinEdit3.Enabled  := False;
   dxDateEdit1.Enabled  := False;
   dxDateEdit2.Enabled  := False;
   Panel10.Caption := 'I N U T I L I Z A D A S';
   dxTLInut.BringToFront;
  end;
 end;

 // Tratamento do nível de acesso, passado pelo Gerpa
 case StrToInt(gNivel) of
  0:
   begin
    { Esse nível deixa liberado tudo no GBNFe - Acesso Total                   }
   end;

  1:
   begin
    { Este nível inibe (deixa invisível) o botão do MDe                        }

    BitBtn16.Visible                        := False;
   end;

  2:
   begin
   end;

  3:
   begin
   end;

  4:
   begin
    { Este Libera somente o MDe - Quando informado entra direto na janela do
      MDe maximizada                                                           }

    PopupMenu2.Items[1].Enabled             := False;
    BitBtn1.Enabled                         := False;
    BitBtn2.Enabled                         := False;
    Btn1.Enabled                            := False;
    BitBtn3.Enabled                         := False;
    BitBtn4.Enabled                         := False;
    BitBtn5.Enabled                         := False;
    BitBtn6.Enabled                         := False;
    BitBtn7.Enabled                         := False;
    BitBtn8.Enabled                         := False;
    BitBtn9.Enabled                         := False;
    BitBtn10.Enabled                        := False;
    BitBtn11.Enabled                        := False;
    BitBtn13.Enabled                        := False;
    BitBtn14.Enabled                        := False;
    BitBtn15.Enabled                        := False;
    BitBtn16.Enabled                        := True;
    RadioButton1.Enabled                    := False;
    GroupBox9.Enabled                       := False;
   end;

  5:
   begin
    { Quando expecificado não verifica as NFe selecionadas que estão em
      contigência e as já enviadas ha mais de um dia para seleciona            }

   end;

  6..9:
   begin
    { Livre }

   end;

 else
   begin
    { Livre }

   end;
 end;

end;

procedure TFrGBNFe.FormCreate(Sender: TObject);
var
 i, x              : integer;
 lista             : Tstringlist;
 data_web,
 data_local,
 path_local,
 path,
 arq_servidor      : string;

begin

 //-----------------------------------------------------------------------------
 // ROTINA DE ATUALIZAÇÃO
 //-----------------------------------------------------------------------------

 if ( gAtualiza ) then
  begin
   if ( InternetCheckConnection('http://www.google.com.br/', 1, 0) ) then
    begin

     arq_servidor := ExtractFileName(Application.ExeName);                          // nome do arquivo e extensão atualizado no servidor
     path         := ExtractFilePath(Application.ExeName);                          // variável com o caminho do exe.
     path_local   := ExtractFilePath(Application.ExeName) + arq_servidor;           // colocar na variavel o caminho do exe da applicação

     //-----------------------------------------------------------------------------
     //fazer conexão com o seu servidor ftp onde se encontra o exe atualizado

     IdFTP1.Host     := 'ftp.casadarocaagrop.com.br';                             // host do servidor
     IdFTP1.Username := 'casadaroca1';                                            // login da conta ftp
     IdFTP1.Password := 'nybhg+ne20';                                             // senha da conta ftp
     IdFTP1.Port     := 21;                                                       // porta
     IdFTP1.Passive  := false;                                                    // 'True' se usar proxy
     try
      IdFTP1.Connect;                                                             // conectar ao servidot ftp
      IdFTP1.ChangeDir('/GB/AtualizacaoSoftware/AtualizacaoGeral/AtuNFe');        // apontar para o diretorio do ftp
     except
      IdFtp1.Disconnect;
     end;

     if ( IdFTP1.Connected = true ) then                                          // verifica se esta conectado ao servidor ftp
      begin

       lista         := TStringList.Create;
       lista.Add('ok');
       lista.Clear;
       IdFTP1.List( lista, arq_servidor, true );                                  // cria a lista do arquivo do diretorio apontado
       IdFTP1.List(nil);

       for x := 0 to IdFTP1.DirectoryListing.Count -1 do
        begin
         if ( UpperCase(arq_servidor) = UpperCase(IdFTP1.DirectoryListing.Items[x].FileName) ) then
          begin
           data_web      := FormatDateTime( 'dd/mm/yyyy HH:mm:ss', IdFTP1.DirectoryListing.Items[x].ModifiedDate ); // adiciona data do arquivo do servidor ftp a variavel
          end;
        end;

       data_local    := FormatDateTime( 'dd/mm/yyyy HH:mm:ss', FileDateToDateTime(FileAge(path_local)));        // adiciona data do arquivo local a variavel
       FreeAndNil(Lista);                                                           // finaliza o stringlist
       IdFTP1.Disconnect;                                                           // disconecta do servidor ftp

       if ( Trim(data_web) = '' ) then
        data_web := data_local;

       if ( (StrToDateTime(data_web)) > (StrToDateTime(data_local)) ) then          // Aqui se compara os valores das datas dos arquivos
        begin

         // Verifica se o atualizador existe
         if ( FilesExists(pchar(ExtractFilePath(Application.ExeName) + 'AtuNFe.exe')) ) then
          begin

           if Application.MessageBox( 'Existe nova versão deste aplicativo para atualizar!' + chr(13) +
                                      'Gostaria de executar esse procedimento agora?',
                                      'Atualização: - GB -', MB_ICONQUESTION + MB_YESNO ) = IdYes then
            begin

             // Chama o AtuNFe.Exe e envia os parêmetros recebidos do Gerpa
             WinExec(pchar( ExtractFilePath(Application.ExeName) + 'AtuNFe.exe' +
                            ' /developed_gb_informática_ltda' +
                            ' /' + gCodEmp +
                            ' /' + gUsu +
                            ' /' + gNivel +
                            ' /' + gInstancias +
                            ' /' + gExpress +
                            ' /' + gNNF +
                            ' /' + gOpcao + chr(0) +
                            ' /' + arq_servidor +
                            ' /' + path ),SW_SHOWNORMAL);                             // executa o aplicativo que fara o download
             Application.Terminate;                                                   //finalza applicaçao para que seja feita a substituicao do aplicativo

            end;

          end;

        end;

      end;

    end;
  end;

 //-----------------------------------------------------------------------------

 // Seta caminho do executável
 gCamExe := ExtractFilePath(Application.ExeName);  // Pega o caminho do executavel GBNFe independente de quem o chamou

 // Seta caminho padão
 gCamPad := gCamExe;
 x       := 0;
 for i := Length(gCamPad) - 1 downto 0 do
  if gCamPad[i] = '\' then
   begin
    x := (x + 1);
    gCamPad := Copy(gCamPad, 1, (i-1));
    if x > 1 then
     Break;
   end;
 gCamPad := gCamPad + '\';

 // Atribui cor para WBResposta...
 TWebControl(WBResposta).ParentColor := False;
 TWebControl(WBResposta).Color       := clInfoBk;

 // By EL 9.2.2012
 // Estabelece tamanho do formulario principal
 FrGBNFe.Height := 624;
 FrGBNFe.Width  := 958;

 DMNFe.ZConnection1.Connected := true;

 dxDateEdit1.Date := date();
 dxDateEdit2.Date := date();
end;

procedure TFrGBNFe.ACBrNFe1GerarLog(const Mensagem: String);
begin
 memoLog.Lines.Add(Mensagem);
end;

procedure TFrGBNFe.ACBrNFe1StatusChange(Sender: TObject);
begin
 case ACBrNFe1.Status of
  stIdle :
   begin
    if ( frmStatus <> nil ) then
      frmStatus.Hide;
   end;
  stNFeStatusServico :
   begin
    if ( frmStatus = nil ) then
      frmStatus := TfrmStatus.Create(Application);
    frmStatus.lblStatus.Caption := 'Verificando Status do servico...';
    frmStatus.Show;
    Application.ProcessMessages;
    frmStatus.BringToFront;
   end;
  stNFeRecepcao :
   begin
    if ( frmStatus = nil ) then
      frmStatus := TfrmStatus.Create(Application);
    frmStatus.lblStatus.Caption := 'Enviando dados da NFe...';
    frmStatus.Show;
    Application.ProcessMessages;
    frmStatus.BringToFront;
   end;
  stNfeRetRecepcao :
   begin
    if ( frmStatus = nil ) then
      frmStatus := TfrmStatus.Create(Application);
    frmStatus.lblStatus.Caption := 'Recebendo dados da NFe...';
    frmStatus.Show;
    Application.ProcessMessages;
    frmStatus.BringToFront;
   end;
  stNfeConsulta :
   begin
    if ( frmStatus = nil ) then
      frmStatus := TfrmStatus.Create(Application);
    frmStatus.lblStatus.Caption := 'Consultando NFe...';
    frmStatus.Show;
    Application.ProcessMessages;
    frmStatus.BringToFront;
   end;
  stNfeCancelamento :
   begin
    if ( frmStatus = nil ) then
      frmStatus := TfrmStatus.Create(Application);
    frmStatus.lblStatus.Caption := 'Enviando cancelamento de NFe...';
    frmStatus.Show;
    Application.ProcessMessages;
    frmStatus.BringToFront;
   end;
  stNfeInutilizacao :
   begin
    if ( frmStatus = nil ) then
      frmStatus := TfrmStatus.Create(Application);
    frmStatus.lblStatus.Caption := 'Enviando pedido de Inutilização...';
    frmStatus.Show;
    Application.ProcessMessages;
    frmStatus.BringToFront;
   end;
  stNFeRecibo :
   begin
    if ( frmStatus = nil ) then
      frmStatus := TfrmStatus.Create(Application);
    frmStatus.lblStatus.Caption := 'Consultando Recibo de Lote...';
    frmStatus.Show;
    Application.ProcessMessages;
    frmStatus.BringToFront;
   end;
  stNFeCadastro :
   begin
    if ( frmStatus = nil ) then
      frmStatus := TfrmStatus.Create(Application);
    frmStatus.lblStatus.Caption := 'Consultando Cadastro...';
    frmStatus.Show;
    Application.ProcessMessages;
    frmStatus.BringToFront;
   end;
  stNFeEmail :
   begin
    if ( frmStatus = nil ) then
      frmStatus := TfrmStatus.Create(Application);
    frmStatus.lblStatus.Caption := 'Enviando Email...';
    frmStatus.Show;
    Application.ProcessMessages;
    frmStatus.BringToFront;
   end;
  stNFeCCe :
   begin
    if ( frmStatus = nil ) then
      frmStatus := TfrmStatus.Create(Application);
    frmStatus.lblStatus.Caption := 'Enviando CCe...';
    frmStatus.Show;
    Application.ProcessMessages;
    frmStatus.BringToFront;
   end;
  stNFeEvento :
   begin
    if ( frmStatus = nil ) then
      frmStatus := TfrmStatus.Create(Application);
    frmStatus.lblStatus.Caption := 'Enviando Eventos...';
    frmStatus.Show;
    Application.ProcessMessages;
    frmStatus.BringToFront;
   end;
  stConsNFeDest :
   begin
    if ( frmStatus = nil ) then
      frmStatus := TfrmStatus.Create(Application);
    frmStatus.lblStatus.Caption := 'Consulta NFe Destinada...';
    frmStatus.Show;
    Application.ProcessMessages;
    frmStatus.BringToFront;
   end;
  stDownloadNFe :
   begin
    if ( frmStatus = nil ) then
      frmStatus := TfrmStatus.Create(Application);
    frmStatus.lblStatus.Caption := 'Download da NFe...';
    frmStatus.Show;
    Application.ProcessMessages;
    frmStatus.BringToFront;
   end;
  stAdmCSCNFCe :
   begin
    if ( frmStatus = nil ) then
      frmStatus := TfrmStatus.Create(Application);
    frmStatus.lblStatus.Caption := 'Administrando CSC NFCe...'; // ?
    frmStatus.Show;
    Application.ProcessMessages;
    frmStatus.BringToFront;
   end;
  stDistDFeInt :
   begin
    if ( frmStatus = nil ) then
      frmStatus := TfrmStatus.Create(Application);
    frmStatus.lblStatus.Caption := 'Destinando DFe Int...'; // ?
    frmStatus.Show;
    Application.ProcessMessages;
    frmStatus.BringToFront;
   end;
 end;
 Application.ProcessMessages;
end;

procedure TFrGBNFe.BitBtn1Click(Sender: TObject);
begin
 PageControl1.TabIndex := 2;

 ACBrNFe1.WebServices.StatusServico.Executar;

 //vMens := 'Status: ' + vartostr(ACBrNFe1.WebServices.StatusServico.cStat) + '- Motivo: ' +  vartostr(ACBrNFe1.WebServices.StatusServico.xMotivo);

 MemoResp.Lines.Text   := UTF8Encode(ACBrNFe1.WebServices.StatusServico.RetWS);
 memoRespWS.Lines.Text := UTF8Encode(ACBrNFe1.WebServices.StatusServico.RetornoWS);
 LoadXML(MemoResp, WBResposta);

 memoLog.Clear;
 MemoLog.Lines.Add('');
 MemoLog.Lines.Add('* -- STATUS - NFe & NFCe -- *');
 MemoLog.Lines.Add('Tipo de Ambiente: '+ TpAmbToStr(ACBrNFe1.WebServices.StatusServico.TpAmb));
 MemoLog.Lines.Add('Versão do Aplicativo: '+ ACBrNFe1.WebServices.StatusServico.verAplic);
 MemoLog.Lines.Add('Código do Status: '+ IntToStr(ACBrNFe1.WebServices.StatusServico.cStat));
 MemoLog.Lines.Add('Código da UF: '+ IntToStr(ACBrNFe1.WebServices.StatusServico.cUF));
 MemoLog.Lines.Add('Descrição: '+ ACBrNFe1.WebServices.StatusServico.xMotivo);

 /// By Edson Lima 14.9.2012 ; 10:10 - Atualiza grade
 pAtuNFeT();
end;

procedure TFrGBNFe.LoadXML(MyMemo: TMemo; MyWebBrowser: TWebBrowser);
begin
 try
  MyMemo.Lines.SaveToFile(gCamLog + 'temp.xml');
   MyWebBrowser.Navigate(gCamLog + 'temp.xml');
 except
 end;
end;

procedure TFrGBNFe.LoadXML1(MyMemo: TMemo; MyWebBrowser: TWebBrowser);
var
 xAux : string;
begin
 if FileExists(gCamLog + gNomXML) then
  begin
   if (gAnoMes = '') then
    begin
     if MessageDlg('Arquivo XML [' + gNomXML + '] já existe ! Deseja Salvar? ', mtConfirmation, [mbYes, mbNo], 0) = mrYes then
      begin
       // Salva os arquivos no log
       MyMemo.Lines.SaveToFile(gCamLog + gNomXML);
       MyWebBrowser.Navigate(gCamLog + gNomXML);
     end;
    end
   else
    begin
     // Diretórios e arquivos no seu ano e mês correto
     xAux := trim(gCamXml) +                                                    // Caminho do arquivo log (gCamXml contém o caminho padrão) ex: c:\Sistemas\GBNFe\Arq\Emp001\Xml\
             gAnoMes +                                                          // Ano, mês
             '\';
     if not DirectoryExists(xAux) then
      CreateDir(xAux);
     xAux := xAux + 'NFe\';                                                     // NFe
     if not DirectoryExists(xAux) then
      CreateDir(xAux);

     // Salva os arquivos no xml correto
     MyMemo.Lines.SaveToFile(xAux + gNomXML);
     MyWebBrowser.Navigate(xAux + gNomXML);
    end;
  end
 else
  begin
   if (gAnoMes = '') then
    begin
     MyMemo.Lines.SaveToFile(gCamLog + gNomXML);
     MyWebBrowser.Navigate(gCamLog + gNomXML);
    end
   else
    begin
     // Diretórios e arquivos no seu ano e mês correto
     xAux := trim(gCamXml) +                                                    // Caminho do arquivo log (gCamXml contém o caminho padrão) ex: c:\Sistemas\GBNFe\Arq\Emp001\Xml\
             gAnoMes +                                                          // Ano, mês
             '\';
     if not DirectoryExists(xAux) then
      CreateDir(xAux);
     xAux := xAux + 'NFe\';                                                     // NFe
     if not DirectoryExists(xAux) then
      CreateDir(xAux);

     // Salva os arquivos no xml correto
     MyMemo.Lines.SaveToFile(xAux + gNomXML);
     MyWebBrowser.Navigate(xAux + gNomXML);
    end;
  end;
end;

procedure TFrGBNFe.LoadXML2(MyMemo: TMemo; MyWebBrowser: TWebBrowser);
begin
 try
  MyMemo.Lines.SaveToFile(gCamLog + 'xml-temp.xml');
  MyWebBrowser.Navigate(gCamLog + 'xml-temp.xml');
 except
 end;
end;

procedure TFrGBNFe.FormKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
var
 Direction : Integer;
begin
 // Altere a propriedade do KeyPreview do Form pra true
 if not (ActiveControl is  TDbGrid) then
  begin
   Direction := -1;
   Case Key of
    VK_NEXT, VK_RETURN : Direction := 0;
    VK_PRIOR	 : Direction := 1;
    VK_ESCAPE : Close;
   end;
   if Direction <> -1 then
    begin
    Perform(WM_NEXTDLGCTL, Direction, 0);
    key := 0;
    end;
  end;
end;

procedure TFrGBNFe.Timer1Timer(Sender: TObject);
begin

 if ((not gVerCon) and (not gVerEpe)) then
  begin
   Timer1.Enabled := False;
   VerifCert();                                                                 // by Edson Lima ; 2014-11-11T1632 ; Verifica o vencimento do certificado digital

   // Verifica o caminho do arquivo da logomarca e da base de dados
   //if not FileExists(PChar(FrPar.edtLogoMarca.Text)) then
   // Application.Messagebox('Logomarca não encontrada, verifique o caminho da logomarca' + Chr(13) +
   //                        'e do servidor da base de dados em parâmetros!','Informação',MB_ICONINFORMATION+mb_ok);

   Timer1.Enabled := True;
  end;

 // By EL 9.2.2012 - Display de mensagens na barra de status
 StatusBar1.Panels[3].Text := 'Aquarde, Sele ' + gUsu;                                       // By EL 9.2.2012 - Mostra usuário no status bar

 gCntTmp := (gCntTmp + Timer1.Interval);

 if ((gNivel <> '4') and (gNivel <> '5')) then
  begin
   //*****************************************************************************
   // Rotina que verifica notas de contingência em fsda
   // by Edson ; 21/6/2012 ; 14:12
   //*****************************************************************************
   if gExpress <> '1' then
    begin
     if not gVerCon then
      begin
       Timer1.Enabled := False;
       gDatConA := Date();
       gDatConB := Date();

       // Filtra os registro por data ; by Edson Lima ;  2015-5-25T0857
       //StatusBar1.Panels[1].Text := ' ' + 'Aguarde!';
       DMNFe.ZQuery15.Close;
        DMNFe.ZQuery15.ParamByName('DatCon').AsString  := FormatDateTime('yyyy/mm/dd', gDatConB);
        DMNFe.ZQuery15.ParamByName('CodEmp').AsInteger := dxSpinEdit1.IntValue;
        DMNFe.ZQuery15.ParamByName('Situac').AsString  := 'FSDA';
       DMNFe.ZQuery15.Open;
       //StatusBar1.Panels[1].Text := '';

       if not DMNFe.ZQuery15.IsEmpty then
        begin
         if MessageDlg('Atenção, pendências para envio em contingência ' + 'FSDA,' + chr(13) +
                       'Lembre-se que pela legislação temos 7 dias p/transmitir !' + chr(13) + chr(13) +
                       'GOSTARIA DE IR PARA O ENVIO DESSA PENDÊNCIA AGORA ?', mtConfirmation, [mbYes, mbNo], 0) = mrYes then
          begin
           gVerCon := True;
           RadioGroup1.ItemIndex := 1;  // Contigência (FSDA ou OFF-LINE)
           BitBtn2Click(Sender);
           MarcaDesmarcaTodos1Click(Sender);
           dxTLCont.SetFocus;
           Timer1.Enabled := True;
           gVerCon := True;
           gVerEpe := True;
           exit;
          end
         else
          gVerCon := True;
        end;
       Timer1.Enabled := True;
      end;
     if not gVerEpe then
      begin
       Timer1.Enabled := False;
       gDatConA := Date();
       gDatConB := Date();

       // Filtra os registro por data ; by Edson Lima ;  2015-5-25T0857
       //StatusBar1.Panels[1].Text := ' ' + 'Aguarde!';
       DMNFe.ZQuery15.Close;
        DMNFe.ZQuery15.ParamByName('DatCon').AsString  := FormatDateTime('yyyy/mm/dd', gDatConB);
        DMNFe.ZQuery15.ParamByName('CodEmp').AsInteger := dxSpinEdit1.IntValue;
        DMNFe.ZQuery15.ParamByName('Situac').AsString  := 'OFFL';
       DMNFe.ZQuery15.Open;
       //StatusBar1.Panels[1].Text := '';

       if not DMNFe.ZQuery15.IsEmpty then
        begin
         if MessageDlg('Atenção, pendências para envio em contingência ' + 'OFF-LINE,' + chr(13) +
                       'Lembre-se que pela legislação temos 24 hoas p/transmitir !' + chr(13) + chr(13) +
                       'GOSTARIA DE IR PARA O ENVIO DESSA PENDÊNCIA AGORA ?', mtConfirmation, [mbYes, mbNo], 0) = mrYes then
          begin
           gVerEpe := True;
           RadioGroup1.ItemIndex := 1;  // Contigência (FSDA ou OFF-LINE)
           BitBtn2Click(Sender);
           MarcaDesmarcaTodos1Click(Sender);
           dxTLCont.SetFocus;
           Timer1.Enabled := True;
           gVerEpe := True;
           gVerCon := True;
           exit;
          end
         else
          gVerEpe := True;
        end;
       Timer1.Enabled := True;
      end;
    end;
   //*****************************************************************************

   //*****************************************************************************
   // Rotina que verifica notas de ENVI pendentes pra serem atualizadas
   // by Edson ; 22/6/2012 ; 10:23
   //*****************************************************************************
   if gExpress <> '1' then
    begin
     if not gVerCon then
      begin
       Timer1.Enabled := False;
       gDatConA := Date();
       gDatConB := Date();

       // Filtra os registro por data ; by Edson Lima ;  2015-5-25T0857
       //StatusBar1.Panels[1].Text := ' ' + 'Aguarde!';
       DMNFe.ZQuery15.Close;
        DMNFe.ZQuery15.ParamByName('DatCon').AsString  := FormatDateTime('yyyy/mm/dd', gDatConB);
        DMNFe.ZQuery15.ParamByName('CodEmp').AsInteger := dxSpinEdit1.IntValue;
        DMNFe.ZQuery15.ParamByName('Situac').AsString  := '';
       DMNFe.ZQuery15.Open;
       //StatusBar1.Panels[1].Text := '';

       if not DMNFe.ZQuery15.IsEmpty then
        begin

         if MessageDlg('Atenção, existe pendência de nota emitidas com mais' + chr(13) +
                       'de um dia, envie assim possível, caso de duplicidade de' + chr(13) +
                       'nota, é só CONSULTAR! Lembre-se temos 10 dias p/enviar!' + chr(13) + chr(13) +
                       'GOSTARIA DE IR PARA O ENVIO DESSA PENDENCIA AGORA ?', mtConfirmation, [mbYes, mbNo], 0) = mrYes then
          SelecionarTudo1Click(Sender);

         dxTLPend.SetFocus;

        end;

       gVerCon := True;
       Timer1.Enabled := True;
      end;
    end;
   //***************************************************************************

  end;

end;

procedure TFrGBNFe.Destinatrio1Click(Sender: TObject);
begin

end;

//------------------------------------------------------------------------------
//
// Modify By Edson 10.2.2012t09:14
// Procedure:    GravaConfiguração
// Description:  Grava dados no arquivo ini de parâmetros
//
//------------------------------------------------------------------------------

procedure TFrGBNFe.GravarConfiguracao;
begin
 //-----------------------------------------------------------------------------
 // Nova forma de ler e gravar os dados, foi modificado o local dos dados de
 // configuração o GBNFe.ini que passa apartir da versão 3.12.9.25 a ser gravado
 // no banco de dados nfe na tabela emitente
 // by Edson Lima ; 11-9-2012 ; 17:22
 //-----------------------------------------------------------------------------
 try
  DMNFe.ZQuery4.DisableControls;
  DMNFe.ZQuery4.Close;
  DMNFe.ZQuery4.SQL.Clear;
  DMNFe.ZQuery4.SQL.Add( 'update emitente set                               ' );
  DMNFe.ZQuery4.SQL.Add( '  Certificado_NumSerie   = :Certificado_NumSerie, ' );
  DMNFe.ZQuery4.SQL.Add( '  Certificado_NumSerie2  = :Certificado_NumSerie2,' );
  DMNFe.ZQuery4.SQL.Add( '  CSC                    = :CSC,                  ' );
  DMNFe.ZQuery4.SQL.Add( '  IdCSC                  = :IdCSC,                ' );
  DMNFe.ZQuery4.SQL.Add( '  DANFE_QtdCopias        = :DANFE_QtdCopias,      ' );
  DMNFe.ZQuery4.SQL.Add( '  DANFE_QtdCopNFCe       = :DANFE_QtdCopNFCe,     ' );
  DMNFe.ZQuery4.SQL.Add( '  DANFE_Visualiza        = :DANFE_Visualiza,      ' );
  DMNFe.ZQuery4.SQL.Add( '  DANFE_HorariodeVerao   = :DANFE_HorariodeVerao, ' );
  DMNFe.ZQuery4.SQL.Add( '  DANFE_FusoHorario      = :DANFE_FusoHorario,    ' );
  DMNFe.ZQuery4.SQL.Add( '  DANFE_UsaHorarioDF     = :DANFE_UsaHorarioDF,   ' );
  DMNFe.ZQuery4.SQL.Add( '  DANFE_ImportaTxt       = :DANFE_ImportaTxt,     ' );
  DMNFe.ZQuery4.SQL.Add( '  DANFE_LogoMarca        = :DANFE_LogoMarca,      ' );
  DMNFe.ZQuery4.SQL.Add( '  DANFE_LocSRV           = :DANFE_LocSRV,         ' );
  DMNFe.ZQuery4.SQL.Add( '  DANFE_CAMSRV           = :DANFE_CAMSRV,         ' );
  DMNFe.ZQuery4.SQL.Add( '  DANFE_ImpNFe           = :DANFE_ImpNFe,         ' );
  DMNFe.ZQuery4.SQL.Add( '  DANFE_ImpNFCe          = :DANFE_ImpNFCe,        ' );
  DMNFe.ZQuery4.SQL.Add( '  DANFE_ExibeFatura      = :DANFE_ExibeFatura,    ' );
  DMNFe.ZQuery4.SQL.Add( '  DANFE_ExpandiLogo      = :DANFE_ExpandiLogo,    ' );
  DMNFe.ZQuery4.SQL.Add( '  DANFE_TipoDANF         = :DANFE_TipoDANF   ,    ' );
  DMNFe.ZQuery4.SQL.Add( '  DANFE_TipoDANFCE       = :DANFE_TipoDANFCE,     ' );
  DMNFe.ZQuery4.SQL.Add( '  DANFE_EdEmail          = :DANFE_EdEmail,        ' );
  DMNFe.ZQuery4.SQL.Add( '  Web_Ambiente           = :Web_Ambiente,         ' );
  DMNFe.ZQuery4.SQL.Add( '  Web_Visualizar         = :Web_Visualizar,       ' );
  DMNFe.ZQuery4.SQL.Add( '  Proxy_Host             = :Proxy_Host,           ' );
  DMNFe.ZQuery4.SQL.Add( '  Proxy_Porta            = :Proxy_Porta,          ' );
  DMNFe.ZQuery4.SQL.Add( '  Proxy_User             = :Proxy_User,           ' );
  DMNFe.ZQuery4.SQL.Add( '  Proxy_Pass             = :Proxy_Pass,           ' );
  DMNFe.ZQuery4.SQL.Add( '  Email_NEeMAIL          = :Email_NEeMAIL,        ' );
  DMNFe.ZQuery4.SQL.Add( '  Email_Host             = :Email_Host,           ' );
  DMNFe.ZQuery4.SQL.Add( '  Email_Port             = :Email_Port,           ' );
  DMNFe.ZQuery4.SQL.Add( '  Email_User             = :Email_User,           ' );
  DMNFe.ZQuery4.SQL.Add( '  Email_Pass             = :Email_Pass,           ' );
  DMNFe.ZQuery4.SQL.Add( '  Email_SSL              = :Email_SSL,            ' );
  DMNFe.ZQuery4.SQL.Add( '  Email_Assunto          = :Email_Assunto,        ' );
  DMNFe.ZQuery4.SQL.Add( '  Email_Assunto_Canc     = :Email_Assunto_Canc,   ' );
  DMNFe.ZQuery4.SQL.Add( '  Email_Assunto_CCe      = :Email_Assunto_CCe,    ' );
  DMNFe.ZQuery4.SQL.Add( '  Email_CC               = :Email_CC,             ' );
  DMNFe.ZQuery4.SQL.Add( '  Email_Mensagem         = :Email_Mensagem,       ' );
  DMNFe.ZQuery4.SQL.Add( '  OUTROS_ExcTmp          = :OUTROS_ExcTmp,        ' );
  DMNFe.ZQuery4.SQL.Add( '  OUTROS_DtIni           = :OUTROS_DtIni          ' );
  DMNFe.ZQuery4.SQL.Add( ' where codigo_loja = :codigo_loja                 ' );

  // Mosta qual certificado o usuário está usando
  if FileExists(gCamCert + 'GBNFe.ini') then
   begin
    LerIni();
    if ((gPSCert = 1) and (StrToInt(gCodEmp) = gCEIni)) then
     begin
      FrPar.CheckBox6.Checked := true;
      FrPar.CheckBox7.Checked := false;
     end;
    if ((gPSCert = 2) and (StrToInt(gCodEmp) = gCEIni)) then
     begin
      FrPar.CheckBox6.Checked := false;
      FrPar.CheckBox7.Checked := true;
     end;
   end;

  DMNFe.ZQuery4.ParamByName('Certificado_NumSerie').AsString     := FrPar.edtNumSerie.Text;
  DMNFe.ZQuery4.ParamByName('Certificado_NumSerie2').AsString    := FrPar.edtNumSerie2.Text;
  DMNFe.ZQuery4.ParamByName('CSC').AsString                      := FrPar.edtCSC.Text;
  DMNFe.ZQuery4.ParamByName('IdCSC').AsString                    := FrPar.edtIdCSC.Text;
  DMNFe.ZQuery4.ParamByName('DANFE_QtdCopias').AsInteger         := StrToInt(FrPar.ed_QtdCopNFe.Text);
  DMNFe.ZQuery4.ParamByName('DANFE_QtdCopNFCe').AsInteger        := StrToInt(FrPar.ed_QtdCopNFCe.Text);
  if FrPar.CheckBox2.Checked then
   DMNFe.ZQuery4.ParamByName('DANFE_Visualiza').AsString         := 'S'
  else
   DMNFe.ZQuery4.ParamByName('DANFE_Visualiza').AsString         := 'N';
  if FrPar.CheckBox1.Checked then
   DMNFe.ZQuery4.ParamByName('DANFE_HorariodeVerao').AsString    := 'S'
  else
   DMNFe.ZQuery4.ParamByName('DANFE_HorariodeVerao').AsString    := 'N';
  if FrPar.CheckBox3.Checked then
   DMNFe.ZQuery4.ParamByName('DANFE_FusoHorario').AsString       := 'S'
  else
   DMNFe.ZQuery4.ParamByName('DANFE_FusoHorario').AsString       := 'N';
  if FrPar.CheckBox4.Checked then
   DMNFe.ZQuery4.ParamByName('DANFE_UsaHorarioDF').AsString      := 'S'
  else
   DMNFe.ZQuery4.ParamByName('DANFE_UsaHorarioDF').AsString      := 'N';
  if FrPar.CheckBox5.Checked then
   DMNFe.ZQuery4.ParamByName('DANFE_ImportaTxt').AsString        := 'S'
  else
   DMNFe.ZQuery4.ParamByName('DANFE_ImportaTxt').AsString        := 'N';

  DMNFe.ZQuery4.ParamByName('DANFE_LogoMarca').AsString          := FrPar.edtLogoMarca.Text;

  if FrPar.ragLocSrv.ItemIndex = 0 then
   begin
    DMNFe.ZQuery4.ParamByName('DANFE_LocSRV').AsString           := 'L';
    DMNFe.ZQuery4.ParamByName('DANFE_CAMSRV').AsString           := FrPar.edtCamSrv.Text;
   end
  else
   begin
    DMNFe.ZQuery4.ParamByName('DANFE_LocSRV').AsString           := 'S';
    DMNFe.ZQuery4.ParamByName('DANFE_CAMSRV').AsString           := '';
   end;
  DMNFe.ZQuery4.ParamByName('DANFE_CAMSRV').AsString             := FrPar.edtCamSrv.Text;
  DMNFe.ZQuery4.ParamByName('DANFE_ImpNFe').AsString             := FrPar.edtImpNFe.Text;
  DMNFe.ZQuery4.ParamByName('DANFE_ImpNFCe').AsString            := FrPar.edtImpNFCe.Text;
  if FrPar.CheckBox8.Checked then
   DMNFe.ZQuery4.ParamByName('DANFE_ExibeFatura').AsString       := 'S'
  else
   DMNFe.ZQuery4.ParamByName('DANFE_ExibeFatura').AsString       := 'N';
  if FrPar.CheckBox9.Checked then
   DMNFe.ZQuery4.ParamByName('DANFE_ExpandiLogo').AsString       := 'S'
  else
   DMNFe.ZQuery4.ParamByName('DANFE_ExpandiLogo').AsString       := 'N';
  DMNFe.ZQuery4.ParamByName('DANFE_TipoDANF').AsInteger          := FrPar.cbbTipoDANF.ItemIndex;
  DMNFe.ZQuery4.ParamByName('DANFE_TipoDANFCE').AsInteger        := FrPar.cbbTipoDANFCE.ItemIndex;
  if FrPar.CheckBox10.Checked then
   DMNFe.ZQuery4.ParamByName('DANFE_EdEmail').AsString           := 'S'
  else
   DMNFe.ZQuery4.ParamByName('DANFE_EdEmail').AsString           := 'N';
  if FrPar.rgTipoAmb.ItemIndex = 0 then
   DMNFe.ZQuery4.ParamByName('Web_Ambiente').AsString            := 'P'
  else
   DMNFe.ZQuery4.ParamByName('Web_Ambiente').AsString            := 'H';
  if FrPar.ckVisualizar.Checked then
   DMNFe.ZQuery4.ParamByName('Web_Visualizar').AsString          := 'S'
  else
   DMNFe.ZQuery4.ParamByName('Web_Visualizar').AsString          := 'N';
  DMNFe.ZQuery4.ParamByName('Proxy_Host').AsString               := FrPar.edtProxyHost.Text;
  DMNFe.ZQuery4.ParamByName('Proxy_Porta').AsInteger             := StrToInt(FrPar.edtProxyPorta.Text);
  DMNFe.ZQuery4.ParamByName('Proxy_User').AsString               := FrPar.edtProxyUser.Text;
  if FrPar.edtProxySenha.Text <> '' then
   FrPar.edtProxySenha.Text  := EnDecrypt(FrPar.edtProxySenha.Text, 236);
  DMNFe.ZQuery4.ParamByName('Proxy_Pass').AsString               := FrPar.edtProxySenha.Text;
  DMNFe.ZQuery4.ParamByName('Email_NEeMAIL').AsString            := FrPar.edtNEeMail.Text;
  DMNFe.ZQuery4.ParamByName('Email_Host').AsString               := FrPar.edtSmtpHost.Text;
  DMNFe.ZQuery4.ParamByName('Email_Port').AsInteger              := StrToInt(FrPar.edtSmtpPort.Text);
  DMNFe.ZQuery4.ParamByName('Email_User').AsString               := FrPar.edtSmtpUser.Text;
  if FrPar.edtSmtpPass.Text <> '' then
   FrPar.edtSmtpPass.Text  := EnDecrypt(FrPar.edtSmtpPass.Text, 236);
  DMNFe.ZQuery4.ParamByName('Email_Pass').AsString               := FrPar.edtSmtpPass.Text;
  if FrPar.cbEmailSSL.Checked then
   DMNFe.ZQuery4.ParamByName('Email_SSL').AsString               := 'S'
  else
   DMNFe.ZQuery4.ParamByName('Email_SSL').AsString               := 'N';
  DMNFe.ZQuery4.ParamByName('Email_Assunto').AsString            := FrPar.edtEmailAssunto.Text;
  DMNFe.ZQuery4.ParamByName('Email_Assunto_Canc').AsString       := FrPar.edtEmailCancAssunto.Text;
  DMNFe.ZQuery4.ParamByName('Email_Assunto_CCe').AsString        := FrPar.edtEmailCCeAssunto.Text;
  DMNFe.ZQuery4.ParamByName('Email_CC').AsString                 := FrPar.edtEnvCC.Text;
  DMNFe.ZQuery4.ParamByName('Email_Mensagem').AsMemo             := FrPar.mmEmailMsg.Text;
  if FrPar.CheckBox.Checked then
   DMNFe.ZQuery4.ParamByName('OUTROS_ExcTmp').AsString           := 'S'
  else
   DMNFe.ZQuery4.ParamByName('OUTROS_ExcTmp').AsString           := 'N';
  DMNFe.ZQuery4.ParamByName('codigo_loja').AsString              := dxSpinEdit1.text;
  DMNFe.ZQuery4.ParamByName('OUTROS_DtIni').AsString             := FormatDateTime('yyyy/mm/dd', FrPar.dtp1.DateTime);
  try
   DMNFe.ZConnection1.StartTransaction;
   DMNFe.ZQuery4.ExecSQL;
   pAtuNFe();   // by Edson Lima ; 2013/02/26 ; 16:03 ; Atualiza Grid
  except
   DMNFe.ZConnection1.Rollback;
   Application.Messagebox('ERRO: Parâmetros não gravado !','Atenção!',MB_ICONERROR+mb_ok);
   pAtuNFe();   // by Edson Lima ; 2013/02/26 ; 16:03 ; Atualiza Grid
  end;
  DMNFe.ZQuery4.Close;
 finally
  DMNFe.ZQuery4.EnableControls;
 end;
 DMNFe.ZQuery4.Close;
 DMNFe.ZQuery4.SQL.Clear;
 DMNFe.ZQuery4.SQL.Add( 'select * from emitente where codigo_loja = ' + dxSpinEdit1.text );
 DMNFe.ZQuery4.Open;
 //------------------------------------------------------------------------
end;

//------------------------------------------------------------------------------
//
// Modify By Edson 10.2.2012t09:14
// Procedure:    LerConfiguração
// Description:  Ler os dados do arquivo ini de parâmetros
//
//------------------------------------------------------------------------------
procedure TFrGBNFe.LerConf1;
begin
 //-----------------------------------------------------------------------------
 // Nova forma de ler e gravar os dados, foi modificado o local dos dados de
 // configuração o GBNFe.ini que passa apartir da versão 3.12.9.25 a ser gravado
 // no banco de dados nfe na tabela emitente
 // by Edson Lima ; 11-9-2012 ; 17:22
 //-----------------------------------------------------------------------------
 try

  {$IFDEF ACBrNFeOpenSSL}

   FrPar.edtNumSerie.Visible  := False;
   FrPar.edtNumSerie2.Visible := False;
   FrPar.Label25.Visible      := False;
   FrPar.sbtnGetCert.Visible  := False;

  {$ELSE}

   // Mosta qual certificado o usuário está usando
   if FileExists(gCamCert + 'GBNFe.ini') then
    begin
     LerIni();
     if ((gPSCert = 1) and (StrToInt(gCodEmp) = gCEIni)) then
      begin
       FrPar.CheckBox6.Checked := true;
       FrPar.CheckBox7.Checked := false;
      end;
     if ((gPSCert = 2) and (StrToInt(gCodEmp) = gCEIni)) then
      begin
       FrPar.CheckBox6.Checked := false;
       FrPar.CheckBox7.Checked := true;
      end;
    end;

   if (DMNFe.ZQuery4['Certificado_NumSerie'] <> Null) then
    FrPar.edtNumSerie.Text       := DMNFe.ZQuery4['Certificado_NumSerie']
   else
    FrPar.edtNumSerie.Text       := '';

   if (DMNFe.ZQuery4['Certificado_NumSerie2'] <> Null) then
    FrPar.edtNumSerie2.Text      := DMNFe.ZQuery4['Certificado_NumSerie2']
   else
    FrPar.edtNumSerie2.Text      := '';

   if (DMNFe.ZQuery4['CSC'] <> Null) then
    FrPar.edtCSC.Text            := DMNFe.ZQuery4['CSC']
   else
    FrPar.edtCSC.Text            := '';

   if (DMNFe.ZQuery4['IdCSC'] <> Null) then
    FrPar.edtIdCSC.Text          := DMNFe.ZQuery4['IdCSC']
   else
    FrPar.edtIdCSC.Text          := '';

   if (DMNFe.ZQuery4['razao_social'] <> null) then
    FrPar.label3.Caption         := DMNFe.ZQuery4['razao_social']
   else
    FrPar.label3.Caption         := '';

   if (DMNFe.ZQuery4['nome_fantasia'] <> null) then
    FrPar.label5.Caption         := DMNFe.ZQuery4['nome_fantasia']
   else
    FrPar.label5.Caption         := '';

   if (DMNFe.ZQuery4['cnpj'] <> null) then
    FrPar.label7.Caption         := DMNFe.ZQuery4['cnpj']
   else
    FrPar.label7.Caption         := '';

   FrPar.Label1.Caption          := 'Informe o número de série do certificado ' +
                                    'Disponível no Internet Explorer no menu'#13 +
                                    'Ferramentas - Opções da Internet - Conteúdo ' +
                                    'Certificados - Exibir - Detalhes - Número do certificado';
  {$ENDIF}

  if (DMNFe.ZQuery4['DANFE_QtdCopias'] <> Null) then
   FrPar.ed_QtdCopNFe.Text              := IntToStr(DMNFe.ZQuery4['DANFE_QtdCopias'])
  else
   FrPar.ed_QtdCopNFe.Text              := '0';

  if (DMNFe.ZQuery4['DANFE_QtdCopNFCe'] <> Null) then
   FrPar.ed_QtdCopNFCe.Text             := IntToStr(DMNFe.ZQuery4['DANFE_QtdCopNFCe'])
  else
   FrPar.ed_QtdCopNFCe.Text             := '0';

  if (DMNFe.ZQuery4['DANFE_Visualiza'] <> Null) then
   begin
    if (DMNFe.ZQuery4['DANFE_Visualiza'] = 'S') then
     FrPar.CheckBox2.Checked     := True
    else
     FrPar.CheckBox2.Checked     := False;
   end
  else
   FrPar.CheckBox2.Checked       := True;

  if (DMNFe.ZQuery4['DANFE_HorariodeVerao'] <> Null) then
   begin
    if (DMNFe.ZQuery4['DANFE_HorariodeVerao'] = 'S') then
     FrPar.CheckBox1.Checked     := True
    else
     FrPar.CheckBox1.Checked     := False;
   end
  else
   FrPar.CheckBox1.Checked       := False;

  if (DMNFe.ZQuery4['DANFE_FusoHorario'] <> Null) then
   begin
    if (DMNFe.ZQuery4['DANFE_FusoHorario'] = 'S') then
     FrPar.CheckBox3.Checked     := True
    else
     FrPar.CheckBox3.Checked     := False;
   end
  else
   FrPar.CheckBox3.Checked       := False;

  if (DMNFe.ZQuery4['DANFE_UsaHorarioDF'] <> Null) then
   begin
    if (DMNFe.ZQuery4['DANFE_UsaHorarioDF'] = 'S') then
     FrPar.CheckBox4.Checked     := True
    else
     FrPar.CheckBox4.Checked     := False;
   end
  else
   FrPar.CheckBox4.Checked       := False;

  if (DMNFe.ZQuery4['DANFE_ImportaTxt'] <> Null) then
   begin
    if (DMNFe.ZQuery4['DANFE_ImportaTxt'] = 'S') then
     FrPar.CheckBox5.Checked     := True
    else
     FrPar.CheckBox5.Checked     := False;
   end
  else
   FrPar.CheckBox5.Checked       := False;

  if (DMNFe.ZQuery4['DANFE_LogoMarca'] <> Null) then
   FrPar.edtLogoMarca.Text       := DMNFe.ZQuery4['DANFE_LogoMarca']
  else
   FrPar.edtLogoMarca.Text       := '';

  if (DMNFe.ZQuery4['DANFE_LocSRV'] <> Null) then
   begin
    if (DMNFe.ZQuery4['DANFE_LocSRV'] = 'S') then
     FrPar.ragLocSrv.ItemIndex   := 1
    else
     FrPar.ragLocSrv.ItemIndex   := 0;
   end
  else
   FrPar.ragLocSrv.ItemIndex     := 1;

  if (DMNFe.ZQuery4['DANFE_CAMSRV'] <> Null) then
   FrPar.edtCamSrv.Text          := DMNFe.ZQuery4['DANFE_CAMSRV']
  else
   FrPar.edtCamSrv.Text          := '';

  if (DMNFe.ZQuery4['DANFE_ImpNFe'] <> Null) then
   FrPar.edtImpNFe.Text          := DMNFe.ZQuery4['DANFE_ImpNFe']
  else
   FrPar.edtImpNFe.Text          := '';

  if (DMNFe.ZQuery4['DANFE_ImpNFCe'] <> Null) then
   FrPar.edtImpNFCe.Text          := DMNFe.ZQuery4['DANFE_ImpNFCe']
  else
   FrPar.edtImpNFCe.Text          := '';

  if (DMNFe.ZQuery4['DANFE_ExibeFatura'] <> Null) then
   begin
    if (DMNFe.ZQuery4['DANFE_ExibeFatura'] = 'S') then
     FrPar.CheckBox8.Checked     := True
    else
     FrPar.CheckBox8.Checked     := False;
   end
  else
   FrPar.CheckBox8.Checked       := False;

  if (DMNFe.ZQuery4['DANFE_ExpandiLogo'] <> Null) then
   begin
    if (DMNFe.ZQuery4['DANFE_ExpandiLogo'] = 'S') then
     FrPar.CheckBox9.Checked     := True
    else
     FrPar.CheckBox9.Checked     := False;
   end
  else
   FrPar.CheckBox9.Checked       := False;

  if (DMNFe.ZQuery4['DANFE_TipoDANF'] <> Null) then
   FrPar.cbbTipoDANF.ItemIndex   := DMNFe.ZQuery4['DANFE_TipoDANF']
  else
   FrPar.cbbTipoDANF.ItemIndex   := 1;

  if (DMNFe.ZQuery4['DANFE_TipoDANFCE'] <> Null) then
   FrPar.cbbTipoDANFCE.ItemIndex := DMNFe.ZQuery4['DANFE_TipoDANFCE']
  else
   FrPar.cbbTipoDANFCE.ItemIndex := 2;

  if (DMNFe.ZQuery4['DANFE_EdEmail'] <> Null) then
   begin
    if (DMNFe.ZQuery4['DANFE_EdEmail'] = 'S') then
     FrPar.CheckBox10.Checked     := True
    else
     FrPar.CheckBox10.Checked     := False;
   end
  else
   FrPar.CheckBox10.Checked       := False;

  if (DMNFe.ZQuery4['Web_Ambiente'] <> Null) then
   begin
    if (DMNFe.ZQuery4['Web_Ambiente'] = 'H') then
     FrPar.rgTipoAmb.ItemIndex   := 1
    else
     FrPar.rgTipoAmb.ItemIndex   := 0;
   end
  else
   FrPar.rgTipoAmb.ItemIndex     := 1;
  if (DMNFe.ZQuery4['Web_Visualizar'] <> Null) then
   begin
    if (DMNFe.ZQuery4['Web_Visualizar'] = 'S') then
     FrPar.ckVisualizar.Checked  := True
    else
     FrPar.ckVisualizar.Checked  := False;
   end
  else
   FrPar.ckVisualizar.Checked    := False;
  if (DMNFe.ZQuery4['Proxy_Host'] <> Null) then
   FrPar.edtProxyHost.Text       := DMNFe.ZQuery4['Proxy_Host']
  else
   FrPar.edtProxyHost.Text       := '';
  if (DMNFe.ZQuery4['Proxy_Porta'] <> Null) then
   FrPar.edtProxyPorta.Text      := IntToStr(DMNFe.ZQuery4['Proxy_Porta'])
  else
   FrPar.edtProxyPorta.Text      := '0';
  if (DMNFe.ZQuery4['Proxy_User'] <> Null) then
   FrPar.edtProxyUser.Text       := DMNFe.ZQuery4['Proxy_User']
  else
   FrPar.edtProxyUser.Text       := '';
  if (DMNFe.ZQuery4['Proxy_Pass'] <> Null) then
   FrPar.edtProxySenha.Text      := DMNFe.ZQuery4['Proxy_Pass']
  else
   FrPar.edtProxySenha.Text      := '';
  if FrPar.edtProxySenha.Text <> '' then
   FrPar.edtProxySenha.Text      := EnDecrypt(FrPar.edtProxySenha.Text, 236);
  if (DMNFe.ZQuery4['Email_NEeMAIL'] <> Null) then
   FrPar.edtNEeMail.Text         := DMNFe.ZQuery4['Email_NEeMAIL']
  else
   FrPar.edtNEeMail.Text         := '';
  if (DMNFe.ZQuery4['Email_Host'] <> Null) then
   FrPar.edtSmtpHost.Text        := DMNFe.ZQuery4['Email_Host']
  else
   FrPar.edtSmtpHost.Text        := '';
  if (DMNFe.ZQuery4['Email_Port'] <> Null) then
   FrPar.edtSmtpPort.Text        := IntToStr(DMNFe.ZQuery4['Email_Port'])
  else
   FrPar.edtSmtpPort.Text        := '0';
  if (DMNFe.ZQuery4['Email_User'] <> Null) then
   FrPar.edtSmtpUser.Text        := DMNFe.ZQuery4['Email_User']
  else
   FrPar.edtSmtpUser.Text        := '';
  if (DMNFe.ZQuery4['Email_Pass'] <> Null) then
   FrPar.edtSmtpPass.Text        := DMNFe.ZQuery4['Email_Pass']
  else
   FrPar.edtSmtpPass.Text        := '';
  if FrPar.edtSmtpPass.Text <> '' then
   FrPar.edtSmtpPass.Text     := EnDecrypt(FrPar.edtSmtpPass.Text, 236);
  if (DMNFe.ZQuery4['Email_SSL'] <> Null) then
   begin
    if (DMNFe.ZQuery4['Email_SSL'] = 'S') then
     FrPar.cbEmailSSL.Checked    := True
    else
     FrPar.cbEmailSSL.Checked    := False;
   end
  else
   FrPar.cbEmailSSL.Checked      := False;
  if (DMNFe.ZQuery4['Email_Assunto'] <> Null) then
   FrPar.edtEmailAssunto.Text    := DMNFe.ZQuery4['Email_Assunto']
  else
   FrPar.edtEmailAssunto.Text    := 'NFe - Nota Fiscal eLetrônica - Transmitida';
  if (DMNFe.ZQuery4['Email_Assunto_Canc'] <> Null) then
   FrPar.edtEmailCancAssunto.Text:= DMNFe.ZQuery4['Email_Assunto_Canc']
  else
   FrPar.edtEmailCancAssunto.Text:= 'NFe - Nota Fiscal eLetrônica - Cancelada';
  if (DMNFe.ZQuery4['Email_Assunto_CCe'] <> Null) then
   FrPar.edtEmailCCeAssunto.Text:= DMNFe.ZQuery4['Email_Assunto_CCe']
  else
   FrPar.edtEmailCCeAssunto.Text:= 'CCe - Carta de Correção';
  if (DMNFe.ZQuery4['Email_CC'] <> Null) then
   FrPar.edtEnvCC.Text           := DMNFe.ZQuery4['Email_CC']
  else
   FrPar.edtEnvCC.Text           := '';
  if (DMNFe.ZQuery4['Email_Mensagem'] <> Null) then
   FrPar.mmEmailMsg.Text         := DMNFe.ZQuery4['Email_Mensagem']
  else
   FrPar.mmEmailMsg.Text         := 'Segue anexo os arquivos XML e PDF da' + Chr(13) + 'NFe - (Nota Fiscal eLetrônica)';

  if (DMNFe.ZQuery4['OUTROS_ExcTmp'] <> Null) then
   begin
    if (DMNFe.ZQuery4['OUTROS_ExcTmp'] = 'S') then
     FrPar.CheckBox.Checked      := True
    else
     FrPar.CheckBox.Checked      := False;
   end
  else
   FrPar.CheckBox.Checked        := False;

  if (DMNFe.ZQuery4['OUTROS_DtIni'] <> Null) then
   FrPar.dtp1.DateTime           := DMNFe.ZQuery4['OUTROS_DtIni']
  else
   FrPar.dtp1.DateTime           := IncMonth(Now(), -3);

  // by Edson Lima ; 2017-1-4T1001 ; Atribui as variáveis globais do Gerente
  gDBERP                         := UpperCase(DMNFe.ZQuery4['DBERP']);
  if (DMNFe.ZQuery4['CodMtC'] <> Null) then
   gCodMtC                       := DMNFe.ZQuery4['CodMtC'];
  if (DMNFe.ZQuery4['CodMtD'] <> Null) then
   gCodMtD                       := DMNFe.ZQuery4['CodMtD'];
  if (DMNFe.ZQuery4['CodMtI'] <> Null) then
   gCodMtI                       := DMNFe.ZQuery4['CodMtI'];
  //----------------------------------------------------------------------------

  // by Edson Lima ; 2015-10-16T0900 ; trunk2 novo - Prenchimento do componente acbrmail
  ACBrMail1.Host                := FrPar.edtSmtpHost.Text;                      // Host
  ACBrMail1.Port                := FrPar.edtSmtpPort.Text;                      // Número da porta
  ACBrMail1.Username            := FrPar.edtSmtpUser.Text;                      // Username
  ACBrMail1.Password            := FrPar.edtSmtpPass.Text;                      // Password (senha)
  ACBrMail1.From                := FrPar.edtSmtpUser.Text;                      // email do emitente
  ACBrMail1.SetSSL              := FrPar.cbEmailSSL.Checked;                    // SSL - Conexão Segura
  ACBrMail1.SetTLS              := True;                                        // Auto TLS
  ACBrMail1.ReadingConfirmation := False;                                       // Pede confirmação de leitura do email
  ACBrMail1.UseThread           := False;                                       // Aguarda Envio do Email(não usa thread)
  ACBrMail1.FromName            := FrPar.edtNEeMail.Text;                       // Nome do Emitente do email

  // by Edson Lima ; 2017-1-4T1024 ; Ler o sistema genrente, Gerpa, Sisa, Sisag
  fLerGer();
  //----------------------------------------------------------------------------

 finally
 end;
end;

//------------------------------------------------------------------------------
//
// Modify By Edson 10.2.2012t09:14
// Procedure:    LerConfiguração 2
// Description:  Ler os dados dos parâmetros
//
//------------------------------------------------------------------------------
procedure TFrGBNFe.LerConf2;
Var
 Ok         : Boolean;
 vPS        : integer;
begin

 try
  {$IFDEF ACBrNFeOpenSSL}

   ACBrNFe1.Configuracoes.Certificados.Certificado  := '';                      // FrPar.edtCaminho.Text;  // by Edson Lima ; 3-4-2012 ; 16:32 ; foi retida apartir dessa data
   ACBrNFe1.Configuracoes.Certificados.Senha        := '';                      // FrPar.edtSenha.Text;    // by Edson Lima ; 3-4-2012 ; 16:32 ; foi retida apartir dessa data

  {$ELSE}

   //Grava e Ler o arquivo ini - by EL - 2014-11-19T1552
   if not FileExists(gCamCert + 'GBNFe.ini') then
    begin
     gCEIni := StrToInt(gCodEmp);
     gPSCert := 1;
     GravarIni();
    end;

   // Mosta qual certificado o usuário está usando
   if FileExists(gCamCert + 'GBNFe.ini') then
    begin
     LerIni();
     if ((gPSCert = 1) and (StrToInt(gCodEmp) = gCEIni)) then
     begin
      ACBrNFe1.Configuracoes.Certificados.NumeroSerie := FrPar.edtNumSerie.Text;
      FrPar.edtNumSerie.Text := ACBrNFe1.Configuracoes.Certificados.NumeroSerie;
     end;
    if ((gPSCert = 2) and (StrToInt(gCodEmp) = gCEIni)) then
     begin
      ACBrNFe1.Configuracoes.Certificados.NumeroSerie := FrPar.edtNumSerie2.Text;
      FrPar.edtNumSerie2.Text := ACBrNFe1.Configuracoes.Certificados.NumeroSerie;
     end;
    end;

  {$ENDIF}

  if FrGBNFe.RadioButton1.Checked then
   ACBrNFe1.Configuracoes.Geral.FormaEmissao := StrToTpEmis(OK, '1');
  if FrGBNFe.RadioButton3.Checked then
   ACBrNFe1.Configuracoes.Geral.FormaEmissao := StrToTpEmis(OK, '2');

   // By Edson Lima ; 18/06/2012 ; 09:00
   ACBrNFe1.Configuracoes.WebServices.UF                         := DMNFe.ZQuery4['uf'];      // trunk2 ; by Edson Lima ; 2015-10-29T1611 - novo
   ACBrNFe1.Configuracoes.Geral.CSC                              := FrPar.edtCSC.Text;        // trunk2 ; by Edson Lima ; 2015-10-29T1611 - novo
   ACBrNFe1.Configuracoes.Geral.IdCSC                            := FrPar.edtIdCSC.Text;      // trunk2 ; by Edson Lima ; 2015-10-29T1611 - novo
   ACBrNFe1.Configuracoes.Arquivos.Salvar                        := true;
   ACBrNFe1.Configuracoes.Arquivos.EmissaoPathNFe                := true;
   ACBrNFe1.Configuracoes.Arquivos.PathNFe                       := gCamXml;
   ACBrNFe1.Configuracoes.Arquivos.DownloadNFe.PathDownload      := gCamXml;
   ACBrNFe1.Configuracoes.Arquivos.PathInu                       := gCamXml;
   ACBrNFe1.Configuracoes.Arquivos.PathEvento                    := gCamXml;
   ACBrNFe1.Configuracoes.Geral.Salvar                           := true;                     //ckSalvar.Checked;
   ACBrNFe1.Configuracoes.Arquivos.PathSalvar                    := gCamLog;                  // trunk2 - Antes => ACBrNFe1.Configuracoes.Geral.PathSalvar         := gCamLog;
   ACBrNFe1.Configuracoes.Arquivos.PathSchemas                   := gCamSch;                  // trunk2 - Antes => ACBrNFe1.Configuracoes.Geral.PathSchemas        := gCamSch;
   ACBrNFe1.Configuracoes.Arquivos.SepararPorMes                 := true;

   // Definição do Ambiente de Transmissão ; by Edson Lima ; 19/10/2012 ; 10:30
   If FrPar.rgTipoAmb.ItemIndex = 0 then
    begin
     ACBrNFe1.NotasFiscais.Add.NFe.Ide.tpAmb       := taProducao;
     ACBrNFe1.Configuracoes.WebServices.Ambiente   := taProducao;
    end
   else
    begin
     ACBrNFe1.NotasFiscais.Add.NFe.Ide.tpAmb       := taHomologacao;
     ACBrNFe1.Configuracoes.WebServices.Ambiente   := taHomologacao;
    end;
   ACBrNFe1.Configuracoes.WebServices.Visualizar := FrPar.ckVisualizar.Checked;
   ACBrNFe1.Configuracoes.WebServices.ProxyHost  := FrPar.edtProxyHost.Text;
   ACBrNFe1.Configuracoes.WebServices.ProxyPort  := FrPar.edtProxyPorta.Text;
   ACBrNFe1.Configuracoes.WebServices.ProxyUser  := FrPar.edtProxyUser.Text;
   ACBrNFe1.Configuracoes.WebServices.ProxyPass  := FrPar.edtProxySenha.Text;

 except

 end;
end;

//el------------------GB Informática Ltda------------------------
//
// By.........: Edson Lima
// Data.......: quarta-feira 1.2.2012 16:09
// Ultima Alt.:
// Descrição..: Procedure que le os arquivos textos e Atualiza nfe
//              Esta procedure contém o mesmo código evento
//              onckick do antigo botão Atualizar.
//--------------------------------------------------------------
procedure TFrGBNFe.pAtuNFe();
var
 aux, vModelo, vSerie     : string;

begin

  Bitbtn4.Visible := true;

 //---------------- executa procedure que le os arquivos txt se tiver setado no parâmetros

 if FrPar.CheckBox5.Checked then
  begin
   try
    DMNFe.ZQuery2.DisableControls;
    DMNFe.ZQuery2.Close;
    DMNFe.ZQuery2.SQL.Clear;
    DMNFe.ZQuery2.SQL.Add( 'exec sp_ler_nfe_textos :gCamTxt ' );
    DMNFe.ZQuery2.Params[0].AsString := gCamTxt;
    try
      DMNFe.ZConnection1.StartTransaction;
      DMNFe.ZQuery2.ExecSQL;
      except
        DMNFe.ZConnection1.Rollback;
        Application.Messagebox('ERRO: sp_ler_nfe_textos','Atenção!',MB_ICONERROR+mb_ok);
      end;
    DMNFe.ZQuery2.Close;

   finally
    DMNFe.ZQuery2.EnableControls;
   end;
  end;

 //ler o retorno da critica da importação
 DMNFe.ZQuery2.Close;
 DMNFe.ZQuery2.SQL.Clear;
 DMNFe.ZQuery2.SQL.Add( 'select * from critica_importacao' );
 DMNFe.ZQuery2.Open;
 DMNFe.ZQuery2.first;

 if not (DMNFe.ZQuery2.IsEmpty) then
  if vartostr(DMNFe.ZQuery2['retorno']) <> '' then begin
   MessageDlg(vartostr(DMNFe.ZQuery2['retorno']),mtError,[mbOK],0);
  end;

 //----------------------------------------------------------------------------

 vSerie := '';

 case RadioGroup2.ItemIndex of
  0 : vModelo := '';
  1 : vModelo := '55';
  2 : vModelo := '65';
 end;

 aux := '';
 aux := dxSpinEdit1.text + ',' + '''' + vModelo + '''' + ',' + '''';
 aux := aux + vSerie + '''';

 DMNFe.ZQuery3.Close;
 DMNFe.ZQuery3.SQL.Clear;
 DMNFe.ZQuery3.SQL.Add( 'exec sp_nfe_a_serem_geradas ' + aux );
 DMNFe.ZQuery3.Open;

 // by Edson Lima ; 2013-7-26T1609 ; Atualiza dados das TreeLest
 pAtuTL(dxTLPend, dxTLCPendCheckSel, dxTLCPendMaskDes,     dxTLCPendMaskCnpjCpf,
                  dxTLCPendMaskCod,  dxTLCPendMaskMod,     dxTLCPendMaskSer,
                  dxTLCPendDateDemi, dxTLCPendSpinNot,     dxTLCPendCurrencyVal,
                  dxTLCPendMaskSit,  dxTLCPendMaskPro,     dxTLCPendMaskRec,
                  dxTLCPendMaskCha,  DMNFe.ZQuery3);

 // by Edson Lima ; 4.4.2012 ; 15:30 ; Linha incluida
 pAtuNFeT();

end;

//el------------------GB Informática Ltda------------------------
//
// By.........: Edson Lima
// Data.......: sexta-feira 3.2.2012 16:05
// Ultima Alt.:
// Descrição..: Procedure que le os arquivos textos e Atualiza nfe
//              transmitidas. Esta procedure contém o mesmo
//              código evento onckick do antigo botão Atualizar
//              nfe transmitidas.
//
//--------------------------------------------------------------
procedure TFrGBNFe.pAtuNFeT();
var
 aux, vModelo, vSerie    : string;
 nodInu                  : TdxTreeListNode;
 vMod, vSer              : integer;
begin

 if dxSpinEdit2.Text = '' then dxSpinEdit2.IntValue := 0;
 if dxSpinEdit3.Text = '' then dxSpinEdit3.IntValue := 0;

 vSerie := '';

 case RadioGroup2.ItemIndex of
  0 : vModelo := '';
  1 : vModelo := '55';
  2 : vModelo := '65';
 end;

 aux := '';
 aux := dxSpinEdit1.text + ',' + '''' + FormatDateTime('yyyy/mm/dd', dxDateEdit1.Date) + ''''+ ',';
 aux := aux + '''' + FormatDateTime('yyyy/mm/dd', dxDateEdit2.Date) + '''' + ',';
 aux := aux + '''' + dxSpinEdit2.Text + '''' + ',';
 aux := aux + '''' + dxSpinEdit3.Text + '''' + ',';
 aux := aux + '''' + vModelo + '''' + ',';
 aux := aux + '''' + vSerie + '''';

 DMNFe.ZQuery5.Close;
 DMNFe.ZQuery5.SQL.Clear;
 DMNFe.ZQuery5.SQL.Add( 'exec sp_nfe_transmitidas ' + aux );
 DMNFe.ZQuery5.Open;

 // by Edson Lima ; 2013-7-26T1609 ; Atualiza dados das TreeLest - TRANSMITIDAS
 pAtuTL(dxTLTrans, dxTLCPendCheckSel, dxTLCPendMaskDes,     dxTLCPendMaskCnpjCpf,
                   dxTLCPendMaskCod,  dxTLCPendMaskMod,     dxTLCPendMaskSer,
                   dxTLCPendDateDemi, dxTLCPendSpinNot,     dxTLCPendCurrencyVal,
                   dxTLCPendMaskSit,  dxTLCPendMaskPro,     dxTLCPendMaskRec,
                   dxTLCPendMaskCha,  DMNFe.ZQuery5);

 //----------------------------------------------------------------------------
 // by Edson Lima ; 2013-7-26T1609 ; Atualiza dados das TreeLest - DE BUSCA
 // Monta a grade busca notas
 FrBuscaNota.dxTLBusca.ClearNodes;

 if DMNFe.zQuery5.RecordCount > 0 Then
  Begin
   FrBuscaNota.dxTLBusca.BeginUpdate;

   Try
    DMNFe.zQuery5.First;

    // Laço para montar grade

    While Not DMNFe.zQuery5.Eof Do
     begin
      nodInu := FrBuscaNota.dxTLBusca.Add;

      nodInu.Values[FrBuscaNota.dxTLCBuscaMaskNnf.Index]           := DMNFe.zQuery5.fieldByName('nfe_nnf').AsString;
      nodInu.Values[FrBuscaNota.dxTLCBuscaMaskDest.Index]          := DMNFe.zQuery5.fieldByName('nfe_codigo_destinatario').AsString;
      nodInu.Values[FrBuscaNota.dxTLCBuscaDateDEmi.Index]          := DMNFe.zQuery5.fieldByName('nfe_demi').AsString;
      nodInu.Values[FrBuscaNota.dxTLCBuscaMaskMod.Index]           := DMNFe.zQuery5.fieldByName('nfe_Modelo').AsString;
      nodInu.Values[FrBuscaNota.dxTLCBuscaMaskSer.Index]           := DMNFe.zQuery5.fieldByName('nfe_Serie').AsString;
      nodInu.Values[FrBuscaNota.dxTLCBuscaMaskChave.Index]         := DMNFe.zQuery5.fieldByName('nfe_chave_nfe').AsString;

     DMNFe.zQuery5.Next;
    end;
  Finally
   FrBuscaNota.dxTLBusca.EndUpdate;
  end;
 end;
 //-----------------------------------------------------------------------------

 // Ler e execulta a query de contingência
 DMNFe.ZQuery6.Close;
 DMNFe.ZQuery6.SQL.Clear;
 DMNFe.ZQuery6.SQL.Add( 'exec sp_nfe_canceladas ' + aux );
 DMNFe.ZQuery6.Open;

 // by Edson Lima ; 2013-7-26T1609 ; Atualiza dados das TreeLest das Canceladas
 pAtuTL(dxTLCanc, dxTLCPendCheckSel, dxTLCPendMaskDes,     dxTLCPendMaskCnpjCpf,
                  dxTLCPendMaskCod,  dxTLCPendMaskMod,     dxTLCPendMaskSer,
                  dxTLCPendDateDemi, dxTLCPendSpinNot,     dxTLCPendCurrencyVal,
                  dxTLCPendMaskSit,  dxTLCPendMaskPro,     dxTLCPendMaskRec,
                  dxTLCPendMaskCha,  DMNFe.ZQuery6);

 // Ler e execulta a query de denegadas
 DMNFe.ZqryGeral.Close;
 DMNFe.ZqryGeral.SQL.Clear;
 DMNFe.ZqryGeral.SQL.Add( 'exec sp_nfe_denegadas ' + aux );
 DMNFe.ZqryGeral.Open;

 // by Edson Lima ; 2013-7-26T1609 ; Atualiza dados das TreeLest denegadas
 pAtuTL(dxTLDeneg, dxTLCPendCheckSel, dxTLCPendMaskDes,     dxTLCPendMaskCnpjCpf,
                   dxTLCPendMaskCod,  dxTLCPendMaskMod,     dxTLCPendMaskSer,
                   dxTLCPendDateDemi, dxTLCPendSpinNot,     dxTLCPendCurrencyVal,
                   dxTLCPendMaskSit,  dxTLCPendMaskPro,     dxTLCPendMaskRec,
                   dxTLCPendMaskCha,  DMNFe.ZqryGeral);

 // Ler e execulta a query de contingência
 aux := '';
 aux := dxSpinEdit1.text + ',' + '''' + vModelo + '''' + ',' + '''';
 aux := aux + vSerie + '''';

 DMNFe.ZQuery10.Close;
 DMNFe.ZQuery10.SQL.Clear;
 DMNFe.ZQuery10.SQL.Add( 'exec sp_nfe_em_contingencia ' + aux );
 DMNFe.ZQuery10.Open;

 // by Edson Lima ; 2013-7-26T1609 ; Atualiza dados das TreeLest das contingências
 pAtuTL(dxTLCont, dxTLCPendCheckSel, dxTLCPendMaskDes,     dxTLCPendMaskCnpjCpf,
                  dxTLCPendMaskCod,  dxTLCPendMaskMod,     dxTLCPendMaskSer,
                  dxTLCPendDateDemi, dxTLCPendSpinNot,     dxTLCPendCurrencyVal,
                  dxTLCPendMaskSit,  dxTLCPendMaskPro,     dxTLCPendMaskRec,
                  dxTLCPendMaskCha,  DMNFe.ZQuery10);

 // Ler e execulta a query de inutilizadas

 vSer := 0;

 case RadioGroup2.ItemIndex of
  0 : vMod := 0;
  1 : vMod := 55;
  2 : vMod := 65;
 end;

 aux := '';
 aux := dxSpinEdit1.text + ',' + '''' + IntToStr(vMod) + '''' + ',' + '''';
 aux := aux + IntToStr(vSer) + '''';

 DMNFe.ZQuery7.Close;
 DMNFe.ZQuery7.SQL.Clear;
 DMNFe.ZQuery7.SQL.Add( 'exec sp_nfe_inutilizadas ' + aux );
 DMNFe.ZQuery7.Open;

 //----------------------------------------------------------------------------
 // Atribui dados na treelist
 // Monta a grade inutilizadas
 dxTLInut.ClearNodes;

 if DMNFe.zQuery7.RecordCount > 0 Then
  Begin
   dxTLInut.BeginUpdate;

   Try
    DMNFe.zQuery7.First;

    // Laço para montar grade

    While Not DMNFe.zQuery7.Eof Do
     begin
      nodInu := dxTLInut.Add;

      nodInu.Values[dxTLCInutDateDemi.Index]          := DMNFe.zQuery7.fieldByName('nfe_demi').AsDateTime;
      nodInu.Values[dxTLCInutMaskAno.Index]           := DMNFe.zQuery7.fieldByName('ano').AsString;
      nodInu.Values[dxTLCInutMaskSerie.Index]         := DMNFe.zQuery7.fieldByName('serie').AsString;
      nodInu.Values[dxTLCInutMaskModelo.Index]        := DMNFe.zQuery7.fieldByName('modelo').AsString;
      nodInu.Values[dxTLCInutMaskNota.Index]          := DMNFe.zQuery7.fieldByName('nfe_nnf').AsString;
      nodInu.Values[dxTLCInutMaskJustificativa.Index] := DMNFe.zQuery7.fieldByName('justificativa').AsString;

     DMNFe.zQuery7.Next;
    end;
  Finally
   dxTLInut.EndUpdate;
  end;
 end;

end;

//el------------------GB Informática Ltda------------------------
//
// By.........: Edson Lima
// Data.......: quarta-feira 8.2.2012 10:05
// Ultima Alt.:
// Descrição..: Procedure que lê o arquivo empresa
//
//--------------------------------------------------------------
procedure TFrGBNFe.pLerEmp();
begin

 DMNFe.ZQuery4.Close;
 DMNFe.ZQuery4.SQL.Clear;
 DMNFe.ZQuery4.SQL.Add( 'select * from emitente            ' );
 DMNFe.ZQuery4.SQL.Add( ' where codigo_loja =:codigo_loja  ' );
 DMNFe.ZQuery4.ParamByName('codigo_loja').AsInteger := StrToInt(gCodEmp);
 DMNFe.ZQuery4.Open;

 DMNFe.ZQuery4.Active := True;

 if DMNFe.ZQuery4.isempty then
  begin

   Application.Messagebox(' Emitente não encontrado, o GBNFe será fechado!','Atenção!',MB_ICONINFORMATION+mb_ok);
    begin
     PostMessage(FindWindow('tfrgbnfe', nil), WM_CLOSE,0,0);
     Exit;
    end;

   end

  else

   begin

    Label1.Caption := ' ' + vartostr(DMNFe.ZQuery4['razao_social']) + ' - ' + vartostr(DMNFe.ZQuery4['nome_fantasia']);
    gCnpj          := DMNFe.ZQuery4['cnpj'];

   end;

end;

procedure TFrGBNFe.FormShow(Sender: TObject);
var
 vNNFenc : boolean;

begin

 // Atualizar o camp cSitConf
 // FrBuscaChave.AtualizarCnpjCpfdoDestinatrio();

 // Coloca o FrGBNFe na frente dos outros
 FrGBNFe.BringToFront;

 // Esta linha coloca a tela na frente ontop
 // SetWindowPos(Handle, HWND_TOPMOST,0,0,0,0,SWP_NOACTIVATE OR SWP_NOMOVE OR SWP_NOSIZE);

 pLerEmp();                                     // By EL 8.2.2012 - Ler e atualiza os dados do emissor
 LerConf1();                                    // Ler a tabela emitente e pega os parâmetros

 // Verifica o caminho do arquivo da logomarca e da base de dados
 if not FileExists(PChar(FrPar.edtLogoMarca.Text)) then
  Application.Messagebox('Logomarca não encontrada, verifique o caminho da logomarca' + Chr(13) +
                         'e do servidor da base de dados em parâmetros!','Informação',MB_ICONINFORMATION+mb_ok);

 pAtrCam();                                     // Atribui caminhos do parâmetros nas variáveis padrão e executavel
 pVerPas();                                     // Verifica e atualiza os caminhos

 dxSpinEdit1.IntValue := StrToInt(gCodEmp);     // Atualiza o dxSpinEdit1 com o gCodEmp passado por parâmetro pelo Gerpa
 ilCodEmp := StrToInt(gCodEmp);

 // Trada dos arquivos DirXX.MB localmente
 if FrPar.ragLocSrv.ItemIndex = 0 then
  Session.PrivateDir := fGetTempDir;

 LerConf2();                                    // Atribui dados nos parâmetros acbr

 pAtuNFe();                                     // Procedure de atualização

 PageControl1.TabIndex := 2;                    // Janela de mensagens de retorno

 /// by EL - 14.2.2012 --> Inicia a com as notas pendentes
 RadioGroup1.ItemIndex := 0;   // Pendentes

 // by EL 14.2.2012 -> função de coleta de dados
 fIniPen();

 DMNFe.ZQuery3.CachedUpdates  := True;
 DMNFe.ZQuery5.CachedUpdates  := True;
 DMNFe.ZQuery6.CachedUpdates  := True;
 DMNFe.ZQuery10.CachedUpdates := True;

 // Pega a versão e atribui no panel da janela principal
 Panel11.Caption := 'NFe && NFCe v.(Z): ' + GetBuildInfo;

 // Pega a versão e atribui no panel da janela de Manifesto
 if gNivel = '4' then
  begin
   FrBuscaChave.Panel11.Caption := 'NFe && NFCe v.(Z): ' + GetBuildInfo;
   FrBuscaChave.SpeedButton2.Visible  := True;
   FrBuscaChave.SpeedButton51.Visible := True;
   FrBuscaChave.img1.Visible          := True;
   FrBuscaChave.Align                 := alBottom;
   FrBuscaChave.WindowState           := wsMinimized;
   FrBuscaChave.hdrcntrl1.Visible     := True;
  end;

 //*****************************************************************************
 //** ROTINAS DAS CHAMADAS EXPRESS PELO GERPA
 //*****************************************************************************

 vNNFenc := false;

 if gExpress = '1' then
  begin
   case StrToInt(gOpcao) of
    1 :                   //** ENVIA NOTA FISCAL
     begin
      RadioGroup1.ItemIndex := 0;                            // seta parâmetro inicial para visualizar nfe a transmitir
      RadioGroup1Click(Sender);                              // força um clic no evento radiogroup1

      DMNFe.ZQuery3.First;                                    // vai pro inicio da tabela nfe
      while (not DMNFe.ZQuery3.eof) do                        // fica no loop até que encontre o fim
       begin
        if (DMNFe.ZQuery3['nfe_nnf'] = StrToInt(gNNF)) then   // se a nota for igual a variavel gNNF marca registro
         begin
          DMNFe.ZQuery3.FieldByName('Checado').ReadOnly := False;
          DMNFe.ZQuery3.Edit;                                 // edita registro
          DMNFe.ZQuery3['Checado'] := 'Y';                    // marca registro para processamento
          vNNFenc := true;                                    // especifica que a nota fiscal foi encontrada
         end;
         DMNFe.ZQuery3.Next;                                  // vai para o próximo registro e retorna para o loop
       end;

      try

       BitBtn2Click(Sender);                                 // força um clic no botão "enviar nota fiscal"

      except
       Application.Messagebox('ERRO NÃO CATALOGADO: Nota Fiscal eletrônica não enviada !','Atenção!',MB_ICONERROR+mb_ok);
       pAtuNFe();
       close;                                                // se der erro sai do sistema
      end;
      if not vNNFenc then
       Application.Messagebox('OBS: Nota Fiscal eletrônica não encontrada !','Atenção!',MB_ICONASTERISK+mb_ok);
      close;                                                 // se terminar sem problema sai do sistema
     end;
    2 :                   //** CANCELA NOTA FISCAL
     begin
      RadioGroup1.ItemIndex := 2;                            // seta parâmetro inicial para visualizar nfe a transmitir
      RadioGroup1Click(Sender);                              // força um clic no evento radiogroup1
      FrGBNFe.dxDateEdit1.Date := Date() - 2;                // seta data da nota para o dxDateEdit1
      btn2Click(Sender);

      DMNFe.ZQuery5.First;                                    // vai pro inicio da tabela nfe
      while (not DMNFe.ZQuery5.eof) do                        // fica no loop até que encontre o fim
       begin
        if (DMNFe.ZQuery5['nfe_nnf'] = StrToInt(gNNF)) then   // se a nota for igual a variavel gNNF marca registro
         begin
          DMNFe.ZQuery5.FieldByName('Checado').ReadOnly := False;
          DMNFe.ZQuery5.Edit;                                 // edita registro
          DMNFe.ZQuery5['Checado'] := 'Y';                    // marca registro para processamento
          vNNFenc := true;                                   // especifica que a nota fiscal foi encontrada
         end;
         DMNFe.ZQuery5.Next;                                  // vai para o próximo registro e retorna para o loop
       end;

      try

       BitBtn11Click(Sender);                                // força um clic no botão "cancelar nota fiscal"

      except
       Application.Messagebox('ERRO NÃO CATALOGADO: Nota Fiscal eletrônica não cancelada !','Atenção!',MB_ICONERROR+mb_ok);
       pAtuNFe();
       close;                                                // se der erro sai do sistema
      end;
      if not vNNFenc then
       Application.Messagebox('OBS: Nota Fiscal eletrônica não encontrada !','Atenção!',MB_ICONASTERISK+mb_ok);
      close;                                                 // se terminar sem problema sai do sistema
     end;

    3 :                   //** INUTILIZA NOTA FISCAL
     begin
      RadioGroup1.ItemIndex := 0;                            // seta parâmetro inicial para visualizar nfe a transmitir
      RadioGroup1Click(Sender);                              // força um clic no evento radiogroup1
      FrInut.Edit4.Text := gNNF;                             // atribui o valor da variável gNNF para edit da tela de inutilização

      try

       BitBtn13Click(Sender);                                // força um clic no botão "inutilizar nota fiscal"

      except
       pAtuNFe();
       close;                                                // se der erro sai do sistema
      end;
      close;                                                 // se terminar sem problema sai do sistema
     end;

    4 :                   //** CONSULTA NOTA FISCAL
     begin
      RadioGroup1.ItemIndex := 2;                            // seta parâmetro inicial para visualizar nfe a transmitir
      RadioGroup1Click(Sender);                              // força um clic no evento radiogroup1
      FrGBNFe.dxDateEdit1.Date := Date() - 2;                // seta data da nota para o dxDateEdit1
      btn2Click(Sender);                                     // força um exit da data inicial

      DMNFe.ZQuery5.First;                                    // vai pro inicio da tabela nfe
      while (not DMNFe.ZQuery5.eof) do                        // fica no loop até que encontre o fim
       begin
        if (DMNFe.ZQuery5['nfe_nnf'] = StrToInt(gNNF)) then   // se a nota for igual a variavel gNNF marca registro
         begin
          DMNFe.ZQuery5.FieldByName('Checado').ReadOnly := False;
          DMNFe.ZQuery5.Edit;                                 // edita registro
          DMNFe.ZQuery5['Checado'] := 'Y';                    // marca registro para processamento
          vNNFenc := true;                                   // especifica que a nota fiscal foi encontrada
         end;
         DMNFe.ZQuery5.Next;                                  // vai para o próximo registro e retorna para o loop
       end;

      try

       gExcluir := True;                                      // Seta variável global para ler somente um registro
       BitBtn8Click(Sender);                                  // força um clic no botão "consulta nota fiscal"
       gExcluir := False;                                     // Seta variável global para ler vários registros

       if gDeuErrConsiste then Exit;                         // Aborta no caso de erro

      except
       Application.Messagebox('ERRO NÃO CATALOGADO: Nota Fiscal eletrônica não consultada !','Atenção!',MB_ICONERROR+mb_ok);
       pAtuNFe();
       close;                                                // se der erro sai do sistema
      end;
      if not vNNFenc then
       Application.Messagebox('OBS: Nota Fiscal eletrônica não encontrada !','Atenção!',MB_ICONASTERISK+mb_ok);
      close;                                                 // se terminar sem problema sai do sistema
     end;

    5 :                   //** IMPRIMIR NOTA FISCAL
     begin
      RadioGroup1.ItemIndex := 2;                            // seta parâmetro inicial para visualizar nfe transmitida
      RadioGroup1Click(Sender);                              // força um clic no evento radiogroup1
      FrGBNFe.dxDateEdit1.Date := Date() - 2;                // seta data da nota para o dxDateEdit1
      btn2Click(Sender);                                     // força um exit da data inicial

      DMNFe.ZQuery5.First;                                    // vai pro inicio da tabela nfe
      while (not DMNFe.ZQuery5.eof) do                        // fica no loop até que encontre o fim
       begin
        if (DMNFe.ZQuery5['nfe_nnf'] = StrToInt(gNNF)) then   // se a nota for igual a variavel gNNF marca registro
         begin
          DMNFe.ZQuery5.FieldByName('Checado').ReadOnly := False;
          DMNFe.ZQuery5.Edit;                                 // edita registro
          DMNFe.ZQuery5['Checado'] := 'Y';                    // marca registro para processamento
          vNNFenc := true;                                   // especifica que a nota fiscal foi encontrada
         end;
         DMNFe.ZQuery5.Next;                                  // vai para o próximo registro e retorna para o loop
       end;

      try

       BitBtn9Click(Sender);                                 // força um clic no botão "imprime nota fiscal"

      except
       Application.Messagebox('ERRO NÃO CATALOGADO: Nota Fiscal eletrônica não impressa !','Atenção!',MB_ICONERROR+mb_ok);
       pAtuNFe();
       close;                                                // se der erro sai do sistema
      end;
      if not vNNFenc then
       Application.Messagebox('OBS: Nota Fiscal eletrônica não encontrada !','Atenção!',MB_ICONASTERISK+mb_ok);
      close;                                                 // se terminar sem problema sai do sistema
     end;

   end;  //**case
  end;   //**if

 // Ajusta o tamanho do Label1 (razão social) com o tamanho do groupbox3
 Label1.Width := (Groupbox3.Width - 20);

 if gNivel = '4' then
  begin
   if ( FrBuscaChave = nil ) then
    FrBuscaChave := TFrBuscaChave.Create(Application)
   else
    FrBuscaChave := TFrBuscaChave.Create(Application);

   FrBuscaChave.ShowModal;
   FrBuscaChave.BringToFront;

   BitBtn12Click(Sender);
  end;

 gVerifCert := True;                                                            // Ativa as mensagens de verificação do certificado digital

 // Inibe a edição do código da empresa
 FrGBNFe.dxSpinEdit1.ReadOnly := gEdtCodEmp;

end;

procedure TFrGBNFe.dxDateEdit2Exit(Sender: TObject);
var
 vIndRG1 :  integer;
begin

 // Faz a contestação da data final antiga
 if dxDateEdit2.Date < (Date - 73000) then                                      // 73000 dias aproximadamente 200 anos
  if Application.MessageBox( 'Data final muito antiga !', 'GBNFe - Período', mb_IconInformation + MB_OK ) = IdOk then
   begin
    dxDateEdit2.SetFocus;
    exit;
   end;

 // Faz a contestação da data final no período
 if dxDateEdit2.Date < dxDateEdit1.Date then
  if Application.MessageBox( 'A data final não pode ser menor que data inicial !', 'GBNFe - Período', mb_IconInformation + MB_OK ) = IdOk then
   begin
    dxDateEdit2.SetFocus;
    exit;
   end;

 vIndRG1 := RadioGroup1.ItemIndex;
 pAtuNFeT();
 RadioGroup1.ItemIndex := 0;         // Pendentes
 RadioGroup1.ItemIndex  := vIndRG1;

end;


//el------------------GB Informática Ltda------------------------
//
// By.........: Edson Lima
// Data.......: terça-feira 14.2.2012 9:56
// Ultima Alt.:
// Descrição..: Função que prepara a query de nfe pendentes
//
//--------------------------------------------------------------
function TFrGBNFe.fIniPen() : boolean;
begin

 Case RadioGroup1.ItemIndex of
 0:                                                          // by EL 14.2.2012 -------->  PENDENTES
  begin

  // By Edson Lima - 1-2-2012 - Ler Arquivos txt e Atualiza
  pAtuNFe;

  DMNFe.ZQuery4.Close;
  DMNFe.ZQuery4.SQL.Clear;
  DMNFe.ZQuery4.SQL.Add( 'select * from emitente where codigo_loja = ' + dxSpinEdit1.text );
  DMNFe.ZQuery4.Open;

  if DMNFe.ZQuery4.isempty then
  begin
  DMNFe.ZQuery4.Close;
  DMNFe.ZQuery4.SQL.Clear;
  DMNFe.ZQuery4.SQL.Add( 'select * from emitente');
  DMNFe.ZQuery4.Open;

  if not DMNFe.ZQuery4.IsEmpty then
   begin
   if dxSpinEdit1.IntValue < DMNFe.ZQuery4['codigo_loja'] then
    begin
    DMNFe.ZQuery4.Last;
    dxSpinEdit1.Text := IntToStr(DMNFe.ZQuery4['codigo_loja']);
    pAtuNFe;
    DMNFe.ZQuery4.Close;
    DMNFe.ZQuery4.SQL.Clear;
    DMNFe.ZQuery4.SQL.Add( 'select * from emitente where codigo_loja = ' + dxSpinEdit1.text );
    DMNFe.ZQuery4.Open;
    end
   else
    begin
    DMNFe.ZQuery4.Last;
    if dxSpinEdit1.IntValue > DMNFe.ZQuery4['codigo_loja'] then
     begin
     DMNFe.ZQuery4.First;
     dxSpinEdit1.Text := IntToStr(DMNFe.ZQuery4['codigo_loja']);
     pAtuNFe;
     DMNFe.ZQuery4.Close;
     DMNFe.ZQuery4.SQL.Clear;
     DMNFe.ZQuery4.SQL.Add( 'select * from emitente where codigo_loja = ' + dxSpinEdit1.text );
     DMNFe.ZQuery4.Open;
     end
    else
     pAtuNFe;
     DMNFe.ZQuery4.Close;
     DMNFe.ZQuery4.SQL.Clear;
     DMNFe.ZQuery4.SQL.Add( 'select * from emitente where codigo_loja = ' + dxSpinEdit1.text );
     DMNFe.ZQuery4.Open;
    end;
   end;
  end;

  if DMNFe.ZQuery4.IsEmpty then
   begin
   Label1.Font.Color := clRed;
   Label1.Caption := ' NÃO EXISTE EMPRESA CADASTRADA NESSE CÓDIGO !';
   end
  else
   begin
   Label1.Font.Color := clBlue;
   Label1.Caption := ' ' + vartostr(DMNFe.ZQuery4['razao_social']) + ' - ' + vartostr(DMNFe.ZQuery4['nome_fantasia']);
   end;

  end;


 end;

 result := true;
end;

//el------------------GB Informática Ltda------------------------
//
// Data.......: quinta-feira 16.2.2011 10:38
// Ultima Alt.:
// Descrição..: Proc. que verifica a existencia das pastas e se
//              não existirem ele as cria
//
//------------------------------------------------------------ok-
procedure TFrGBNFe.pVerPas();
begin
 // Cria os respectivos caminhos Emp000Xml, Emp000Pdf, Emp000Log, Emp000Bak, Emp000NFe e Emp000Doc dentro do ..\Arq
 if not DirectoryExists(gCamPad + 'Arq') then CreateDir(gCamPad + 'Arq');
 if not DirectoryExists(gCamPad + 'Arq\Emp' + gCodEmp ) then
  begin
   CreateDir(gCamPad + 'Arq\Emp' + gCodEmp);
   CreateDir(gCamPad + 'Arq\Emp' + gCodEmp + '\Xml');
   CreateDir(gCamPad + 'Arq\Emp' + gCodEmp + '\XmlI');
   CreateDir(gCamPad + 'Arq\Emp' + gCodEmp + '\Pdf');
   CreateDir(gCamPad + 'Arq\Emp' + gCodEmp + '\Log');
   CreateDir(gCamPad + 'Arq\Emp' + gCodEmp + '\Doc');
  end
 else if DirectoryExists(gCamPad + 'Arq\Emp' + gCodEmp + '\XmlE') then
  RemoveDir(gCamPad + 'Arq\Emp' + gCodEmp + '\XmlE')
 else if DirectoryExists(gCamPad + 'Arq\Emp' + gCodEmp + '\XmlS') then
  RemoveDir(gCamPad + 'Arq\Emp' + gCodEmp + '\XmlS')
 else
  begin
   if not DirectoryExists(gCamPad + 'Arq\Emp' + gCodEmp + '\Xml')  then CreateDir(gCamPad + 'Arq\Emp' + gCodEmp + '\Xml');
   if not DirectoryExists(gCamPad + 'Arq\Emp' + gCodEmp + '\XmlI') then CreateDir(gCamPad + 'Arq\Emp' + gCodEmp + '\XmlI');
   if not DirectoryExists(gCamPad + 'Arq\Emp' + gCodEmp + '\Pdf')  then CreateDir(gCamPad + 'Arq\Emp' + gCodEmp + '\Pdf');
   if not DirectoryExists(gCamPad + 'Arq\Emp' + gCodEmp + '\Log')  then CreateDir(gCamPad + 'Arq\Emp' + gCodEmp + '\Log');
   if not DirectoryExists(gCamPad + 'Arq\Emp' + gCodEmp + '\Doc')  then CreateDir(gCamPad + 'Arq\Emp' + gCodEmp + '\Doc');
  end;

 // Cria os respectivos caminhos de Textos
 if not DirectoryExists(gCamPad + 'Txt') then CreateDir(gCamPad + 'Txt');
 if not DirectoryExists(gCamPad + 'Txt\' + gCodEmp) then CreateDir(gCamPad + 'Txt\' + gCodEmp);

 // Cria os respectivos caminhos
 if not DirectoryExists(gCamPad + 'Arq\Bak') then CreateDir(gCamPad + 'Arq\Bak');

 // Cria os caminhos Report a nível do execultável
 if not DirectoryExists(gCamExe + 'Report') then CreateDir('Report');

 // Cria os caminhos Schemas dentro do Execultável
 if not DirectoryExists(gCamExe + 'Schemas') then CreateDir(gCamExe + 'Schemas');

 // by Edson Lima ; 5.4.2012 ; 14:42 ; Atribui caminho para local do PDF e REV

 if ( gCpt = 1 ) then
  pDefineRel()                                                                  // Define o tipo de Relatório FortesReport
 else
  pDefineRelFR();                                                               // Define o tipo de Relatório FastReport

end;

//-------------- Enviar NFe e NFCe -----------------//
procedure TFrGBNFe.BitBtn2Click(Sender: TObject);
var
 I, vC, c                             : Integer;
 Para, vI, vP, pAux, aux, vCon, vDmsg : String;
 CC                                   : Tstrings;
 y                                    : dword;

begin

 ACBrNFe1.Configuracoes.WebServices.AguardarConsultaRet      := 0;

 Case RadioGroup1.ItemIndex of
 0:                                // by EL 14.2.2012 ->  PENDENTES
  begin
  //----------------------------------------------------------------------fsda

   if RadioButton3.Checked then    // PENDENTES - CONTINGÊNCIA
    begin

     if MessageDlg('Confirma geração em contingência ' + _tipo_emissao + ':', mtConfirmation, [mbYes, mbNo], 0) = mrYes then
      begin
       if not(InputQuery('WebServices Contingência', 'Justificativa', xjustificativa)) then exit;
        if length(trim(xjustificativa)) < 15 then
         begin
          MessageDlg('Justificativa deve ter no mínimo 15 caracteres', mtConfirmation,[mbOK],0);
          exit;
         end;

       DMNFe.ZQuery3.first;
       try // by Edson Lima ; 2013/03/05 ; 15:20 ; Linha incluida para controlar o sistema de atualização
       while ((not DMNFe.ZQuery3.eof) and (DMNFe.ZQuery3['nfe_nnf'] <> Null)) do
        begin

         DMNFe.ZQuery3.FieldByName('Checado').ReadOnly := False;

         if DMNFe.ZQuery3['Checado'] = 'Y' then
          begin

           gModelo := DMNFe.ZQuery3['nfe_Modelo'];
           gSerie  := DMNFe.ZQuery3['nfe_Serie'];

           //-------------------------------------------------------------------
           // by Edson Lima ; 2016-2-26T1021
           // Aqui está sendo bloqueada a emissão da nfce
           //-------------------------------------------------------------------
           if (gModelo = 55) then
            begin

             if gModelo = 65 then
              begin
               ACBrNFe1.Configuracoes.Geral.ModeloDF := moNFCe;
              end
             else
              begin
               ACBrNFe1.Configuracoes.Geral.ModeloDF := moNFe;
              end;

              if ( gCpt = 1 ) then
               pDefineRel()                                                     // Define o tipo de Relatório FortesReport
              else
               pDefineRelFR();                                                  // Define o tipo de Relatório FastReport

             if (gModelo = 55) then
              begin
               _tipo_emissao := 'fsda';
               _tpemissao := '5';
              end
             else if (gModelo = 65) then
              begin
               _tipo_emissao := 'OffL';
               _tpemissao := '9';
              end;

             //*******************************************************************************
             // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update
             gCdloja_Consiste := dxSpinEdit1.Text;
             gdEmi_Consiste   := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery3['nfe_demi']);
             gNNF_Consiste    := vartostr(DMNFe.ZQuery3['nfe_nnf']);
             gSerie_Consiste  := vartostr(DMNFe.ZQuery3['nfe_serie']);
             gSerie           := StrToInt(gSerie_Consiste);
             gModelo          := StrToInt(DMNFe.ZQuery3['nfe_modelo']);
             gChave_Consiste  := '';                                              // está sendo atribuida depois da sp_calcula_digito_chave

             gDataEmi := NullDate;
             aux := VarToStr(DMNFe.ZQuery3['nfe_chave_nfe']);

             if (gModelo = 65) then
              begin
               ACBrNFe1.Configuracoes.Geral.ModeloDF := moNFCe;
               gTN                                   := '\NFCe\';
               if not (DMNFe.ZQuery3['nfe_DatNFCe']   = null) then
                gDataEmi                             := (DMNFe.ZQuery3['nfe_DatNFCe']);
              end
             else
              begin
               ACBrNFe1.Configuracoes.Geral.ModeloDF := moNFe;
               gTN                                   := '\NFe\';
               if not (DMNFe.ZQuery3['nfe_demi']      = null) then
                gDataEmi                             := (DMNFe.ZQuery3['nfe_demi']);
              end;

             //-----------------------------------------------------------------
             // by Edson Lima - 2015-12-18T1559 ; verifica se a situação está null,
             // se sim elimina qualquer xml do sistema, para evitar envio de xml
             // depois de correção e exclusão-----------------------------------
             if ( (DMNFe.ZQuery3['nfe_situacao'] =  null) and ( not (gDataEmi = null))   or
                  (DMNFe.ZQuery3['nfe_situacao'] =  '')   and ( not (gDataEmi = null)) ) then
              pEliminaXml(aux, gTN); // Elimina os xmls quando a situação for null

             //-------------------------------------------------------------------

             //-----------------------------------------------------------------
             // by Edson ; 04/12/2012 ; 10:22 ; Testa se a NFe já foi enviada e
             //                                 aguarda retorno da SEFAZ
             //-----------------------------------------------------------------
             // 2016-1-20T1415 - Implementado para resolber mensagem de não
             // envio para sefaz
             //-----------------------------------------------------------------
             vCon := trim(gCamLog) + trim(Aux) + '-nfe.xml';
             if ( (FileExists(vCon)) and ( DMNFe.ZQuery3['nfe_situacao'] <>  null ) ) then
              begin
               vMens := 'Verificando a existencia da NFe Nº' + vartostr(DMNFe.ZQuery3['nfe_nnf']) + ' na SEFAZ !';

               gExcluir := True;                                                  // Seta variável global para ler somente um registro
               BitBtn8Click(Sender);                                              // Força um click na consulta
               gExcluir := False;                                                 // Seta variável global para ler varios registros

               if gDeuErrConsiste then Exit;                                      // Aborta no caso de erro

               // Caso não exista na base sefaz permite excluir ; by Edson Lima ; 17-9-2012 ; 14:00
               if ( (vartostr(ACBrNFe1.WebServices.Consulta.cStat) > '0') and
                    (vartostr(ACBrNFe1.WebServices.Consulta.cStat) <> '217') ) then
                begin
                 MessageDlg('Esta nota: ' + vartostr(DMNFe.ZQuery3['nfe_nnf']) + ' consta na base SEFAZ' + chr(13) + 'não pode ser gerada em contingência ' + AnsiUpperCase(_tipo_emissao) + '!', mtInformation,[mbOK],0);
                 exit;
                end;
               vMens := '';
              end;

             //*******************************************************************

             if ((copy(vartostr(DMNFe.ZQuery3['nfe_situacao']),1,4) = 'FSDA') or
                 (copy(vartostr(DMNFe.ZQuery3['nfe_situacao']),1,4) = 'OFFL')) then
              begin
               MessageDlg('Esta nota: ' + vartostr(DMNFe.ZQuery3['nfe_nnf']) + ' foi gerada em contingência, não será gerada novamente', mtInformation,[mbOK],0);
              end
             else
              begin
               vAux         :=   DMNFe.ZQuery3['nfe_nnf'];
               _nota        :=   DMNFe.ZQuery3['nfe_nnf'];
               _demi        :=   DMNFe.ZQuery3['nfe_demi'];

               geraenvianf(FrGBNFe);

               if gDeuErrConsiste then Exit;

               xAux := trim(gCamLog) + trim(gChave_Consiste) + '-nfe.xml';
               ACBrNFe1.NotasFiscais.Clear;
               ACBrNFe1.NotasFiscais.LoadFromFile(xAux);

               grava_xml_no_banco;

              end;
            end

           else

            { Mostra mensagem de inconsistencia para tentativa de geração de
              nfce (modelo 65) em contingência.                                 }
            begin
             Application.Messagebox(pchar('O ENVIO DO MODELO NFCe EM CONTINGÊNCIA ESTÁ' + char(13) +
                                          'INDISPONÍVEL, ENVIE A NOTA Nº ' + vartostr(DMNFe.ZQuery3['nfe_nnf']) + ', NO MODO NORMAL!'), 'ENVIO DE NFCe - ATENÇÃO', mb_iconstop+mb_ok);
            end;

          end;
          DMNFe.ZQuery3.Next;
        end;
       except
        // by Edson ; 2013-03-29T08:12 ; Mostra mensagens de erro do ACBr.
        ACBrNFe1.NotasFiscais.Validar;
        // By Edson Lima - 1-2-2012 - Ler Arquivos txt e Atualiza
        pAtuNFe;
       end;
      end;
      /// By Edson Lima - 1-2-2012 - Ler Arquivos txt e Atualiza
      pAtuNFe;                                                                  // Procedure de atualização

      exit;
    end;

   //--------------------------------------------------------------------------
   // PENDENTES - NORMAL
   if not RadioButton1.Checked then exit;

   _tipo_emissao := 'normal';
   _tpemissao := '1';

   DMNFe.ZQuery3.first;
   try // by Edson Lima ; 2013/03/05 ; 15:20 ; Linha incluida para controlar o sistema de atualização
   while ((not DMNFe.ZQuery3.eof) and (DMNFe.ZQuery3['nfe_nnf'] <> Null))  do
    begin

     DMNFe.ZQuery3.FieldByName('Checado').ReadOnly := False;

     if DMNFe.ZQuery3['Checado'] = 'Y' then
      begin

       if ( gCpt = 1 ) then
        pDefineRel()                                                            // Define o tipo de Relatório FortesReport
       else
        pDefineRelFR();                                                         // Define o tipo de Relatório FastReport

       //*******************************************************************************
       // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update
       gCdloja_Consiste := dxSpinEdit1.Text;
       gdEmi_Consiste   := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery3['nfe_demi']);
       gNNF_Consiste    := vartostr(DMNFe.ZQuery3['nfe_nnf']);
       gSerie_Consiste  := vartostr(DMNFe.ZQuery3['nfe_serie']);
       gSerie           := StrToInt(gSerie_Consiste);
       gModelo          := DMNFe.ZQuery3['nfe_modelo'];
       gChave_Consiste  := '';                                                  // está sendo atribuida depois da sp_calcula_digito_chave

       gDataEmi := NullDate;
       aux := VarToStr(DMNFe.ZQuery3['nfe_chave_nfe']);

       if (gModelo = 65) then
        begin
         ACBrNFe1.Configuracoes.Geral.ModeloDF := moNFCe;
         gTN                                   := '\NFCe\';
         if not (DMNFe.ZQuery3['nfe_DatNFCe']   = null) then
          gDataEmi                             := (DMNFe.ZQuery3['nfe_DatNFCe']);
        end
       else
        begin
         ACBrNFe1.Configuracoes.Geral.ModeloDF := moNFe;
         gTN                                   := '\NFe\';
         if not (DMNFe.ZQuery3['nfe_demi']      = null) then
          gDataEmi                             := (DMNFe.ZQuery3['nfe_demi']);
        end;

       //-------------------------------------------------------------------
       // by Edson Lima - 2015-12-18T1559 ; verifica se a situação está null,
       // se sim elimina qualquer xml do sistema, para evitar envio de xml
       // depois de correção e exclusão-------------------------------------
       if ((copy(vartostr(DMNFe.ZQuery3['nfe_situacao']),1,4) = 'FSDA') or
           (copy(vartostr(DMNFe.ZQuery3['nfe_situacao']),1,4) = 'OFFL')) then
        begin
         MessageDlg('Esta nota: ' + vartostr(DMNFe.ZQuery3['nfe_nnf']) + ' foi gerada em contingência, não será gerada novamente', mtInformation,[mbOK],0);
        end
       else
        begin

         if gGeraXML then
          vDmsg := 'Confirme a geração do xml da nota: ['
         else
          vDmsg := 'Confirme o processo de envio da nota: [';

         if MessageDlg(vDmsg + gNNF_Consiste + ' ]', mtConfirmation, [mbYes, mbNo], 0) = mrYes then
          begin
           vAux         := DMNFe.ZQuery3['nfe_nnf'];
           _nota        := DMNFe.ZQuery3['nfe_nnf'];
           _demi        := DMNFe.ZQuery3['nfe_demi'];

           geraenvianf(FrGBNFe);

           if gGeraXml then
            Application.Messagebox(pchar('Pronto, já foi gerado o xml da nota: [' + gNNF_Consiste + ' ]'), 'Gerar XML:',MB_ICONINFORMATION+mb_ok)
           else
            begin
             // by Edson Lima ; 2013/03/11 ; 06:57 ; com essa nova abordágem, é possível a continuação após uma rejeição e verificado seu codigo de retorno ;
             if (vartostr(ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[0].cStat) <> '100') and
                (vartostr(ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[0].cStat) <> '150') then exit;
             // by Edson Lima ; 2013/03/04 ; 09:26 ; se der erro de consistencia aborta processo

             if gDeuErrConsiste then Exit;

             xAux := vartostr(ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[0].chNFe);
             if xAux <> '' then
              begin

               xAux := trim(gCamLog) + trim(xAux) + '-nfe.xml'; /// by EL - 23.2.2012 -> xAux := trim(FrPar.edtPathLogs.Text) + '\' + trim(xAux) + '-nfe.xml';
               ACBrNFe1.NotasFiscais.Clear;
               ACBrNFe1.NotasFiscais.LoadFromFile(xAux);

               grava_xml_no_banco;

               //---------------------enviar email
               xAux := vartostr(ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[0].chNFe);
               //pega os dados do destinatario
               DMNFe.ZQuery2.Close;
               DMNFe.ZQuery2.SQL.Clear;
               DMNFe.ZQuery2.SQL.Add( 'Select                                                     ' );
               DMNFe.ZQuery2.SQL.Add( 't1.*                                                       ' );
               DMNFe.ZQuery2.SQL.Add( 'from destinatario t1                                       ' );
               DMNFe.ZQuery2.SQL.Add( 'inner join nfe t2 on t2.codigo_destinatario = t1.codigo    ' );
               DMNFe.ZQuery2.SQL.Add( 'where t2.codigo_loja = :parm1                              ' );
               DMNFe.ZQuery2.SQL.Add( 'and t2.chave_nfe = :parm2                                  ' );
               DMNFe.ZQuery2.SQL.Add( 'and t2.situacao <> :parm3                                  ' );
               DMNFe.ZQuery2.SQL.Add( 'and t2.situacao <> :parm4                                  ' );
               DMNFe.ZQuery2.Params[0].AsInteger := dxSpinEdit1.intValue;
               DMNFe.ZQuery2.Params[1].AsString  := (xAux);
               DMNFe.ZQuery2.Params[2].AsString  := '101';
               DMNFe.ZQuery2.Params[3].AsString  := '151';
               DMNFe.ZQuery2.Open;
               if DMNFe.ZQuery2.IsEmpty then
                begin
                 exit;
                end;

               para := vartostr(DMNFe.ZQuery2['email']);

               if ( (trim(para) = '') or (FrPar.CheckBox10.Checked) ) then
                begin
                 // By Edson Lima - 2016-6-30T1143 - Verifica o email do destinatário
                 while (not fValidaEmail(para)) do
                  begin
                   Para := '';
                   if not(InputQuery(vartostr(DMNFe.ZQuery2['razao_social']), 'Email de destino:', Para)) then exit;
                   if (not fValidaEmail(para)) then
                    Application.Messagebox('Campo de email do destinatário inválido! ','Atenção!',mb_iconstop+mb_ok);
                  end;
                end;

               if (trim(para) <> '') then
                begin

                 pAux := trim(gCamPdf) + trim(xAux) + '-nfe.pdf';                 // trunk2 - novo ; caminho e nome do danf pdf

                 xAux := trim(gCamLog) + trim(xAux) + '-nfe.xml';

                 ACBrNFe1.NotasFiscais.Clear;
                 ACBrNFe1.NotasFiscais.LoadFromFile(xAux);
                 CC:=TstringList.Create;

                 if ( trim(FrPar.edtEnvCC.Text) <> '' ) then
                  for I := 1 to (Length(FrPar.edtEnvCC.Text)+1) do
                   begin
                    if (FrPar.edtEnvCC.Text[I] = ',') or (FrPar.edtEnvCC.Text[I] = ';') or (I = Length(FrPar.edtEnvCC.Text)+1)then
                     begin
                      CC.Add(trim(vI));                                           //especifique um email válido
                      vI := '';
                     end
                    else
                     vI := (vI + FrPar.edtEnvCC.Text[I]);
                   end;

                 vI := '';                                                        // Limpa variável
                 vC := 0;                                                         // zera contador

                 for I := 1 to (Length(Para)+1) do
                  begin
                   if (Para[I] = ',') or (Para[I] = ';') or (I = Length(Para)+1)then
                    begin
                     if vC > 0 then
                      CC.Add(trim(vI))                                            // Especifique um email válido
                     else
                      vP := trim(vI);                                             // Atribui apenas o primeiro email

                     vI := '';
                     inc(vC);                                                     // Incrementa 1
                    end
                   else
                    vI := (vI + Para[I]);
                  end;

                 Para := vP;

                 if not FileExists(pAux) then
                  ACBrNFe1.NotasFiscais.ImprimirPDF;

                 ACBrNFe1.NotasFiscais.Items[0].EnviarEmail(Para
                                                          , FrPar.edtEmailAssunto.Text + ' - Nº ' + VarToStr(DMNFe.ZQuery3['nfe_nnf'])
                                                          , FrPar.mmEmailMsg.Lines
                                                          , True                     //Enviar PDF junto
                                                          , CC                       //com copia
                                                          , nil
                                                           );
                 CC.Free;

                end;
              //---------------------final - enviar email
              end;
            end;
          end;
        end;
      end;
      DMNFe.ZQuery3.Next;
    end;
   except
    // by Edson ; 2013-03-29T08:12 ; Mostra mensagens de erro do ACBr.
    ACBrNFe1.NotasFiscais.Validar;
    // By Edson Lima - 1-2-2012 - Ler Arquivos txt e Atualiza
    pAtuNFe;                          // Procedure de atualização
   end;
  end;
 1: MenuItem2Click(Sender);                                                     // by EL 14.2.2012 ->  EM CONTINGÊNCIA
 end;
 // By Edson Lima - 1-2-2012 - Ler Arquivos txt e Atualiza
 pAtuNFe;                          // Procedure de atualização
end;

procedure TFrGBNFe.BitBtn8Click(Sender: TObject);
var
 aux, vDescr : string;
 iCodPed     : Integer;

begin

 ACBrNFe1.Configuracoes.Geral.VersaoDF := ve310;

 Case RadioGroup1.ItemIndex of
 0: // Pendentes
  begin
   if not gExcluir then DMNFe.ZQuery3.first;
   try
    while ((not DMNFe.ZQuery3.eof) and (DMNFe.ZQuery3['nfe_nnf'] <> Null)) do
     begin

      DMNFe.ZQuery3.FieldByName('Checado').ReadOnly := False;

      if DMNFe.ZQuery3['Checado'] = 'Y' then // Selecinado
       begin
        //*******************************************************************************
        // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update

        gModelo := DMNFe.ZQuery3['nfe_Modelo'];
        gSerie  := DMNFe.ZQuery3['nfe_Serie'];

        if ( gCpt = 1 ) then
         pDefineRel()                                                           // Define o tipo de Relatório FortesReport
        else
         pDefineRelFR();                                                        // Define o tipo de Relatório FastReport

        gCdloja_Consiste := dxSpinEdit1.Text;
        gdEmi_Consiste   := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery3['nfe_demi']);
        gDataEmi         := DMNFe.ZQuery3['nfe_demi'];                          // by Edson Lima 2015-10-14T1107 - trunk2 novo
        gNNF_Consiste    := vartostr(DMNFe.ZQuery3['nfe_nnf']);
        gSerie_Consiste  := vartostr(DMNFe.ZQuery3['nfe_serie']);
        gSerie           := StrToInt(gSerie_Consiste);
        gChave_Consiste  := '';                                                 // está sendo atribuida depois da sp_calcula_digito_chave

        if ((copy(vartostr(DMNFe.ZQuery3['nfe_situacao']),1,4) = 'FSDA') or
            (copy(vartostr(DMNFe.ZQuery3['nfe_situacao']),1,4) = 'OFFL')) then
         exit;

        _tpemissao := '1';                                                      // Normal

        Aux := '';
        Aux := dxSpinEdit1.Text + ',' + '''' + VarToStr(DMNFe.ZQuery3['nfe_nnf']) + '''' + ',' + '''' + _tpemissao + '''' + ',' + '''';
        Aux := Aux + FormatDateTime('yyyy/mm/dd', VarToDateTime(DMNFe.ZQuery3['nfe_demi'])) + '''' + ',' + '''';
        Aux := Aux + IntToStr(gModelo) + '''' + ',' + '''';
        Aux := Aux + VarToStr(DMNFe.ZQuery3['nfe_Serie']) + '''';

        DMNFe.ZQuery1.Close;
        DMNFe.ZQuery1.SQL.Clear;
        DMNFe.ZQuery1.SQL.Add( 'exec sp_calcula_digito_chave ' + Aux );
        DMNFe.ZQuery1.open;

        // by Edson Lima 2015-12-9T1007 - trunk2 novo
         vAux := '';
        if not DMNFe.ZQuery1.IsEmpty then
         vAux := vartostr(DMNFe.ZQuery1['chave']);

        if (trim(vAux) = '') then
         begin
          if (DMNFe.ZQuery3['nfe_chave_nfe'] <> null) and (DMNFe.ZQuery3['nfe_chave_nfe'] <> '') then
           vAux := DMNFe.ZQuery3['nfe_chave_nfe']
          else
           begin
            if not (InputQuery( pchar('Nota nº ' + vartostr(DMNFe.ZQuery3['nfe_nnf']) + ' sem chave!' ), 'Chave da nota:', vAux)) then
             exit;
           end;
         end;

        //----------------------------------------------------------------------
        // by Edson Lima ; 2017-1-5T1027 ; Atribuição de dados nas variáveis do
        //                                 gerente
        //----------------------------------------------------------------------
        gChvNFe := vAux;
        gCd_Emp := dxSpinEdit1.IntValue;
        if ( DMNFe.ZQuery3['nfe_CodPed'] <> null ) then
         gCodPed := DMNFe.ZQuery3['nfe_CodPed']
        else
         gCodPed := 0;
        //----------------------------------------------------------------------

        // by Edson ; 2013-10-8T1031 ; Variável Global Chave criada para contestar gravação;
        gChave_Consiste  := vAux;

        if (StrToInt(DMNFe.ZQuery3['nfe_modelo']) = 65) then
         gTN              := '\NFCe\'                                           // by Edson Lima 2015-10-14T1107 - trunk2 novo ; Global utilizado para setar o nome da pasta
        else
         gTN              := '\NFe\';                                           // by Edson Lima 2015-10-14T1107 - trunk2 novo ; Global utilizado para setar o nome da pasta

        Copia_Xml_PathLog(vAux, gTN);                                           // by Edson Lima 2015-10-14T1107 - trunk2 novo Copia o Xml da pasta oficial para a pasta Log

        if vAux <> '' then
         begin
          if (dxDateEdit1.Date > DMNFe.ZQuery3['nfe_demi']) then
           dxDateEdit1.Date := DMNFe.ZQuery3['nfe_demi'];

          vAux := trim(gCamLog) + trim(vAux) + '-nfe.xml';

          if FileExists(vAux) then
           begin
            ACBrNFe1.NotasFiscais.Clear;
            ACBrNFe1.NotasFiscais.LoadFromFile(vAux);
            if not (ACBrNFe1.Consultar) then
             begin
              showmessage('Foi encontrado erro no arquivo xml!');
              gDeuErrXml := True;
              if gExcluir then Exit;
             end
            else
             grava_xml_no_banco;
           end;

          if gModelo = 65 then
           begin
            vDescr := 'NFC-e PENDENTE:';
            Application.Messagebox(pchar('DADOS DA NFC-e : ' + vartostr(DMNFe.ZQuery3['nfe_nnf']) + char(13) +
                                         'Status=' + vartostr(ACBrNFe1.WebServices.Consulta.cStat)  + '-' + vartostr(ACBrNFe1.WebServices.Consulta.xMotivo) + char(13) +
                                         'Protocolo=' + ACBrNFe1.WebServices.Consulta.Protocolo + char(13) +
                                         'Data do recebimento=' + vartostr(ACBrNFe1.WebServices.Consulta.DhRecbto) + char(13)), pChar(vDescr), mb_iconstop+mb_ok);
           end
          else
           begin
            vDescr := 'NF-e PENDENTE:';
            Application.Messagebox(pchar('DADOS DA NF-e  : ' + vartostr(DMNFe.ZQuery3['nfe_nnf']) + char(13) +
                                         'Status=' + vartostr(ACBrNFe1.WebServices.Consulta.cStat)  + '-' + vartostr(ACBrNFe1.WebServices.Consulta.xMotivo) + char(13) +
                                         'Protocolo=' + ACBrNFe1.WebServices.Consulta.Protocolo + char(13) +
                                         'Data do recebimento=' + vartostr(ACBrNFe1.WebServices.Consulta.DhRecbto) + char(13)), pChar(vDescr), mb_iconstop+mb_ok);
           end;

          memoLog.Clear;
          MemoResp.Lines.Text   := UTF8Encode(ACBrNFe1.WebServices.Consulta.RetWS);
          MemoLog.Lines.Add(vDescr);
          MemoLog.Lines.Add('Status');
          MemoLog.Lines.Add('Tipo de Ambiente:'     + TpAmbToStr(ACBrNFe1.WebServices.Consulta.TpAmb));
          MemoLog.Lines.Add('Versão do Aplicativo: '+ ACBrNFe1.WebServices.Consulta.verAplic);
          MemoLog.Lines.Add('Código do Status: '    + IntToStr(ACBrNFe1.WebServices.Consulta.cStat));
          MemoLog.Lines.Add('Código da UF: '        + IntToStr(ACBrNFe1.WebServices.Consulta.cUF));
          MemoLog.Lines.Add('Descrição: '           + ACBrNFe1.WebServices.Consulta.xMotivo);
          MemoLog.Lines.Add('Mensagem: '            + ACBrNFe1.WebServices.Consulta.Msg);
          MemoLog.Lines.Add('Data do recebimento: ' + vartostr(ACBrNFe1.WebServices.Consulta.DhRecbto));
          MemoLog.Lines.Add('Protocolo: '           + ACBrNFe1.WebServices.Consulta.Protocolo);
          memoRespWS.Lines.Text := UTF8Encode(ACBrNFe1.WebServices.Consulta.RetornoWS);
          LoadXML(MemoResp, WBResposta);
         end;

         if (vartostr(ACBrNFe1.WebServices.Consulta.cStat) <> '217') then       // 217 = Não consta na base de dados sefaz
         begin
          gAtuCon := True;                                                      // seta True para gAtuCon

          // by Edson Lima ; 2013/03/12 ; 14:23 ; Atualiza a nfe no update centralizado
          pGravaNFe('006', 'protocolo', 'data_hora_recebimento',
                    'chave_nfe', 'situacao',  'motivo', '', '',
                    'codigo_loja', 'demi',      'nnf',       'serie', 'chave_nfe',
                    ACBrNFe1.WebServices.Consulta.Protocolo,
                    FormatDateTime('yyyy/mm/dd hh:nn:ss', ACBrNFe1.WebServices.consulta.DhRecbto),
                    ACBrNFe1.WebServices.Consulta.NFeChave,
                    ACBrNFe1.WebServices.Consulta.cStat,
                    ACBrNFe1.WebServices.Consulta.xMotivo,
                    '',
                    '',
                    dxSpinEdit1.IntValue,
                    FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery3['nfe_demi']),
                    DMNFe.ZQuery3['nfe_nnf'],
                    DMNFe.ZQuery3['nfe_serie'],
                    ACBrNFe1.WebServices.Consulta.NFeChave, true);

          //-----------------------------------------------------------------
          // by Edson Lima ; 2017-1-5T1054 ; Grava a chave no pedido do gerente
          if ( (vartostr(ACBrNFe1.WebServices.Consulta.cStat) = '100') or
               (vartostr(ACBrNFe1.WebServices.Consulta.cStat) = '150') ) then
           fGraGer();
          //-----------------------------------------------------------------

         end;
       end;

      if gExcluir then
       exit
      else
       DMNFe.ZQuery3.Next;

     end;
   except
    // by Edson ; 2013-03-29T08:12 ; Mostra mensagens de erro do ACBr.
    ACBrNFe1.NotasFiscais.Validar;
    // by Edson Lima ; 2013/02/26 ; 16:03 ; Atualiza Grid
    pAtuNFe();
   end;
  end;

 1:  // Contigência
  begin
   if not gAtuFSD then
    begin
     gReConsulta := True;
     ConsultarnotaemFSDA1Click(Sender);
    end
   else
    begin
     DMNFe.ZQuery10.first;
     try
      while ((not DMNFe.ZQuery10.eof) and (DMNFe.ZQuery10['nfe_nnf'] <> Null)) do
       begin

        DMNFe.ZQuery10.FieldByName('Checado').ReadOnly := False;

        if DMNFe.ZQuery10['Checado'] = 'Y' then
         begin
          //*******************************************************************************
          // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update

          gModelo := DMNFe.ZQuery10['nfe_Modelo'];
          gSerie  := DMNFe.ZQuery10['nfe_Serie'];

          if ( gCpt = 1 ) then
           pDefineRel()                                                         // Define o tipo de Relatório FortesReport
          else
           pDefineRelFR();                                                      // Define o tipo de Relatório FastReport

          gCdloja_Consiste := dxSpinEdit1.Text;
          gdEmi_Consiste   := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery10['nfe_demi']);
          gDataEmi         := DMNFe.ZQuery10['nfe_demi'];                       // by Edson Lima 2015-10-14T1107 - trunk2 novo
          gNNF_Consiste    := vartostr(DMNFe.ZQuery10['nfe_nnf']);
          gSerie_Consiste  := vartostr(DMNFe.ZQuery10['nfe_serie']);
          gSerie           := StrToInt(gSerie_Consiste);
          gChave_Consiste  := '';                                               // está sendo atribuida depois da sp_calcula_digito_chave

          //caso não tenha gravado a nota, calcula a chave e a procura
          if (gModelo = 55) then
           _tpemissao := '5'
          else if (gModelo = 65) then
           _tpemissao := '9';

          aux := '';
          aux := dxSpinEdit1.Text + ',' + '''' + VarToStr(DMNFe.ZQuery10['nfe_nnf']) + '''' + ',' + '''' + _tpemissao + '''' + ',' + '''';
          aux := aux + FormatDateTime('yyyy/mm/dd', VarToDateTime(DMNFe.ZQuery10['nfe_demi'])) + '''' + ',' + '''';
          aux := aux + IntToStr(gModelo) + '''' + ',' + '''';
          aux := aux + IntToStr(gSerie) + '''';

          DMNFe.ZQuery1.Close;
          DMNFe.ZQuery1.SQL.Clear;
          DMNFe.ZQuery1.SQL.Add( 'exec sp_calcula_digito_chave ' + aux );
          DMNFe.ZQuery1.open;

          if not DMNFe.ZQuery1.IsEmpty then
           vAux := vartostr(DMNFe.ZQuery1['chave']);

          //----------------------------------------------------------------------
          // by Edson Lima ; 2017-1-5T1027 ; Atribuição de dados nas variáveis do
          //                                 gerente
          //----------------------------------------------------------------------
          gChvNFe := vAux;
          gCd_Emp := dxSpinEdit1.IntValue;
          if ( DMNFe.ZQuery1['nfe_CodPed'] <> null ) then
           gCodPed := DMNFe.ZQuery1['nfe_CodPed']
          else
           gCodPed := 0;
          //----------------------------------------------------------------------

          // by Edson ; 2013-10-8T1031 ; Variável Global Chave criada para contestar gravação;
          gChave_Consiste  := vAux;

          if (StrToInt(DMNFe.ZQuery1['nfe_modelo']) = 65) then
           gTN              := '\NFCe\'                                         // by Edson Lima 2015-10-14T1107 - trunk2 novo ; Global utilizado para setar o nome da pasta
          else
           gTN              := '\NFe\';                                         // by Edson Lima 2015-10-14T1107 - trunk2 novo ; Global utilizado para setar o nome da pasta

          Copia_Xml_PathLog(vAux, gTN);                                         // by Edson Lima 2015-10-14T1107 - trunk2 novo

          if vAux <> '' then
           begin
            if (dxDateEdit1.Date > DMNFe.ZQuery10['nfe_demi']) then             /// by Edson Lima ; 18/6/2012 ; 17:07
              dxDateEdit1.Date := DMNFe.ZQuery10['nfe_demi'];                   // Atualiza da data

            vAux := trim(gCamLog) + trim(vAux) + '-nfe.xml';
            ACBrNFe1.NotasFiscais.Clear;
            ACBrNFe1.NotasFiscais.LoadFromFile(vAux);
            if not (ACBrNFe1.Consultar) then
             begin
              showmessage('Foi encontrado erro no arquivo xml!');
              gDeuErrXml := True;
             end
            else
             grava_xml_no_banco;

            if gModelo = 65 then
             begin
              vDescr := 'NFC-e CONTINGÊNCIA:';
              Application.Messagebox(pchar('DADOS DA NFC-e : ' + vartostr(DMNFe.ZQuery5['nfe_nnf']) + char(13) +
                                           'Status=' + vartostr(ACBrNFe1.WebServices.Consulta.cStat)  + '-' + vartostr(ACBrNFe1.WebServices.Consulta.xMotivo) + char(13) +
                                           'Protocolo=' + ACBrNFe1.WebServices.Consulta.Protocolo + char(13) +
                                           'Data do recebimento=' + vartostr(ACBrNFe1.WebServices.Consulta.DhRecbto) + char(13)), pChar(vDescr), mb_iconstop+mb_ok);
             end
            else
             begin
              vDescr := 'NF-e CONTINGÊNCIA:';
              Application.Messagebox(pchar('DADOS DA NF-e  : ' + vartostr(DMNFe.ZQuery5['nfe_nnf']) + char(13) +
                                           'Status=' + vartostr(ACBrNFe1.WebServices.Consulta.cStat)  + '-' + vartostr(ACBrNFe1.WebServices.Consulta.xMotivo) + char(13) +
                                           'Protocolo=' + ACBrNFe1.WebServices.Consulta.Protocolo + char(13) +
                                           'Data do recebimento=' + vartostr(ACBrNFe1.WebServices.Consulta.DhRecbto) + char(13)), pChar(vDescr), mb_iconstop+mb_ok);
             end;

            memoLog.Clear;
            MemoResp.Lines.Text   := UTF8Encode(ACBrNFe1.WebServices.Consulta.RetWS);
            MemoLog.Lines.Add(vDescr);
            MemoLog.Lines.Add('Status');
            MemoLog.Lines.Add('Tipo de Ambiente:'     + TpAmbToStr(ACBrNFe1.WebServices.Consulta.TpAmb));
            MemoLog.Lines.Add('Versão do Aplicativo: '+ ACBrNFe1.WebServices.Consulta.verAplic);
            MemoLog.Lines.Add('Código do Status: '    + IntToStr(ACBrNFe1.WebServices.Consulta.cStat));
            MemoLog.Lines.Add('Código da UF: '        + IntToStr(ACBrNFe1.WebServices.Consulta.cUF));
            MemoLog.Lines.Add('Descrição: '           + ACBrNFe1.WebServices.Consulta.xMotivo);
            MemoLog.Lines.Add('Mensagem: '            + ACBrNFe1.WebServices.Consulta.Msg);
            MemoLog.Lines.Add('Data do recebimento: ' + vartostr(ACBrNFe1.WebServices.Consulta.DhRecbto));
            MemoLog.Lines.Add('Protocolo: '           + ACBrNFe1.WebServices.Consulta.Protocolo);
            memoRespWS.Lines.Text := UTF8Encode(ACBrNFe1.WebServices.Consulta.RetornoWS);
            LoadXML(MemoResp, WBResposta);
           end;

          if vartostr(ACBrNFe1.WebServices.Consulta.cStat) <> '217' then
           begin
            gAtuCon := True;                                       // seta True para gAtuCon

            // by Edson Lima ; 2013/03/12 ; 14:23 ; Atualiza a nfe no update centralizado
            pGravaNFe('007', 'protocolo', 'recibo', 'data_hora_recebimento',
                      'chave_nfe', 'situacao',  'motivo', '', 'codigo_loja',
                      'demi',      'nnf',       'serie', 'chave_nfe',
                      ACBrNFe1.WebServices.Consulta.Protocolo,
                      ACBrNFe1.WebServices.Retorno.NFeRetorno.nRec,
                      FormatDateTime('yyyy/mm/dd hh:nn:ss', ACBrNFe1.WebServices.consulta.DhRecbto),
                      ACBrNFe1.WebServices.Consulta.NFeChave,
                      ACBrNFe1.WebServices.Consulta.cStat,
                      ACBrNFe1.WebServices.Consulta.xMotivo,
                      '',
                      dxSpinEdit1.IntValue,
                      FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery10['nfe_demi']),
                      DMNFe.ZQuery10['nfe_nnf'],
                      DMNFe.ZQuery10['nfe_serie'],
                      ACBrNFe1.WebServices.Consulta.NFeChave, true);

            //-----------------------------------------------------------------
            // by Edson Lima ; 2017-1-5T1054 ; Grava a chave no pedido do gerente
            if ( (vartostr(ACBrNFe1.WebServices.Consulta.cStat) = '100') or
                 (vartostr(ACBrNFe1.WebServices.Consulta.cStat) = '150') ) then
             fGraGer();
            //-----------------------------------------------------------------

           end;

        end;
        DMNFe.ZQuery10.Next;
       end;
     except
      // by Edson ; 2013-03-29T08:12 ; Mostra mensagens de erro do ACBr.
      ACBrNFe1.NotasFiscais.Validar;
      // by Edson Lima ; 2013/02/26 ; 16:03 ; Atualiza Grid
      pAtuNFe();
     end;
    end;
   end;

 2:  // Transmitidas
  begin
   DMNFe.ZQuery5.first;
   while ((not DMNFe.ZQuery5.eof) and (DMNFe.ZQuery5['nfe_nnf'] <> Null)) do
    begin

     DMNFe.ZQuery5.FieldByName('Checado').ReadOnly := False;

     if DMNFe.ZQuery5['Checado'] = 'Y' then
      begin
       //*******************************************************************************
       // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update

       gModelo := DMNFe.ZQuery5['nfe_Modelo'];
       gSerie  := DMNFe.ZQuery5['nfe_Serie'];

       if ( gCpt = 1 ) then
        pDefineRel()                                                            // Define o tipo de Relatório FortesReport
       else
        pDefineRelFR();                                                         // Define o tipo de Relatório FastReport

       gCdloja_Consiste := dxSpinEdit1.Text;
       gdEmi_Consiste   := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery5['nfe_demi']);
       gDataEmi         := DMNFe.ZQuery5['nfe_demi'];                           // by Edson Lima 2015-10-14T1107 - trunk2 novo
       gNNF_Consiste    := vartostr(DMNFe.ZQuery5['nfe_nnf']);
       gSerie_Consiste  := vartostr(DMNFe.ZQuery5['nfe_serie']);
       gSerie           := StrToInt(gSerie_Consiste);
       gChave_Consiste  := DMNFe.ZQuery5['nfe_chave_nfe'];                                                  // está sendo atribuida depois da sp_calcula_digito_chave

       vAux             := DMNFe.ZQuery5['nfe_chave_nfe'];

       if not ( DMNFe.ZQuery5['nfe_CodPed'] = null ) then
        iCodPed := DMNFe.ZQuery5['nfe_CodPed']
       else
        iCodPed := 0;

       //----------------------------------------------------------------------
       // by Edson Lima ; 2017-1-5T1027 ; Atribuição de dados nas variáveis do
       //                                 gerente
       //----------------------------------------------------------------------
       gChvNFe := vAux;
       gCd_Emp := dxSpinEdit1.IntValue;
       if ( DMNFe.ZQuery5['nfe_CodPed'] <> null ) then
        gCodPed := DMNFe.ZQuery5['nfe_CodPed']
       else
        gCodPed := 0;
       //----------------------------------------------------------------------

       if (StrToInt(DMNFe.ZQuery5['nfe_modelo']) = 65) then
        gTN              := '\NFCe\'                                            // by Edson Lima 2015-10-14T1107 - trunk2 novo ; Global utilizado para setar o nome da pasta
       else
        gTN              := '\NFe\';                                            // by Edson Lima 2015-10-14T1107 - trunk2 novo ; Global utilizado para setar o nome da pasta

       Copia_Xml_PathLog(vAux, gTN);                                            // by Edson Lima 2015-10-14T1107 - trunk2 novo

       if vAux <> '' then
        begin

         // Consulta Transmitidas
         vAux := trim(gCamLog) + trim(vAux) + '-nfe.xml';
         ACBrNFe1.NotasFiscais.Clear;
         ACBrNFe1.NotasFiscais.LoadFromFile(vAux);
         ACBrNFe1.Consultar;

         if gModelo = 65 then
          begin
           vDescr := 'NFC-e TRANSMITIDA:';
           Application.Messagebox(pchar('DADOS DA NFC-e : ' + vartostr(DMNFe.ZQuery5['nfe_nnf']) + char(13) +
                                        'Status=' + vartostr(ACBrNFe1.WebServices.Consulta.cStat)  + '-' + vartostr(ACBrNFe1.WebServices.Consulta.xMotivo) + char(13) +
                                        'Protocolo=' + ACBrNFe1.WebServices.Consulta.Protocolo + char(13) +
                                        'Data do recebimento=' + vartostr(ACBrNFe1.WebServices.Consulta.DhRecbto) + char(13)), pChar(vDescr), mb_iconstop+mb_ok);
          end
         else
          begin
           vDescr := 'NF-e TRANSMITIDA:';
           Application.Messagebox(pchar('DADOS DA NF-e  : ' + vartostr(DMNFe.ZQuery5['nfe_nnf']) + char(13) +
                                        'Status=' + vartostr(ACBrNFe1.WebServices.Consulta.cStat)  + '-' + vartostr(ACBrNFe1.WebServices.Consulta.xMotivo) + char(13) +
                                        'Protocolo=' + ACBrNFe1.WebServices.Consulta.Protocolo + char(13) +
                                        'Data do recebimento=' + vartostr(ACBrNFe1.WebServices.Consulta.DhRecbto) + char(13)), pChar(vDescr), mb_iconstop+mb_ok);
          end;

         memoLog.Clear;
         MemoResp.Lines.Text   := UTF8Encode(ACBrNFe1.WebServices.Consulta.RetWS);
         MemoLog.Lines.Add(vDescr);
         MemoLog.Lines.Add('Status');
         MemoLog.Lines.Add('Tipo de Ambiente:'     + TpAmbToStr(ACBrNFe1.WebServices.Consulta.TpAmb));
         MemoLog.Lines.Add('Versão do Aplicativo: '+ ACBrNFe1.WebServices.Consulta.verAplic);
         MemoLog.Lines.Add('Código do Status: '    + IntToStr(ACBrNFe1.WebServices.Consulta.cStat));
         MemoLog.Lines.Add('Código da UF: '        + IntToStr(ACBrNFe1.WebServices.Consulta.cUF));
         MemoLog.Lines.Add('Descrição: '           + ACBrNFe1.WebServices.Consulta.xMotivo);
         MemoLog.Lines.Add('Mensagem: '            + ACBrNFe1.WebServices.Consulta.Msg);
         MemoLog.Lines.Add('Data do recebimento: ' + vartostr(ACBrNFe1.WebServices.Consulta.DhRecbto));
         MemoLog.Lines.Add('Protocolo: '           + ACBrNFe1.WebServices.Consulta.Protocolo);
         memoRespWS.Lines.Text := UTF8Encode(ACBrNFe1.WebServices.Consulta.RetornoWS);
         LoadXML(MemoResp, WBResposta);
        end;

       if vartostr(ACBrNFe1.WebServices.Consulta.cStat) <> '217' then
        begin
         gAtuCon := True;                                       // seta True para gAtuCon

         // by Edson Lima ; 2013/03/12 ; 14:23 ; Atualiza a nfe no update centralizado
         pGravaNFe('007', 'protocolo', 'recibo', 'data_hora_recebimento',
                   'chave_nfe', 'situacao',  'motivo', '', 'codigo_loja',
                   'demi',      'nnf',       'serie', 'chave_nfe',
                   ACBrNFe1.WebServices.Consulta.Protocolo,
                   ACBrNFe1.WebServices.Retorno.NFeRetorno.nRec,
                   FormatDateTime('yyyy/mm/dd hh:nn:ss', ACBrNFe1.WebServices.consulta.DhRecbto),
                   ACBrNFe1.WebServices.Consulta.NFeChave,
                   ACBrNFe1.WebServices.Consulta.cStat,
                   ACBrNFe1.WebServices.Consulta.xMotivo,
                   '',
                   dxSpinEdit1.IntValue,
                   FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery5['nfe_demi']),
                   DMNFe.ZQuery5['nfe_nnf'],
                   DMNFe.ZQuery5['nfe_serie'],
                   ACBrNFe1.WebServices.Consulta.NFeChave, true);

         //---------------------------------------------------------------------
         // by Edson Lima ; 2017-1-5T1054 ; Grava a chave no pedido do gerente
         if ( (vartostr(ACBrNFe1.WebServices.Consulta.cStat) = '100') or
              (vartostr(ACBrNFe1.WebServices.Consulta.cStat) = '150') ) then
          fGraGer();
         //---------------------------------------------------------------------

         //---------------------------------------------------------------------
         // by Edson Lima ; 2017-1-11T1031
         // Efetua o Cancelamento Administrativo do PEDIDO
         //---------------------------------------------------------------------
         if ( (vartostr(ACBrNFe1.WebServices.Consulta.cStat) = '101') or
              (vartostr(ACBrNFe1.WebServices.Consulta.cStat) = '135') or
              (vartostr(ACBrNFe1.WebServices.Consulta.cStat) = '136') or
              (vartostr(ACBrNFe1.WebServices.Consulta.cStat) = '151') or
              (vartostr(ACBrNFe1.WebServices.Consulta.cStat) = '155') ) then
          begin

           if iCodPed <> 0 then
            begin
             if not ( fCanCAP(StrToInt(gNNF_Consiste), dxSpinEdit1.IntValue, iCodPed, gCodMtC) ) then
              Application.MessageBox(PChar('Nota cancelada, mas o pedido não!'), 'Atenção', MB_ICONINFORMATION );
            end
           else
            Application.MessageBox(PChar('Número do pedido não informado! Nota cancelada, mas Pedido não!'), 'Atenção', MB_ICONINFORMATION );

          end;
         //--------------------------------------------------------------------

        end;

      end;
      DMNFe.ZQuery5.Next;
    end;
  end;
 end;
 pAtuNFe();   // by Edson Lima ; 2013/02/26 ; 16:03 ; Atualiza Grid
end;

procedure TFrGBNFe.Excluinota1Click(Sender: TObject);
var
 aux    : string;
 dt     : TDateTime;
 vDescr : string;
 vTN    : string;

begin

 //-----------------------------------------------------------------------------
 if (RadioGroup1.ItemIndex = 0) then
  begin
   // by Edson Lima ; 2013-7-17T1024 ; Chama a procedure de atribuição de seleção da TreeList das pendentes
   pAtribSel(dxTLPend, dxTLCPendDateDemi, dxTLCPendSpinNot, dxTLCPendMaskMod, dxTLCPendMaskSer, DMNFe.ZQuery3);
   vTN := 'pendentes';
  end
 else if (RadioGroup1.ItemIndex = 1) then
  begin
   // by Edson Lima ; 2016-9-15T1153 ; Chama a procedure de atribuição de seleção da TreeList das contingências
   pAtribSel(dxTLCont, dxTLCContDateDemi, dxTLCContSpinNot, dxTLCContMaskMod, dxTLCContMaskSer, DMNFe.ZQuery10);
   vTN := 'em contingência';
  end;

 if MessageDlg('Continua o processo da exclusão de notas ' + vTN + '?', mtConfirmation, [mbYes, mbNo], 0) = mrYes then
  begin

   //---------------------------------------------------------------------------
   if ( RadioGroup1.ItemIndex = 0 ) then                                        // Pendentes
   //---------------------------------------------------------------------------

    begin

     DMNFe.ZQuery3.first;
     while ((not DMNFe.ZQuery3.eof) and (DMNFe.ZQuery3['nfe_nnf'] <> Null)) do
      begin

       DMNFe.ZQuery3.FieldByName('Checado').ReadOnly := False;

       if DMNFe.ZQuery3['Checado'] = 'Y' then
        begin
         //*******************************************************************************
         // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update

         gDeuErrXml := False;
         gModelo    := DMNFe.ZQuery3['nfe_Modelo'];
         gSerie     := DMNFe.ZQuery3['nfe_Serie'];

         if ( gCpt = 1 ) then
          pDefineRel()                                                          // Define o tipo de Relatório FortesReport
         else
          pDefineRelFR();                                                       // Define o tipo de Relatório FastReport

         dt       := DMNFe.ZQuery3['nfe_demi'];
         vAux     := vartostr(DMNFe.ZQuery3['nfe_nnf']);

         _tpemissao := '1';

         if ( (gModelo = 55) and (RadioButton3.Checked) ) then
          begin
           _tipo_emissao := 'fsda';
           _tpemissao := '5';
          end
         else if ( (gModelo = 65) and (RadioButton3.Checked) ) then
          begin
           _tipo_emissao := 'OffL';
           _tpemissao := '9';
          end;

         Aux := '';
         Aux := dxSpinEdit1.Text + ',' + '''' + VarToStr(DMNFe.ZQuery3['nfe_nnf']) + '''' + ',' + '''' + _tpemissao + '''' + ',' + '''';
         Aux := Aux + FormatDateTime('yyyy/mm/dd', VarToDateTime(DMNFe.ZQuery3['nfe_demi'])) + '''' + ',' + '''';
         Aux := Aux + IntToStr(gModelo) + '''' + ',' + '''';
         Aux := Aux + VarToStr(DMNFe.ZQuery3['nfe_Serie']) + '''';

         DMNFe.ZQuery1.Close;
         DMNFe.ZQuery1.SQL.Clear;
         DMNFe.ZQuery1.SQL.Add( 'exec sp_calcula_digito_chave ' + Aux );
         DMNFe.ZQuery1.open;

         // by Edson Lima 2015-12-9T1007 - trunk2 novo
         vAux := '';
         if not DMNFe.ZQuery1.IsEmpty then
          vAux := vartostr(DMNFe.ZQuery1['chave']);

         // by Edson ; 2013-10-8T1031 ; Variável Global Chave criada para contestar gravação;
         gChave_Consiste  := vAux;

         if (gModelo = 65) then
          begin
           gTN                                   := '\NFCe\';
           if not (DMNFe.ZQuery3['nfe_DatNFCe']   = null) then
            gDataEmi                             := (DMNFe.ZQuery3['nfe_DatNFCe']);
          end
         else
          begin
           gTN                                   := '\NFe\';
           if not (DMNFe.ZQuery3['nfe_demi']      = null) then
            gDataEmi                             := (DMNFe.ZQuery3['nfe_demi']);
          end;

          if vAux <> '' then
           begin

            // Ajusta a data inicial para a data de emissão
            if (dxDateEdit1.Date > DMNFe.ZQuery3['nfe_demi']) then
             dxDateEdit1.Date := DMNFe.ZQuery3['nfe_demi'];

            vAux := trim(gCamLog) + trim(vAux) + '-nfe.xml';

            if FileExists(vAux) then
             begin

              gAtuCon := True;

              Copia_Xml_PathLog(Aux, gTN);

              ACBrNFe1.NotasFiscais.Clear;
              ACBrNFe1.NotasFiscais.LoadFromFile(vAux);
              ACBrNFe1.Consultar;

              if gModelo = 65 then
               begin
                vDescr := 'NFC-e PENDENTE:';
                Application.Messagebox(pchar('DADOS DA NFC-e : ' + vartostr(DMNFe.ZQuery3['nfe_nnf']) + char(13) +
                                             'Status=' + vartostr(ACBrNFe1.WebServices.Consulta.cStat)  + '-' + vartostr(ACBrNFe1.WebServices.Consulta.xMotivo) + char(13) +
                                             'Protocolo=' + ACBrNFe1.WebServices.Consulta.Protocolo + char(13) +
                                             'Data do recebimento=' + vartostr(ACBrNFe1.WebServices.Consulta.DhRecbto) + char(13)), pChar(vDescr), mb_iconstop+mb_ok);
               end
              else
               begin
                vDescr := 'NF-e PENDENTE:';
                Application.Messagebox(pchar('DADOS DA NF-e  : ' + vartostr(DMNFe.ZQuery3['nfe_nnf']) + char(13) +
                                             'Status=' + vartostr(ACBrNFe1.WebServices.Consulta.cStat)  + '-' + vartostr(ACBrNFe1.WebServices.Consulta.xMotivo) + char(13) +
                                             'Protocolo=' + ACBrNFe1.WebServices.Consulta.Protocolo + char(13) +
                                             'Data do recebimento=' + vartostr(ACBrNFe1.WebServices.Consulta.DhRecbto) + char(13)), pChar(vDescr), mb_iconstop+mb_ok);
               end;

              memoLog.Clear;
              MemoResp.Lines.Text   := UTF8Encode(ACBrNFe1.WebServices.Consulta.RetWS);
              MemoLog.Lines.Add(vDescr);
              MemoLog.Lines.Add('Status');
              MemoLog.Lines.Add('Tipo de Ambiente:'     + TpAmbToStr(ACBrNFe1.WebServices.Consulta.TpAmb));
              MemoLog.Lines.Add('Versão do Aplicativo: '+ ACBrNFe1.WebServices.Consulta.verAplic);
              MemoLog.Lines.Add('Código do Status: '    + IntToStr(ACBrNFe1.WebServices.Consulta.cStat));
              MemoLog.Lines.Add('Código da UF: '        + IntToStr(ACBrNFe1.WebServices.Consulta.cUF));
              MemoLog.Lines.Add('Descrição: '           + ACBrNFe1.WebServices.Consulta.xMotivo);
              MemoLog.Lines.Add('Mensagem: '            + ACBrNFe1.WebServices.Consulta.Msg);
              MemoLog.Lines.Add('Data do recebimento: ' + vartostr(ACBrNFe1.WebServices.Consulta.DhRecbto));
              MemoLog.Lines.Add('Protocolo: '           + ACBrNFe1.WebServices.Consulta.Protocolo);
              memoRespWS.Lines.Text := UTF8Encode(ACBrNFe1.WebServices.Consulta.RetornoWS);
              LoadXML(MemoResp, WBResposta);

              // Caso não exista na base sefaz permite excluir ; by Edson Lima ; 17-9-2012 ; 14:00
              if ( (vartostr(ACBrNFe1.WebServices.Consulta.cStat) = '217') or
                   (vartostr(ACBrNFe1.WebServices.Consulta.cStat) = '613') ) then
               begin
                if MessageDlg('(Status 217) NF-e não consta na base de dados da SEFAZ ! ou ' + chr(13) +
                              '(Status 613) Chave de Acesso difere da existente em BD !' + chr(13)      +
                              'Confirme a exclusão da NFe nº ' + vartostr(DMNFe.ZQuery3['nfe_nnf']), mtConfirmation, [mbYes, mbNo], 0) = mrYes then
                 begin
                  //excluir nota
                  try
                   DMNFe.ZQuery1.DisableControls;
                   DMNFe.ZQuery1.Close;
                   DMNFe.ZQuery1.SQL.Clear;
                   DMNFe.ZQuery1.SQL.Add( 'exec sp_exclui_nfe ' + aux );
                   try
                    DMNFe.ZConnection1.StartTransaction;
                    DMNFe.ZQuery1.ExecSQL;
                    pExcluiXmlErro(VarToStr(DMNFe.ZQuery3['nfe_modelo']),
                                   VarToStr(DMNFe.ZQuery3['nfe_serie']),
                                   VarToStr(DMNFe.ZQuery3['nfe_nnf']));
                   except
                    DMNFe.ZConnection1.Rollback;
                    Application.Messagebox('ERRO: Não EXCLUIU este registro !','Atenção!',mb_iconstop+mb_ok);
                   end;
                  finally
                   DMNFe.ZQuery1.EnableControls;
                  end;
                 end;
               end;

              gDeuErrXml := False;

             end
            else
             begin

              gAtuCon := False;

              if MessageDlg('Confirme a exclusão da NFe nº ' + vartostr(DMNFe.ZQuery3['nfe_nnf']), mtConfirmation, [mbYes, mbNo], 0) = mrYes then
               begin
                //excluir nota
                try
                 DMNFe.ZQuery1.DisableControls;
                 DMNFe.ZQuery1.Close;
                 DMNFe.ZQuery1.SQL.Clear;
                 DMNFe.ZQuery1.SQL.Add( 'exec sp_exclui_nfe ' + aux );
                 try
                  DMNFe.ZConnection1.StartTransaction;
                  DMNFe.ZQuery1.ExecSQL;
                  pExcluiXmlErro(VarToStr(DMNFe.ZQuery3['nfe_modelo']),
                                 VarToStr(DMNFe.ZQuery3['nfe_serie']),
                                 VarToStr(DMNFe.ZQuery3['nfe_nnf']));
                 except
                  DMNFe.ZConnection1.Rollback;
                  Application.Messagebox('ERRO: Não EXCLUIU este registro !','Atenção!',mb_iconstop+mb_ok);
                 end;
                finally
                 DMNFe.ZQuery1.EnableControls;
                end;
               end;
             end;
           end;
        end;

       DMNFe.ZQuery3.Next;
      end;

     pAtuNFe;                          // Procedure de atualização

     // by Edson ; 20/6/2012 ; 09:20 ; Mostra as notas transmitidas no caso de atualização por consulta
     if gAtuCon then
      begin
       //RadioGroup1.ItemIndex := 2;    // Transmitidas
       vMens   := '';
       gAtuCon := False
      end;

    end

   //---------------------------------------------------------------------------
   else if ( RadioGroup1.ItemIndex = 1 ) then                                   // Contingência
   //---------------------------------------------------------------------------

    begin

     DMNFe.ZQuery10.first;
     while ((not DMNFe.ZQuery10.eof) and (DMNFe.ZQuery10['nfe_nnf'] <> Null)) do
      begin

       DMNFe.ZQuery10.FieldByName('Checado').ReadOnly := False;

       if DMNFe.ZQuery10['Checado'] = 'Y' then
        begin
         //*******************************************************************************
         // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update

         gDeuErrXml := False;
         gModelo    := DMNFe.ZQuery10['nfe_Modelo'];
         gSerie     := DMNFe.ZQuery10['nfe_Serie'];

         if ( gCpt = 1 ) then
          pDefineRel()                                                          // Define o tipo de Relatório FortesReport
         else
          pDefineRelFR();                                                       // Define o tipo de Relatório FastReport

         dt       := DMNFe.ZQuery10['nfe_demi'];
         vAux     := vartostr(DMNFe.ZQuery10['nfe_nnf']);

         _tpemissao := '1';

         if ( (gModelo = 55) and (RadioButton3.Checked) ) then
          begin
           _tipo_emissao := 'fsda';
           _tpemissao := '5';
          end
         else if ( (gModelo = 65) and (RadioButton3.Checked) ) then
          begin
           _tipo_emissao := 'OffL';
           _tpemissao := '9';
          end;

         Aux := '';
         Aux := dxSpinEdit1.Text + ',' + '''' + VarToStr(DMNFe.ZQuery10['nfe_nnf']) + '''' + ',' + '''' + _tpemissao + '''' + ',' + '''';
         Aux := Aux + FormatDateTime('yyyy/mm/dd', VarToDateTime(DMNFe.ZQuery10['nfe_demi'])) + '''' + ',' + '''';
         Aux := Aux + IntToStr(gModelo) + '''' + ',' + '''';
         Aux := Aux + VarToStr(DMNFe.ZQuery10['nfe_Serie']) + '''';

         DMNFe.ZQuery1.Close;
         DMNFe.ZQuery1.SQL.Clear;
         DMNFe.ZQuery1.SQL.Add( 'exec sp_calcula_digito_chave ' + Aux );
         DMNFe.ZQuery1.open;

         // by Edson Lima 2015-12-9T1007 - trunk2 novo
         vAux := '';
         if not DMNFe.ZQuery1.IsEmpty then
          vAux := vartostr(DMNFe.ZQuery1['chave']);

         // by Edson ; 2013-10-8T1031 ; Variável Global Chave criada para contestar gravação;
         gChave_Consiste  := vAux;

         if (gModelo = 65) then
          begin
           gTN                                   := '\NFCe\';
           if not (DMNFe.ZQuery10['nfe_DatNFCe']   = null) then
            gDataEmi                             := (DMNFe.ZQuery10['nfe_DatNFCe']);
          end
         else
          begin
           gTN                                   := '\NFe\';
           if not (DMNFe.ZQuery10['nfe_demi']      = null) then
            gDataEmi                             := (DMNFe.ZQuery10['nfe_demi']);
          end;

          if vAux <> '' then
           begin

            // Ajusta a data inicial para a data de emissão
            if (dxDateEdit1.Date > DMNFe.ZQuery10['nfe_demi']) then
             dxDateEdit1.Date := DMNFe.ZQuery10['nfe_demi'];

            vAux := trim(gCamLog) + trim(vAux) + '-nfe.xml';

            if FileExists(vAux) then
             begin

              gAtuCon := True;

              Copia_Xml_PathLog(Aux, gTN);

              ACBrNFe1.NotasFiscais.Clear;
              ACBrNFe1.NotasFiscais.LoadFromFile(vAux);
              ACBrNFe1.Consultar;

              if gModelo = 65 then
               begin
                vDescr := 'NFC-e PENDENTE:';
                Application.Messagebox(pchar('DADOS DA NFC-e : ' + vartostr(DMNFe.ZQuery10['nfe_nnf']) + char(13) +
                                             'Status=' + vartostr(ACBrNFe1.WebServices.Consulta.cStat)  + '-' + vartostr(ACBrNFe1.WebServices.Consulta.xMotivo) + char(13) +
                                             'Protocolo=' + ACBrNFe1.WebServices.Consulta.Protocolo + char(13) +
                                             'Data do recebimento=' + vartostr(ACBrNFe1.WebServices.Consulta.DhRecbto) + char(13)), pChar(vDescr), mb_iconstop+mb_ok);
               end
              else
               begin
                vDescr := 'NF-e PENDENTE:';
                Application.Messagebox(pchar('DADOS DA NF-e  : ' + vartostr(DMNFe.ZQuery10['nfe_nnf']) + char(13) +
                                             'Status=' + vartostr(ACBrNFe1.WebServices.Consulta.cStat)  + '-' + vartostr(ACBrNFe1.WebServices.Consulta.xMotivo) + char(13) +
                                             'Protocolo=' + ACBrNFe1.WebServices.Consulta.Protocolo + char(13) +
                                             'Data do recebimento=' + vartostr(ACBrNFe1.WebServices.Consulta.DhRecbto) + char(13)), pChar(vDescr), mb_iconstop+mb_ok);
               end;

              memoLog.Clear;
              MemoResp.Lines.Text   := UTF8Encode(ACBrNFe1.WebServices.Consulta.RetWS);
              MemoLog.Lines.Add(vDescr);
              MemoLog.Lines.Add('Status');
              MemoLog.Lines.Add('Tipo de Ambiente:'     + TpAmbToStr(ACBrNFe1.WebServices.Consulta.TpAmb));
              MemoLog.Lines.Add('Versão do Aplicativo: '+ ACBrNFe1.WebServices.Consulta.verAplic);
              MemoLog.Lines.Add('Código do Status: '    + IntToStr(ACBrNFe1.WebServices.Consulta.cStat));
              MemoLog.Lines.Add('Código da UF: '        + IntToStr(ACBrNFe1.WebServices.Consulta.cUF));
              MemoLog.Lines.Add('Descrição: '           + ACBrNFe1.WebServices.Consulta.xMotivo);
              MemoLog.Lines.Add('Mensagem: '            + ACBrNFe1.WebServices.Consulta.Msg);
              MemoLog.Lines.Add('Data do recebimento: ' + vartostr(ACBrNFe1.WebServices.Consulta.DhRecbto));
              MemoLog.Lines.Add('Protocolo: '           + ACBrNFe1.WebServices.Consulta.Protocolo);
              memoRespWS.Lines.Text := UTF8Encode(ACBrNFe1.WebServices.Consulta.RetornoWS);
              LoadXML(MemoResp, WBResposta);

              // Caso não exista na base sefaz permite excluir ; by Edson Lima ; 17-9-2012 ; 14:00
              if ( (vartostr(ACBrNFe1.WebServices.Consulta.cStat) = '217') or
                   (vartostr(ACBrNFe1.WebServices.Consulta.cStat) = '613') ) then
               begin
                if MessageDlg('(Status 217) NF-e não consta na base de dados da SEFAZ ! ou ' + chr(13) +
                              '(Status 613) Chave de Acesso difere da existente em BD !' + chr(13)      +
                              'Confirme a exclusão da NFe nº ' + vartostr(DMNFe.ZQuery3['nfe_nnf']), mtConfirmation, [mbYes, mbNo], 0) = mrYes then
                 begin
                  //excluir nota
                  try
                   DMNFe.ZQuery1.DisableControls;
                   DMNFe.ZQuery1.Close;
                   DMNFe.ZQuery1.SQL.Clear;
                   DMNFe.ZQuery1.SQL.Add( 'exec sp_exclui_nfe ' + aux );
                   try
                    DMNFe.ZConnection1.StartTransaction;
                    DMNFe.ZQuery1.ExecSQL;
                    pExcluiXmlErro(VarToStr(DMNFe.ZQuery10['nfe_modelo']),
                                   VarToStr(DMNFe.ZQuery10['nfe_serie']),
                                   VarToStr(DMNFe.ZQuery10['nfe_nnf']));
                   except
                    DMNFe.ZConnection1.Rollback;
                    Application.Messagebox('ERRO: Não EXCLUIU este registro !','Atenção!',mb_iconstop+mb_ok);
                   end;
                  finally
                   DMNFe.ZQuery1.EnableControls;
                  end;
                 end;
               end;

              gDeuErrXml := False;

             end
            else
             begin

              gAtuCon := False;

              if MessageDlg('Confirme a exclusão da NFe nº ' + vartostr(DMNFe.ZQuery10['nfe_nnf']), mtConfirmation, [mbYes, mbNo], 0) = mrYes then
               begin
                //excluir nota
                try
                 DMNFe.ZQuery1.DisableControls;
                 DMNFe.ZQuery1.Close;
                 DMNFe.ZQuery1.SQL.Clear;
                 DMNFe.ZQuery1.SQL.Add( 'exec sp_exclui_nfe ' + aux );
                 try
                  DMNFe.ZConnection1.StartTransaction;
                  DMNFe.ZQuery1.ExecSQL;
                  pExcluiXmlErro(VarToStr(DMNFe.ZQuery10['nfe_modelo']),
                                 VarToStr(DMNFe.ZQuery10['nfe_serie']),
                                 VarToStr(DMNFe.ZQuery10['nfe_nnf']));
                 except
                  DMNFe.ZConnection1.Rollback;
                  Application.Messagebox('ERRO: Não EXCLUIU este registro !','Atenção!',mb_iconstop+mb_ok);
                 end;
                finally
                 DMNFe.ZQuery1.EnableControls;
                end;
               end;
             end;
           end;
        end;

       DMNFe.ZQuery10.Next;
      end;

     pAtuNFe;                          // Procedure de atualização

     // by Edson ; 20/6/2012 ; 09:20 ; Mostra as notas transmitidas no caso de atualização por consulta
     if gAtuCon then
      begin
       //RadioGroup1.ItemIndex := 2;    // Transmitidas
       vMens   := '';
       gAtuCon := False
      end;

    end;

  end;

 pAtuNFe;                          // Procedure de atualização

end;

procedure TFrGBNFe.BitBtn9Click(Sender: TObject);
var
 xAux, vPdf, vCaminho : string;
 ProcInfo            : TProcessInformation;
 c                   : Integer;

begin

 CloseHandle(ProcInfo.hProcess);

 ACBrNFe1.Configuracoes.Geral.VersaoDF := ve310;

 if RadioGroup1.ItemIndex = 1 then      // Contigência FSDA OU OFF-LINE
  begin
   DMNFe.ZQuery10.first;
   while ((not DMNFe.ZQuery10.eof) and (DMNFe.ZQuery10['nfe_nnf'] <> Null)) do
    begin

     DMNFe.ZQuery10.FieldByName('Checado').ReadOnly := False;

     if DMNFe.ZQuery10['Checado'] = 'Y' then
      begin

       //*******************************************************************************
       // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update

       gModelo := DMNFe.ZQuery10['nfe_Modelo'];
       gSerie  := DMNFe.ZQuery10['nfe_Serie'];

       if ( gCpt = 1 ) then
        pDefineRel()                                                            // Define o tipo de Relatório FortesReport
       else
        pDefineRelFR();                                                         // Define o tipo de Relatório FastReport

       gCdloja_Consiste := dxSpinEdit1.Text;
       gdEmi_Consiste   := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery10['nfe_demi']);
       gNNF_Consiste    := vartostr(DMNFe.ZQuery10['nfe_nnf']);
       gSerie_Consiste  := vartostr(DMNFe.ZQuery10['nfe_serie']);
       gSerie           := StrToInt(gSerie_Consiste);
       gChave_Consiste  := '';                                                  // está sendo atribuida depois da sp_calcula_digito_chave

       xAux := trim(gCamLog) + trim(vartostr(DMNFe.ZQuery10['nfe_chave_nfe'])) + '-nfe.xml';   /// by EL 23.2.2012 -> xAux := trim(FrPar.edtPathLogs.Text) + '\' + trim(vartostr(DMNFe.ZQuery5['nfe_chave_nfe'])) + '-nfe.xml';
       vPdf := trim(gCamPdf) + trim(vartostr(DMNFe.ZQuery10['nfe_chave_nfe'])) + '-nfe.pdf';

       if copy(trim(vartostr(DMNFe.ZQuery10['nfe_chave_nfe'])),3,1) = '124' then
        xAux := trim(gCamLog) + trim(vartostr(DMNFe.ZQuery10['nfe_nr_dpec']));

       if FileExists(vPdf) then
        begin

         pImpr();

        end
       else
        begin

         ACBrNFe1.NotasFiscais.Clear;
         ACBrNFe1.NotasFiscais.LoadFromFile(xAux);
         ACBrNFe1.NotasFiscais.ImprimirPDF;

         pImpr();

        end;

     end;
     DMNFe.ZQuery10.Next;
    end;
  end
 else        // Transmitidas
  begin
   DMNFe.ZQuery5.first;
   while ((not DMNFe.ZQuery5.eof) and (DMNFe.ZQuery5['nfe_nnf'] <> Null)) do
    begin

     DMNFe.ZQuery5.FieldByName('Checado').ReadOnly := False;

     if DMNFe.ZQuery5['Checado'] = 'Y' then
      begin
       //*******************************************************************************
       // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update

       gModelo := DMNFe.ZQuery5['nfe_Modelo'];
       gSerie  := DMNFe.ZQuery5['nfe_Serie'];

       if ( gCpt = 1 ) then
        pDefineRel()                                                            // Define o tipo de Relatório FortesReport
       else
        pDefineRelFR();                                                         // Define o tipo de Relatório FastReport

       gCdloja_Consiste := dxSpinEdit1.Text;
       gdEmi_Consiste   := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery5['nfe_demi']);
       gNNF_Consiste    := vartostr(DMNFe.ZQuery5['nfe_nnf']);
       gSerie_Consiste  := vartostr(DMNFe.ZQuery5['nfe_serie']);
       gSerie           := StrToInt(gSerie_Consiste);
       gChave_Consiste  := '';                                                  // está sendo atribuida depois da sp_calcula_digito_chave

       xAux  := trim(gCamLog) + trim(vartostr(DMNFe.ZQuery5['nfe_chave_nfe'])) + '-nfe.xml';   /// by EL 23.2.2012 -> xAux := trim(FrPar.edtPathLogs.Text) + '\' + trim(vartostr(DMNFe.ZQuery5['nfe_chave_nfe'])) + '-nfe.xml';
       vPdf := trim(gCamPdf) + trim(vartostr(DMNFe.ZQuery5['nfe_chave_nfe'])) + '-nfe.pdf';

       if copy(trim(vartostr(DMNFe.ZQuery5['nfe_chave_nfe'])),3,1) = '124' then
        xAux := trim(gCamLog) + trim(vartostr(DMNFe.ZQuery5['nfe_nr_dpec']));    /// by EL 23.2.2012 ->  if copy(trim(vartostr(DMNFe.ZQuery5['nfe_chave_nfe'])),3,1) = '124' then xAux := trim(FrPar.edtPathLogs.Text) + '\' + trim(vartostr(DMNFe.ZQuery5['nfe_nr_dpec']));

       if FileExists(vPdf) then
        begin

         pImpr();

        end
       else
        begin

         ACBrNFe1.NotasFiscais.Clear;
         ACBrNFe1.NotasFiscais.LoadFromFile(xAux);
         ACBrNFe1.NotasFiscais.ImprimirPDF;

         pImpr();

        end;

     end;
     DMNFe.ZQuery5.Next;
    end;
  end;

 /// By Edson Lima 3.2.2012 - Antes -->  BitBtn5Click(FrImprimeVenda);
 pAtuNFeT();

end;

procedure TFrGBNFe.BitBtn11Click(Sender: TObject);
var
 I, vC, iCodPed                           : Integer;
 vNnf, vP, idLote                         : String;
 Para, xAuxC, vChave, vI                  : String;
 vdhEvento, vUTC                          : String;
 ddhEvento                                : TDateTime;
begin

 vAux := '';
 DMNFe.ZQuery5.first;

 //----------------------------------------------------------------------
 ACBrNFe1.Configuracoes.WebServices.AguardarConsultaRet      := 15000;
 ACBrNFe1.Configuracoes.WebServices.AjustaAguardaConsultaRet := True;
 ACBrNFe1.Configuracoes.WebServices.IntervaloTentativas      := 1000;
 ACBrNFe1.Configuracoes.WebServices.Tentativas               := 10;
 ACBrNFe1.Configuracoes.WebServices.TimeOut                  := 15000;
 //----------------------------------------------------------------------

 try
  while ((not DMNFe.ZQuery5.eof) and (DMNFe.ZQuery5['nfe_nnf'] <> Null)) do
   begin

    DMNFe.ZQuery5.FieldByName('Checado').ReadOnly := False;

    if DMNFe.ZQuery5['Checado'] = 'Y' then
     begin
      //*******************************************************************************
      // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update

      gModelo := DMNFe.ZQuery5['nfe_Modelo'];
      gSerie  := DMNFe.ZQuery5['nfe_Serie'];

      ACBrNFe1.Configuracoes.Geral.VersaoDF := ve310;

      if gModelo = 65 then
       begin
        ACBrNFe1.Configuracoes.Geral.ModeloDF := moNFCe;
       end
      else
       begin
        ACBrNFe1.Configuracoes.Geral.ModeloDF := moNFe;
       end;

      gModelo := DMNFe.ZQuery5['nfe_Modelo'];
      gSerie  := DMNFe.ZQuery5['nfe_Serie'];

      if ( gCpt = 1 ) then
       pDefineRel()                                                             // Define o tipo de Relatório FortesReport
      else
       pDefineRelFR();                                                          // Define o tipo de Relatório FastReport

      gCdloja_Consiste := dxSpinEdit1.Text;
      gdEmi_Consiste   := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery5['nfe_demi']);
      gNNF_Consiste    := vartostr(DMNFe.ZQuery5['nfe_nnf']);
      gSerie_Consiste  := vartostr(DMNFe.ZQuery5['nfe_serie']);
      gSerie           := StrToInt(gSerie_Consiste);
      gChave_Consiste  := '';                                                   // está sendo atribuida depois da sp_calcula_digito_chave

      xAux    := DMNFe.ZQuery5['nfe_chave_nfe'];
      vChave  := xAux;

      if not ( DMNFe.ZQuery5['nfe_CodPed'] = null ) then
       iCodPed := DMNFe.ZQuery5['nfe_CodPed']
      else
       iCodPed := 0;

      if MessageDlg('Confirma cancelamento da nota [ ' + VarToStr(DMNFe.ZQuery5['nfe_nnf']) + ' ]?', mtConfirmation, [mbYes, mbNo], 0) = mrYes then
       begin

        //----------------------------------------------------------------------
        // by Edson Lima ; 2017-1-9T1130 ; Verifica a precisão adm do gerpa para
        //                                 cancelamento
        //----------------------------------------------------------------------
        if iCodPed <> 0 then
         begin
          if not ( fVerPAG(StrToInt(gNNF_Consiste), dxSpinEdit1.IntValue, iCodPed) ) then
           Exit;
         end
        else
         Application.MessageBox(PChar('Número do pedido não informado!'), 'Atenção', MB_ICONINFORMATION );

        //----------------------------------------------------------------------

        xAux := trim(gCamLog) + trim(xAux) + '-nfe.xml';

        ACBrNFe1.NotasFiscais.Clear;
        ACBrNFe1.NotasFiscais.LoadFromFile(xAux);
        ACBrNFe1.Consultar;

        gChave_Consiste  := ACBrNFe1.WebServices.Consulta.NFeChave;

        idLote := ( VarToStr(DMNFe.ZQuery5['nfe_Serie']) + VarToStr(DMNFe.ZQuery5['nfe_codigo_loja']) + VarToStr(DMNFe.ZQuery5['nfe_nnf']) );

        vMens := 'A Justificativa deve ter pelo menos 15 caracteres';
        vAux  := gNomMtC;
        if not(InputQuery('WebServices Cancelamento', 'Justificativa', vAux)) then exit;
         if length(trim(vAux)) < 15 then
         begin
          MessageDlg('Justificativa deve ter no mínimo 15 caracteres', mtInformation,[mbOK],0);
          exit;
         end;

        memoLog.Clear;
        ACBrNFe1.EventoNFe.Evento.Clear;
        ACBrNFe1.EventoNFe.idLote  := StrToInt(idLote) ;

        with ACBrNFe1.EventoNFe.Evento.Add do
        begin
         infEvento.tpAmb           := ACBrNFe1.NotasFiscais.Add.NFe.Ide.tpAmb;

         // by Edson ; 2013/4/18T0849 ; Verifica a data e hora do evento com UTC da UF
         case strtoint(DMNFe.ZQuery4['codigo_uf']) of
                                                                                //Região Norte
          11, 12, 13, 14:         vUTC := '-04:00';                             // 11-Rondônia/RO - 12-Acre/AC - 13-Amazonas/AM - 14-Roraima/RR
          15, 16, 17:             vUTC := '-03:00';                             // 15-Pará/PA - 16-Amapá/AP - 17-Tocantins/TO
                                                                                //Região Nordeste
          21, 22, 23, 24, 25:     vUTC := '-03:00';                             // 21-Maranhão/MA - 22-Piauí/PI - 23-Ceará/CE - 24-Rio Grande do Norte/RN - 25-Paraíba/PB
          26:
           begin
            if (DMNFe.ZQuery4['codigo_municipio'] = '2605459') then
                                  vUTC := '-02:00'                              // 26-Pernambuco/PE - 2605459 - Fernando de Noronha
             else
                                  vUTC := '-03:00';                             // 26-Pernambuco/PE
           end;
          27, 28, 29:             vUTC := '-03:00';                             // 27-Alagoas/AL - 28-Sergipe/SE - 29-Bahia/BA
                                                                                //Região Sudeste
          31, 32, 33, 35:         vUTC := '-03:00';                             // 31-Minas Gerais/MG - 32-Espírito Santo/ES - 33-Rio de Janeiro/RJ - 35-São Paulo/SP
                                                                                // Região Sul
          41, 42, 43:             vUTC := '-03:00';                             // 41-Paraná/PR - 42-Santa Catarina/SC - 43-Rio Grande do Sul/RS
                                                                                // Região Centro-Oeste
          50, 51:                 vUTC := '-04:00';                             // 50-Mato Grosso do Sul/MS - 51-Mato Grosso/MT
          52, 53:                 vUTC := '-03:00';                             // 52-Goiás/GO - 53-Distrito Federal/DF
         end;

         ddhEvento := VarToDateTime(ACBrNFe1.WebServices.Consulta.protNFe.dhRecbto);
         vdhEvento := DateTimeToStr(ddhEvento);
         //ddhEvento := (IncMinute(ddhEvento, 1));                              // adiciona 1 minutos no horário do evento
         //ddhEvento := (IncHour(ddhEvento, 1));                                // adiciona 1 hora no horário do evento
         ddhEvento := (IncSecond(ddhEvento, 1));                                // adiciona 1 segundo no horário do evento

         // Rotina para o período do Horário de Verão
         if (DMNFe.ZQuery4['DANFE_HorariodeVerao'] = 'S') then
          begin
           ddhEvento := (IncHour(ddhEvento, -1))                                // se for horário de verão, reduz uma hora no horário do evento
          end;

         if (DMNFe.ZQuery4['DANFE_UsaHorarioDF'] = 'S') then
          ddhEvento := (IncHour(ddhEvento, 1));                                 // se utilizar o horário de Brasília, adiciona uma hora no horário do evento

         vdhEvento := DateTimeToStr(ddhEvento);

         if (DMNFe.ZQuery4['DANFE_FusoHorario'] = 'S') then
          vdhEvento  := (vdhEvento + vUTC);                                     // atruibui o utc no horário do evento

         //*********************************************************************

         infEvento.dhEvento         := StrToDateTime(vdhEvento);
         infEvento.tpEvento         := teCancelamento;
         infEvento.id               := 'ID' + VarToStr(infEvento.tpEvento) + vChave + '1';
         infEvento.detEvento.xJust  := vAux;
         infEvento.cOrgao           := strtoint(DMNFe.ZQuery4['codigo_uf']);
        end;

        //----------------------------------------------------------------------
        ACBrNFe1.EnviarEvento(StrToInt(idLote));                                // trunk2 - Antes => ACBrNFe1.EnviarEventoNFe(StrToInt(idLote));
        //----------------------------------------------------------------------
        ACBrNFe1.Configuracoes.WebServices.AguardarConsultaRet      := 0;
        //----------------------------------------------------------------------

        // by Edson ; 2013/03/21T09:01 ; Define o nome do arquivo para envio por email
        // by Edson ; 2015/01/28T1029 ; Foi modificado o tipo de evento para o início
        with ACBrNFe1.EventoNFe do
         begin

          xAuxC := trim(gCamXml) +                                                // Caminho do arquivo log (gCamlog contém o caminho padrão) ex: c:\Sistemas\GBNFe\Arq\Emp001\log\
                   FormatDateTime('yyyymm', Evento.Items[0].InfEvento.dhEvento) + // Ano, mês
                   '\Evento\Cancelamento\' +                                      // Evento e Cancelamento
                   Evento.Items[0].InfEvento.TipoEvento +                         // Tipo de evento, neste caso (110111)
                   trim(vChave) +                                                 // Chave da NFe
                   Format('%.2d', [Evento.Items[0].InfEvento.nSeqEvento]) +       // Sequencia do Evento com duas casas decimais
                   '-procEventoNFe.xml';                                          // Final do nome + tipo (xml)

         end;

        memoLog.Clear;
        MemoResp.Lines.Text   :=  UTF8Encode(ACBrNFe1.WebServices.EnvEvento.RetWS);
        MemoLog.Lines.Text    :=  UTF8Encode(ACBrNFe1.WebServices.EnvEvento.Msg);
        memoRespWS.Lines.Text :=  UTF8Encode(ACBrNFe1.WebServices.EnvEvento.RetornoWS);
        LoadXML(MemoResp, WBResposta);

        vNnf := DMNFe.ZQuery5['nfe_nnf'];

        // by Edson Lima ; 2013/03/12 ; 14:23 ; Atualiza a nfe no update centralizado
        // by Edson Lima ; 18.4.2012 ; 09:58 ; Implementa o email no cancelamento
        if ((VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) = '101')  or
            (VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) = '135')  or
            (VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) = '136')  or
            (VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) = '151')  or
            (VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) = '155')) then
         begin
          pGravaNFe('008', 'protocolo', 'data_hora_recebimento', 'situacao',  'motivo', 'cStat_CCe', 'xMotivo_CCe', '', 'codigo_loja',
                    'demi',      'nnf',       'serie', 'chave_nfe',
                    ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.nProt,
                    FormatDateTime('yyyy/mm/dd hh:nn:ss', ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.dhRegEvento),
                    ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat,
                    ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.xMotivo,
                    '', '', '',
                    dxSpinEdit1.IntValue,
                    FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery5['nfe_demi']),
                    DMNFe.ZQuery5['nfe_nnf'],
                    DMNFe.ZQuery5['nfe_serie'],
                    ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.chNFe, true);

          // Verifia se tem carta de correção e se tiver modifica o status da carta para CCe COM NFE CANCELADA
          if fGravaCCe( DMNFe.ZQuery5['nfe_nnf'], '580', '(NFe Cancelada) - O evento exige uma NF-e autorizada' ) then
           pGravaNFe('008', 'protocolo', 'data_hora_recebimento', '',  '', '', '', '', 'codigo_loja',
                    'demi',      'nnf',       'serie', 'chave_nfe',
                    ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.nProt,
                    FormatDateTime('yyyy/mm/dd hh:nn:ss', ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.dhRegEvento),
                    '',
                    '',
                    '580', '(NFe Cancelada) - O evento exige uma NF-e autorizada', '',
                    dxSpinEdit1.IntValue,
                    FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery5['nfe_demi']),
                    DMNFe.ZQuery5['nfe_nnf'],
                    DMNFe.ZQuery5['nfe_serie'],
                    ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.chNFe, true);

          //--------------------------------------------------------------------
          // by Edson Lima ; 7/1/2014T1026 ; Cancela CCe caso tenha alt. na NFe
          //--------------------------------------------------------------------

          fCancelaCCe(gCdloja_Consiste, gNNF_Consiste, gdEmi_Consiste);

          //--------------------------------------------------------------------

          //--------------------------------------------------------------------
          // by Edson Lima ; 2017-1-11T1031
          // Efetua o Cancelamento Administrativo do PEDIDO
          //--------------------------------------------------------------------
          if iCodPed <> 0 then
           begin
            if not ( fCanCAP(StrToInt(gNNF_Consiste), dxSpinEdit1.IntValue, iCodPed, gCodMtC) ) then
             Application.MessageBox(PChar('Nota cancelada, mas o pedido não!'), 'Atenção', MB_ICONINFORMATION );
           end
          else
           Application.MessageBox(PChar('Número do pedido não informado! Nota cancelada, mas Pedido não!'), 'Atenção', MB_ICONINFORMATION );
          //--------------------------------------------------------------------

         end
        else
         begin
          MessageDlg('Nota:[ ' + vNnf + ' ]' + Chr(13) +
                     'Status: ' + VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) + Chr(13) +
                     ' - Motivo:' + ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.xMotivo + Chr(13) +
                     'REJEIÇÃO', mtInformation, [mbOK], 0);
          exit;
         end;

        // by Edson Lima ; 18.4.2012 ; 09:58 ; Implementa o email no cancelamento
        if ((VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) = '101')  or
            (VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) = '135')  or
            (VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) = '136')  or
            (VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) = '151')  or
            (VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) = '155')) then
         begin
          //pega os dados do destinatario
          DMNFe.ZQuery2.Close;
          DMNFe.ZQuery2.SQL.Clear;
          DMNFe.ZQuery2.SQL.Add( 'Select                                                               ' );
          DMNFe.ZQuery2.SQL.Add( 't1.*                                                                 ' );
          DMNFe.ZQuery2.SQL.Add( 'from destinatario t1                                                 ' );
          DMNFe.ZQuery2.SQL.Add( 'inner join nfe t2 on t2.codigo_destinatario = t1.codigo              ' );
          DMNFe.ZQuery2.SQL.Add( 'where t2.codigo_loja = :parm1                                        ' );
          DMNFe.ZQuery2.SQL.Add( 'and t2.chave_nfe = :parm2                                            ' );
          DMNFe.ZQuery2.Params[0].AsInteger := dxSpinEdit1.intValue;
          DMNFe.ZQuery2.Params[1].AsString  := (vChave);
          DMNFe.ZQuery2.Open;
          if DMNFe.ZQuery2.IsEmpty then
           begin
            MessageDlg('Nfe cancelada não existe',mtInformation,[mbOK],0);
            exit;
           end;

           para := vartostr(DMNFe.ZQuery2['email']);

           if ( (trim(para) = '') or (FrPar.CheckBox10.Checked) ) then
            begin
             // By Edson Lima - 2016-6-30T1143 - Verifica o email do destinatário
             while (not fValidaEmail(para)) do
              begin
               Para := '';
               if not(InputQuery(vartostr(DMNFe.ZQuery2['razao_social']), 'Email de destino:', Para)) then exit;
               if (not fValidaEmail(para)) then
                Application.Messagebox('Campo de email do destinatário inválido! ','Atenção!',mb_iconstop+mb_ok);
              end;
            end;

          if vartostr(DMNFe.ZQuery2['email']) <> '' then
           begin
            if FrPar.edtEnvCC.Text = '' then
             IdMessage.CCList.EMailAddresses := 'nfe@gbinformatica.com.br'      //especifique um email válido
            else
             for I := 1 to (Length(FrPar.edtEnvCC.Text)+1) do
              begin
               if (FrPar.edtEnvCC.Text[I] = ',') or (FrPar.edtEnvCC.Text[I] = ';') or (I = Length(FrPar.edtEnvCC.Text)+1)then
                begin
                 IdMessage.CCList.Add.Address := Trim(vI);                      //especifique um email válido
                 vI := '';
                end
               else
                vI := (vI + Trim(FrPar.edtEnvCC.Text[I]));
              end;

              vI := '';                                                         // Limpa variável
              vC := 0;                                                          // zera contador

              for I := 1 to (Length(Para)+1) do
               begin
                if (Para[I] = ',') or (Para[I] = ';') or (I = Length(Para)+1)then
                 begin
                  if vC > 0 then
                   IdMessage.CCList.Add.Address := Trim(vI)                     //especifique um email válido
                  else
                   vP := trim(vI);                                              // Atribui apenas o primeiro email

                  vI := '';
                  inc(vC);                                                      // Incrementa 1
                 end
                else
                 vI := (vI + Trim(Para[I]));
               end;

              Para := vP;

              // Envia email do xml cancelado
              IdSMTP.Port                         := StrToInt(FrPar.edtSmtpPort.Text);
              IdSMTP.Host                         := FrPar.edtSmtpHost.Text;
              IdSMTP.Username                     := FrPar.edtSmtpUser.Text;
              IdSMTP.Password                     := FrPar.edtSmtpPass.Text;
              IdSMTP.AuthenticationType           := atLogin;
              IdSMTP.UseEhlo                      := True;
              IdSMTP.Connect(0);

              IdMessage.From.Address              := FrPar.edtSmtpUser.Text;
              IdMessage.From.Name                 := Format('%s<%s>', [Trim(FrPar.edtNEeMail.Text), Trim(FrPar.edtSmtpUser.Text)]) ;
              IdMessage.Recipients.EMailAddresses := Para;
              IdMessage.Subject                   := FrPar.edtEmailCancAssunto.Text + ' - Nº:' + vNnf;
              IdMessage.Body                      := FrPar.mmEmailMsg.Lines;
              TIdAttachment.Create(Idmessage.MessageParts, TFileName(xAuxC));

              try
               IdSMTP.Send(IdMessage);
               MessageDlg('Nota:[ ' + vNnf + ' ]' + Chr(13) +
                           'Status: ' + VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) + ' - Protocolo:' +
                           ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.nProt + Chr(13) +
                           'ENVIADA POR EMAIL', mtInformation, [mbOK], 0);
              finally
               IdSMTP.Disconnect;
              end;
           end;
          MessageDlg('Nota:[ ' + vNnf + ' ]' + Chr(13) +
                     'Status: ' + VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) + ' - Protocolo:' +
                     ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.nProt + Chr(13) +
                     'CANCELADA', mtInformation, [mbOK], 0);
         end;
       end;
     end;
    DMNFe.ZQuery5.Next;
   end;
 except
  // by Edson ; 2013-03-29T08:12 ; Mostra mensagens de erro do ACBr.
  ACBrNFe1.NotasFiscais.Validar;
  // by Edson Lima ; 2013/02/26 ; 16:03 ; Atualiza Grid
  pAtuNFeT();
 end;
 pAtuNFeT(); // By Edson Lima 14.9.2012 ; 10:10 - Atualiza grade
end;

procedure TFrGBNFe.MenuItem2Click(Sender: TObject);
var
 aux : string;
 I,vC         : Integer;
 Para, vI, vP : String;
 CC           : Tstrings;
begin

 DMNFe.ZQuery10.first;

 while ((not DMNFe.ZQuery10.eof) and (DMNFe.ZQuery10['nfe_nnf'] <> Null)) do
  begin

   DMNFe.ZQuery10.FieldByName('Checado').ReadOnly := False;

   if DMNFe.ZQuery10['Checado'] = 'Y' then
    begin

     if ( gCpt = 1 ) then
      pDefineRel()                                                              // Define o tipo de Relatório FortesReport
     else
      pDefineRelFR();                                                           // Define o tipo de Relatório FastReport

     //*******************************************************************************
     // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update

     gCdloja_Consiste := dxSpinEdit1.Text;
     gdEmi_Consiste   := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery10['nfe_demi']);
     gNNF_Consiste    := vartostr(DMNFe.ZQuery10['nfe_nnf']);
     gSerie_Consiste  := vartostr(DMNFe.ZQuery10['nfe_serie']);
     gSerie           := StrToInt(gSerie_Consiste);
     gModelo          := DMNFe.ZQuery10['nfe_modelo'];
     gChave_Consiste  := '';                                                    // está sendo atribuida depois da sp_calcula_digito_chave

     // by Edson Lima - 2015-12-18T1559 ; verifica se a situação está null,
     // se sim elimina qualquer xml do sistema, para evitar envio de xml
     // depois de correção e exclusão-------------------------------------

     gDataEmi := NullDate;
     aux := VarToStr(DMNFe.ZQuery10['nfe_chave_nfe']);

     if (gModelo = 65) then
      begin
       ACBrNFe1.Configuracoes.Geral.ModeloDF := moNFCe;
       gTN                                   := '\NFCe\';
       if not (DMNFe.ZQuery10['nfe_DatNFCe']  = null) then
        gDataEmi                             := (DMNFe.ZQuery10['nfe_DatNFCe']);
      end
     else
      begin
       ACBrNFe1.Configuracoes.Geral.ModeloDF := moNFe;
       gTN                                   := '\NFe\';
       if not (DMNFe.ZQuery10['nfe_demi']     = null) then
        gDataEmi                             := (DMNFe.ZQuery10['nfe_demi']);
      end;

     if ( (DMNFe.ZQuery10['nfe_situacao'] =  null) and ( not (gDataEmi = null))   or
          (DMNFe.ZQuery10['nfe_situacao'] =  '')   and ( not (gDataEmi = null)) ) then
      pEliminaXml(aux, gTN);                                                    // Elimina os xmls quando a situação for null

     //-------------------------------------------------------------------

     if (gModelo = 55) then
      begin
       _tipo_emissao := 'fsda';
       _tpemissao := '5';
      end
     else if (gModelo = 65) then
      begin
       _tipo_emissao := 'OffL';
       _tpemissao := '9';
      end;

     if ((copy(vartostr(DMNFe.ZQuery10['nfe_situacao']),1,4) = 'FSDA') or
         (copy(vartostr(DMNFe.ZQuery10['nfe_situacao']),1,4) = 'OFFL')) then
      begin
       //caso não tenha gravado a nota, calcula a chave e a procura
       if vartostr(DMNFe.ZQuery10['nfe_chave_nfe']) = '' then
        begin
         //procura pelo ano e mes da nota

         //1- Normal, 2-Contingência FS, 3-Contingência SCAN, 4-EPEC, 5-FSDA 9-OFFL

         if copy(vartostr(DMNFe.ZQuery10['nfe_situacao']),1,4) = 'FSDA' then
          _tpemissao := '5'
         else if copy(vartostr(DMNFe.ZQuery10['nfe_situacao']),1,4) = 'OFFL' then
          _tpemissao := '9';

         aux := '';
         aux := dxSpinEdit1.Text + ',' + '''' + VarToStr(DMNFe.ZQuery10['nfe_nnf']) + '''' + ',' + '''' + _tpemissao + '''' + ',' + '''';
         aux := aux + FormatDateTime('yyyy/mm/dd', VarToDateTime(DMNFe.ZQuery10['nfe_demi'])) + '''' + ',' + '''';
         aux := aux + IntToStr(gModelo) + '''' + ',' + '''';
         aux := aux + IntToStr(gSerie) + '''';

         DMNFe.ZQuery1.Close;
         DMNFe.ZQuery1.SQL.Clear;
         DMNFe.ZQuery1.SQL.Add( 'exec sp_calcula_digito_chave ' + aux );
         DMNFe.ZQuery1.open;

         if not DMNFe.ZQuery1.IsEmpty then
          vAux := vartostr(DMNFe.ZQuery1['chave']);

         // by Edson ; 2013-10-8T1031 ; Variável Global Chave criada para contestar gravação;
         gChave_Consiste  := vAux;

        end
       else
        begin
         vAux         := DMNFe.ZQuery10['nfe_chave_nfe'];

         // by Edson ; 2013-10-8T1031 ; Variável Global Chave criada para contestar gravação;
         gChave_Consiste  := vAux;
        end;

       if vAux <> '' then
        begin

         // By Edson Lima ; 2015-12-8T1702 - Serve para copiar a nota gerada em contingência
         // by Edson ; 2013-10-8T1031 ; Variável Global Chave criada para contestar gravação;
         gChave_Consiste  := vAux;

         if (gModelo = 65) then
          gTN              := '\NFCe\'                                          // by Edson Lima 2015-10-14T1107 - trunk2 novo ; Global utilizado para setar o nome da pasta
         else
          gTN              := '\NFe\';                                          // by Edson Lima 2015-10-14T1107 - trunk2 novo ; Global utilizado para setar o nome da pasta

         Copia_Xml_PathLog(vAux, gTN);                                          // by Edson Lima 2015-10-14T1107 - trunk2 novo

         vAux := trim(gCamLog) + trim(vAux) + '-nfe.xml';
         ACBrNFe1.NotasFiscais.Clear;
         ACBrNFe1.NotasFiscais.LoadFromFile(vAux);

         if ( gCpt = 1 ) then
          pDefineRel()                                                          // Define o tipo de Relatório FortesReport
         else
          pDefineRelFR();                                                       // Define o tipo de Relatório FastReport

         //---------------------------------------------------------------------
         // by Edson Lima ; 19/6/2012 ; 15:24 - Se dê erro de rejeição da chave
         // em Contingência, vai para consulta
         //---------------------------------------------------------------------

         ACBrNFe1.Enviar(0);

         //consultar a nota transmitida
         ACBrNFe1.NotasFiscais.Clear;
         ACBrNFe1.NotasFiscais.LoadFromFile(vAux);
         ACBrNFe1.Consultar;

         grava_xml_no_banco;

         memoLog.Clear;
         MemoResp.Lines.Text   := UTF8Encode(ACBrNFe1.WebServices.Consulta.RetWS);
         MemoLog.Lines.Text    := UTF8Encode(ACBrNFe1.WebServices.Consulta.Msg);
         memoRespWS.Lines.Text := UTF8Encode(ACBrNFe1.WebServices.Consulta.RetornoWS);
         LoadXML(MemoResp, WBResposta);

         Try
          // by Edson Lima ; 2013/03/12 ; 14:23 ; Atualiza a nfe no update centralizado
          pGravaNFe('009', 'chave_nfe', '', '', '', '', '', '',
                    'codigo_loja', 'demi',      'nnf',       'serie', 'chave_nfe',
                    '', '', '', '', '', '', '',
                    dxSpinEdit1.IntValue,
                    FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery10['nfe_demi']),
                    DMNFe.ZQuery10['nfe_nnf'],
                    DMNFe.ZQuery10['nfe_serie'],
                    DMNFe.ZQuery10['nfe_chave_nfe'], true)

         except

          memoLog.Clear;
          MemoResp.Lines.Text   := UTF8Encode(ACBrNFe1.WebServices.Retorno.RetWS);
          MemoLog.Lines.Text    := UTF8Encode(ACBrNFe1.WebServices.Retorno.Msg);
          memoRespWS.Lines.Text := UTF8Encode(ACBrNFe1.WebServices.Retorno.RetornoWS);
          LoadXML(MemoResp, WBResposta);

          Exit;

         end;
         if (trim(vartostr(ACBrNFe1.WebServices.Consulta.cStat)) = '100') or
            (trim(vartostr(ACBrNFe1.WebServices.Consulta.cStat)) = '150') then
          begin
           // by Edson Lima ; 2013/03/12 ; 14:23 ; Atualiza a nfe no update centralizado
           pGravaNFe('010', 'protocolo', 'recibo', 'data_hora_recebimento',
                     'chave_nfe', 'situacao',  'motivo', '',
                     'codigo_loja', 'demi',      'nnf',       'serie', 'chave_nfe',
                     ACBrNFe1.WebServices.Consulta.Protocolo,
                     ACBrNFe1.WebServices.Retorno.NFeRetorno.nRec,
                     FormatDateTime('yyyy/mm/dd hh:nn:ss', ACBrNFe1.WebServices.consulta.DhRecbto),
                     ACBrNFe1.WebServices.Consulta.NFeChave,
                     ACBrNFe1.WebServices.Consulta.cStat,
                     ACBrNFe1.WebServices.Consulta.xMotivo,
                     '',
                     dxSpinEdit1.IntValue,
                     FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery10['nfe_demi']),
                     DMNFe.ZQuery10['nfe_nnf'],
                     DMNFe.ZQuery10['nfe_serie'],
                     ACBrNFe1.WebServices.Consulta.NFeChave, true);

         end;

        MessageDlg('DADOS DA NOTA : ' + vartostr(DMNFe.ZQuery10['nfe_nnf']) + char(13) + '  Status=' + vartostr(ACBrNFe1.WebServices.Consulta.cStat)  + '-' +  vartostr(ACBrNFe1.WebServices.Consulta.xMotivo) + char(13) + '  Protocolo=' + ACBrNFe1.WebServices.Consulta.Protocolo + char(13) + '  Data do recebimento=' + vartostr(ACBrNFe1.WebServices.Consulta.DhRecbto) + char(13) ,mtInformation,[mbOK],0);

        if not gDuplic then // by Edson ; 2013-11-22T1420 ; Só envia email se não der duplicidade de nota
         begin
          //---------------------enviar email
          xAux := vartostr(ACBrNFe1.WebServices.Retorno.NFeRetorno.ProtNFe.Items[0].chNFe);
          //pega os dados do destinatario
          DMNFe.ZQuery2.Close;
          DMNFe.ZQuery2.SQL.Clear;
          DMNFe.ZQuery2.SQL.Add( 'Select                                                     ' );
          DMNFe.ZQuery2.SQL.Add( 't1.*                                                       ' );
          DMNFe.ZQuery2.SQL.Add( 'from destinatario t1                                       ' );
          DMNFe.ZQuery2.SQL.Add( 'inner join nfe t2 on t2.codigo_destinatario = t1.codigo    ' );
          DMNFe.ZQuery2.SQL.Add( 'where t2.codigo_loja = :parm1                              ' );
          DMNFe.ZQuery2.SQL.Add( 'and t2.chave_nfe = :parm2                                  ' );
          DMNFe.ZQuery2.SQL.Add( 'and t2.situacao <> :parm3                                  ' );
          DMNFe.ZQuery2.SQL.Add( 'and t2.situacao <> :parm4                                  ' );
          DMNFe.ZQuery2.Params[0].AsInteger := dxSpinEdit1.intValue;
          DMNFe.ZQuery2.Params[1].AsString  := (xAux);
          DMNFe.ZQuery2.Params[2].AsString  := '101';
          DMNFe.ZQuery2.Params[3].AsString  := '151';
          DMNFe.ZQuery2.Open;
          if DMNFe.ZQuery2.IsEmpty then
           begin
            exit;
           end;

          para := vartostr(DMNFe.ZQuery2['email']);

          if ( (trim(para) = '') or (FrPar.CheckBox10.Checked) ) then
           begin
            // By Edson Lima - 2016-6-30T1143 - Verifica o email do destinatário
            while (not fValidaEmail(para)) do
             begin
              Para := '';
              if not(InputQuery(vartostr(DMNFe.ZQuery2['razao_social']), 'Email de destino:', Para)) then exit;
              if (not fValidaEmail(para)) then
               Application.Messagebox('Campo de email do destinatário inválido! ','Atenção!',mb_iconstop+mb_ok);
             end;
           end;

          if (trim(para) <> '') then
           begin
            xAux := trim(gCamLog) + trim(xAux) + '-nfe.xml';                    /// by EL - 23.2.2012 -> xAux := trim(FrPar.edtPathLogs.Text) + '\' + trim(xAux) + '-nfe.xml';
            ACBrNFe1.NotasFiscais.Clear;
            ACBrNFe1.NotasFiscais.LoadFromFile(xAux);
            CC:=TstringList.Create;

            if ( Trim(FrPar.edtEnvCC.Text) <> '' ) then
             for I := 1 to (Length(FrPar.edtEnvCC.Text)+1) do
              begin
               if (FrPar.edtEnvCC.Text[I] = ',') or (FrPar.edtEnvCC.Text[I] = ';') or (I = Length(FrPar.edtEnvCC.Text)+1)then
                begin
                 CC.Add(trim(vI));                                              //especifique um email válido
                 vI := '';
                end
               else
                vI := (vI + FrPar.edtEnvCC.Text[I]);
              end;

            vI := '';                                                           // Limpa variável
            vC := 0;                                                            // zera contador

            for I := 1 to (Length(Para)+1) do
             begin
              if (Para[I] = ',') or (Para[I] = ';') or (I = Length(Para)+1)then
               begin
                if vC > 0 then
                 CC.Add(trim(vI))                                               // Especifique um email válido
                else
                 vP := trim(vI);                                                // Atribui apenas o primeiro email

                vI := '';
                inc(vC);                                                        // Incrementa 1
               end
              else
               vI := (vI + Para[I]);
             end;

             Para := vP;

            ACBrNFe1.NotasFiscais.Items[0].EnviarEmail(Para
                                                     , FrPar.edtEmailAssunto.Text + ' - Nº ' + VarToStr(DMNFe.ZQuery3['nfe_nnf'])
                                                     , FrPar.mmEmailMsg.Lines
                                                     , True                     //Enviar PDF junto
                                                     , CC                       //com copia
                                                     , nil
                                                      );

            CC.Free;

           end;
           //---------------------final - enviar email
         end;
        gDuplic := False;
       end;
      end;
    end;
   DMNFe.ZQuery10.Next;
  end;

 RadioGroup1Click(FrGBNFe);

end;

procedure TFrGBNFe.ConsultarnotaemFSDA1Click(Sender: TObject);
var
 aux, vnRec : string;
begin
 try
  DMNFe.ZQuery10.first;
  while ((not DMNFe.ZQuery10.eof) and (DMNFe.ZQuery10['nfe_nnf'] <> Null)) do
   begin

    DMNFe.ZQuery10.FieldByName('Checado').ReadOnly := False;

    if DMNFe.ZQuery10['Checado'] = 'Y' then
     begin
      //*******************************************************************************
      // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update

      gModelo := DMNFe.ZQuery10['nfe_Modelo'];
      gSerie  := DMNFe.ZQuery10['nfe_Serie'];

      if ( gCpt = 1 ) then
       pDefineRel()                                                             // Define o tipo de Relatório FortesReport
      else
       pDefineRelFR();                                                          // Define o tipo de Relatório FastReport

      gCdloja_Consiste := dxSpinEdit1.Text;
      gdEmi_Consiste   := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery10['nfe_demi']);
      gNNF_Consiste    := vartostr(DMNFe.ZQuery10['nfe_nnf']);
      gSerie_Consiste  := vartostr(DMNFe.ZQuery10['nfe_serie']);
      gSerie           := StrToInt(gSerie_Consiste);
      gChave_Consiste  := '';                                                   // está sendo atribuida depois da sp_calcula_digito_chave

      //procura pelo ano e mes da nota
      // ['1', '2', '3', '4', '5', '6', '7', '8', '9'], [teNormal, teContingencia, teSCAN, teDPEC, teFSDA, teSVCAN, teSVCRS, teSVCSP, teOffLine]);
      if (gModelo = 55) then
       _tpemissao := '5'
      else if (gModelo = 65) then
       _tpemissao := '9';

      aux := '';
      aux := dxSpinEdit1.Text + ',' + '''' + VarToStr(DMNFe.ZQuery10['nfe_nnf']) + '''' + ',' + '''' + _tpemissao + '''' + ',' + '''';
      aux := aux + FormatDateTime('yyyy/mm/dd', VarToDateTime(DMNFe.ZQuery10['nfe_demi'])) + '''' + ',' + '''';
      aux := aux + IntToStr(gModelo) + '''' + ',' + '''';
      aux := aux + IntToStr(gSerie) + '''';

      DMNFe.ZQuery1.Close;
      DMNFe.ZQuery1.SQL.Clear;
      DMNFe.ZQuery1.SQL.Add( 'exec sp_calcula_digito_chave ' + aux );
      DMNFe.ZQuery1.open;

      if not DMNFe.ZQuery1.IsEmpty then
       vAux := vartostr(DMNFe.ZQuery1['chave']);

      // by Edson ; 2013-10-8T1031 ; Variável Global Chave criada para contestar gravação;
      gChave_Consiste  := vAux;

      if (VarToStr(DMNFe.ZQuery10['nfe_chave_nfe']) <> '') and (trim(vAux) = '') then
       vAux := DMNFe.ZQuery10['nfe_chave_nfe'];

      vAux := trim(gCamLog) + trim(vAux) + '-nfe.xml';    /// by EL 24.2.2012 -> vAux := trim(FrPar.edtPathLogs.Text) + '\' + trim(vAux) + '-nfe.xml';

      // by Edson Lima ; 2013/03/18 ; 08:45 ; Rotina para o caso de 613 = Chave de Acesso difere da existente em BD
      if not FileExists(vAux) then
       begin
        _tpemissao := '1';

        aux := '';
        aux := dxSpinEdit1.Text + ',' + '''' + VarToStr(DMNFe.ZQuery3['nfe_nnf']) + '''' + ',' + '''' + _tpemissao + '''' + ',' + '''';
        aux := aux + FormatDateTime('yyyy/mm/dd', VarToDateTime(DMNFe.ZQuery3['nfe_demi'])) + '''' + ',' + '''';
        aux := aux + IntToStr(gModelo) + '''' + ',' + '''';
        aux := aux + IntToStr(gSerie) + '''';

        DMNFe.ZQuery1.Close;
        DMNFe.ZQuery1.SQL.Clear;
        DMNFe.ZQuery1.SQL.Add( 'exec sp_calcula_digito_chave ' + aux );
        DMNFe.ZQuery1.open;

        if not DMNFe.ZQuery1.IsEmpty then
         vAux := vartostr(DMNFe.ZQuery1['chave']);

        // by Edson ; 2013-10-8T1031 ; Variável Global Chave criada para contestar gravação;
        gChave_Consiste  := vAux;

        if (VarToStr(DMNFe.ZQuery3['nfe_chave_nfe']) <> '') and (trim(vAux) = '') then
         vAux := DMNFe.ZQuery3['nfe_chave_nfe'];

        if vAux <> '' then
         begin
          if (dxDateEdit1.Date > DMNFe.ZQuery3['nfe_demi']) then
            dxDateEdit1.Date := DMNFe.ZQuery3['nfe_demi'];

          vAux := trim(gCamLog) + trim(vAux) + '-nfe.xml';
         end;
       end;
      //********************************************************************

      ACBrNFe1.NotasFiscais.Clear;
      ACBrNFe1.NotasFiscais.LoadFromFile(vAux);
      ACBrNFe1.Consultar;

      if (trim(vartostr(ACBrNFe1.WebServices.Consulta.cStat)) = '100') or
         (trim(vartostr(ACBrNFe1.WebServices.Consulta.cStat)) = '150') then
       begin
        grava_xml_no_banco;

        // by Edson Lima ; 2013-11-25T1104 ; Rotina acrescina para o a efetiva
        // consulta das notas movidas de transmitidas...
        if gReConsulta then
         vnRec := DMNFe.ZQuery10['nfe_recibo']
        else
         vnRec := ACBrNFe1.WebServices.Retorno.NFeRetorno.nRec;
        //----------------------------------------------------------------------

        // by Edson Lima ; 2013/03/12 ; 14:23 ; Atualiza a nfe no update centralizado
        pGravaNFe('011', 'protocolo', 'recibo', 'data_hora_recebimento',
                  'chave_nfe', 'situacao',  'motivo', '',
                  'codigo_loja', 'demi',    'nnf',    'serie', 'chave_nfe',
                  ACBrNFe1.WebServices.Consulta.Protocolo,
                  vnRec,
                  FormatDateTime('yyyy/mm/dd hh:nn:ss', ACBrNFe1.WebServices.consulta.DhRecbto),
                  ACBrNFe1.WebServices.Consulta.NFeChave,
                  ACBrNFe1.WebServices.Consulta.cStat,
                  ACBrNFe1.WebServices.Consulta.xMotivo,
                  '',
                  dxSpinEdit1.IntValue,
                  FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery10['nfe_demi']),
                  DMNFe.ZQuery10['nfe_nnf'],
                  DMNFe.ZQuery10['nfe_serie'],
                  ACBrNFe1.WebServices.Consulta.NFeChave, true);
       end;

      MessageDlg('DADOS DA NOTA : ' + vartostr(DMNFe.ZQuery10['nfe_nnf']) + char(13) + '  Status=' + vartostr(ACBrNFe1.WebServices.Consulta.cStat)  + '-' +  vartostr(ACBrNFe1.WebServices.Consulta.xMotivo) + char(13) + '  Protocolo=' + ACBrNFe1.WebServices.Consulta.Protocolo + char(13) + '  Data do recebimento=' + vartostr(ACBrNFe1.WebServices.Consulta.DhRecbto) + char(13) ,mtInformation,[mbOK],0);

      memoLog.Clear;
      MemoResp.Lines.Text   := UTF8Encode(ACBrNFe1.WebServices.Consulta.RetWS);
      MemoLog.Lines.Text    := UTF8Encode(ACBrNFe1.WebServices.Consulta.Msg);
      memoRespWS.Lines.Text := UTF8Encode(ACBrNFe1.WebServices.Consulta.RetornoWS);
      LoadXML(MemoResp, WBResposta);
     end;
    DMNFe.ZQuery10.Next;
   end;
 except
  // by Edson ; 2013-03-29T08:12 ; Mostra mensagens de erro do ACBr.
  ACBrNFe1.NotasFiscais.Validar;
  // by Edson Lima ; 2013/02/26 ; 16:03 ; Atualiza Grid
  pAtuNFe();
 end;

 gReConsulta := False;
 RadioGroup1Click(FrGBNFe);

 // TabSheet15Show(FrImprimeVenda);
end;

procedure TFrGBNFe.BitBtn4Click(Sender: TObject);
begin

  OpenDialog1.FileName  :=  '';
  OpenDialog1.Title := 'Selecione a NFE';
  OpenDialog1.DefaultExt := '*-nfe.XML';
  OpenDialog1.Filter := 'Arquivos NFE (*-nfe.XML)|*-nfe.XML|Arquivos XML (*.XML)|*.XML|Todos os Arquivos (*.*)|*.*';
  OpenDialog1.InitialDir := ACBrNFe1.Configuracoes.Arquivos.PathSalvar;
  if OpenDialog1.Execute then begin
    ACBrNFe1.NotasFiscais.Clear;
    ACBrNFe1.NotasFiscais.LoadFromFile(OpenDialog1.FileName);

    grava_xml_no_banco;

    MessageDlg('Gravado com sucesso',mtInformation,[mbOK],0);

  end;

 /// By Edson Lima 14.9.2012 ; 10:10 - Atualiza grade
 pAtuNFeT();

end;

procedure TFrGBNFe.BitBtn5Click(Sender: TObject);
var
  i, j, k, n  : integer;
  Nota, Node, NodePai, NodeItem: TTreeNode;
begin
  gMostraXML := True;
  OpenDialog1.FileName  :=  '';
  OpenDialog1.Title := 'Selecione a NFE';
  OpenDialog1.DefaultExt := '*-nfe.XML';
  OpenDialog1.Filter := 'Arquivos NFE (*-nfe.XML)|*-nfe.XML|Arquivos XML (*.XML)|*.XML|Todos os Arquivos (*.*)|*.*';
  OpenDialog1.InitialDir := ACBrNFe1.Configuracoes.Arquivos.PathSalvar;
  if OpenDialog1.Execute then
  begin
    ACBrNFe1.NotasFiscais.Clear;
    ACBrNFe1.NotasFiscais.LoadFromFile(OpenDialog1.FileName);
    trvwNFe.Items.Clear;

    for n:=0 to ACBrNFe1.NotasFiscais.Count-1 do
    begin
    with ACBrNFe1.NotasFiscais.Items[n].NFe do
     begin

       Nota := trvwNFe.Items.Add(nil,infNFe.ID);
       trvwNFe.Items.AddChild(Nota,'ID= ' +infNFe.ID);
       Node := trvwNFe.Items.AddChild(Nota,'procNFe');
       trvwNFe.Items.AddChild(Node,'tpAmb= '     +TpAmbToStr(procNFe.tpAmb));
       trvwNFe.Items.AddChild(Node,'verAplic= '  +procNFe.verAplic);
       trvwNFe.Items.AddChild(Node,'chNFe= '     +procNFe.chNFe);
       trvwNFe.Items.AddChild(Node,'dhRecbto= '  +DateTimeToStr(procNFe.dhRecbto));
       trvwNFe.Items.AddChild(Node,'nProt= '     +procNFe.nProt);
       trvwNFe.Items.AddChild(Node,'digVal= '    +procNFe.digVal);
       trvwNFe.Items.AddChild(Node,'cStat= '     +IntToStr(procNFe.cStat));
       trvwNFe.Items.AddChild(Node,'xMotivo= '   +procNFe.xMotivo);

       Node := trvwNFe.Items.AddChild(Nota,'Ide');
       trvwNFe.Items.AddChild(Node,'cNF= '     +IntToStr(Ide.cNF));
       trvwNFe.Items.AddChild(Node,'natOp= '   +Ide.natOp );
       trvwNFe.Items.AddChild(Node,'indPag= '  +IndpagToStr(Ide.indPag));
       trvwNFe.Items.AddChild(Node,'modelo= '  +IntToStr(Ide.modelo));
       trvwNFe.Items.AddChild(Node,'serie= '   +IntToStr(Ide.serie));
       trvwNFe.Items.AddChild(Node,'nNF= '     +IntToStr(Ide.nNF));
       trvwNFe.Items.AddChild(Node,'dEmi= '    +DateToStr(Ide.dEmi));
       trvwNFe.Items.AddChild(Node,'dSaiEnt= ' +DateToStr(Ide.dSaiEnt));
       //trvwNFe.Items.AddChild(Node,'hSaiEnt= ' +DateToStr(Ide.hSaiEnt));        // 2016-3-22 ; nova linha inclusção
       trvwNFe.Items.AddChild(Node,'tpNF= '    +tpNFToStr(Ide.tpNF));
       trvwNFe.Items.AddChild(Node,'finNFe= '  +FinNFeToStr(Ide.finNFe));
       trvwNFe.Items.AddChild(Node,'verProc= ' +Ide.verProc);
       trvwNFe.Items.AddChild(Node,'cUF= '     +IntToStr(Ide.cUF));
       trvwNFe.Items.AddChild(Node,'cMunFG= '  +IntToStr(Ide.cMunFG));
       trvwNFe.Items.AddChild(Node,'tpImp= '   +TpImpToStr(Ide.tpImp));
       trvwNFe.Items.AddChild(Node,'tpEmis= '  +TpEmisToStr(Ide.tpEmis));
       trvwNFe.Items.AddChild(Node,'cDV= '     +IntToStr(Ide.cDV));
       trvwNFe.Items.AddChild(Node,'tpAmb= '   +TpAmbToStr(Ide.tpAmb));
       trvwNFe.Items.AddChild(Node,'finNFe= '  +FinNFeToStr(Ide.finNFe));
       trvwNFe.Items.AddChild(Node,'procEmi= ' +procEmiToStr(Ide.procEmi));
       trvwNFe.Items.AddChild(Node,'verProc= ' +Ide.verProc);
       //trvwNFe.Items.AddChild(Node,'dhCont= '  +DateTimeToStr(Ide.dhCont));     // 2016-3-22 ; nova linha inclusção
       //trvwNFe.Items.AddChild(Node,'xJust= '   +Ide.xJust);                     // 2016-3-22 ; nova linha inclusção

       for i:=0 to Ide.NFref.Count-1 do
        begin
         if Ide.NFref.Items[i].refNFe <> '' then                                // 2016-3-22 ; nova linha inclusção
          begin                                                                 // 2016-3-22 ; nova linha inclusção
           Node := trvwNFe.Items.AddChild(Node,'NFRef'+IntToStrZero(i+1,3));
           trvwNFe.Items.AddChild(Node,'refNFe= ' +Ide.NFref.Items[i].refNFe);
           trvwNFe.Items.AddChild(Node,'cUF= '    +IntToStr(Ide.NFref.Items[i].RefNF.cUF));
           trvwNFe.Items.AddChild(Node,'AAMM= '   +Ide.NFref.Items[i].RefNF.AAMM);
           trvwNFe.Items.AddChild(Node,'CNPJ= '   +Ide.NFref.Items[i].RefNF.CNPJ);
           trvwNFe.Items.AddChild(Node,'modelo= ' +IntToStr(Ide.NFref.Items[i].RefNF.modelo));
           trvwNFe.Items.AddChild(Node,'serie= '  +IntToStr(Ide.NFref.Items[i].RefNF.serie));
           trvwNFe.Items.AddChild(Node,'nNF= '    +IntToStr(Ide.NFref.Items[i].RefNF.nNF));
          end;

         //if Ide.NFref.Items[i].RefECF.nCOO <> '' then                           // 2016-3-22 ; nova linha inclusção
         // begin                                                                 // 2016-3-22 ; nova linha inclusção
         //  Node := trvwNFe.Items.AddChild(Node,'refECF'+IntToStrZero(i+1,3));   // 2016-3-22 ; nova linha inclusção
         //  trvwNFe.Items.AddChild(Node,'mod= '  +ECFModRefToStr(Ide.NFref.Items[i].RefECF.modelo));  // 2016-3-22 ; nova linha inclusção
         //  trvwNFe.Items.AddChild(Node,'nECF= ' +Ide.NFref.Items[i].RefECF.nECF); // 2016-3-22 ; nova linha inclusção
         //  trvwNFe.Items.AddChild(Node,'nCOO= ' +Ide.NFref.Items[i].RefECF.nCOO); // 2016-3-22 ; nova linha inclusção
         // end;                                                                  // 2016-3-22 ; nova linha inclusção
        end;

       Node := trvwNFe.Items.AddChild(Nota,'Emit');
       trvwNFe.Items.AddChild(Node,'CNPJCPF= ' +Emit.CNPJCPF);
       trvwNFe.Items.AddChild(Node,'IE='       +Emit.IE);
       trvwNFe.Items.AddChild(Node,'xNome='    +Emit.xNome);
       trvwNFe.Items.AddChild(Node,'xFant='    +Emit.xFant );
       trvwNFe.Items.AddChild(Node,'IEST='     +Emit.IEST);
       trvwNFe.Items.AddChild(Node,'IM='       +Emit.IM);
       trvwNFe.Items.AddChild(Node,'CNAE='     +Emit.CNAE);
       trvwNFe.Items.AddChild(Node,'CRT='      +CRTToStr(Emit.CRT));            // 2016-3-22 ; nova linha inclusção

       Node := trvwNFe.Items.AddChild(Node,'EnderEmit');
       trvwNFe.Items.AddChild(Node,'Fone='    +Emit.EnderEmit.fone);
       trvwNFe.Items.AddChild(Node,'CEP='     +IntToStr(Emit.EnderEmit.CEP));
       trvwNFe.Items.AddChild(Node,'xLgr='    +Emit.EnderEmit.xLgr);
       trvwNFe.Items.AddChild(Node,'nro='     +Emit.EnderEmit.nro);
       trvwNFe.Items.AddChild(Node,'xCpl='    +Emit.EnderEmit.xCpl);
       trvwNFe.Items.AddChild(Node,'xBairro=' +Emit.EnderEmit.xBairro);
       trvwNFe.Items.AddChild(Node,'cMun='    +IntToStr(Emit.EnderEmit.cMun));
       trvwNFe.Items.AddChild(Node,'xMun='    +Emit.EnderEmit.xMun);
       trvwNFe.Items.AddChild(Node,'UF'       +Emit.EnderEmit.UF);
       trvwNFe.Items.AddChild(Node,'cPais='   +IntToStr(Emit.EnderEmit.cPais));
       trvwNFe.Items.AddChild(Node,'xPais='   +Emit.EnderEmit.xPais);

       if Avulsa.CNPJ  <> '' then
        begin
          Node := trvwNFe.Items.AddChild(Nota,'Avulsa');
          trvwNFe.Items.AddChild(Node,'CNPJ='    +Avulsa.CNPJ);
          trvwNFe.Items.AddChild(Node,'xOrgao='  +Avulsa.xOrgao);
          trvwNFe.Items.AddChild(Node,'matr='    +Avulsa.matr );
          trvwNFe.Items.AddChild(Node,'xAgente=' +Avulsa.xAgente);
          trvwNFe.Items.AddChild(Node,'fone='    +Avulsa.fone);
          trvwNFe.Items.AddChild(Node,'UF='      +Avulsa.UF);
          trvwNFe.Items.AddChild(Node,'nDAR='    +Avulsa.nDAR);
          trvwNFe.Items.AddChild(Node,'dEmi='    +DateToStr(Avulsa.dEmi));
          trvwNFe.Items.AddChild(Node,'vDAR='    +FloatToStr(Avulsa.vDAR));
          trvwNFe.Items.AddChild(Node,'repEmi='  +Avulsa.repEmi);
          trvwNFe.Items.AddChild(Node,'dPag='    +DateToStr(Avulsa.dPag));
        end;
       Node := trvwNFe.Items.AddChild(Nota,'Dest');
       trvwNFe.Items.AddChild(Node,'CNPJCPF= ' +Dest.CNPJCPF);
       trvwNFe.Items.AddChild(Node,'IE='       +Dest.IE);
       trvwNFe.Items.AddChild(Node,'ISUF='     +Dest.ISUF);
       trvwNFe.Items.AddChild(Node,'xNome='    +Dest.xNome);
       trvwNFe.Items.AddChild(Node,'email='    +Dest.Email);                    // 2016-3-22 ; nova linha inclusção
       //trvwNFe.Items.AddChild(Node,'emailDest='   +Dest.Email);                 // by Edson ; 2013/03/19 ; 08:37 ; Implementado nesta dada

       Node := trvwNFe.Items.AddChild(Node,'EnderDest');
       trvwNFe.Items.AddChild(Node,'Fone='        +Dest.EnderDest.Fone);
       trvwNFe.Items.AddChild(Node,'CEP='         +IntToStr(Dest.EnderDest.CEP));
       trvwNFe.Items.AddChild(Node,'xLgr='        +Dest.EnderDest.xLgr);
       trvwNFe.Items.AddChild(Node,'nro='         +Dest.EnderDest.nro);
       trvwNFe.Items.AddChild(Node,'xCpl='        +Dest.EnderDest.xCpl);
       trvwNFe.Items.AddChild(Node,'xBairro='     +Dest.EnderDest.xBairro);
       trvwNFe.Items.AddChild(Node,'cMun='        +IntToStr(Dest.EnderDest.cMun));
       trvwNFe.Items.AddChild(Node,'xMun='        +Dest.EnderDest.xMun);
       trvwNFe.Items.AddChild(Node,'UF='          +Dest.EnderDest.UF );
       trvwNFe.Items.AddChild(Node,'cPais='       +IntToStr(Dest.EnderDest.cPais));
       trvwNFe.Items.AddChild(Node,'xPais='       +Dest.EnderDest.xPais);

       for I := 0 to Det.Count-1 do
        begin
          with Det.Items[I] do
           begin
               NodeItem := trvwNFe.Items.AddChild(Nota,'Produto'+IntToStrZero(I+1,3));
               trvwNFe.Items.AddChild(NodeItem,'nItem='         +IntToStr(Prod.nItem) );
               trvwNFe.Items.AddChild(NodeItem,'cProd='         +Prod.cProd );
               trvwNFe.Items.AddChild(NodeItem,'cEAN='          +Prod.cEAN);
               trvwNFe.Items.AddChild(NodeItem,'xProd='         +Prod.xProd);
               trvwNFe.Items.AddChild(NodeItem,'NCM='           +Prod.NCM);
               trvwNFe.Items.AddChild(NodeItem,'EXTIPI='        +Prod.EXTIPI);
               //trvwNFe.Items.AddChild(NodeItem,'genero=' +IntToStr(Prod.genero));
               trvwNFe.Items.AddChild(NodeItem,'CFOP='          +Prod.CFOP);
               trvwNFe.Items.AddChild(NodeItem,'uCom='          +Prod.uCom);
               trvwNFe.Items.AddChild(NodeItem,'qCom='          +FloatToStr(Prod.qCom)) ;
               trvwNFe.Items.AddChild(NodeItem,'vUnCom='        +FloatToStr(Prod.vUnCom)) ;
               trvwNFe.Items.AddChild(NodeItem,'CEST='          +Prod.CEST) ;
               trvwNFe.Items.AddChild(NodeItem,'vProd='         +FloatToStr(Prod.vProd)) ;

               trvwNFe.Items.AddChild(NodeItem,'cEANTrib='      +Prod.cEANTrib);
               trvwNFe.Items.AddChild(NodeItem,'uTrib='         +Prod.uTrib);
               trvwNFe.Items.AddChild(NodeItem,'qTrib='         +FloatToStr(Prod.qTrib));
               trvwNFe.Items.AddChild(NodeItem,'vUnTrib='       +FloatToStr(Prod.vUnTrib)) ;

               trvwNFe.Items.AddChild(NodeItem,'vFrete='        +FloatToStr(Prod.vFrete)) ;
               trvwNFe.Items.AddChild(NodeItem,'vSeg='          +FloatToStr(Prod.vSeg)) ;
               trvwNFe.Items.AddChild(NodeItem,'vDesc='         +FloatToStr(Prod.vDesc)) ;
               trvwNFe.Items.AddChild(NodeItem,'vOutro='        +FloatToStr(Prod.vOutro)) ;  // 2016-3-22 ; nova linha inclusção
               trvwNFe.Items.AddChild(NodeItem,'indTot='        +indTotToStr(Prod.IndTot)) ; // 2016-3-22 ; nova linha inclusção
               trvwNFe.Items.AddChild(NodeItem,'xPed='          +Prod.xPed) ;
               trvwNFe.Items.AddChild(NodeItem,'nItemPedido='   +Prod.nItemPed) ;

               trvwNFe.Items.AddChild(NodeItem,'infAdProd=' +infAdProd);

               for J:=0 to Prod.DI.Count-1 do
                begin
                  if Prod.DI.Items[j].nDi <> '' then
                   begin
                     with Prod.DI.Items[j] do
                      begin
                        NodePai := trvwNFe.Items.AddChild(NodeItem,'DI'+IntToStrZero(J+1,3));
                        trvwNFe.Items.AddChild(NodePai,'nDi='         +nDi);
                        trvwNFe.Items.AddChild(NodePai,'dDi='         +DateToStr(dDi));
                        trvwNFe.Items.AddChild(NodePai,'xLocDesemb='  +xLocDesemb);
                        trvwNFe.Items.AddChild(NodePai,'UFDesemb='    +UFDesemb);
                        trvwNFe.Items.AddChild(NodePai,'dDesemb='     +DateToStr(dDesemb));
                        trvwNFe.Items.AddChild(NodePai,'cExportador=' +cExportador);;

                        for K:=0 to adi.Count-1 do
                         begin
                           with adi.Items[K] do
                            begin
                              Node := trvwNFe.Items.AddChild(NodePai,'LADI'+IntToStrZero(K+1,3));
                              trvwNFe.Items.AddChild(Node,'nAdicao='     +IntToStr(nAdicao)) ;
                              trvwNFe.Items.AddChild(Node,'nSeqAdi='     +IntToStr(nSeqAdi)) ;
                              trvwNFe.Items.AddChild(Node,'cFabricante=' +cFabricante);
                              trvwNFe.Items.AddChild(Node,'vDescDI='     +FloatToStr(vDescDI));
                            end;
                         end;
                      end;
                   end
                  else
                    Break;
                end;

              if Prod.veicProd.chassi <> '' then
               begin
                 Node := trvwNFe.Items.AddChild(NodeItem,'Veiculo');
                 with Prod.veicProd do
                  begin
                    trvwNFe.Items.AddChild(Node,'tpOP='     +tpOPToStr(tpOP));
                    trvwNFe.Items.AddChild(Node,'chassi='   +chassi) ;
                    trvwNFe.Items.AddChild(Node,'cCor='     +cCor);
                    trvwNFe.Items.AddChild(Node,'xCor='     +xCor);
                    trvwNFe.Items.AddChild(Node,'pot='      +pot);
                    trvwNFe.Items.AddChild(Node,'Cilin='    +Cilin);
                    trvwNFe.Items.AddChild(Node,'pesoL='    +pesoL);
                    trvwNFe.Items.AddChild(Node,'pesoB='    +pesoB);
                    trvwNFe.Items.AddChild(Node,'nSerie='   +nSerie);
                    trvwNFe.Items.AddChild(Node,'tpComb='   +tpComb);
                    trvwNFe.Items.AddChild(Node,'nMotor='   +nMotor);
                    trvwNFe.Items.AddChild(Node,'CMT='      +CMT);
                    trvwNFe.Items.AddChild(Node,'dist='     +dist);
                    //trvwNFe.Items.AddChild(Node,'RENAVAM='  +RENAVAM);
                    trvwNFe.Items.AddChild(Node,'anoMod='   +IntToStr(anoMod));
                    trvwNFe.Items.AddChild(Node,'anoFab='   +IntToStr(anoFab));
                    trvwNFe.Items.AddChild(Node,'tpPint='   +tpPint);
                    trvwNFe.Items.AddChild(Node,'tpVeic='   +IntToStr(tpVeic));
                    trvwNFe.Items.AddChild(Node,'espVeic='  +IntToStr(espVeic));
                    trvwNFe.Items.AddChild(Node,'VIN='      +VIN);
                    trvwNFe.Items.AddChild(Node,'condVeic=' +condVeicToStr(condVeic));
                    trvwNFe.Items.AddChild(Node,'cMod='     +cMod);
                  end;
               end;

               for J:=0 to Prod.med.Count-1 do
                begin
                  Node := trvwNFe.Items.AddChild(NodeItem,'Medicamento'+IntToStrZero(J+1,3) );
                  with Prod.med.Items[J] do
                   begin
                     trvwNFe.Items.AddChild(Node,'nLote=' +nLote) ;
                     trvwNFe.Items.AddChild(Node,'qLote=' +FloatToStr(qLote)) ;
                     trvwNFe.Items.AddChild(Node,'dFab='  +DateToStr(dFab)) ;
                     trvwNFe.Items.AddChild(Node,'dVal='  +DateToStr(dVal)) ;
                     trvwNFe.Items.AddChild(Node,'vPMC='  +FloatToStr(vPMC)) ;
                    end;
                end;

               for J:=0 to Prod.arma.Count-1 do
                begin
                  Node := trvwNFe.Items.AddChild(NodeItem,'Arma'+IntToStrZero(J+1,3));
                  with Prod.arma.Items[J] do
                   begin
                     trvwNFe.Items.AddChild(Node,'nSerie=' + nSerie) ;
                     trvwNFe.Items.AddChild(Node,'tpArma=' + tpArmaToStr(tpArma)) ;
                     trvwNFe.Items.AddChild(Node,'nCano='  + nCano) ;
                     trvwNFe.Items.AddChild(Node,'descr='  + descr) ;
                    end;
                end;

               if (Prod.comb.cProdANP > 0) then
                begin
                 NodePai := trvwNFe.Items.AddChild(NodeItem,'Combustivel');
                 with Prod.comb do
                  begin
                    trvwNFe.Items.AddChild(NodePai,'cProdANP=' +IntToStr(cProdANP)) ;
                    trvwNFe.Items.AddChild(NodePai,'CODIF='    +CODIF) ;
                    trvwNFe.Items.AddChild(NodePai,'qTemp='    +FloatToStr(qTemp)) ;
                    trvwNFe.Items.AddChild(NodePai,'UFcons='   +UFcons) ;

                    Node := trvwNFe.Items.AddChild(NodePai,'CIDE'+IntToStrZero(I+1,3));
                    trvwNFe.Items.AddChild(Node,'qBCprod='   +FloatToStr(CIDE.qBCprod)) ;
                    trvwNFe.Items.AddChild(Node,'vAliqProd=' +FloatToStr(CIDE.vAliqProd)) ;
                    trvwNFe.Items.AddChild(Node,'vCIDE='     +FloatToStr(CIDE.vCIDE)) ;

                    Node := trvwNFe.Items.AddChild(NodePai,'ICMSComb'+IntToStrZero(I+1,3));
                    trvwNFe.Items.AddChild(Node,'vBCICMS='   +FloatToStr(ICMS.vBCICMS)) ;
                    trvwNFe.Items.AddChild(Node,'vICMS='     +FloatToStr(ICMS.vICMS)) ;
                    trvwNFe.Items.AddChild(Node,'vBCICMSST=' +FloatToStr(ICMS.vBCICMSST)) ;
                    trvwNFe.Items.AddChild(Node,'vICMSST='   +FloatToStr(ICMS.vICMSST)) ;

                    if (ICMSInter.vBCICMSSTDest>0) then
                     begin
                       Node := trvwNFe.Items.AddChild(NodePai,'ICMSInter'+IntToStrZero(I+1,3));
                       trvwNFe.Items.AddChild(Node,'vBCICMSSTDest=' +FloatToStr(ICMSInter.vBCICMSSTDest)) ;
                       trvwNFe.Items.AddChild(Node,'vICMSSTDest='   +FloatToStr(ICMSInter.vICMSSTDest)) ;
                     end;

                    if (ICMSCons.vBCICMSSTCons>0) then
                     begin
                       Node := trvwNFe.Items.AddChild(NodePai,'ICMSCons'+IntToStrZero(I+1,3));
                       trvwNFe.Items.AddChild(Node,'vBCICMSSTCons=' +FloatToStr(ICMSCons.vBCICMSSTCons)) ;
                       trvwNFe.Items.AddChild(Node,'vICMSSTCons='   +FloatToStr(ICMSCons.vICMSSTCons)) ;
                       trvwNFe.Items.AddChild(Node,'UFCons='        +ICMSCons.UFcons) ;
                     end;
                  end;
               end;

               with Imposto do
                begin
                   NodePai := trvwNFe.Items.AddChild(NodeItem,'Imposto');

                   if ISSQN.cSitTrib = ISSQNcSitTribVazio then                  // 2016-3-22 ; nova linha inclusção
                    begin                                                       // 2016-3-22 ; nova linha inclusção

                     Node := trvwNFe.Items.AddChild(NodePai,'ICMS');
                     with ICMS do
                      begin
                       trvwNFe.Items.AddChild(Node,'CST=' +CSTICMSToStr(CST));

                       if CST = cst00 then
                        begin
                          trvwNFe.Items.AddChild(Node,'orig='        +OrigToStr(ICMS.orig));
                          trvwNFe.Items.AddChild(Node,'modBC='       +modBCToStr(ICMS.modBC));
                          trvwNFe.Items.AddChild(Node,'vBC='         +FloatToStr(ICMS.vBC));
                          trvwNFe.Items.AddChild(Node,'pICMS='       +FloatToStr(ICMS.pICMS));
                          trvwNFe.Items.AddChild(Node,'vICMS='       +FloatToStr(ICMS.vICMS));
                        end
                       else if CST = cst10 then
                        begin
                          trvwNFe.Items.AddChild(Node,'orig='        +OrigToStr(ICMS.orig));
                          trvwNFe.Items.AddChild(Node,'modBC='       +modBCToStr(ICMS.modBC));
                          trvwNFe.Items.AddChild(Node,'vBC='         +FloatToStr(ICMS.vBC));
                          trvwNFe.Items.AddChild(Node,'pICMS='       +FloatToStr(ICMS.pICMS));
                          trvwNFe.Items.AddChild(Node,'vICMS='       +FloatToStr(ICMS.vICMS));
                          trvwNFe.Items.AddChild(Node,'modBCST='     +modBCSTToStr(ICMS.modBCST));
                          trvwNFe.Items.AddChild(Node,'pMVAST='      +FloatToStr(ICMS.pMVAST));
                          trvwNFe.Items.AddChild(Node,'pRedBCST='    +FloatToStr(ICMS.pRedBCST));
                          trvwNFe.Items.AddChild(Node,'vBCST='       +FloatToStr(ICMS.vBCST));
                          trvwNFe.Items.AddChild(Node,'pICMSST='     +FloatToStr(ICMS.pICMSST));
                          trvwNFe.Items.AddChild(Node,'vICMSST='     +FloatToStr(ICMS.vICMSST));
                        end
                       else if CST = cst20 then
                        begin
                          trvwNFe.Items.AddChild(Node,'orig='        +OrigToStr(ICMS.orig));
                          trvwNFe.Items.AddChild(Node,'modBC='       +modBCToStr(ICMS.modBC));
                          trvwNFe.Items.AddChild(Node,'pRedBC='      +FloatToStr(ICMS.pRedBC));
                          trvwNFe.Items.AddChild(Node,'vBC='         +FloatToStr(ICMS.vBC));
                          trvwNFe.Items.AddChild(Node,'pICMS='       +FloatToStr(ICMS.pICMS));
                          trvwNFe.Items.AddChild(Node,'vICMS='       +FloatToStr(ICMS.vICMS));
                          trvwNFe.Items.AddChild(Node,'vICMSDeson='  +FloatToStr(ICMS.vICMSDeson));  // by Edson Lima ; 2016/10/11
                          trvwNFe.Items.AddChild(Node,'motDesICMS='  +VarToStr(motDesICMS));         // by Edson Lima ; 2016/10/11
                        end
                       else if CST = cst30 then
                        begin
                          trvwNFe.Items.AddChild(Node,'orig='        +OrigToStr(ICMS.orig));
                          trvwNFe.Items.AddChild(Node,'modBCST='     +modBCSTToStr(ICMS.modBCST));
                          trvwNFe.Items.AddChild(Node,'pMVAST='      +FloatToStr(ICMS.pMVAST));
                          trvwNFe.Items.AddChild(Node,'pRedBCST='    +FloatToStr(ICMS.pRedBCST));
                          trvwNFe.Items.AddChild(Node,'vBCST='       +FloatToStr(ICMS.vBCST));
                          trvwNFe.Items.AddChild(Node,'pICMSST='     +FloatToStr(ICMS.pICMSST));
                          trvwNFe.Items.AddChild(Node,'vICMSST='     +FloatToStr(ICMS.vICMSST));
                          trvwNFe.Items.AddChild(Node,'vICMSDeson='  +FloatToStr(ICMS.vICMSDeson));  // by Edson Lima ; 2016/10/11
                          trvwNFe.Items.AddChild(Node,'motDesICMS='  +VarToStr(motDesICMS));         // by Edson Lima ; 2016/10/11
                        end
                       else if (CST = cst40) or (CST = cst41) or (CST = cst50) then
                        begin
                          trvwNFe.Items.AddChild(Node,'orig='        +OrigToStr(ICMS.orig));
                          trvwNFe.Items.AddChild(Node,'vICMSDeson='  +FloatToStr(ICMS.vICMSDeson));  // by Edson Lima ; 2016/10/11
                          trvwNFe.Items.AddChild(Node,'motDesICMS='  +VarToStr(motDesICMS));         // by Edson Lima ; 2016/10/11
                        end
                       else if CST = cst51 then
                          begin
                          trvwNFe.Items.AddChild(Node,'orig='        +OrigToStr(ICMS.orig));
                          trvwNFe.Items.AddChild(Node,'modBC='       +modBCToStr(ICMS.modBC));
                          trvwNFe.Items.AddChild(Node,'pRedBC='      +FloatToStr(ICMS.pRedBC));
                          trvwNFe.Items.AddChild(Node,'vBC='         +FloatToStr(ICMS.vBC));
                          trvwNFe.Items.AddChild(Node,'pICMS='       +FloatToStr(ICMS.pICMS));
                          trvwNFe.Items.AddChild(Node,'vICMS='       +FloatToStr(ICMS.vICMS));
                        end
                       else if CST = cst60 then
                        begin
                          trvwNFe.Items.AddChild(Node,'orig='        +OrigToStr(ICMS.orig));
                          trvwNFe.Items.AddChild(Node,'vBCST='       +FloatToStr(ICMS.vBCST));
                          trvwNFe.Items.AddChild(Node,'vICMSST='     +FloatToStr(ICMS.vICMSST));
                        end
                       else if CST = cst70 then
                        begin
                          trvwNFe.Items.AddChild(Node,'orig='        +OrigToStr(ICMS.orig));
                          trvwNFe.Items.AddChild(Node,'modBC='       +modBCToStr(ICMS.modBC));
                          trvwNFe.Items.AddChild(Node,'pRedBC='      +FloatToStr(ICMS.pRedBC));
                          trvwNFe.Items.AddChild(Node,'vBC='         +FloatToStr(ICMS.vBC));
                          trvwNFe.Items.AddChild(Node,'pICMS='       +FloatToStr(ICMS.pICMS));
                          trvwNFe.Items.AddChild(Node,'vICMS='       +FloatToStr(ICMS.vICMS));
                          trvwNFe.Items.AddChild(Node,'modBCST='     +modBCSTToStr(ICMS.modBCST));
                          trvwNFe.Items.AddChild(Node,'pMVAST='      +FloatToStr(ICMS.pMVAST));
                          trvwNFe.Items.AddChild(Node,'pRedBCST='    +FloatToStr(ICMS.pRedBCST));
                          trvwNFe.Items.AddChild(Node,'vBCST='       +FloatToStr(ICMS.vBCST));
                          trvwNFe.Items.AddChild(Node,'pICMSST='     +FloatToStr(ICMS.pICMSST));
                          trvwNFe.Items.AddChild(Node,'vICMSST='     +FloatToStr(ICMS.vICMSST));
                          trvwNFe.Items.AddChild(Node,'vICMSDeson='  +FloatToStr(ICMS.vICMSDeson));  // by Edson Lima ; 2016/10/11
                          trvwNFe.Items.AddChild(Node,'motDesICMS='  +VarToStr(motDesICMS));         // by Edson Lima ; 2016/10/11
                        end
                       else if CST = cst90 then
                        begin
                          trvwNFe.Items.AddChild(Node,'orig='        +OrigToStr(ICMS.orig));
                          trvwNFe.Items.AddChild(Node,'modBC='       +modBCToStr(ICMS.modBC));
                          trvwNFe.Items.AddChild(Node,'pRedBC='      +FloatToStr(ICMS.pRedBC));
                          trvwNFe.Items.AddChild(Node,'vBC='         +FloatToStr(ICMS.vBC));
                          trvwNFe.Items.AddChild(Node,'pICMS='       +FloatToStr(ICMS.pICMS));
                          trvwNFe.Items.AddChild(Node,'vICMS='       +FloatToStr(ICMS.vICMS));
                          trvwNFe.Items.AddChild(Node,'modBCST='     +modBCSTToStr(ICMS.modBCST));
                          trvwNFe.Items.AddChild(Node,'pMVAST='      +FloatToStr(ICMS.pMVAST));
                          trvwNFe.Items.AddChild(Node,'pRedBCST='    +FloatToStr(ICMS.pRedBCST));
                          trvwNFe.Items.AddChild(Node,'vBCST='       +FloatToStr(ICMS.vBCST));
                          trvwNFe.Items.AddChild(Node,'pICMSST='     +FloatToStr(ICMS.pICMSST));
                          trvwNFe.Items.AddChild(Node,'vICMSST='     +FloatToStr(ICMS.vICMSST));
                          trvwNFe.Items.AddChild(Node,'vICMSDeson='  +FloatToStr(ICMS.vICMSDeson));  // by Edson Lima ; 2016/10/11
                          trvwNFe.Items.AddChild(Node,'motDesICMS='  +VarToStr(motDesICMS));         // by Edson Lima ; 2016/10/11
                        end;
                     end;

                     // by Edson Lima ; 2016-3-22 ; trata do ICMSUFDest
                     Node := trvwNFe.Items.AddChild(NodePai,'ICMSUFDest');
                     with ICMSUFDest do
                      begin
                       trvwNFe.Items.AddChild(Node,'vBCUFDest='      +FloatToStr(vBCUFDest));
                       trvwNFe.Items.AddChild(Node,'pFCPUFDest='     +FloatToStr(pFCPUFDest));
                       trvwNFe.Items.AddChild(Node,'pICMSUFDest='    +FloatToStr(pICMSUFDest));
                       trvwNFe.Items.AddChild(Node,'pICMSInter='     +FloatToStr(pICMSInter));
                       trvwNFe.Items.AddChild(Node,'pICMSInterPart=' +FloatToStr(pICMSInterPart));
                       trvwNFe.Items.AddChild(Node,'vFCPUFDest='     +FloatToStr(vFCPUFDest));
                       trvwNFe.Items.AddChild(Node,'vICMSUFDest='    +FloatToStr(vICMSUFDest));
                       trvwNFe.Items.AddChild(Node,'vICMSUFRemet='   +FloatToStr(vICMSUFRemet));
                      end;
                    end
                   else
                    begin
                     Node := trvwNFe.Items.AddChild(NodePai,'ISSQN');
                     with ISSQN do
                      begin
                        trvwNFe.Items.AddChild(Node,'vBC='           +FloatToStr(vBC));
                        trvwNFe.Items.AddChild(Node,'vAliq='         +FloatToStr(vAliq));
                        trvwNFe.Items.AddChild(Node,'vISSQN='        +FloatToStr(vISSQN));
                        trvwNFe.Items.AddChild(Node,'cMunFG='        +IntToStr(cMunFG));
                        trvwNFe.Items.AddChild(Node,'cListServ='     +cListServ);
                      end;
                    end;

                   if (IPI.vBC > 0) then
                    begin
                      Node := trvwNFe.Items.AddChild(NodePai,'IPI');
                      with IPI do
                       begin
                         trvwNFe.Items.AddChild(Node,'CST='          +CSTIPIToStr(CST)) ;
                         trvwNFe.Items.AddChild(Node,'clEnq='        +clEnq);
                         trvwNFe.Items.AddChild(Node,'CNPJProd='     +CNPJProd);
                         trvwNFe.Items.AddChild(Node,'cSelo='        +cSelo);
                         trvwNFe.Items.AddChild(Node,'qSelo='        +IntToStr(qSelo));
                         trvwNFe.Items.AddChild(Node,'cEnq='         +cEnq);
                         trvwNFe.Items.AddChild(Node,'vBC='          +FloatToStr(vBC));
                         trvwNFe.Items.AddChild(Node,'qUnid='        +FloatToStr(qUnid));
                         trvwNFe.Items.AddChild(Node,'vUnid='        +FloatToStr(vUnid));
                         trvwNFe.Items.AddChild(Node,'pIPI='         +FloatToStr(pIPI));
                         trvwNFe.Items.AddChild(Node,'vIPI='         +FloatToStr(vIPI));
                       end;
                    end;

                   if (II.vBc > 0) then
                    begin
                      Node := trvwNFe.Items.AddChild(NodePai,'II');
                      with II do
                       begin
                         trvwNFe.Items.AddChild(Node,'vBc='          +FloatToStr(vBc));
                         trvwNFe.Items.AddChild(Node,'vDespAdu='     +FloatToStr(vDespAdu));
                         trvwNFe.Items.AddChild(Node,'vII='          +FloatToStr(vII));
                         trvwNFe.Items.AddChild(Node,'vIOF='         +FloatToStr(vIOF));
                       end;
                    end;

                   Node := trvwNFe.Items.AddChild(NodePai,'PIS');
                   with PIS do
                    begin
                      trvwNFe.Items.AddChild(Node,'CST='             +CSTPISToStr(CST));

                      //if (CST = pis01) or (CST = pis02) then
                      if (CST = pis01) or (CST = pis02) or (CST = pis05) then
                       begin
                         trvwNFe.Items.AddChild(Node,'vBC='          +FloatToStr(PIS.vBC));
                         trvwNFe.Items.AddChild(Node,'pPIS='         +FloatToStr(PIS.pPIS));
                         trvwNFe.Items.AddChild(Node,'vPIS='         +FloatToStr(PIS.vPIS));
                       end
                      else if CST = pis03 then
                       begin
                         trvwNFe.Items.AddChild(Node,'qBCProd='      +FloatToStr(PIS.qBCProd));
                         trvwNFe.Items.AddChild(Node,'vAliqProd='    +FloatToStr(PIS.vAliqProd));
                         trvwNFe.Items.AddChild(Node,'vPIS='         +FloatToStr(PIS.vPIS));
                       end
                      else if CST = pis99 then
                       begin
                         trvwNFe.Items.AddChild(Node,'vBC='          +FloatToStr(PIS.vBC));
                         trvwNFe.Items.AddChild(Node,'pPIS='         +FloatToStr(PIS.pPIS));
                         trvwNFe.Items.AddChild(Node,'qBCProd='      +FloatToStr(PIS.qBCProd));
                         trvwNFe.Items.AddChild(Node,'vAliqProd='    +FloatToStr(PIS.vAliqProd));
                         trvwNFe.Items.AddChild(Node,'vPIS='         +FloatToStr(PIS.vPIS));
                       end;
                    end;

                   if (PISST.vBc>0) then
                    begin
                      Node := trvwNFe.Items.AddChild(NodePai,'PISST');
                      with PISST do
                       begin
                         trvwNFe.Items.AddChild(Node,'vBc='          +FloatToStr(vBc));
                         trvwNFe.Items.AddChild(Node,'pPis='         +FloatToStr(pPis));
                         trvwNFe.Items.AddChild(Node,'qBCProd='      +FloatToStr(qBCProd));
                         trvwNFe.Items.AddChild(Node,'vAliqProd='    +FloatToStr(vAliqProd));
                         trvwNFe.Items.AddChild(Node,'vPIS='         +FloatToStr(vPIS));
                       end;
                      end;

                   Node := trvwNFe.Items.AddChild(NodePai,'COFINS');
                   with COFINS do
                    begin
                      trvwNFe.Items.AddChild(Node,'CST='             +CSTCOFINSToStr(CST));

                      // if (CST = cof01) or (CST = cof02) then
                      if (CST = cof01) or (CST = cof02) or (CST = cof05)  then
                       begin
                         trvwNFe.Items.AddChild(Node,'vBC='          +FloatToStr(COFINS.vBC));
                         trvwNFe.Items.AddChild(Node,'pCOFINS='      +FloatToStr(COFINS.pCOFINS));
                         trvwNFe.Items.AddChild(Node,'vCOFINS='      +FloatToStr(COFINS.vCOFINS));
                       end
                      else if CST = cof03 then
                       begin
                         trvwNFe.Items.AddChild(Node,'qBCProd='      +FloatToStr(COFINS.qBCProd));
                         trvwNFe.Items.AddChild(Node,'vAliqProd='    +FloatToStr(COFINS.vAliqProd));
                         trvwNFe.Items.AddChild(Node,'vCOFINS='      +FloatToStr(COFINS.vCOFINS));
                       end
                      else if CST = cof99 then
                       begin
                         trvwNFe.Items.AddChild(Node,'vBC='          +FloatToStr(COFINS.vBC));
                         trvwNFe.Items.AddChild(Node,'pCOFINS='      +FloatToStr(COFINS.pCOFINS));
                         trvwNFe.Items.AddChild(Node,'qBCProd='      +FloatToStr(COFINS.qBCProd));
                         trvwNFe.Items.AddChild(Node,'vAliqProd='    +FloatToStr(COFINS.vAliqProd));
                         trvwNFe.Items.AddChild(Node,'vCOFINS='      +FloatToStr(COFINS.vCOFINS));
                       end;
                    end;

                   if (COFINSST.vBC > 0) then
                    begin
                      Node := trvwNFe.Items.AddChild(NodePai,'COFINSST');
                      with COFINSST do
                       begin
                         trvwNFe.Items.AddChild(Node,'vBC='          +FloatToStr(vBC));
                         trvwNFe.Items.AddChild(Node,'pCOFINS='      +FloatToStr(pCOFINS));
                         trvwNFe.Items.AddChild(Node,'qBCProd='      +FloatToStr(qBCProd));
                         trvwNFe.Items.AddChild(Node,'vAliqProd='    +FloatToStr(vAliqProd));
                         trvwNFe.Items.AddChild(Node,'vCOFINS='      +FloatToStr(vCOFINS));
                       end;
                    end;
                end;
             end;
          end ;

       NodePai := trvwNFe.Items.AddChild(Nota,'Total');
       Node := trvwNFe.Items.AddChild(NodePai,'ICMSTot');
       trvwNFe.Items.AddChild(Node,'vBC='          +FloatToStr(Total.ICMSTot.vBC));
       trvwNFe.Items.AddChild(Node,'vICMS='        +FloatToStr(Total.ICMSTot.vICMS)) ;
       trvwNFe.Items.AddChild(Node,'vBCST='        +FloatToStr(Total.ICMSTot.vBCST)) ;
       trvwNFe.Items.AddChild(Node,'vST='          +FloatToStr(Total.ICMSTot.vST)) ;
       trvwNFe.Items.AddChild(Node,'vProd='        +FloatToStr(Total.ICMSTot.vProd)) ;
       trvwNFe.Items.AddChild(Node,'vFrete='       +FloatToStr(Total.ICMSTot.vFrete)) ;
       trvwNFe.Items.AddChild(Node,'vSeg='         +FloatToStr(Total.ICMSTot.vSeg)) ;
       trvwNFe.Items.AddChild(Node,'vDesc='        +FloatToStr(Total.ICMSTot.vDesc)) ;
       trvwNFe.Items.AddChild(Node,'vII='          +FloatToStr(Total.ICMSTot.vII)) ;
       trvwNFe.Items.AddChild(Node,'vIPI='         +FloatToStr(Total.ICMSTot.vIPI)) ;
       trvwNFe.Items.AddChild(Node,'vPIS='         +FloatToStr(Total.ICMSTot.vPIS)) ;
       trvwNFe.Items.AddChild(Node,'vCOFINS='      +FloatToStr(Total.ICMSTot.vCOFINS)) ;
       trvwNFe.Items.AddChild(Node,'vOutro='       +FloatToStr(Total.ICMSTot.vOutro)) ;
       trvwNFe.Items.AddChild(Node,'vNF='          +FloatToStr(Total.ICMSTot.vNF)) ;
       trvwNFe.Items.AddChild(Node,'vICMSDeson='   +FloatToStr(Total.ICMSTot.vICMSDeson)) ;   // 2016-10-11 ; nova linha inclusção
       trvwNFe.Items.AddChild(Node,'vFCPUFDest='   +FloatToStr(Total.ICMSTot.vFCPUFDest)) ;   // 2016-3-22 ; nova linha inclusção
       trvwNFe.Items.AddChild(Node,'vICMSUFDest='  +FloatToStr(Total.ICMSTot.vICMSUFDest)) ;  // 2016-3-22 ; nova linha inclusção
       trvwNFe.Items.AddChild(Node,'vICMSUFRemet=' +FloatToStr(Total.ICMSTot.vICMSUFRemet)) ; // 2016-3-22 ; nova linha inclusção

       if Total.ISSQNtot.vServ > 0 then
        begin
          Node := trvwNFe.Items.AddChild(NodePai,'ISSQNtot');
          trvwNFe.Items.AddChild(Node,'vServ='     +FloatToStr(Total.ISSQNtot.vServ)) ;
          trvwNFe.Items.AddChild(Node,'vBC='       +FloatToStr(Total.ISSQNTot.vBC)) ;
          trvwNFe.Items.AddChild(Node,'vISS='      +FloatToStr(Total.ISSQNTot.vISS)) ;
          trvwNFe.Items.AddChild(Node,'vPIS='      +FloatToStr(Total.ISSQNTot.vPIS)) ;
          trvwNFe.Items.AddChild(Node,'vCOFINS='   +FloatToStr(Total.ISSQNTot.vCOFINS)) ;
        end;

       Node := trvwNFe.Items.AddChild(NodePai,'retTrib');
       trvwNFe.Items.AddChild(Node,'vRetPIS='      +FloatToStr(Total.retTrib.vRetPIS)) ;
       trvwNFe.Items.AddChild(Node,'vRetCOFINS='   +FloatToStr(Total.retTrib.vRetCOFINS)) ;
       trvwNFe.Items.AddChild(Node,'vRetCSLL='     +FloatToStr(Total.retTrib.vRetCSLL)) ;
       trvwNFe.Items.AddChild(Node,'vBCIRRF='      +FloatToStr(Total.retTrib.vBCIRRF)) ;
       trvwNFe.Items.AddChild(Node,'vIRRF='        +FloatToStr(Total.retTrib.vIRRF)) ;
       trvwNFe.Items.AddChild(Node,'vBCRetPrev='   +FloatToStr(Total.retTrib.vBCRetPrev)) ;
       trvwNFe.Items.AddChild(Node,'vRetPrev='     +FloatToStr(Total.retTrib.vRetPrev)) ;

       NodePai := trvwNFe.Items.AddChild(Nota,'Transp');
       Node := trvwNFe.Items.AddChild(NodePai,'Transporta');
       trvwNFe.Items.AddChild(Node,'modFrete='     +modFreteToStr(Transp.modFrete));
       trvwNFe.Items.AddChild(Node,'CNPJCPF='      +Transp.Transporta.CNPJCPF);
       trvwNFe.Items.AddChild(Node,'xNome='        +Transp.Transporta.xNome);
       trvwNFe.Items.AddChild(Node,'IE='           +Transp.Transporta.IE);
       trvwNFe.Items.AddChild(Node,'xEnder='       +Transp.Transporta.xEnder);
       trvwNFe.Items.AddChild(Node,'xMun='         +Transp.Transporta.xMun);
       trvwNFe.Items.AddChild(Node,'UF='           +Transp.Transporta.UF);

       Node := trvwNFe.Items.AddChild(NodePai,'retTransp');
       trvwNFe.Items.AddChild(Node,'vServ='        +FloatToStr(Transp.retTransp.vServ)) ;
       trvwNFe.Items.AddChild(Node,'vBCRet='       +FloatToStr(Transp.retTransp.vBCRet)) ;
       trvwNFe.Items.AddChild(Node,'pICMSRet='     +FloatToStr(Transp.retTransp.pICMSRet)) ;
       trvwNFe.Items.AddChild(Node,'vICMSRet='     +FloatToStr(Transp.retTransp.vICMSRet)) ;
       trvwNFe.Items.AddChild(Node,'CFOP='         +Transp.retTransp.CFOP);
       trvwNFe.Items.AddChild(Node,'cMunFG='       +FloatToStr(Transp.retTransp.cMunFG));

       Node := trvwNFe.Items.AddChild(NodePai,'veicTransp');
       trvwNFe.Items.AddChild(Node,'placa='        +Transp.veicTransp.placa);
       trvwNFe.Items.AddChild(Node,'UF='           +Transp.veicTransp.UF);
       trvwNFe.Items.AddChild(Node,'RNTC='         +Transp.veicTransp.RNTC);

       for I:=0 to Transp.Reboque.Count-1 do
        begin
          Node := trvwNFe.Items.AddChild(NodePai,'Reboque'+IntToStrZero(I+1,3));
          with Transp.Reboque.Items[I] do
           begin
             trvwNFe.Items.AddChild(Node,'placa='  +placa) ;
             trvwNFe.Items.AddChild(Node,'UF='     +UF) ;
             trvwNFe.Items.AddChild(Node,'RNTC='   +RNTC) ;
           end;
        end;

       for I:=0 to Transp.Vol.Count-1 do
        begin
          Node := trvwNFe.Items.AddChild(NodePai,'Volume'+IntToStrZero(I+1,3));
          with Transp.Vol.Items[I] do
           begin
             trvwNFe.Items.AddChild(Node,'qVol='   +IntToStr(qVol)) ;
             trvwNFe.Items.AddChild(Node,'esp='    +esp);
             trvwNFe.Items.AddChild(Node,'marca='  +marca);
             trvwNFe.Items.AddChild(Node,'nVol='   +nVol);
             trvwNFe.Items.AddChild(Node,'pesoL='  +FloatToStr(pesoL)) ;
             trvwNFe.Items.AddChild(Node,'pesoB'   +FloatToStr(pesoB)) ;

             for J:=0 to Lacres.Count-1 do
              begin
                Node := trvwNFe.Items.AddChild(Node,'Lacre'+IntToStrZero(I+1,3)+IntToStrZero(J+1,3) );
                trvwNFe.Items.AddChild(Node,'nLacre='+Lacres.Items[J].nLacre) ;
              end;
           end;
        end;

       if (gModelo = 55) then
        begin
         NodePai := trvwNFe.Items.AddChild(Nota,'Cobr');
         Node    := trvwNFe.Items.AddChild(NodePai,'Fat');
         trvwNFe.Items.AddChild(Node,'nFat='       +Cobr.Fat.nFat);
         trvwNFe.Items.AddChild(Node,'vOrig='      +FloatToStr(Cobr.Fat.vOrig)) ;
         trvwNFe.Items.AddChild(Node,'vDesc='      +FloatToStr(Cobr.Fat.vDesc)) ;
         trvwNFe.Items.AddChild(Node,'vLiq='       +FloatToStr(Cobr.Fat.vLiq)) ;
        end;

       for I:=0 to Cobr.Dup.Count-1 do
        begin
          Node    := trvwNFe.Items.AddChild(NodePai,'Duplicata'+IntToStrZero(I+1,3));
          with Cobr.Dup.Items[I] do
           begin
             trvwNFe.Items.AddChild(Node,'nDup='   +nDup) ;
             trvwNFe.Items.AddChild(Node,'dVenc='  +DateToStr(dVenc));
             trvwNFe.Items.AddChild(Node,'vDup='   +FloatToStr(vDup)) ;
           end;
        end;

       NodePai := trvwNFe.Items.AddChild(Nota,'InfAdic');
       trvwNFe.Items.AddChild(NodePai,'infCpl='    +InfAdic.infCpl);
       trvwNFe.Items.AddChild(NodePai,'infAdFisco='+InfAdic.infAdFisco);

       for I:=0 to InfAdic.obsCont.Count-1 do
        begin
          Node := trvwNFe.Items.AddChild(NodePai,'obsCont'+IntToStrZero(I+1,3));
          with InfAdic.obsCont.Items[I] do
           begin
             trvwNFe.Items.AddChild(Node,'xCampo=' +xCampo) ;
             trvwNFe.Items.AddChild(Node,'xTexto=' +xTexto);
           end;
        end;

         for I:=0 to InfAdic.obsFisco.Count-1 do
          begin
            Node := trvwNFe.Items.AddChild(NodePai,'obsFisco'+IntToStrZero(I+1,3));
            with InfAdic.obsFisco.Items[I] do
             begin
                trvwNFe.Items.AddChild(Node,'xCampo=' +xCampo) ;
                trvwNFe.Items.AddChild(Node,'xTexto=' +xTexto);
             end;
          end;

         for I:=0 to InfAdic.procRef.Count-1 do
          begin
            Node := trvwNFe.Items.AddChild(NodePai,'procRef'+IntToStrZero(I+1,3));
            with InfAdic.procRef.Items[I] do
             begin
               trvwNFe.Items.AddChild(Node,'nProc='   +nProc) ;
               trvwNFe.Items.AddChild(Node,'indProc=' +indProcToStr(indProc));
             end;
          end;

         if (exporta.UFembarq <> '') then
          begin
            Node := trvwNFe.Items.AddChild(Nota,'exporta');
            trvwNFe.Items.AddChild(Node,'UFembarq='   +exporta.UFembarq) ;
            trvwNFe.Items.AddChild(Node,'xLocEmbarq=' +exporta.xLocEmbarq);
          end;

         if (compra.xNEmp <> '') then
          begin
            Node := trvwNFe.Items.AddChild(Nota,'compra');
            trvwNFe.Items.AddChild(Node,'xNEmp=' +compra.xNEmp) ;
            trvwNFe.Items.AddChild(Node,'xPed='  +compra.xPed);
            trvwNFe.Items.AddChild(Node,'xCont=' +compra.xCont);
          end;
     end;

     PageControl1.ActivePageIndex := 3;

     end;
  end;
  trvwNFe.FullExpand;
  trvwNFe.Select(nota);

 /// By Edson Lima 14.9.2012 ; 10:10 - Atualiza grade
 pAtuNFeT();
end;

procedure TFrGBNFe.BitBtn7Click(Sender: TObject);
var
 vPdf, vAux, xAux, vCaminho: string;
 ProcInfo                  : TProcessInformation;
 c                         : Integer;

begin

 CloseHandle(ProcInfo.hProcess);

 DMNFe.ZQuery5.first;
 while ((not DMNFe.ZQuery5.eof) and (DMNFe.ZQuery5['nfe_nnf'] <> Null)) do begin

  DMNFe.ZQuery5.FieldByName('Checado').ReadOnly := False;

  if DMNFe.ZQuery5['Checado'] = 'Y' then
   begin
    //*******************************************************************************
    // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update

    gModelo := DMNFe.ZQuery5['nfe_Modelo'];
    gSerie  := DMNFe.ZQuery5['nfe_Serie'];

    if ( gCpt = 1 ) then
     pDefineRel()                                                               // Define o tipo de Relatório FortesReport
    else
     pDefineRelFR();                                                            // Define o tipo de Relatório FastReport

    gCdloja_Consiste := dxSpinEdit1.Text;
    gdEmi_Consiste   := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery5['nfe_demi']);
    gNNF_Consiste    := vartostr(DMNFe.ZQuery5['nfe_nnf']);
    gSerie_Consiste  := vartostr(DMNFe.ZQuery5['nfe_serie']);
    gSerie           := StrToInt(gSerie_Consiste);
    gChave_Consiste  := '';                                                     // está sendo atribuida depois da sp_calcula_digito_chave

    vAux         := DMNFe.ZQuery5['nfe_chave_nfe'];
    if vAux <> '' then
     begin

      xAux := trim(gCamLog) + trim(vAux) + '-nfe.xml';                          // by EL 24.2.2012 -> xAux := trim(FrPar.edtPathLogs.Text) + '\' + trim(vAux) + '-nfe.xml';
      vPdf := trim(gCamPdf) + trim(vAux) + '-nfe.pdf';

      if FileExists(vPdf) then
       begin

        if Application.MessageBox( 'Pdf já existe, gostaria de recriá-lo?', 'GBNFe - Gera PDF', MB_ICONQUESTION + MB_YESNO ) = IdYes then
         begin
          ACBrNFe1.NotasFiscais.Clear;
          ACBrNFe1.NotasFiscais.LoadFromFile(xAux);
          ACBrNFe1.NotasFiscais.ImprimirPDF;
         end;

         pImpr();

       end
      else
       begin

        ACBrNFe1.NotasFiscais.Clear;
        ACBrNFe1.NotasFiscais.LoadFromFile(xAux);
        ACBrNFe1.NotasFiscais.ImprimirPDF;

        pImpr();

       end;

     end;
   end;
  DMNFe.ZQuery5.Next;
 end;

 /// By Edson Lima 14.9.2012 ; 10:10 - Atualiza grade
 pAtuNFeT();

end;

procedure TFrGBNFe.BitBtn6Click(Sender: TObject);
var
 I, vC        : Integer;
 Para, vI, vP : String;
 CC           : Tstrings;
begin

 // by Edson ; 2013/03/21T14:21 ; Estabelece o envio do arquivo de cancelamento por email
 if (RadioGroup1.ItemIndex = 4) then         // Canceladas
  begin

   //---------------------------------------------------------------------------
   pEnviaEmailCan();
   exit;
   //---------------------------------------------------------------------------

  end;

 // by Edson ; 2013/03/21T17:54 ; Estabelece o envio do arquivo da NFe por email
 DMNFe.ZQuery5.first;
 while ((not DMNFe.ZQuery5.eof) and (DMNFe.ZQuery5['nfe_nnf'] <> Null)) do begin

   DMNFe.ZQuery5.FieldByName('Checado').ReadOnly := False;

   if DMNFe.ZQuery5['Checado'] = 'Y' then
    begin
     //*******************************************************************************
     // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update

     gModelo := DMNFe.ZQuery5['nfe_Modelo'];
     gSerie  := DMNFe.ZQuery5['nfe_Serie'];

     if ( gCpt = 1 ) then
      pDefineRel()                                                              // Define o tipo de Relatório FortesReport
     else
      pDefineRelFR();                                                           // Define o tipo de Relatório FastReport

     gCdloja_Consiste := dxSpinEdit1.Text;
     gdEmi_Consiste   := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery5['nfe_demi']);
     gNNF_Consiste    := vartostr(DMNFe.ZQuery5['nfe_nnf']);
     gSerie_Consiste  := vartostr(DMNFe.ZQuery5['nfe_serie']);
     gSerie           := StrToInt(gSerie_Consiste);
     gChave_Consiste  := '';                                                    // está sendo atribuida depois da sp_calcula_digito_chave

     xAux := trim(vartostr(DMNFe.ZQuery5['nfe_chave_nfe']));
     if xAux <> '' then begin
       //pega os dados do destinatario
       DMNFe.ZQuery2.Close;
       DMNFe.ZQuery2.SQL.Clear;
       DMNFe.ZQuery2.SQL.Add( 'Select                                                               ' );
       DMNFe.ZQuery2.SQL.Add( 't1.*                                                                 ' );
       DMNFe.ZQuery2.SQL.Add( 'from destinatario t1                                                 ' );
       DMNFe.ZQuery2.SQL.Add( 'inner join nfe t2 on t2.codigo_destinatario = t1.codigo              ' );
       DMNFe.ZQuery2.SQL.Add( 'where t2.codigo_loja = :parm1                                        ' );
       DMNFe.ZQuery2.SQL.Add( 'and t2.chave_nfe = :parm2                                            ' );
       DMNFe.ZQuery2.Params[0].AsInteger := dxSpinEdit1.intValue;
       DMNFe.ZQuery2.Params[1].AsString  := (xAux);
       DMNFe.ZQuery2.Open;
       if DMNFe.ZQuery2.IsEmpty then begin
         MessageDlg('Nfe não existe',mtInformation,[mbOK],0);
         exit;
       end;

       para := vartostr(DMNFe.ZQuery2['email']);

       if ( (trim(para) = '') or (FrPar.CheckBox10.Checked) ) then
        begin
         // By Edson Lima - 2016-6-30T1143 - Verifica o email do destinatário
         if not(InputQuery(vartostr(DMNFe.ZQuery2['razao_social']), 'Email de destino:', Para)) then exit;
         while (not fValidaEmail(para)) do
          begin
           if (not fValidaEmail(para)) then
            Application.Messagebox('Campo de email do destinatário inválido! ','Atenção!',mb_iconstop+mb_ok);
           if not(InputQuery(vartostr(DMNFe.ZQuery2['razao_social']), 'Email de destino:', Para)) then exit;
          end;
        end;

       xAux := trim(gCamLog) + '\' + trim(xAux) + '-nfe.xml';                   /// by EL 24.2.2012 -> xAux := trim(FrPar.edtPathLogs.Text) + '\' + trim(xAux) + '-nfe.xml';

       begin
         ACBrNFe1.NotasFiscais.Clear;
         ACBrNFe1.NotasFiscais.LoadFromFile(xAux);
         CC:=TstringList.Create;

         if ( FrPar.edtEnvCC.Text <> '') then
          for I := 1 to (Length(FrPar.edtEnvCC.Text)+1) do
           begin
            if (FrPar.edtEnvCC.Text[I] = ',') or (FrPar.edtEnvCC.Text[I] = ';') or (I = Length(FrPar.edtEnvCC.Text)+1)then
             begin
              CC.Add(trim(vI));                                                 //especifique um email válido
              vI := '';
             end
            else
             vI := (vI + FrPar.edtEnvCC.Text[I]);
           end;

          vI := '';                                                             // Limpa variável
          vC := 0;                                                              // zera contador

          for I := 1 to (Length(Para)+1) do
           begin
            if (Para[I] = ',') or (Para[I] = ';') or (I = Length(Para)+1)then
             begin
              if vC > 0 then
               CC.Add(trim(vI))                                              //especifique um email válido
              else
               vP := trim(vI);                                               // Atribui apenas o primeiro email

              vI := '';
              inc(vC);                                                       // Incrementa 1
             end
            else
             vI := (vI + Para[I]);
           end;

          Para := vP;

         ACBrNFe1.NotasFiscais.Items[0].EnviarEmail(Para
                                                  , FrPar.edtEmailAssunto.Text + ' - Nº ' + VarToStr(DMNFe.ZQuery5['nfe_nnf'])
                                                  , FrPar.mmEmailMsg.Lines
                                                  , True                     //Enviar PDF junto
                                                  , CC                       //com copia
                                                  , nil
                                                   );

         CC.Free;

       end;

     end;

   end;
   DMNFe.ZQuery5.Next;
 end;

 /// By Edson Lima 14.9.2012 ; 10:10 - Atualiza grade
 pAtuNFeT();
end;

procedure TFrGBNFe.dxSpinEdit2Exit(Sender: TObject);
begin
 pAtuNFe();
end;

procedure TFrGBNFe.SelecionarTudo1Click(Sender: TObject);
begin
 MarcaBloco( dxTLPend, True, True );
end;

procedure TFrGBNFe.MarcaDesmarcaTodos1Click(Sender: TObject);
begin
 MarcaBloco( dxTLCont, True, True );
end;

procedure TFrGBNFe.MarcaDesmarcaTodos2Click(Sender: TObject);
begin
 MarcaBloco( dxTLTrans, True, True );
end;

procedure TFrGBNFe.DesmarcarTudo1Click(Sender: TObject);
begin
 MarcaBloco( dxTLPend, False, True );
end;

procedure TFrGBNFe.DesmarcarTodas1Click(Sender: TObject);
begin
 MarcaBloco( dxTLCont, False, True );
end;

procedure TFrGBNFe.DesmarcarTodas2Click(Sender: TObject);
begin
 MarcaBloco( dxTLTrans, False, True );
end;

procedure TFrGBNFe.FormClose(Sender: TObject; var Action: TCloseAction);
begin

 // Exclui os arquivos temporários
 // by Edson Lima ; 2016-8-31T1738
 gExcTmp := True;
 ConsultaWeb5inuClick(Sender);
 //-------------------------------

 if ( ACBrNFe1.DANFE = ACBrNFeDANFeRL1 ) then
  begin
   ACBrNFeDANFERL1.Free;                                                        // trunk2 - Antes => ACBrNFeDANFERave1.Free;
   ACBrNFeDANFCeFortes1.Free;                                                   // trunk2 - Novo
   ACBrNFeDANFCeFortesA41.Free;
  end
 else
  begin

   ACBrNFeDANFEFR1.Free;                                                        // trunk2 - Antes => ACBrNFeDANFERave1.Free;
   ACBrNFeDANFeESCPOS1.Free;                                                    // trunk2 - Novo
   ACBrECFVirtualNFCe1.Free;
  end;


 Application.Terminate;

end;

procedure TFrGBNFe.BitBtn12Click(Sender: TObject);
begin
 Close;
end;

//---
// Funcao     : StrZero
// Parametros : String Numerica, Quantidade
// Objetivo   : Preencher zeros a esquerda de uma string numerica
//---

Function TFrGBNFe.StrZero( cString: String; iInteger: Integer ): String;
Var
  iInt, i : Integer;
  cStr    : String;

begin
  iInt := 0;
  cStr := '';

  if iInteger > Length( Trim( cString ) ) then                                  {Testa se o tamanho informado é maior que a string passada}
    iInt := ( IInteger - Length( Trim( cString ) ) );

  for i:= 1 to iInt do
    cStr := cStr + '0';

  StrZero := cStr + Trim( cString );
end;

//el------------------GB Informática Ltda------------------------
//
// Data.......: segunda-feira 23.4.2012 14:23
// Ultima Alt.:
// Descrição..: Proc. de atribuição de variáveis pra de caminhos
//              padrão e do executavel do arquivo ini
//
//------------------------------------------------------------ok-
procedure TFrGBNFe.pAtrCam(); // Atribui caminhos do ini nas variáveis padrão e executavel
var
 i       : integer;
begin
 if FrPar.ragLocSrv.ItemIndex = 0 then
  gCamPad :=  FrPar.edtCamSrv.Text
 else
  gCamPad := gCamExe;        // Caminho padrão será modificado mais adiante

 if FrPar.ragLocSrv.ItemIndex = 1 then
  begin
   for i := Length(gCamPad) - 1 downto 0 do
    if gCamPad[i] = '\' then
     begin
      gCamPad := Copy(gCamPad, 1, (i-1));
      Break;
     end;
  end;

 gCamPad := gCamPad + '\';

 // Atribui caminhos para as variáveis globais
 gCamRep        := (gCamExe + 'Report\');                              // Caminho dos Arquivos Report
 gCamSch        := (gCamExe + 'Schemas\');                             // Caminho dos Arquivos de Schemas
 gCamTxt        := (gCamPad + 'Txt\');                                 // Caminho dos Arquivos Textos - vai pro sp_ler_nfe_textos
 gCamXml        := (gCamPad + 'Arq\Emp' + gCodEmp + '\Xml\');          // Caminho dos Arquivos Xml
 gCamXmlI       := (gCamPad + 'Arq\Emp' + gCodEmp + '\XmlI\');         // Caminho dos Arquivos XmlI de Importação
 gCamCert       := (gCamExe);                                          // Caminho do Arquivo GBNFe.ini
 gCamPdf        := (gCamPad + 'Arq\Emp' + gCodEmp + '\Pdf\');          // Caminho dos Arquivos Pdf
 gCamLog        := (gCamPad + 'Arq\Emp' + gCodEmp + '\Log\');          // Caminho dos Arquivos Log
 gCamBak        := (gCamPad + 'Arq\Bak\');                             // Caminho dos Arquivos Bak    - vai pro sp_bak
 gCamDoc        := (gCamPad + 'Arq\Emp' + gCodEmp + '\Doc\');          // Caminho dos Arquivos Doc
end;

//el------------------GB Informática Ltda------------------------
//
// Data.......: terça-feira 24.4.2012 10:15
// Ultima Alt.:
// Descrição..: Proc. que encrypta e decrypta uma senha
//
//------------------------------------------------------------ok-

function TFrGBNFe.EnDecrypt(StrValue : String; Chave: Word) : String;
var
 I: Integer;
 OutValue : String;
begin
 OutValue := '';
 for I := 1 to Length(StrValue) do
  OutValue := OutValue + char(Not(ord(StrValue[I])-Chave));
 Result := OutValue;
end;

//el------------------GB Informática Ltda------------------------
//
// Data.......: terça-feira 24.4.2012 10:15
// Ultima Alt.:
// Descrição..: Function que compartilha pasta de um outro micro e
//              mapeia com uma letra
// Obs........: Se "PLetra" for deixada em branco, o acesso será
//              liberado sem ser criada uma unidade lógica.
//              ESTA FUNÇÃO NÃO ESTA SENDO USADA
//------------------------------------------------------------ok-

Function TFrGBNFe.fUniMap(PServer, PLetra, PSenha :Pchar): Boolean;
var
 err     : DWord;
Begin
 ERR := WNetAddConnection ( PServer , PSenha , PLetra );
 CASE ERR of
  ERROR_ACCESS_DENIED             : ShowMessage ( 'Acesso negado.' );
  ERROR_ALREADY_ASSIGNED          : ShowMessage ( 'A letra do drive especificada já está conectada.' );
  ERROR_BAD_DEV_TYPE              : ShowMessage ( 'O tipo de dispositivo e o tipo de recurso não são compatíveis.' );
  ERROR_BAD_DEVICE                : ShowMessage ( 'Letra inválida.' );
  ERROR_BAD_NET_NAME              : ShowMessage ( 'Nome do servidor não é válido ou não pode ser localizado.' );
  ERROR_BAD_PROFILE               : ShowMessage ( 'Formato incorreto de parâmetros.' );
  ERROR_CANNOT_OPEN_PROFILE       : ShowMessage ( 'Conexão permanente não disponível.' );
  ERROR_DEVICE_ALREADY_REMEMBERED : ShowMessage ( 'Uma entrada para o dispositivo especificado já está no perfil do usuário.' );
  ERROR_EXTENDED_ERROR            : ShowMessage ( 'Erro de rede.' );
  ERROR_INVALID_PASSWORD          : ShowMessage ( 'Senha especificada inválida.' );
  ERROR_NO_NET_OR_BAD_PATH        : ShowMessage ( 'A operação não foi concluída porque a rede não foi inicializada ou caminho é inválido.' );
  ERROR_NO_NETWORK                : ShowMessage ( 'A rede não está presente.' );
 else if Err > 0 then
  ShowMessage (IntToStr(Err));
 end;
end;

//el------------------GB Informática Ltda------------------------
//
// Data.......: terça-feira 25.4.2012 14:44
// Ultima Alt.:
// Descrição..: Function Disconecta uma unidade mapeada via
//              programação
//
// Obs........: Letra = Letra atribuida a unidade
//              Forcada = Força o cancelamento do mapeamento
//              ESTA FUNÇÃO NÃO ESTA SENDO USADA
//------------------------------------------------------------ok-

function TFrGBNFe.fDesRed(Letra:Pchar; Forcada:boolean): String;
begin
 WNetCancelConnection2(Letra, CONNECT_UPDATE_PROFILE, Forcada);

 Case GetLastError() of
  1205: Result := 'Não foi possível abrir o perfil';
  1206: Result := 'Perfil do usuário não encontrado ou inválido';
  1208: Result := 'Ocorreu um Erro específico na rede';
  2138: Result := 'Rede não encontrada ou fora do ar';
  2250: Result := 'Mapeamento inválido ou não encontrado';
  2401: Result := 'Existem muitos arquivos abertos';
 else
  Result := 'Unidade disconectada com sucesso';
 end;
end;

//el------------------GB Informática Ltda------------------------
//
// Data.......: quinta-feira 26.4.2012 14:44
// Ultima Alt.:
// Descrição..: Function que trata da criação dos malditos tempo-
//              rarios DirXX.MB e os cria localmente
//
//------------------------------------------------------------ok-

function TFrGBNFe.fGetTempDir: String;
var
 TempDir: Array[0..255] of Char;
begin
 GetTempPath(255, @TempDir);
 Result := StrPas(TempDir);
end;

//el------------------GB Informática Ltda------------------------
//
// Data.......: quinta-feira 26.4.2012 14:44
// Ultima Alt.:
// Descrição..: function que retorna a versão do aplicativo
//
//------------------------------------------------------------ok-

function TFrGBNFe.GetBuildInfo:string;
var
 VerInfoSize: DWORD;
 VerInfo: Pointer;
 VerValueSize: DWORD;
 VerValue: PVSFixedFileInfo;
 Dummy: DWORD;
 V1, V2, V3, V4: Word;
 Prog : string;
begin
 Prog := Application.Exename;
 VerInfoSize := GetFileVersionInfoSize(PChar(prog), Dummy);
 GetMem(VerInfo, VerInfoSize);
 GetFileVersionInfo(PChar(prog), 0, VerInfoSize, VerInfo);
 VerQueryValue(VerInfo, '\', Pointer(VerValue), VerValueSize);

 with VerValue^ do
   begin
    V1 := dwFileVersionMS shr 16;
    V2 := dwFileVersionMS and $FFFF;
    V3 := dwFileVersionLS shr 16;
    V4 := dwFileVersionLS and $FFFF;
   end;

 FreeMem(VerInfo, VerInfoSize);

 result := (IntToStr (v1) + '.' +
            IntToStr (v2) + '.' +
            IntToStr (v3) + '.' +
            IntToStr (v4));
end;

procedure TFrGBNFe.SpeedButton1Click(Sender: TObject);
begin
 Close;
end;

procedure TFrGBNFe.BitBtn3Click(Sender: TObject);
begin
 if ( FrCCe = nil ) then
  FrCCe := TFrCCe.Create(Application)
 else
  FrCCe := TFrCCe.Create(Application);

 FrCCe.ShowModal;
 FrCCe.BringToFront;

 // By Edson Lima 14.9.2012 ; 10:10 - Atualiza grade
 pAtuNFe();
end;

//------------------------------------------------------------------------------
// Procedure  : TransmiteCCe
// Objetivo   : Efetua a transmissão da CCe para a base SEFAZ
// by Edson Lima ; 29-01-2013 ; 17:27
//------------------------------------------------------------------------------
Procedure TFrGBNFe.TransmiteCCe();
var
 I, vC                                    : Integer;
 vNnf, vP, Para, vI, xAux                 : String;
 Chave, idLote, CNPJ, nSeqEvento          : String;
 xAuxC, xAuxP, vChave                     : string;
 tpAmb                                    : TpcnTipoAmbiente;
 vUTC                                     : String;
 ddhEvento                                : TDateTime;
 vVer_Laiaute, vcOrgao,    vdhEvento,
 vVer_CCe,   vcStat,       vxMotivo,
 vemailDest, vdhRegEvento, vnProt         : String;
begin
 //*******************************************************************************
 // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update
 gCdloja_Consiste := dxSpinEdit1.Text;
 gdEmi_Consiste   := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery5['nfe_demi']);
 gNNF_Consiste    := vartostr(DMNFe.ZQuery5['nfe_nnf']);
 gSerie_Consiste  := vartostr(DMNFe.ZQuery5['nfe_serie']);
 gSerie           := StrToInt(gSerie_Consiste);
 gChave_Consiste  := '';                                                        // está sendo atribuida depois da sp_calcula_digito_chave

 // Atribuição de variáveis que serão usadas durante a transmissão
 Chave         := DMNFe.ZQuery11['CCe_chave_nfe'];
 idLote        := DMNFe.ZQuery11['CCe_idLote'];
 CNPJ          := copy(DMNFe.ZQuery11['CCe_chave_nfe'], 7, 14);      //  DMNFe.ZQuery4['cnpj'];
 nSeqEvento    := DMNFe.ZQuery11['CCe_Evento'];
 xAux          := DMNFe.ZQuery5['nfe_chave_nfe'];
 vChave        := xAux;
 xAux          := trim(gCamLog) + trim(xAux) + '-nfe.xml';
 vNnf          := gNNF_Consiste;

 // by Edson ; 2013/04/01T15:29 ; Contulta a nota na base sefaz para obter dados, ex: a data do evento..
 ACBrNFe1.NotasFiscais.Clear;
 ACBrNFe1.NotasFiscais.LoadFromFile(xAux);
 ACBrNFe1.Consultar;

 if (DMNFe.ZQuery4['Web_Ambiente'] <> Null) then
  begin
   if (DMNFe.ZQuery4['Web_Ambiente'] = 'H') then
    tpAmb   := taHomologacao
   else
    tpAmb   := taProducao;
  end
 else
  tpAmb     := taHomologacao;

 (* processo de desenvolvimento *)
 ACBrNFe1.EventoNFe.Evento.Clear;
 with ACBrNFe1.EventoNFe.Evento.Add do
  begin
   infEvento.id                  := DMNFe.ZQuery11['CCe_id'];
   infEvento.cOrgao              := strtoint(DMNFe.ZQuery4['codigo_uf']);
   infEvento.tpAmb               := tpAmb;
   infEvento.CNPJ                := CNPJ;
   infEvento.chNFe               := Chave;

   //---------------------------------------------------------------------------
   // by Edson ; 2013/4/18T0849 ; Verifica a data e hora do evento com UTC da UF
   case strtoint(DMNFe.ZQuery4['codigo_uf']) of
                                                                                //Região Norte
    11, 12, 13, 14:         vUTC := '-04:00';                                   // 11-Rondônia/RO - 12-Acre/AC - 13-Amazonas/AM - 14-Roraima/RR
    15, 16, 17:             vUTC := '-03:00';                                   // 15-Pará/PA - 16-Amapá/AP - 17-Tocantins/TO
                                                                                //Região Nordeste
    21, 22, 23, 24, 25:     vUTC := '-03:00';                                   // 21-Maranhão/MA - 22-Piauí/PI - 23-Ceará/CE - 24-Rio Grande do Norte/RN - 25-Paraíba/PB
    26:
     begin
      if (DMNFe.ZQuery4['codigo_municipio'] = '2605459') then
                            vUTC := '-02:00'                                    // 26-Pernambuco/PE - 2605459 - Fernando de Noronha
      else
                            vUTC := '-03:00';                                   // 26-Pernambuco/PE
     end;
    27, 28, 29:             vUTC := '-03:00';                                   // 27-Alagoas/AL - 28-Sergipe/SE - 29-Bahia/BA
                                                                                //Região Sudeste
    31, 32, 33, 35:         vUTC := '-03:00';                                   // 31-Minas Gerais/MG - 32-Espírito Santo/ES - 33-Rio de Janeiro/RJ - 35-São Paulo/SP
                                                                                // Região Sul
    41, 42, 43:             vUTC := '-03:00';                                   // 41-Paraná/PR - 42-Santa Catarina/SC - 43-Rio Grande do Sul/RS
                                                                                // Região Centro-Oeste
    50, 51:                 vUTC := '-04:00';                                   // 50-Mato Grosso do Sul/MS - 51-Mato Grosso/MT
    52, 53:                 vUTC := '-03:00';                                   // 52-Goiás/GO - 53-Distrito Federal/DF
   end;

   ddhEvento := now; //VarToDateTime(ACBrNFe1.WebServices.Consulta.DhRecbto);
   ddhEvento := (IncSecond(ddhEvento, 1));

   // Rotina para o período do Horário de Verão
   if (DMNFe.ZQuery4['DANFE_HorariodeVerao'] = 'S') then
    begin
     ddhEvento := (IncHour(ddhEvento, -1))
    end;

   if (DMNFe.ZQuery4['DANFE_UsaHorarioDF'] = 'S') then
    begin
     ddhEvento := (IncHour(ddhEvento, 1));
     ddhEvento := (IncSecond(ddhEvento, 2));
    end
   else
    ddhEvento := (IncSecond(ddhEvento, 2));

   vdhEvento := DateTimeToStr(ddhEvento);

   if (DMNFe.ZQuery4['DANFE_FusoHorario'] = 'S') then
    vdhEvento  := (vdhEvento + vUTC);

   //---------------------------------------------------------------------------

   infEvento.dhEvento            := StrToDateTime(vdhEvento);
   infEvento.tpEvento            := teCCe;
   infEvento.nSeqEvento          := StrToInt(nSeqEvento);
   infEvento.detEvento.descEvento:= c_desc_Evento;
   infEvento.detEvento.xCorrecao := DMNFe.ZQuery11['CCe_xCorrecao'];
  end;

 //-----------------------------------------------------------------------------
 // by
 //-----------------------------------------------------------------------------
 if ACBrNFe1.EnviarEvento(StrToInt(idLote)) then                                // trunk2 - Antes => if ACBrNFe1.EnviarEventoNFe(StrToInt(idLote)) then
  begin
   with ACBrNFe1.EventoNFe do
    begin
     xAuxC := trim(gCamXml) +                                                   // Caminho do arquivo log (gCamXml contém o caminho padrão) ex: c:\Sistemas\GBNFe\Arq\Emp001\Xml\
              FormatDateTime('yyyymm',Date) +                                   // Ano, mês
              '\Evento\CCe\' +                                                  // Evento e CCe
              Evento.Items[0].InfEvento.TipoEvento +                            // Tipo de evento, neste caso (110110)
              trim(vChave) +                                                    // Chave da NFe
              Format('%.2d', [Evento.Items[ 0].InfEvento.nSeqEvento]) +         // Sequencia do Evento com duas casas decimais
              '-procEventoNFe.xml';                                             // Final do nome + tipo (xml)

     xAuxP := trim(gCamPdf) +
     Evento.Items[0].InfEvento.TipoEvento +
     trim(vChave) +
     Format('%.2d', [Evento.Items[0].InfEvento.nSeqEvento]) +
     '-procEventoNFe.PDF';
    end;

   memoLog.Clear;
   MemoResp.Lines.Text   := UTF8Encode(ACBrNFe1.WebServices.EnvEvento.RetWS);
   MemoLog.Lines.Text    := UTF8Encode(ACBrNFe1.WebServices.EnvEvento.Msg);
   memoRespWS.Lines.Text := UTF8Encode(ACBrNFe1.WebServices.EnvEvento.RetornoWS);
   LoadXML(MemoResp, WBResposta);

   if ((VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) = '128')  or
       (VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) = '135')  or
       (VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) = '136')) then
    begin
     pGravaNFe('017', 'nProt_CCe', 'dhRegEvento_CCe', 'cStat_CCe',  'xMotivo_CCe', 'evento_CCe', 'xCorrecao_CCe', '',
               'codigo_loja', 'demi',      'nnf',       'serie', 'Modelo',
              ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.nProt,
              FormatDateTime('yyyy/mm/dd hh:nn:ss', ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.dhRegEvento),
              ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat,
              ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.xMotivo,
              StrToInt(nSeqEvento),
              DMNFe.ZQuery11['CCe_xCorrecao'],
              '',
              dxSpinEdit1.IntValue,
              FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery5['nfe_demi']),
              DMNFe.ZQuery5['nfe_nnf'],
              DMNFe.ZQuery5['nfe_serie'],
              DMNFe.ZQuery5['nfe_Modelo'], false);

     //pega os dados do destinatario
     DMNFe.ZQuery2.Close;
     DMNFe.ZQuery2.SQL.Clear;
     DMNFe.ZQuery2.SQL.Add( 'Select                                                       ' );
     DMNFe.ZQuery2.SQL.Add( 't1.*                                                         ' );
     DMNFe.ZQuery2.SQL.Add( 'from destinatario t1                                         ' );
     DMNFe.ZQuery2.SQL.Add( 'inner join nfe t2 on t2.codigo_destinatario = t1.codigo      ' );
     DMNFe.ZQuery2.SQL.Add( 'where t2.codigo_loja = :parm1                                ' );
     DMNFe.ZQuery2.SQL.Add( 'and t2.chave_nfe     = :parm2                                ' );
     DMNFe.ZQuery2.Params[0].AsInteger := dxSpinEdit1.intValue;
     DMNFe.ZQuery2.Params[1].AsString  := (vChave);
     DMNFe.ZQuery2.Open;
     if DMNFe.ZQuery2.IsEmpty then
      begin
       MessageDlg('Destinatário não encontrado! ',mtInformation,[mbOK],0);
       exit;
      end;

     // Atualiza a tabela CCe com os dados retornados da sefaz

     vVer_Laiaute   :=  VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.verAplic);
     vcOrgao        :=  VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cOrgao);
     vdhEvento      :=  FormatDateTime('yyyy/mm/dd hh:nn:ss', ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.dhRegEvento);
     vVer_CCe       :=  GetBuildInfo;
     vcStat         :=  VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat);
     vxMotivo       :=  VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.xMotivo);
     if DMNFe.ZQuery2['email'] <> null then
      vemailDest    :=  vartostr(DMNFe.ZQuery2['email'])
     else
      vemailDest    :=  '';
     vdhRegEvento   :=  FormatDateTime('yyyy/mm/dd hh:nn:ss', ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.dhRegEvento);
     vnProt         :=  VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.nProt);

     try
      DMNFe.ZQuery2.DisableControls;
      DMNFe.ZQuery2.Close;
      DMNFe.ZQuery2.SQL.Clear;
      DMNFe.ZQuery2.SQL.Add( 'Update NFe_CCe Set                                   ' );
      DMNFe.ZQuery2.SQL.Add( '    Ver_Laiaute    = :Ver_Laiaute                    ' );
      DMNFe.ZQuery2.SQL.Add( '   ,cOrgao         = :cOrgao                         ' );
      DMNFe.ZQuery2.SQL.Add( '   ,dhEvento	      = :dhEvento	                      ' );
      DMNFe.ZQuery2.SQL.Add( '   ,Ver_CCe	       = :Ver_CCe                        ' );
      DMNFe.ZQuery2.SQL.Add( '   ,cStat          = :cStat                          ' );
      DMNFe.ZQuery2.SQL.Add( '   ,xMotivo        = :xMotivo                        ' );
      DMNFe.ZQuery2.SQL.Add( '   ,emailDest      = :emailDest                      ' );
      DMNFe.ZQuery2.SQL.Add( '   ,dhRegEvento    = :dhRegEvento                    ' );
      DMNFe.ZQuery2.SQL.Add( '   ,nProt          = :nProt                          ' );
      DMNFe.ZQuery2.SQL.Add( 'where                                                ' );
      DMNFe.ZQuery2.SQL.Add( '    Codigo_Loja    = :Codigo_Loja  and               ' );
      DMNFe.ZQuery2.SQL.Add( '    nNF            = :nNF          and               ' );
      DMNFe.ZQuery2.SQL.Add( '    Evento         = :Evento       and               ' );
      DMNFe.ZQuery2.SQL.Add( '    dEmi           = :dEmi         and               ' );
      DMNFe.ZQuery2.SQL.Add( '    Modelo         = :Modelo       and               ' );
      DMNFe.ZQuery2.SQL.Add( '    Serie          = :Serie                          ' );
      DMNFe.ZQuery2.ParamByName('Ver_Laiaute').Value  := vVer_Laiaute;
      DMNFe.ZQuery2.ParamByName('cOrgao').Value       := vcOrgao;
      DMNFe.ZQuery2.ParamByName('dhEvento').Value     := vdhEvento;
      DMNFe.ZQuery2.ParamByName('Ver_CCe').Value      := vVer_CCe;
      DMNFe.ZQuery2.ParamByName('cStat').Value        := vcStat;
      DMNFe.ZQuery2.ParamByName('xMotivo').Value      := vxMotivo;
      DMNFe.ZQuery2.ParamByName('emailDest').Value    := vemailDest;
      DMNFe.ZQuery2.ParamByName('dhRegEvento').Value  := vdhRegEvento;
      DMNFe.ZQuery2.ParamByName('nProt').Value        := vnProt;
      DMNFe.ZQuery2.ParamByName('Codigo_Loja').Value  := dxSpinEdit1.intValue;
      DMNFe.ZQuery2.ParamByName('nNF').Value          := StrToInt(FrCCe.Edit_Nota.Text);
      DMNFe.ZQuery2.ParamByName('Evento').Value       := FrCCe.Edit_Evento.Text;
      DMNFe.ZQuery2.ParamByName('dEmi').Value         := FormatDateTime('yyyy/mm/dd', VarToDateTime(DMNFe.ZQuery5['nfe_demi']));
      DMNFe.ZQuery2.ParamByName('Modelo').Value       := VarToStr(DMNFe.ZQuery5['nfe_Modelo']);
      DMNFe.ZQuery2.ParamByName('Serie').Value        := VarToStr(DMNFe.ZQuery5['nfe_Serie']);

      try
       DMNFe.ZConnection1.StartTransaction;
       DMNFe.ZQuery2.ExecSQL;
      except
       DMNFe.ZConnection1.Rollback;
       Application.Messagebox('ERRO: CCe não atualizada !','Atenção!',mb_iconstop+mb_ok);
      end;
      DMNFe.ZQuery2.Close;
     finally
      DMNFe.ZQuery2.EnableControls;
     end;
    end
   else
    begin
     MessageDlg('Nota:[ ' + VarToStr(DMNFe.ZQuery5['nfe_nnf']) + ' ]' + Chr(13) +
                'Status: ' + VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) + Chr(13) +
                ' - Motivo:' + ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.xMotivo + Chr(13) +
                'REJEIÇÃO', mtInformation, [mbOK], 0);
     exit;
    end;

   if ((VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) = '128')  or
       (VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) = '135')  or
       (VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) = '136')) then
    begin

     // Gera PDF e Imprime
     FrCCe.p_ImprimeCCe();

     //pega os dados do destinatario
     DMNFe.ZQuery2.Close;
     DMNFe.ZQuery2.SQL.Clear;
     DMNFe.ZQuery2.SQL.Add( 'Select                                                       ' );
     DMNFe.ZQuery2.SQL.Add( 't1.*                                                         ' );
     DMNFe.ZQuery2.SQL.Add( 'from destinatario t1                                         ' );
     DMNFe.ZQuery2.SQL.Add( 'inner join nfe t2 on t2.codigo_destinatario = t1.codigo      ' );
     DMNFe.ZQuery2.SQL.Add( 'where t2.codigo_loja = :parm1                                ' );
     DMNFe.ZQuery2.SQL.Add( 'and t2.chave_nfe     = :parm2                                ' );
     DMNFe.ZQuery2.Params[0].AsInteger := dxSpinEdit1.intValue;
     DMNFe.ZQuery2.Params[1].AsString  := (vChave);
     DMNFe.ZQuery2.Open;
     if DMNFe.ZQuery2.IsEmpty then
      begin
       MessageDlg('Destinatário não encontrado! ',mtInformation,[mbOK],0);
       exit;
      end;

     para := vartostr(DMNFe.ZQuery2['email']);

     if ( (trim(para) = '') or (FrPar.CheckBox10.Checked) ) then
      begin
       // By Edson Lima - 2016-6-30T1143 - Verifica o email do destinatário
       while (not fValidaEmail(para)) do
        begin
         Para := '';
         if not(InputQuery(vartostr(DMNFe.ZQuery2['razao_social']), 'Email de destino:', Para)) then exit;
         if (not fValidaEmail(para)) then
          Application.Messagebox('Campo de email do destinatário inválido! ','Atenção!',mb_iconstop+mb_ok);
        end;
      end;

     if (para <> '') then
      begin
       if ( FrPar.edtEnvCC.Text <> '' ) then
        for I := 1 to (Length(FrPar.edtEnvCC.Text)+1) do
         begin
          if (FrPar.edtEnvCC.Text[I] = ',') or (FrPar.edtEnvCC.Text[I] = ';') or (I = Length(FrPar.edtEnvCC.Text)+1)then
           begin
            IdMessage.CCList.Add.Address := Trim(vI);                           //especifique um email válido
            vI := '';
           end
          else
           vI := (vI + Trim(FrPar.edtEnvCC.Text[I]));
         end;

         vI := '';                                                              // Limpa variável
         vC := 0;                                                               // zera contador

         for I := 1 to (Length(Para)+1) do
          begin
           if (Para[I] = ',') or (Para[I] = ';') or (I = Length(Para)+1)then
            begin
             if vC > 0 then
              IdMessage.CCList.Add.Address := Trim(vI)                          //especifique um email válido
             else
              vP := trim(vI);                                                   // Atribui apenas o primeiro email

             vI := '';
             inc(vC);                                                           // Incrementa 1
            end
           else
            vI := (vI + Trim(Para[I]));
          end;

         Para := vP;

         // Envia email do xml CCe
         IdSMTP.Port                         := StrToInt(FrPar.edtSmtpPort.Text);
         IdSMTP.Host                         := FrPar.edtSmtpHost.Text;
         IdSMTP.Username                     := FrPar.edtSmtpUser.Text;
         IdSMTP.Password                     := FrPar.edtSmtpPass.Text;
         IdSMTP.AuthenticationType           := atLogin;
         IdSMTP.UseEhlo                      := True;
         IdSMTP.Connect(0);

         IdMessage.From.Address              := FrPar.edtSmtpUser.Text;
         IdMessage.From.Name                 := Format('%s<%s>', [Trim(FrPar.edtNEeMail.Text), Trim(FrPar.edtSmtpUser.Text)]) ;
         IdMessage.Recipients.EMailAddresses := Para;
         IdMessage.Subject                   := FrPar.edtEmailCCeAssunto.Text + ' - Nº:' + vNnf;
         IdMessage.Body                      := FrPar.mmEmailMsg.Lines;
         TIdAttachment.Create(Idmessage.MessageParts, TFileName(xAuxC));
         TIdAttachment.Create(Idmessage.MessageParts, TFileName(xAuxP));

         try
          IdSMTP.Send(IdMessage);
          MessageDlg('Carta de Correção ref a NFe:[ ' + vNnf + ' ]' + Chr(13) +
                      'Status: ' + VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) + ' - Protocolo:' +
                      ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.nProt + Chr(13) +
                      'ENVIADA POR EMAIL !', mtInformation, [mbOK], 0);
         finally
          IdSMTP.Disconnect;
         end;
      end;

     if (VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) = '135') then
      MessageDlg('Carta de Correção ref a NFe:[ ' + vNnf + ' ]' + Chr(13) +
                 'Status: ' + VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) + ' - Protocolo:' +
                 ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.nProt + Chr(13) +
                 'REGISTRADA E VINCULADA A NFE !', mtInformation, [mbOK], 0)
     else
      MessageDlg('Carta de Correção ref a NFe:[ ' + vNnf + ' ]' + Chr(13) +
                 'Status: ' + VarToStr(ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat) + ' - Protocolo:' +
                 ACBrNFe1.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.nProt + Chr(13) +
                 'REGISTRADA, MAS NÃO VINCULADA A NFE !', mtInformation, [mbOK], 0);
    end;
  end
 else
  begin
   with ACBrNFe1.WebServices.EnvEvento do
    begin
     raise Exception.Create('Ocorreram erros ao enviar a Carta de Correção:' + sLineBreak +
                            'Lote: ' + IntToStr(EventoRetorno.idLote) + sLineBreak +
                            'Ambiente: ' + TpAmbToStr(EventoRetorno.tpAmb) + sLineBreak +
                            'Orgao: ' + IntToStr(EventoRetorno.cOrgao) + sLineBreak +
                            sLineBreak +
                            'Status: ' + IntToStr(EventoRetorno.cStat) + sLineBreak +
                            'Motivo: ' + EventoRetorno.xMotivo);
    end;
  end
end;

//------------------------------------------------------------------------------
// Procedure  : ConsultaCCe
// Objetivo   : Efetua a consulta da CCe para a base SEFAZ
// by Edson Lima ; 02-10-2013 ; 17:18
//------------------------------------------------------------------------------
Procedure TFrGBNFe.ConsultaCCe();
var
 i, vC, nSEve                             : Integer;
 vNnf, vP, Para, vI, xAux                 : String;
 Chave, idLote, CNPJ, nSeqEvento          : String;
 xAuxC, vChave, vtpEvento                 : string;
 tpAmb                                    : TpcnTipoAmbiente;
 vUTC                                     : String;
 ddhEvento                                : TDateTime;
 vctpAmb, vcOrgao, vcChave, vcStat,
 vxMotivo, vemailDest, vdhRegEvento,
 vnProt, vVer_Laiaute, vVer_CCe           : String;
 vnSequencia1, vnSequencia2               : Integer;
begin
 //-----------------------------------------------------------------------------
 // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update
 gCdloja_Consiste := dxSpinEdit1.Text;
 gdEmi_Consiste   := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery5['nfe_demi']);
 gNNF_Consiste    := vartostr(DMNFe.ZQuery5['nfe_nnf']);
 gSerie_Consiste  := vartostr(DMNFe.ZQuery5['nfe_serie']);
 gSerie           := StrToInt(gSerie_Consiste);
 gChave_Consiste  := vartostr(DMNFe.ZQuery5['nfe_chave_nfe']);

 // Atribuição de variáveis que serão usadas durante a transmissão
 Chave         := DMNFe.ZQuery11['CCe_chave_nfe'];
 idLote        := DMNFe.ZQuery11['CCe_idLote'];
 vTpEvento     := DMNFe.ZQuery11['CCe_TpEvento'];
 CNPJ          := DMNFe.ZQuery4['cnpj'];
 nSeqEvento    := DMNFe.ZQuery11['CCe_Evento'];
 nSEve         := StrToInt(nSeqEvento);
 xAux          := DMNFe.ZQuery5['nfe_chave_nfe'];
 vChave        := xAux;
 xAux          := trim(gCamLog) + trim(xAux) + '-nfe.xml';
 vNnf          := gNNF_Consiste;
 vC            := 0;

 // by Edson ; 2013/04/01T15:29 ; Contulta a nota na base sefaz para obter dados, ex: a data do evento..
 ACBrNFe1.NotasFiscais.Clear;
 ACBrNFe1.NotasFiscais.LoadFromFile(xAux);
 ACBrNFe1.Consultar;

 With ACBrNFe1.WebServices do
  begin

   vnSequencia1 := consulta.procEventoNFe.Count;

   if (vnSequencia1 < nSEve) then
    begin
     MessageDlg('NF-e sem eventos registrados! - Qtd.Eventos: ' + IntToStr(vnSequencia1) + '',mtInformation,[mbOK],0);
     exit;
    end;

   if consulta.procEventoNFe.Count <> 0 then
    begin

     for i := 0 to consulta.procEventoNFe.Count - 1 do
      begin

       if (VarToStr(consulta.procEventoNFe.Items[i].RetEventoNFe.InfEvento.TipoEvento) = vtpEvento) then
        begin

         vVer_Laiaute   := VarToStr(consulta.procEventoNFe.Items[i].RetEventoNFe.verAplic);
         vcOrgao        := VarToStr(consulta.procEventoNFe.Items[i].RetEventoNFe.cOrgao);
         vVer_CCe       := GetBuildInfo;

         vcStat         := VarToStr(consulta.procEventoNFe.Items[i].RetEventoNFe.cStat);
         vctpAmb        := TpAmbToStr(consulta.procEventoNFe.Items[i].RetEventoNFe.InfEvento.tpAmb);
         vxMotivo       := VarToStr(consulta.procEventoNFe.Items[i].RetEventoNFe.xMotivo);
         vnProt         := VarToStr(Consulta.procEventoNFe.Items[i].RetEventoNFe.retEvento.Items[0].RetInfEvento.nProt);
         vdhRegEvento   := FormatDateTime('yyyy/mm/dd hh:nn:ss', Consulta.procEventoNFe.Items[i].RetEventoNFe.retEvento.Items[0].RetInfEvento.dhRegEvento);
         vcChave        := VarToStr(consulta.procEventoNFe.Items[i].RetEventoNFe.InfEvento.chNFe);

         vC             := i;

        end;

      end;

     MessageDlg('DADOS DA CC-e da NOTA: ' + vartostr(DMNFe.ZQuery5['nfe_nnf']) + char(13) +
                ' Status = ' + vcStat + ' - ' + vxMotivo + char(13) +
                ' Ambiente = ' + vctpAmb + ' - Protocolo = ' + vnProt + char(13) +
                ' Dt.Reg.Evento = ' + vdhRegEvento + char(13) +
                ' Chave = ' + vcChave ,mtInformation,[mbOK],0);

     // Mostra Retorno
     memoLog.Clear;
     MemoResp.Lines.Text   := UTF8Encode(Consulta.RetWS);                         // Modificado depois da atualização do acbr de 02/12/2014 de (RetWS) para (Consulta.RetWS)
     MemoLog.Lines.Text    := UTF8Encode(Consulta.Msg);
     memoRespWS.Lines.Text := UTF8Encode(Consulta.RetornoWS);                   // Modificado depois da atualização do acbr de 02/12/2014 de (RetornoWS) para (Consulta.RetornoWS)
     LoadXML(MemoResp, WBResposta);

     if ((consulta.procEventoNFe.Items[vC].RetEventoNFe.cStat = 128)  or
         (consulta.procEventoNFe.Items[vC].RetEventoNFe.cStat = 135)  or
         (consulta.procEventoNFe.Items[vC].RetEventoNFe.cStat = 136)) then
      begin

       pGravaNFe('017', 'nProt_CCe', 'dhRegEvento_CCe', 'cStat_CCe',  'xMotivo_CCe', 'evento_CCe', 'xCorrecao_CCe', '',
                 'codigo_loja', 'demi', 'nnf', 'serie', 'chave_nfe',
                 Consulta.procEventoNFe.Items[vC].RetEventoNFe.retEvento.Items[0].RetInfEvento.nProt,
                 FormatDateTime('yyyy/mm/dd hh:nn:ss', Consulta.procEventoNFe.Items[vC].RetEventoNFe.retEvento.Items[0].RetInfEvento.dhRegEvento),
                 consulta.procEventoNFe.Items[vC].RetEventoNFe.cStat,
                 consulta.procEventoNFe.Items[vC].RetEventoNFe.xMotivo,
                 StrToInt(nSeqEvento),
                 DMNFe.ZQuery11['CCe_xCorrecao'],
                 '',
                 dxSpinEdit1.IntValue,
                 FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery5['nfe_demi']),
                 DMNFe.ZQuery5['nfe_nnf'],
                 DMNFe.ZQuery5['nfe_serie'],
                 consulta.protNFe.chNFe, true);

       //pega os dados do destinatario
       DMNFe.ZQuery2.Close;
       DMNFe.ZQuery2.SQL.Clear;
       DMNFe.ZQuery2.SQL.Add( 'Select                                                       ' );
       DMNFe.ZQuery2.SQL.Add( 't1.*                                                         ' );
       DMNFe.ZQuery2.SQL.Add( 'from destinatario t1                                         ' );
       DMNFe.ZQuery2.SQL.Add( 'inner join nfe t2 on t2.codigo_destinatario = t1.codigo      ' );
       DMNFe.ZQuery2.SQL.Add( 'where t2.codigo_loja = :parm1                                ' );
       DMNFe.ZQuery2.SQL.Add( 'and t2.chave_nfe     = :parm2                                ' );
       DMNFe.ZQuery2.Params[0].AsInteger := dxSpinEdit1.intValue;
       DMNFe.ZQuery2.Params[1].AsString  := (vChave);
       DMNFe.ZQuery2.Open;

       if DMNFe.ZQuery2.IsEmpty then
        begin
         MessageDlg('Nfe não encontrada! ',mtInformation,[mbOK],0);
         exit;
        end;

       if DMNFe.ZQuery2['email'] <> null then
        vemailDest    :=  vartostr(DMNFe.ZQuery2['email'])
       else
        vemailDest    :=  '';

       // Atualiza a tabela CCe com os dados retornados da sefaz
       try
        DMNFe.ZQuery2.DisableControls;
        DMNFe.ZQuery2.Close;
        DMNFe.ZQuery2.SQL.Clear;
        DMNFe.ZQuery2.SQL.Add( 'Update NFe_CCe Set                                   ' );
        DMNFe.ZQuery2.SQL.Add( '    Ver_Laiaute    = :Ver_Laiaute                    ' );
        DMNFe.ZQuery2.SQL.Add( '   ,cOrgao         = :cOrgao                         ' );
        DMNFe.ZQuery2.SQL.Add( '   ,dhEvento	      = :dhEvento	                      ' );
        DMNFe.ZQuery2.SQL.Add( '   ,Ver_CCe	       = :Ver_CCe                        ' );
        DMNFe.ZQuery2.SQL.Add( '   ,cStat          = :cStat                          ' );
        DMNFe.ZQuery2.SQL.Add( '   ,xMotivo        = :xMotivo                        ' );
        DMNFe.ZQuery2.SQL.Add( '   ,emailDest      = :emailDest                      ' );
        DMNFe.ZQuery2.SQL.Add( '   ,dhRegEvento    = :dhRegEvento                    ' );
        DMNFe.ZQuery2.SQL.Add( '   ,nProt          = :nProt                          ' );
        DMNFe.ZQuery2.SQL.Add( 'where                                                ' );
        DMNFe.ZQuery2.SQL.Add( '    Codigo_Loja    = :Codigo_Loja  and               ' );
        DMNFe.ZQuery2.SQL.Add( '    nNF            = :nNF          and               ' );
        DMNFe.ZQuery2.SQL.Add( '    Evento         = :Evento       and               ' );
        DMNFe.ZQuery2.SQL.Add( '    dEmi           = :dEmi         and               ' );
        DMNFe.ZQuery2.SQL.Add( '    Modelo         = :Modelo       and               ' );
        DMNFe.ZQuery2.SQL.Add( '    Serie          = :Serie                          ' );
        DMNFe.ZQuery2.ParamByName('Ver_Laiaute').Value  := vVer_Laiaute;
        DMNFe.ZQuery2.ParamByName('cOrgao').Value       := vcOrgao;
        DMNFe.ZQuery2.ParamByName('dhEvento').Value     := vdhRegEvento;
        DMNFe.ZQuery2.ParamByName('Ver_CCe').Value      := vVer_CCe;
        DMNFe.ZQuery2.ParamByName('cStat').Value        := vcStat;
        DMNFe.ZQuery2.ParamByName('xMotivo').Value      := vxMotivo;
        DMNFe.ZQuery2.ParamByName('emailDest').Value    := vemailDest;
        DMNFe.ZQuery2.ParamByName('dhRegEvento').Value  := vdhRegEvento;
        DMNFe.ZQuery2.ParamByName('nProt').Value        := vnProt;
        DMNFe.ZQuery2.ParamByName('Codigo_Loja').Value  := dxSpinEdit1.intValue;
        DMNFe.ZQuery2.ParamByName('nNF').Value          := StrToInt(FrCCe.Edit_Nota.Text);
        DMNFe.ZQuery2.ParamByName('Evento').Value       := FrCCe.Edit_Evento.Text;
        DMNFe.ZQuery2.ParamByName('dEmi').Value         := FormatDateTime('yyyy/mm/dd', VarToDateTime(DMNFe.ZQuery5['nfe_demi']));
        DMNFe.ZQuery2.ParamByName('Modelo').Value       := VarToStr(DMNFe.ZQuery5['nfe_Modelo']);
        DMNFe.ZQuery2.ParamByName('Serie').Value        := VarToStr(DMNFe.ZQuery5['nfe_Serie']);
        try
         DMNFe.ZConnection1.StartTransaction;
         DMNFe.ZQuery2.ExecSQL;
        except
         DMNFe.ZConnection1.Rollback;
         Application.Messagebox('ERRO: CCe não atualizada !','Atenção!',mb_iconstop+mb_ok);
        end;
        DMNFe.ZQuery2.Close;
       finally
        DMNFe.ZQuery2.EnableControls;
       end;
      end
     else
      begin
       MessageDlg('Nota:[ ' + VarToStr(DMNFe.ZQuery5['nfe_nnf']) + ' ]' + Chr(13) +
                  'Status: ' + VarToStr(consulta.procEventoNFe.Items[vC].RetEventoNFe.cStat) + Chr(13) +
                  ' - Motivo:' + consulta.procEventoNFe.Items[vC].RetEventoNFe.xMotivo + Chr(13) +
                  'REJEIÇÃO', mtInformation, [mbOK], 0);
       exit;
      end;
    end;
  end;
end;

//------------------------------------------------------------------------------
// Procedure  : EnviaEmailCCe
// Objetivo   : Reenvia emails da CCe
// by Edson Lima ; 13-01-2014 ; 19:09
//------------------------------------------------------------------------------
Procedure TFrGBNFe.EnviaEmailCCe();
var
 I, vC, nSeqEvento                        : Integer;
 vNnf, vP, Para, vI, xAux                 : String;
 Chave, idLote, CNPJ                      : String;
 xAuxC, xAuxP, vChave                     : string;
 tpAmb                                    : TpcnTipoAmbiente;
 vUTC                                     : String;
 ddhEvento                                : TDateTime;
 vVer_Laiaute, vcOrgao,    vdhEvento,
 vVer_CCe,   vcStat,       vxMotivo,
 vemailDest, vdhRegEvento, vnProt         : String;
begin

 //-----------------------------------------------------------------------------
 // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update
 gCdloja_Consiste := dxSpinEdit1.Text;
 gdEmi_Consiste   := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery5['nfe_demi']);
 gNNF_Consiste    := vartostr(DMNFe.ZQuery5['nfe_nnf']);
 gSerie_Consiste  := vartostr(DMNFe.ZQuery5['nfe_serie']);
 gSerie           := StrToInt(gSerie_Consiste);
 gChave_Consiste  := '';                                                        // está sendo atribuida depois da sp_calcula_digito_chave

 // Atribuição de variáveis que serão usadas durante a transmissão
 Chave         := DMNFe.ZQuery11['CCe_chave_nfe'];
 idLote        := DMNFe.ZQuery11['CCe_idLote'];
 CNPJ          := DMNFe.ZQuery4['cnpj'];
 nSeqEvento    := DMNFe.ZQuery11['CCe_Evento'];
 xAux          := DMNFe.ZQuery5['nfe_chave_nfe'];
 vChave        := xAux;
 xAux          := trim(gCamLog) + trim(xAux) + '-nfe.xml';
 vNnf          := gNNF_Consiste;

 if (DMNFe.ZQuery4['Web_Ambiente'] <> Null) then
  begin
   if (DMNFe.ZQuery4['Web_Ambiente'] = 'H') then
    tpAmb   := taHomologacao
   else
    tpAmb   := taProducao;
  end
 else
  tpAmb     := taHomologacao;

 //-----------------------------------------------------------------------------
 xAuxP := (trim(gCamPDF) + DMNFe.ZQuery11['CCe_tpEvento'] + trim(vChave) + Format('%.2d', [nSeqEvento]) + '-ProcEventoNFe.pdf');    // tps_PDF, tps_preview ou tps_Print
 xAuxC := trim(gCamXml) +                                                       // Caminho do arquivo log (gCamXml contém o caminho padrão) ex: c:\Sistemas\GBNFe\Arq\Emp001\Xml\
          FormatDateTime('yyyymm',Date) +                                       // Ano, mês
          '\Evento\CCe\' +                                                      // Evento e CCe
          DMNFe.ZQuery11['CCe_tpEvento'] +                                      // Tipo de evento, neste caso (110110)
          trim(vChave) +                                                        // Chave da NFe
          Format('%.2d', [nSeqEvento]) +                                        // Sequencia do Evento com duas casas decimais
          '-procEventoNFe.xml';                                                 // Final do nome + tipo (xml)

 if not FileExists(xAuxC) then
  begin
   MessageDlg('Arquivo XML CCe' + chr(13) + '[' + xAuxC + ']' + chr(13) + 'não existe ! ', mtInformation, [mbOk], 0);
   //Application.Messagebox('Arquivo XML CCe [' + char(xAuxC) + '] não existe ! ', 'Atenção!',mb_iconstop+mb_ok);
   exit;
  end;

 if not FileExists(xAuxP) then
  begin
   MessageDlg('Arquivo PDF CCe' + chr(13) + '[' + xAuxP + ']' + chr(13) + 'não existe ! ', mtInformation, [mbOk], 0);
   //Application.Messagebox('Arquivo PDF CCe [' + char(xAuxP) + '] não existe ! ', 'Atenção!',mb_iconstop+mb_ok);
   exit;
  end;

 //pega os dados do destinatario
 DMNFe.ZQuery2.Close;
 DMNFe.ZQuery2.SQL.Clear;
 DMNFe.ZQuery2.SQL.Add( 'Select                                                       ' );
 DMNFe.ZQuery2.SQL.Add( 't1.*                                                         ' );
 DMNFe.ZQuery2.SQL.Add( 'from destinatario t1                                         ' );
 DMNFe.ZQuery2.SQL.Add( 'inner join nfe t2 on t2.codigo_destinatario = t1.codigo      ' );
 DMNFe.ZQuery2.SQL.Add( 'where t2.codigo_loja = :parm1                                ' );
 DMNFe.ZQuery2.SQL.Add( 'and t2.chave_nfe     = :parm2                                ' );
 DMNFe.ZQuery2.Params[0].AsInteger := dxSpinEdit1.intValue;
 DMNFe.ZQuery2.Params[1].AsString  := (vChave);
 DMNFe.ZQuery2.Open;
 if DMNFe.ZQuery2.IsEmpty then
  begin
   MessageDlg('Destinatário não encontrado! ',mtInformation,[mbOK],0);
   exit;
  end;

 para := vartostr(DMNFe.ZQuery2['email']);

 if ( (trim(para) = '') or (FrPar.CheckBox10.Checked) ) then
  begin
   // By Edson Lima - 2016-6-30T1143 - Verifica o email do destinatário
   while (not fValidaEmail(para)) do
    begin
     Para := '';
     if not(InputQuery(vartostr(DMNFe.ZQuery2['razao_social']), 'Email de destino:', Para)) then exit;
     if (not fValidaEmail(para)) then
      Application.Messagebox('Campo de email do destinatário inválido! ','Atenção!',mb_iconstop+mb_ok);
    end;
  end;

 if (Para <> '') then
  begin
   if FrPar.edtEnvCC.Text = '' then
    IdMessage.CCList.EMailAddresses := 'nfe@gbinformatica.com.br'               //especifique um email válido
   else
    for I := 1 to (Length(FrPar.edtEnvCC.Text)+1) do
     begin
      if (FrPar.edtEnvCC.Text[I] = ',') or (FrPar.edtEnvCC.Text[I] = ';') or (I = Length(FrPar.edtEnvCC.Text)+1)then
       begin
        IdMessage.CCList.Add.Address := Trim(vI);                               //especifique um email válido
        vI := '';
       end
      else
       vI := (vI + Trim(FrPar.edtEnvCC.Text[I]));
     end;
    vI := '';                                                                   // Limpa variável
    vC := 0;                                                                    // zera contador
    for I := 1 to (Length(Para)+1) do
     begin
      if (Para[I] = ',') or (Para[I] = ';') or (I = Length(Para)+1)then
       begin
        if vC > 0 then
         IdMessage.CCList.Add.Address := Trim(vI)                               //especifique um email válido
        else
         vP := trim(vI);                                                        // Atribui apenas o primeiro email
         vI := '';
        inc(vC);                                                                // Incrementa 1
       end
      else
       vI := (vI + Trim(Para[I]));
     end;
    Para := vP;
    // Envia email do xml CCe
    try
     IdSMTP.Port                         := StrToInt(FrPar.edtSmtpPort.Text);
     IdSMTP.Host                         := FrPar.edtSmtpHost.Text;
     IdSMTP.Username                     := FrPar.edtSmtpUser.Text;
     IdSMTP.Password                     := FrPar.edtSmtpPass.Text;
     IdSMTP.AuthenticationType           := atLogin;
     IdSMTP.UseEhlo                      := True;
     IdSMTP.Connect(0);
     IdMessage.From.Address              := FrPar.edtSmtpUser.Text;
     IdMessage.From.Name                 := Format('%s<%s>', [Trim(FrPar.edtNEeMail.Text), Trim(FrPar.edtSmtpUser.Text)]) ;
     IdMessage.Recipients.EMailAddresses := Para;
     IdMessage.Subject                   := FrPar.edtEmailCCeAssunto.Text + ' - Nº:' + vNnf;
     IdMessage.Body                      := FrPar.mmEmailMsg.Lines;
     TIdAttachment.Create(Idmessage.MessageParts, TFileName(xAuxC));
     TIdAttachment.Create(Idmessage.MessageParts, TFileName(xAuxP));
     try
      IdSMTP.Send(IdMessage);
      MessageDlg('Carta de Correção ref a NFe:[ ' + vNnf + ' ]' + Chr(13) +
                 'Status: ' + DMNFe.ZQuery11['CCe_cStat'] + ' - ' + DMNFe.ZQuery11['CCe_xMotivo'] + Chr(13) +
                 'Protocolo: ' + DMNFe.ZQuery11['CCe_nProt'] + Chr(13) +
                 'EMAIL ENVIADO COM SUCESSO !', mtInformation, [mbOK], 0);
     except
      IdSMTP.Disconnect;
      Application.Messagebox('ERRO: Encontrado !','Atenção!',mb_iconstop+mb_ok);
     end;

    finally
     IdSMTP.Disconnect;
    end;
  end;
end;

//------------------------------------------------------------------------------
// Funcao     : OnlyNumbers
// Parametros : Texto
// Objetivo   : Retorna somente os números de 'sTexto'
//------------------------------------------------------------------------------
function TFrGBNFe.OnlyNumbers (var sTexto : String; sRetorno : String = 'N' ) : String;
var
   i: integer;
begin
 Result := '';

 for i := 1 to Length( sTexto ) do
  if sRetorno = 'N' then
   begin
    if sTexto[i] in ['0'..'9'] then
     Result := Result + sTexto[i];
   end
  else if sRetorno = 'C' then
   begin
    if( sTexto[i] in ['0'..'9'] ) or ( sTexto[i] in ['a'..'z'] ) or ( sTexto[i] in ['A'..'Z'] ) then
     Result := Result + sTexto[i];
   end;
end;

//------------------------------------------------------------------------------
// Funcao     : f_Consiste
// Parametros : nnf1 e nnf2, retorna true ou false
// Objetivo   : Retorna verdadeiro se a nnf1 for igual a nnf2
// Author     : by Edson Lima ; 2013/03/04 ; 10:28
//------------------------------------------------------------------------------
function TFrGBNFe.fConsiste(locErr, cdloj1, cdloj2, demi1,  demi2, nnf1,
                                    nnf2,   ser1,   ser2,   chv1,  chv2 :String) : Boolean;

begin
 if ((trim(cdloj1) = trim(cdloj2)) and (trim(demi1) = trim(demi2)) and
     (trim(nnf1)   = trim(nnf2))   and (trim(ser1)  = trim(ser2))  and
     (trim(chv1)   = trim(chv2)))  then
  begin
   gDeuErrConsiste := false;
   Result := true;
  end
 else
  begin

   ShowMessage('Atenção!  Houve uma insconsistência nesse ponto do processo.' + chr(13) +
               'Faça um PRINT desta tela e envie para o suporte da GB p/a de-' + chr(13) +
               'vida correção:Empresa-> ' + cdloj1 + ' = ' + cdloj2 + ' Dt.Emis. -> ' + demi1 + ' = ' + demi2 + '' + chr(13) +
               'Número da Nota -> ' + nnf1 + ' = ' + nnf2 + ' Série -> ' + ser1 + ' = ' + ser2 + '' + ' LocErr -> ' + locerr  + chr(13) +
               'Número da Chave-> ' + chv1 + ' = ' + chv2 + chr(13) +
               'O processo será abortado! - e-mail: <sac@gbinformatica.com.br>');
   gDeuErrConsiste := true;
   Result := false;

  end;
end;

//******************************************************************************

procedure TFrGBNFe.MovepPendentes1Click(Sender: TObject);
begin
 // by Edson Lima ; 2013-7-17T1024 ; Chama a procedure de atribuição de seleção da TreeList
 pAtribSel(dxTLTrans, dxTLCTransDateDemi, dxTLCTransSpinNot, dxTLCTransMaskMod, dxTLCTransMaskSer, DMNFe.ZQuery5);

 //-----------------------------------------------------------------------------

 DMNFe.ZQuery5.first;
 while ((not DMNFe.ZQuery5.eof) and (DMNFe.ZQuery5['nfe_nnf'] <> Null)) do
  begin

   DMNFe.ZQuery5.FieldByName('Checado').ReadOnly := False;

   if DMNFe.ZQuery5['Checado'] = 'Y' then
    begin
     //*******************************************************************************
     // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update

     gModelo := DMNFe.ZQuery5['nfe_Modelo'];
     gSerie  := DMNFe.ZQuery5['nfe_Serie'];

     if ( gCpt = 1 ) then
      pDefineRel()                                                              // Define o tipo de Relatório FortesReport
     else
      pDefineRelFR();                                                           // Define o tipo de Relatório FastReport

     gCdloja_Consiste := dxSpinEdit1.Text;
     gdEmi_Consiste   := FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery5['nfe_demi']);
     gNNF_Consiste    := vartostr(DMNFe.ZQuery5['nfe_nnf']);
     gSerie_Consiste  := vartostr(DMNFe.ZQuery5['nfe_serie']);
     gSerie           := StrToInt(gSerie_Consiste);
     gChave_Consiste  := '';                                                    // está sendo atribuida depois da sp_calcula_digito_chave

     if (copy(vartostr(DMNFe.ZQuery5['nfe_chave_nfe']), 35, 1) = '5') then
      pGravaNFe('016', 'situacao', 'motivo', '', '', '', '', '', 'codigo_loja', 'demi', 'nnf', 'serie', 'chave_nfe',
                AnsiUpperCase(_tipo_emissao), 'Movida das Transmitidas', '', '', '', '', '', dxSpinEdit1.IntValue, FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery5['nfe_demi']), DMNFe.ZQuery5['nfe_nnf'], DMNFe.ZQuery5['nfe_serie'], '', true)
     else if (copy(vartostr(DMNFe.ZQuery5['nfe_chave_nfe']), 35, 1) = '4') then
      pGravaNFe('016', 'situacao', 'motivo', '', '', '', '', '', 'codigo_loja', 'demi', 'nnf', 'serie', 'chave_nfe',
                AnsiUpperCase(_tipo_emissao), 'Movida das Transmitidas', '', '', '', '', '', dxSpinEdit1.IntValue, FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery5['nfe_demi']), DMNFe.ZQuery5['nfe_nnf'], DMNFe.ZQuery5['nfe_serie'], '', true)
     else
      pGravaNFe('016', 'situacao', 'motivo', '', '', '', '', '', 'codigo_loja', 'demi', 'nnf', 'serie', 'chave_nfe',
                '', 'Movida das Transmitidas', '', '', '', '', '', dxSpinEdit1.IntValue, FormatDateTime('yyyy/mm/dd', DMNFe.ZQuery5['nfe_demi']), DMNFe.ZQuery5['nfe_nnf'], DMNFe.ZQuery5['nfe_serie'], '', true);

    end;
   DMNFe.ZQuery5.Next;
  end;
 pAtuNFe();
end;

//------------------------------------------------------------------------------
// Procedure  : pGravaNFe
// Parametros : c01 - c10 nome dos campos - p01 - p10 são parametros
// Objetivo   : Centralizar os updates em um só lugar
// Author     : by Edson Lima ; 2013/03/11 ; 16:30
//------------------------------------------------------------------------------
procedure TFrGBNFe.pGravaNFe(locErr, c01, c02, c03, c04, c05, c06, c07, c08, c09, c10, c11, c12: String;
                                     p01, p02, p03, p04, p05, p06, p07, p08, p09, p10, p11, p12: Variant;
                                     Consiste                                                  : Boolean);
begin
 // by Edson Lima ; 2013/03/13 ; 09:26 ; Função de consistência para evitar duplicidade de chave nnf
 if Consiste then
  if not fConsiste(locErr, VarToStr(p08), gCdloja_Consiste,
                           vartostr(p09), gdEmi_Consiste,
                           vartostr(p10), gNNF_Consiste,
                           vartostr(p11), gSerie_Consiste,
                           vartostr(p12), gChave_Consiste) then Exit;

 try
  DMNFe.ZQuery2.DisableControls;
  DMNFe.ZQuery2.Close;
  DMNFe.ZQuery2.SQL.Clear;

  // Deve haver pelo menos um campo a ser gravado na tabela nfe
  DMNFe.ZQuery2.SQL.Add(  'Update nfe set                                    ' );
  if trim(c01) <> '' then
   DMNFe.ZQuery2.SQL.Add( '               ' + c01 + ' = :' + c01 + '         ' );
  if trim(c02) <> '' then
   DMNFe.ZQuery2.SQL.Add( ',              ' + c02 + ' = :' + c02 + '         ' );
  if trim(c03) <> '' then
   DMNFe.ZQuery2.SQL.Add( ',              ' + c03 + ' = :' + c03 + '         ' );
  if trim(c04) <> '' then
   DMNFe.ZQuery2.SQL.Add( ',              ' + c04 + ' = :' + c04 + '         ' );
  if trim(c05) <> '' then
   DMNFe.ZQuery2.SQL.Add( ',              ' + c05 + ' = :' + c05 + '         ' );
  if trim(c06) <> '' then
   DMNFe.ZQuery2.SQL.Add( ',              ' + c06 + ' = :' + c06 + '         ' );
  if trim(c07) <> '' then
   DMNFe.ZQuery2.SQL.Add( ',              ' + c07 + ' = :' + c07 + '         ' );

  DMNFe.ZQuery2.SQL.Add( '  where ' + c08 + ' = :' + c08 + '                 ' );
  DMNFe.ZQuery2.SQL.Add( '    and ' + c09 + ' = :' + c09 + '                 ' );
  DMNFe.ZQuery2.SQL.Add( '    and ' + c10 + ' = :' + c10 + '                 ' );
  DMNFe.ZQuery2.SQL.Add( '    and ' + c11 + ' = :' + c11 + '                 ' );

  if trim(c01) <> '' then
   DMNFe.ZQuery2.ParamByName(c01).Value    := p01;
  if trim(c02) <> '' then
   DMNFe.ZQuery2.ParamByName(c02).Value    := p02;
  if trim(c03) <> '' then
   DMNFe.ZQuery2.ParamByName(c03).Value    := p03;
  if trim(c04) <> '' then
   DMNFe.ZQuery2.ParamByName(c04).Value    := p04;
  if trim(c05) <> '' then
   DMNFe.ZQuery2.ParamByName(c05).Value    := p05;
  if trim(c06) <> '' then
   DMNFe.ZQuery2.ParamByName(c06).Value    := p06;
  if trim(c07) <> '' then
   DMNFe.ZQuery2.ParamByName(c07).Value    := p07;

  DMNFe.ZQuery2.ParamByName(c08).Value     := p08;
  DMNFe.ZQuery2.ParamByName(c09).Value     := p09;
  DMNFe.ZQuery2.ParamByName(c10).Value     := p10;
  DMNFe.ZQuery2.ParamByName(c11).Value     := p11;
  try
   DMNFe.ZConnection1.StartTransaction;
   DMNFe.ZQuery2.ExecSQL;
  except
   DMNFe.ZConnection1.Rollback;
   Application.Messagebox('ERRO: O Registro não foi atualizado !','Atenção!',mb_iconstop+mb_ok);
  end;
  DMNFe.ZQuery2.Close;
 finally
  DMNFe.ZQuery2.EnableControls;
 end;
end;

//------------------------------------------------------------------------------
// Procedure  : pEnviaEmailCan
// Parametros : c01 - c10 nome dos campos - p01 - p10 são parametros
// Objetivo   : Centralizar os updates em um só lugar
// Author     : by Edson Lima ; 2013/03/11 ; 16:30
//------------------------------------------------------------------------------
procedure TFrGBNFe.pEnviaEmailCan();
var
 I, vC                   : Integer;
 vNnf, vP, idLote        : String;
 Para, xAuxC, vChave, vI : String;
begin

 vAux := '';
 DMNFe.ZQuery6.first;

 try
  while ((not DMNFe.ZQuery6.eof) and (DMNFe.ZQuery6['nfe_nnf'] <> Null)) do
   begin

    DMNFe.ZQuery6.FieldByName('Checado').ReadOnly := False;

    if DMNFe.ZQuery6['Checado'] = 'Y' then
     begin

      //*******************************************************************************
      // by Edson ; 2013-03-04 ;08:41 ; Atribuição para consistir nnf na hora do update

      gModelo := DMNFe.ZQuery6['nfe_Modelo'];
      gSerie  := DMNFe.ZQuery6['nfe_Serie'];

      if ( gCpt = 1 ) then
       pDefineRel()                                                             // Define o tipo de Relatório FortesReport
      else
       pDefineRelFR();                                                          // Define o tipo de Relatório FastReport

      gCdloja_Consiste := dxSpinEdit1.Text;
      gdEmi_Consiste   := vartostr(DMNFe.ZQuery6['nfe_demi']);
      gNNF_Consiste    := vartostr(DMNFe.ZQuery6['nfe_nnf']);
      gSerie_Consiste  := vartostr(DMNFe.ZQuery6['nfe_serie']);
      gSerie           := StrToInt(gSerie_Consiste);
      gChave_Consiste  := '';                                                   // está sendo atribuida depois da sp_calcula_digito_chave

      xAux   := DMNFe.ZQuery6['nfe_chave_nfe'];
      vChave := xAux;

      if MessageDlg('Confirma o envio do email de cancelamento da nota [ ' + VarToStr(DMNFe.ZQuery6['nfe_nnf']) + ' ]?', mtConfirmation, [mbYes, mbNo], 0) = mrYes then
       begin
        xAux  := trim(gCamLog) + trim(xAux) + '-nfe.xml';

        ACBrNFe1.NotasFiscais.Clear;
        ACBrNFe1.NotasFiscais.LoadFromFile(xAux);
        ACBrNFe1.Consultar;

        idLote := ( VarToStr(DMNFe.ZQuery6['nfe_Serie']) + VarToStr(DMNFe.ZQuery6['nfe_codigo_loja']) + VarToStr(DMNFe.ZQuery6['nfe_nnf']) );

        memoLog.Clear;
        ACBrNFe1.EventoNFe.Evento.Clear;
        ACBrNFe1.EventoNFe.idLote := StrToInt(idLote) ;

        with ACBrNFe1.EventoNFe.Evento.Add do
        begin
         infevento.tpAmb           := ACBrNFe1.NotasFiscais.Add.NFe.Ide.tpAmb;
         infEvento.dhEvento        := ACBrNFe1.WebServices.Consulta.DhRecbto;
         infEvento.tpEvento        := teCancelamento;
         infEvento.detEvento.xJust := vAux;
        end;

        with ACBrNFe1.EventoNFe do
        begin

         xAuxC := trim(gCamXml) +                                                // Caminho do arquivo log (gCamlog contém o caminho padrão) ex: c:\Sistemas\GBNFe\Arq\Emp001\log\
                  FormatDateTime('yyyymm', Evento.Items[0].InfEvento.dhEvento) + // Ano, mês
                  '\Evento\Cancelamento\' +                                      // Evento e Cancelamento
                  Evento.Items[0].InfEvento.TipoEvento +                         // Tipo de evento, neste caso (110111)
                  trim(vChave) +                                                 // Chave da NFe
                  '01' +                                                         // Sequencia do Evento com duas casas decimais
                  '-procEventoNFe.xml';                                          // Final do nome + tipo (xml)
        end;

        // by Edson ; 2013/03/27T15:02 ; Verifica a existência dos arquivos de cancelamento
        if not FileExists(xAuxC) then
         begin
          //xAuxC := trim(gCamLog) + Trim(vChave) + '-can.xml';
          if not FileExists(xAuxC) then
           begin
            MessageDlg('Arquivo XML de Cancelamento não Encontrado !',mtInformation,[mbOK],0);
            exit;
           end;
         end;

        vNnf := DMNFe.ZQuery6['nfe_nnf'];

        //pega os dados do destinatario
        DMNFe.ZQuery2.Close;
        DMNFe.ZQuery2.SQL.Clear;
        DMNFe.ZQuery2.SQL.Add( 'Select                                                 ' );
        DMNFe.ZQuery2.SQL.Add( 't1.*                                                 ' );
        DMNFe.ZQuery2.SQL.Add( 'from destinatario t1                                                 ' );
        DMNFe.ZQuery2.SQL.Add( 'inner join nfe t2 on t2.codigo_destinatario = t1.codigo                                               ' );
        DMNFe.ZQuery2.SQL.Add( 'where t2.codigo_loja = :parm1                                  ' );
        DMNFe.ZQuery2.SQL.Add( 'and t2.chave_nfe = :parm2                                  ' );
        DMNFe.ZQuery2.Params[0].AsInteger := dxSpinEdit1.intValue;
        DMNFe.ZQuery2.Params[1].AsString  := (vChave);
        DMNFe.ZQuery2.Open;
        if DMNFe.ZQuery2.IsEmpty then
         begin
          MessageDlg('Nfe cancelada não existe',mtInformation,[mbOK],0);
          exit;
         end;

        para := vartostr(DMNFe.ZQuery2['email']);

        if ( (trim(para) = '') or (FrPar.CheckBox10.Checked) ) then
         begin
          // By Edson Lima - 2016-6-30T1143 - Verifica o email do destinatário
          while (not fValidaEmail(para)) do
           begin
            Para := '';
            if not(InputQuery(vartostr(DMNFe.ZQuery2['razao_social']), 'Email de destino:', Para)) then exit;
            if (not fValidaEmail(para)) then
             Application.Messagebox('Campo de email do destinatário inválido! ','Atenção!',mb_iconstop+mb_ok);
           end;
         end;

        if vartostr(DMNFe.ZQuery2['email']) <> '' then
         begin
          if ( FrPar.edtEnvCC.Text <> '' ) then
          // IdMessage.CCList.EMailAddresses := 'nfe@gbinformatica.com.br'        //especifique um email válido
          //else
           for I := 1 to (Length(FrPar.edtEnvCC.Text)+1) do
            begin
             if (FrPar.edtEnvCC.Text[I] = ',') or (FrPar.edtEnvCC.Text[I] = ';') or (I = Length(FrPar.edtEnvCC.Text)+1)then
              begin
               IdMessage.CCList.Add.Address := Trim(vI);                        //especifique um email válido
               vI := '';
              end
             else
              vI := (vI + Trim(FrPar.edtEnvCC.Text[I]));
            end;

            vI := '';                                                           // Limpa variável
            vC := 0;                                                            // zera contador

            for I := 1 to (Length(Para)+1) do
             begin
              if (Para[I] = ',') or (Para[I] = ';') or (I = Length(Para)+1)then
               begin
                if vC > 0 then
                 IdMessage.CCList.Add.Address := Trim(vI)                       //especifique um email válido
                else
                 vP := trim(vI);                                                // Atribui apenas o primeiro email

                vI := '';
                inc(vC);                                                        // Incrementa 1
               end
              else
               vI := (vI + Trim(Para[I]));
             end;

            Para := vP;

            // Envia email do xml cancelado
            IdSMTP.Port                         := StrToInt(FrPar.edtSmtpPort.Text);
            IdSMTP.Host                         := FrPar.edtSmtpHost.Text;
            IdSMTP.Username                     := FrPar.edtSmtpUser.Text;
            IdSMTP.Password                     := FrPar.edtSmtpPass.Text;
            IdSMTP.AuthenticationType           := atLogin;
            IdSMTP.UseEhlo                      := True;
            IdSMTP.Connect(0);

            IdMessage.From.Address              := FrPar.edtSmtpUser.Text;
            IdMessage.From.Name                 := Format('%s<%s>', [Trim(FrPar.edtNEeMail.Text), Trim(FrPar.edtSmtpUser.Text)]) ;
            IdMessage.Recipients.EMailAddresses := Para;
            IdMessage.Subject                   := FrPar.edtEmailCancAssunto.Text + ' - Nº:' + vNnf;
            IdMessage.Body                      := FrPar.mmEmailMsg.Lines;
            TIdAttachment.Create(Idmessage.MessageParts, TFileName(xAuxC));

            try
             IdSMTP.Send(IdMessage);
             MessageDlg('Nota:[ ' + vNnf + ' ]' + Chr(13) +
                        'ENVIADA POR EMAIL', mtInformation, [mbOK], 0);
            finally
             IdSMTP.Disconnect;
            end;
         end;
       end;
     end;
    DMNFe.ZQuery6.Next;
   end;
 except

  MessageDlg('Inconsistência no envio do email!',mtInformation,[mbOK],0);

  pAtuNFeT();

 end;

 pAtuNFeT(); // By Edson Lima 14.9.2012 ; 10:10 - Atualiza grade

end;

//------------------------------------------------------------------------------
// Função....: MarcaBloco
// Objetivo..: Marca um bloco de Nodes selecionados
// Parametros: Recebe a TreeList a marcar
// Criação...: 2013/7/17T1017
// Autor.....: Edson Lima (Modificador)
//------------------------------------------------------------------------------
procedure TFrGBNFe.MarcaBloco( dxTLPend : TdxTreeList; blMarca : Boolean; blTodos : Boolean = False );
Var
 I : Integer;

begin
 dxTLPend.BeginUpdate;

 Try
  if blTodos then
   for I := 0 to dxTLPend.Count - 1 do
    begin
     if blMarca then
      dxTLPend.Items[I].Strings[00] := 'True'
     else
      dxTLPend.Items[I].Strings[00] := 'False';
    end
  else
   for I := 0 to dxTLPend.SelectedCount - 1 do
    begin
     if blMarca then
      dxTLPend.SelectedNodes[I].Strings[00] := 'True'
     else
      dxTLPend.SelectedNodes[I].Strings[00] := 'False';
    end;
 Finally
  dxTLPend.EndUpdate;
  dxTLPend.Refresh;
 end;
end;

//------------------------------------------------------------------------------
// Função....: pAtribSel
// Objetivo..: Atribui seleção da TreeList e Monta a Query referenciada
// Parametros: Recebe a TreeList e o nome do campo
// Criação...: 2013/7/17T1017
// Autor.....: Edson Lima
//------------------------------------------------------------------------------
Procedure TFrGBNFe.pAtribSel( dxTL : TdxTreeList; dxTLCDem : TdxTreeListDateColumn ;
                                                  dxTLCNot : TdxTreeListSpinColumn ;
                                                  dxTLCMod : TdxTreeListMaskColumn ;
                                                  dxTLCSer : TdxTreeListMaskColumn ;
                                                  ZQ :  TZQuery );              // by Edson ; 2016-6-28T1505 - incluido todas as chaves
Var
 I : Integer;
begin
 // by Edson ; 2013-7-16T0922 ; Atribui seleção da TreeList e Monta a query das pendentes

 for I := 0 to dxTL.Count - 1 do
  begin

   ZQ.First;

   while (not ZQ.Eof) do
    begin

     ZQ.FieldByName('Checado').ReadOnly := False;

     if ((ZQ['nfe_demi']   = dxTL.Items[I].Strings[dxTLCDem.Index])  and
         (ZQ['nfe_nnf']    = dxTL.Items[I].Strings[dxTLCNot.Index])  and
         (ZQ['nfe_Modelo'] = dxTL.Items[I].Strings[dxTLCMod.Index])  and
         (ZQ['nfe_Serie']  = dxTL.Items[I].Strings[dxTLCSer.Index])) then
      begin
       if (dxTL.Items[I].Strings[00] = 'True') then
        begin

         ZQ.Edit;
         ZQ['Checado'] := 'Y';

        end
       else
        begin

         ZQ.Edit;
         ZQ['Checado'] := 'N';

        end;
      end;

     ZQ.Next;

    end;
  end;

end;

procedure TFrGBNFe.dxTLPendExit(Sender: TObject);
begin

 // by Edson Lima ; 2013-7-17T1024 ; Chama a procedure de atribuição de seleção da TreeList
 pAtribSel(dxTLPend, dxTLCPendDateDemi, dxTLCPendSpinNot, dxTLCPendMaskMod, dxTLCPendMaskSer, DMNFe.ZQuery3);

end;

procedure TFrGBNFe.dxTLContEditing(Sender: TObject; Node: TdxTreeListNode;
  var Allow: Boolean);
begin
 Allow := ( dxTLCont.FocusedColumn = dxTLCContCheckSel.Index ) or
          ( node.Strings[dxTLCContCheckSel.Index] = 'True' );
end;

procedure TFrGBNFe.dxTLContExit(Sender: TObject);
begin

 // by Edson Lima ; 2013-7-17T1024 ; Chama a procedure de atribuição de seleção da TreeList
 pAtribSel(dxTLCont, dxTLCContDateDemi, dxTLCContSpinNot, dxTLCContMaskMod, dxTLCContMaskSer, DMNFe.ZQuery10);

end;

procedure TFrGBNFe.dxTLContClick(Sender: TObject);
begin
 if dxTLCont.FocusedColumn = dxTLCContCheckSel.index then
  begin
   dxTLCont.FocusedColumn := dxTLCContMaskDes.index;
   dxTLCont.FocusedColumn := dxTLCContCheckSel.index;
  end;
end;

procedure TFrGBNFe.dxTLPendClick(Sender: TObject);
begin
 if dxTLPend.FocusedColumn = dxTLCPendCheckSel.index then
  begin
   dxTLPend.FocusedColumn := dxTLCPendMaskDes.index;
   dxTLPend.FocusedColumn := dxTLCPendCheckSel.index;
  end;
end;

procedure TFrGBNFe.dxTLTransClick(Sender: TObject);
begin
 if dxTLTrans.FocusedColumn = dxTLCTransCheckSel.index then
  begin
   dxTLTrans.FocusedColumn := dxTLCTransMaskDes.index;
   dxTLTrans.FocusedColumn := dxTLCTransCheckSel.index;
  end;
end;

procedure TFrGBNFe.dxTLTransEditing(Sender: TObject; Node: TdxTreeListNode;
  var Allow: Boolean);
begin
 Allow := ( dxTLTrans.FocusedColumn = dxTLCTransCheckSel.Index ) or
          ( node.Strings[dxTLCTransCheckSel.Index] = 'True' );
end;

procedure TFrGBNFe.dxTLTransExit(Sender: TObject);
begin

 // by Edson Lima ; 2013-7-17T1024 ; Chama a procedure de atribuição de seleção da TreeList
 pAtribSel(dxTLTrans, dxTLCTransDateDemi, dxTLCTransSpinNot, dxTLCTransMaskMod, dxTLCTransMaskSer, DMNFe.ZQuery5);

end;

//------------------------------------------------------------------------------
// Função....: pAtuTL
// Objetivo..: Atualiza dados das TreeLest
// Parametros: Recebe a TreeList e a Query - Monta a grade
// Criação...: 2013/7/26T1508
// Autor.....: Edson Lima
//------------------------------------------------------------------------------
Procedure TFrGBNFe.pAtuTL( dxTL : TdxTreeList; dxTLCSel  :  TdxTreeListCheckColumn ;
                                               dxTLCDes  :  TdxTreeListMaskColumn ;
                                               dxTLCCpf  :  TdxTreeListMaskColumn ;
                                               dxTLCCod  :  TdxTreeListMaskColumn ;
                                               dxTLCMod  :  TdxTreeListMaskColumn ;
                                               dxTLCSer  :  TdxTreeListMaskColumn ;
                                               dxTLCDem  :  TdxTreeListDateColumn ;
                                               dxTLCNot  :  TdxTreeListSpinColumn ;
                                               dxTLCVal  :  TdxTreeListCurrencyColumn ;
                                               dxTLCSit  :  TdxTreeListMaskColumn ;
                                               dxTLCPro  :  TdxTreeListMaskColumn ;
                                               dxTLCRec  :  TdxTreeListMaskColumn ;
                                               dxTLCCha  :  TdxTreeListMaskColumn ;
                                               ZQ :  TZQuery );
var
 nodPed : TdxTreeListNode;
begin
 dxTL.ClearNodes;

 if ZQ.RecordCount > 0 Then
  Begin
   dxTL.BeginUpdate;

   Try
    ZQ.First;

    // Laço para montar grade

    While Not ZQ.Eof Do
     begin
      nodPed := dxTL.Add;

      nodPed.Values[dxTLCSel.Index] := 'False';
      nodPed.Values[dxTLCDes.Index] := ZQ.fieldByName('des_razao_social').AsString;
      nodPed.Values[dxTLCCpf.Index] := ZQ.fieldByName('des_cnpj').AsString;
      nodPed.Values[dxTLCCod.Index] := ZQ.fieldByName('nfe_codigo_destinatario').AsString;
      nodPed.Values[dxTLCMod.Index] := ZQ.fieldByName('nfe_modelo').AsString;
      nodPed.Values[dxTLCSer.Index] := ZQ.fieldByName('nfe_serie').AsString;
      nodPed.Values[dxTLCDem.Index] := ZQ.fieldByName('nfe_demi').AsDateTime;
      nodPed.Values[dxTLCNot.Index] := ZQ.fieldByName('nfe_nnf').AsString;
      nodPed.Values[dxTLCVal.Index] := ZQ.fieldByName('nfe_total_nf').AsCurrency;
      nodPed.Values[dxTLCSit.Index] := ZQ.fieldByName('nfe_situacao').AsString + ' ' + ZQ.fieldByName('nfe_motivo').AsString;
      nodPed.Values[dxTLCPro.Index] := ZQ.fieldByName('nfe_protocolo').AsString;
      nodPed.Values[dxTLCRec.Index] := ZQ.fieldByName('nfe_recibo').AsString;
      nodPed.Values[dxTLCCha.Index] := ZQ.fieldByName('nfe_chave_nfe').AsString;

     ZQ.Next;
    end;
  Finally
   dxTL.EndUpdate;
  end;
 end;
end;

procedure TFrGBNFe.dxTLDenegClick(Sender: TObject);
begin
 if dxTLDeneg.FocusedColumn = dxTLCDenegCheckSel.index then
  begin
   dxTLDeneg.FocusedColumn := dxTLCDenegMaskDes.index;
   dxTLDeneg.FocusedColumn := dxTLCDenegCheckSel.index;
  end;
end;

procedure TFrGBNFe.dxTLDenegEditing(Sender: TObject; Node: TdxTreeListNode;
  var Allow: Boolean);
begin
 Allow := ( dxTLDeneg.FocusedColumn = dxTLCDenegCheckSel.Index ) or
          ( node.Strings[dxTLCDenegCheckSel.Index] = 'True' );
end;

procedure TFrGBNFe.dxTLDenegExit(Sender: TObject);
begin

 // by Edson Lima ; 2013-7-17T1024 ; Chama a procedure de atribuição de seleção da TreeList
 pAtribSel(dxTLDeneg, dxTLCDenegDateDemi, dxTLCDenegSpinNot, dxTLCDenegMaskMod, dxTLCDenegMaskSer, DMNFe.ZQryGeral);

end;

procedure TFrGBNFe.dxTLCancClick(Sender: TObject);
begin
 if dxTLCanc.FocusedColumn = dxTLCCancCheckSel.index then
  begin
   dxTLCanc.FocusedColumn := dxTLCCancMaskDes.index;
   dxTLCanc.FocusedColumn := dxTLCCancCheckSel.index;
  end;
end;

procedure TFrGBNFe.dxTLCancEditing(Sender: TObject; Node: TdxTreeListNode;
  var Allow: Boolean);
begin
 Allow := ( dxTLCanc.FocusedColumn = dxTLCCancCheckSel.Index ) or
          ( node.Strings[dxTLCCancCheckSel.Index] = 'True' );
end;

procedure TFrGBNFe.dxTLCancExit(Sender: TObject);
begin

 // by Edson Lima ; 2013-7-17T1024 ; Chama a procedure de atribuição de seleção da TreeList
 pAtribSel(dxTLCanc, dxTLCCancDateDemi, dxTLCCancSpinNot, dxTLCCancMaskMod, dxTLCCancMaskSer, DMNFe.ZQuery6);

end;

//------------------------------------------------------------------------------
// by Edson Lima ; 2013-9-6T1507 ; Deletando arquivos xml's tempo da empresa,
//                                 utilizando caracter curinga '*'
//------------------------------------------------------------------------------
procedure TFrGBNFe.ConsultaWeb5inuClick(Sender: TObject);
var
 SearchRec     : TSearchRec;
 Result        : Integer;
 vAuxT         : String;
 vAnoIni       : String;
 vMesIni       : String;
 vDt1, vDt2    : TDateTime;
begin

 vDt1    := FrPar.dtp1.DateTime;
 vDt2    := now();

 vAnoIni := FormatDateTime('yyyy', vDt1);
 vMesIni := FormatDateTime('mm',   vDt1);

 while ( vDt1 <= vDt2 ) do
  begin

   vAuxT := ( vAnoIni + vMesIni );

   if ( FrPar.CheckBox.Checked ) then
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Aguade! Sistema excluindo arquivos temporários...';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     sleep(1000);
    end
   else
    begin
     if not gExcTmp then
      begin
       if ( frmStatus = nil ) then
        frmStatus := TfrmStatus.Create(Application);
       frmStatus.lblStatus.Caption := 'Desculpe! Parâmetros configurado para não permitir a exclusão de arquivos temporários...';
       frmStatus.Show;
       frmStatus.BringToFront;
       Application.ProcessMessages;
       sleep(4000);
       frmStatus.Close;
      end;
     Exit;
    end;

   Result:=FindFirst(gCamLog + '*temp.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamLog+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + '*temp.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamLog + '*-sit.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamLog+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + '*-sit.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamLog + '*-lot.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamLog+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + '*-lot.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamLog + '*-rec.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamLog+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + '*-rec.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamLog + '*-eve.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamLog+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + '*-eve.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamLog + '*-evento.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamLog+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + '*-evento.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamLog + '*-sta.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamLog+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + '*-sta.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamLog + '*-cons-dpec.Xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamLog+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + '*-cons-dpec.Xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamLog + '*-sit-dpec.Xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamLog+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + '*-sit-dpec.Xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamLog + '*nfe-dest.Xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamLog+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + '*nfe-dest.Xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamLog + '*-dist-dfe.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamLog+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + '*-dist-dfe.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamLog + '*-con-dist-dfe.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamLog+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + '*-con-dist-dfe.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamLog + '*-ped-down-nfe.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamLog+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + '*-ped-down-nfe.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamLog + '*-down-nfe.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamLog+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + '*-down-nfe.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml+SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamLog + vAuxT + '\Down\*-procEventoNFe.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamLog + vAuxT + '\Down\' + SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + vAuxT + '\Down\*-procEventoNFe.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml + vAuxT + '\Down\' + SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamLog + vAuxT + '\Down\*-resNFe.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamLog + vAuxT + '\Down\' + SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + vAuxT + '\Down\*-resNFe.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml + vAuxT + '\Down\' + SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamLog + vAuxT + '\Down\*-resEventoNFe.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamLog + vAuxT + '\Down\' + SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + vAuxT + '\Down\*-resEventoNFe.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml + vAuxT + '\Down\' + SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + vAuxT + '\NFe\*-NFeDFe.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml + vAuxT + '\NFe\' + SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + vAuxT + '\Evento\Cancelamento\*-eve.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml + vAuxT + '\Evento\Cancelamento\' + SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

   Result:=FindFirst(gCamXml + vAuxT + '\Inu\*-inu.xml', faAnyFile, SearchRec);
   while result=0 do
    begin
     if ( frmStatus = nil ) then
       frmStatus := TfrmStatus.Create(Application);
     frmStatus.lblStatus.Caption := 'Excluindo arquivo! [' + SearchRec.Name + '] Tam: [' + IntToStr(SearchRec.Size) + ']';
     frmStatus.Show;
     frmStatus.BringToFront;
     Application.ProcessMessages;
     DeleteFile(gCamXml + vAuxT + '\Inu\' + SearchRec.Name);
     Result:=FindNext(SearchRec);
    end;

    vDt1 := IncMonth(vDt1, 1);

    vAnoIni := FormatDateTime('yyyy', vDt1);
    vMesIni := FormatDateTime('mm',   vDt1);

  end;

 //-----------------------------------------------------------------------------

 if ( frmStatus <> nil ) then
  frmStatus.Hide;

 frmStatus.Close;

 FindClose(SearchRec);

end;

//------------------------------------------------------------------------------
// by Edson Lima ; 2016-01-11T1704 ; Exclui xml das notas -
//                                 utilizando caracter curinga '*'
//------------------------------------------------------------------------------
procedure TFrGBNFe.pExcluiXmlErro(M, S, N : String);                            // M = Modelo, S = Série, N = Nota
var
 SearchRec          : TSearchRec;
 Result             : Integer;
 caminho, mascara   : string;
 vDate              : TDateTime;
begin

 if ( frmStatus = nil ) then
   frmStatus := TfrmStatus.Create(Application);
 frmStatus.lblStatus.Caption := 'Aguade! Sistema excluindo arquivos xml da nota...';
 frmStatus.Show;
 frmStatus.BringToFront;
 Application.ProcessMessages;
 sleep(1000);

 vDate   := gDataEmi;

 caminho := (gCamXml + FormatDateTime('yyyymm', vDate) + gTN);
 mascara := ('*' + M + Format('%.3d', [StrToInt(S)]) + Format('%.9d', [StrToInt(N)]) + '*.xml');

 Result:=FindFirst(caminho + mascara , faAnyFile, SearchRec);

 while result=0 do
  begin
   if ( frmStatus = nil ) then
     frmStatus := TfrmStatus.Create(Application);
   frmStatus.lblStatus.Caption := 'Excluindo arquivos xml da pasta xml!';
   frmStatus.Show;
   frmStatus.BringToFront;
   Application.ProcessMessages;
   DeleteFile(caminho+SearchRec.Name);
   Result:=FindNext(SearchRec);
  end;

 caminho := (gCamLog);
 mascara := ('*' + M + Format('%.3d', [StrToInt(S)]) + Format('%.9d', [StrToInt(N)]) + '*.xml');

 Result:=FindFirst(caminho + mascara , faAnyFile, SearchRec);

 while result=0 do
  begin
   if ( frmStatus = nil ) then
     frmStatus := TfrmStatus.Create(Application);
   frmStatus.lblStatus.Caption := 'Excluindo arquivos xml da pasta log!';
   frmStatus.Show;
   frmStatus.BringToFront;
   Application.ProcessMessages;
   DeleteFile(gCamLog+SearchRec.Name);
   Result:=FindNext(SearchRec);
  end;

 //-----------------------------------------------------------------------------

 if ( frmStatus <> nil ) then
  frmStatus.Hide;

 FindClose(SearchRec);

end;

procedure TFrGBNFe.trvwNFeExit(Sender: TObject);
begin
 if gMostraXML then
  begin
   trvwNFe.Items.Clear;
   gMostraXML := False;
  end;
end;

procedure TFrGBNFe.BitBtn15Click(Sender: TObject);
begin

 // By Edson Lima 11.10.2013 ; 10:17 - Efetua varios dados com o xml gravado na Base de Dados
 if ( FrXML = nil ) then
   FrXML := TFrXML.Create(Application);
 FrXML.ShowModal;
 FrXML.BringToFront;

 // By Edson Lima 14.9.2012 ; 10:10 - Atualiza grade
 pAtuNFe();

end;

//------------------------------------------------------------------------------
// Verifica existência da CCe em uma nota fiscal, Grava e retorna status
//------------------------------------------------------------------------------
function TFrGBNFe.fGravaCCe( nNF : Variant; cStat, xMotivo : String ) : Boolean;
begin
 try
  DMNFe.ZqryGeral.DisableControls;
  DMNFe.ZqryGeral.Close;
  DMNFe.ZqryGeral.SQL.Clear;
  DMNFe.ZqryGeral.SQL.Add( 'Select * from NFe_CCe                               ' );
  DMNFe.ZqryGeral.SQL.Add( ' where nNF         = :nNF                           ' );
  DMNFe.ZqryGeral.ParamByName('nNF').Value     := nNF;
  try
   DMNFe.ZConnection1.StartTransaction;
   DMNFe.ZqryGeral.ExecSQL;
  except
   DMNFe.ZConnection1.Rollback;
   Result := False;
  end;

  if not DMNFe.ZqryGeral.IsEmpty then
   begin
    DMNFe.ZqryGeral.SQL.Add( 'Update NFe_CCe Set                                ' );
    DMNFe.ZqryGeral.SQL.Add( '   ,cStat          = :cStat                       ' );
    DMNFe.ZqryGeral.SQL.Add( '   ,xMotivo        = :xMotiv                      ' );
    DMNFe.ZqryGeral.SQL.Add( ' where nNF         = :nNF                         ' );
    DMNFe.ZqryGeral.ParamByName('cStat').Value   := cStat;
    DMNFe.ZqryGeral.ParamByName('xMotivo').Value := xMotivo;
    DMNFe.ZqryGeral.ParamByName('nNF').Value     := nNF;
    try
     DMNFe.ZConnection1.StartTransaction;
     DMNFe.ZqryGeral.ExecSQL;
     result := True;
    except
     DMNFe.ZConnection1.Rollback;
     Result := False;
    end;
    DMNFe.ZqryGeral.Close;
   end;
 finally
  DMNFe.ZqryGeral.EnableControls;
 end;
end;

//------------------------------------------------------------------------------
// Function: p_CancelaCCe - Consiste em mudar o Status para
//           580 - Rejeição: O evento exige uma NF-e autorizada
//           (nfe cancelada)
// by Edson Lima ; 7/1/2014T1026 ; Cancela CCe caso tenha alt. na NFe
//------------------------------------------------------------------------------
function TFrGBNFe.fCancelaCCe(Codigo_loja, nNF, dEmi: String) : Boolean;
begin

 DMNFe.ZQuery11.Close;
  DMNFe.ZQuery11.ParamByName('Codigo_Loja').AsInteger := StrToInt(Codigo_loja);
  DMNFe.ZQuery11.ParamByName('Nota').Value := StrToInt(nNF);
 DMNFe.ZQuery11.Open;

 if DMNFe.ZQuery11.IsEmpty then
  begin
   result := False;
   exit;
  end;

 try
  DMNFe.ZQuery2.DisableControls;
  DMNFe.ZQuery2.Close;
  DMNFe.ZQuery2.SQL.Clear;
  DMNFe.ZQuery2.SQL.Add( 'Update NFe_CCe Set                                   ' );
  DMNFe.ZQuery2.SQL.Add( '    cStat          = :cStat                          ' );
  DMNFe.ZQuery2.SQL.Add( '   ,xMotivo        = :xMotivo                        ' );
  DMNFe.ZQuery2.SQL.Add( 'where                                                ' );
  DMNFe.ZQuery2.SQL.Add( '    Codigo_Loja    = :Codigo_Loja  and               ' );
  DMNFe.ZQuery2.SQL.Add( '    nNF            = :nNF                            ' );
  DMNFe.ZQuery2.ParamByName('cStat'      ).Value  := '580';
  DMNFe.ZQuery2.ParamByName('xMotivo'    ).Value  := 'Rejeição: O evento exige uma NF-e autorizada (NF-e Cancelada)';
  DMNFe.ZQuery2.ParamByName('Codigo_Loja').Value  := StrToInt(Codigo_loja);
  DMNFe.ZQuery2.ParamByName('nNF'        ).Value  := StrToInt(nNF);

  DMNFe.ZConnection1.StartTransaction;
  DMNFe.ZQuery2.ExecSQL;
 except
  DMNFe.ZConnection1.Rollback;
  Application.Messagebox('ERRO: CCe não alterada !','Atenção!',mb_iconstop+mb_ok);
  result := False;
  exit;
 end;

 // Salva dados na NFe que foi excluido da CCe (atualiza o stat e motivo)
 try
  DMNFe.ZQuery2.DisableControls;
  DMNFe.ZQuery2.Close;
  DMNFe.ZQuery2.SQL.Clear;
  DMNFe.ZQuery2.SQL.Add( 'Update nfe set                                         ' );
  DMNFe.ZQuery2.SQL.Add( '  cStat_CCe                = :cStat_CCe,               ' );
  DMNFe.ZQuery2.SQL.Add( '  xMotivo_CCe              = :xMotivo_CCe              ' );
  DMNFe.ZQuery2.SQL.Add( 'where codigo_loja          = :codigo_loja              ' );
  DMNFe.ZQuery2.SQL.Add( '  and demi                 = :demi                     ' );
  DMNFe.ZQuery2.SQL.Add( '  and nnf                  = :nnf                      ' );
  DMNFe.ZQuery2.ParamByName('cStat_CCe'  ).Value    := '580';
  DMNFe.ZQuery2.ParamByName('xMotivo_CCe').Value    := 'Rejeição: O evento exige uma NF-e autorizada (NF-e Cancelada)';
  DMNFe.ZQuery2.ParamByName('codigo_loja').Value    := StrToInt(Codigo_loja);
  DMNFe.ZQuery2.ParamByName('demi'       ).Value    := gdEmi_Consiste;
  DMNFe.ZQuery2.ParamByName('nnf'        ).Value    := StrToInt(nNF);

  try
   DMNFe.ZConnection1.StartTransaction;
   DMNFe.ZQuery2.ExecSQL;
  except
   DMNFe.ZConnection1.Rollback;
   Application.Messagebox('ERRO: NFe não foi atualizado os dados da Nota!','Atenção!',mb_iconstop+mb_ok);
   result := False;
   exit;
  end;
  DMNFe.ZQuery2.Close;
 finally
  DMNFe.ZQuery2.EnableControls;
 end;

 result := True;

end;

procedure TFrGBNFe.SpeedButton2Click(Sender: TObject);
var
 Aplic: string;
begin
 Aplic := gCamExe + 'Help\' + 'Manual Sistema GBNFe.chm';
 ShellExecute(0, nil, PChar(Aplic), nil, nil, Sw_Maximize);
end;

procedure TFrGBNFe.BitBtn16Click(Sender: TObject);
Begin

 //----------------------------------------------------------------------
 ACBrNFe1.Configuracoes.Geral.VersaoDF := ve310;
 ACBrNFe1.Configuracoes.WebServices.AguardarConsultaRet      := 30000;
 ACBrNFe1.Configuracoes.WebServices.AjustaAguardaConsultaRet := True;
 ACBrNFe1.Configuracoes.WebServices.IntervaloTentativas      := 2000;
 ACBrNFe1.Configuracoes.WebServices.Tentativas               := 10;
 ACBrNFe1.Configuracoes.WebServices.TimeOut                  := 6000;
 //----------------------------------------------------------------------

 if ( FrBuscaChave = nil ) then
  FrBuscaChave := TFrBuscaChave.Create(Application)
 else
  FrBuscaChave := TFrBuscaChave.Create(Application);

 FrBuscaChave.ShowModal;
 FrBuscaChave.BringToFront;

 // By Edson Lima 14.9.2012 ; 10:10 - Atualiza grade
 pAtuNFe();

end;

//------------------------------------------------------------------------------
// procedure : Verifica o vencimento do certificado digital
// by Edson Lima ; 2014-11-11T1632
//------------------------------------------------------------------------------
procedure TFrGBNFe.VerifCert();                                                 // Verifica o vencimento do certificado digital
var
 vQtdDias : Integer;
begin

 if not ACBrNFe1.Configuracoes.Certificados.VerificarValidade then              // trunk2 - Antes => if not ACBrNFe1.Configuracoes.Certificados.GetCertificado.IsValid.Result then
  exit;

 if (trim( ACBrNFe1.Configuracoes.Certificados.NumeroSerie ) <> '' ) then
  begin
   if ACBrNFe1.Configuracoes.Certificados.VerificarValidade then                // trunk2 - Antes => if ACBrNFe1.Configuracoes.Certificados.GetCertificado.IsValid.Result then
    begin
     vQtdDias := DaysBetween( now(), ACBrNFe1.SSL.CertDataVenc ) - 1;
     if ( vQtdDias <= 10 ) then
      if gVerifCert then
       if vQtdDias > 1 then

        Application.Messagebox( PCHAR('Faltam ' + IntToStr(vQtdDias) + ' dias para CERTIFICADO DIGITAL VENCER!' + chr(13) +
                                'Providencie um novo para substuir o existente!' + chr(13) +
                                'GB INFORMÁTICA!'), 'Atenção!', MB_ICONASTERISK + mb_ok )

       else if (vQtdDias = 1) then

        Application.Messagebox( 'HOJE É O ÚLTIMO DIA DO SEU CERTIFICADO!' + chr(13) +
                                'INSTALE O NOVO CERTIFICADO DIGIAL! ' + chr(13) +
                                'GB INFORMÁTICA!', 'Atenção!', MB_ICONASTERISK + mb_ok )

       else if (vQtdDias = 0) then

        Application.Messagebox( 'O SEU CERTIFICADO ESTÁ VENCIDO !' + chr(13) +
                                'INSTALE O NOVO CERTIFICADO DIGIAL! ' + chr(13) +
                                'GB INFORMÁTICA!', 'Atenção!', MB_ICONASTERISK + mb_ok );

    end;
  end;

end;

//------------------------------------------------------------------------------
// by Edson Lima - 2014-11-19T1554
// procedure que grava o arquivo GBNFe.ini na pasta da empresa em referência
//------------------------------------------------------------------------------
procedure TFrGBNFe.GravarIni();
Var
 IniFile       : String ;
 Ini           : TIniFile ;
begin

 IniFile := gCamCert + 'GBNFe.Ini';
 Ini := TIniFile.Create( IniFile );

 try
  Ini.WriteInteger( 'Certificado' + '-Emp' + gCodEmp, 'CodEmp_Ini', gCEIni) ;
  Ini.WriteInteger( 'Certificado' + '-Emp' + gCodEmp, '1º-2º_Cert', gPSCert) ;
 finally
  Ini.Free ;
 end;

end;

//------------------------------------------------------------------------------
// by Edson Lima - 2014-11-19T1554
// procedure que ler o arquivo GBNFe.ini na pasta da empresa em referência
//------------------------------------------------------------------------------
procedure TFrGBNFe.LerIni();
Var
 IniFile     : String ;
 Ini         : TIniFile ;
 Ok          : Boolean;
 vPS         : Integer;
begin

 IniFile := gCamCert + 'GBNFe.Ini';
 Ini := TIniFile.Create( IniFile );

 try

  if (trim(FrPar.edtNumSerie.Text) <> '') then
   vPS := 1
  else if (trim(FrPar.edtNumSerie2.Text) <> '') then
   vPS := 2
  else
   vPS := 0;

  gCEIni  := Ini.ReadInteger( 'Certificado' + '-Emp' + gCodEmp,'CodEmp_Ini', StrToInt(gCodEmp)) ;
  gPSCert := Ini.ReadInteger( 'Certificado' + '-Emp' + gCodEmp,'1º-2º_Cert', vPS) ;
 finally
  Ini.Free ;
 end;

end;

//------------------------------------------------------------------------------
// by Edson Lima - 2014-11-24T1725
// procedure que grava o arquivo GBNFe.ini o NSU da manifestação
//------------------------------------------------------------------------------
procedure TFrGBNFe.GravarNSU();
Var
 IniFile       : String ;
 Ini           : TIniFile ;
begin

 IniFile := gCamCert + 'GBNFe.Ini';
 Ini := TIniFile.Create( IniFile );

 try
  Ini.WriteString( 'Manifesto', 'NSU', FrConsManif.Edit_NSU_nfe.Text) ;
  Ini.WriteBool( 'Manifesto', 'ULT', FrConsManif.CheckBox1.Checked);
  Ini.WriteInteger( 'Manifesto','EMI', FrConsManif.ComboBox2.ItemIndex ) ;
  Ini.WriteBool( 'Manifesto','PAD', FrConsManif.CheckBox2.Checked) ;
 finally
  Ini.Free ;
 end;

end;

//------------------------------------------------------------------------------
// by Edson Lima - 2014-11-24T1725
// procedure que ler o arquivo GBNFe.ini o NSU da manifestação
//------------------------------------------------------------------------------
procedure TFrGBNFe.LerNSU();
Var
 IniFile     : String ;
 Ini         : TIniFile ;
 Ok          : Boolean;
begin

 IniFile := gCamCert + 'GBNFe.Ini';
 Ini := TIniFile.Create( IniFile );

 try
  FrConsManif.Edit_NSU_nfe.Text := Ini.ReadString( 'Manifesto','NSU', '0') ;
  FrConsManif.CheckBox1.Checked   := Ini.ReadBool( 'Manifesto','ULT', false) ;
  FrConsManif.ComboBox2.ItemIndex := Ini.ReadInteger( 'Manifesto','EMI', 0 ) ;
  FrConsManif.CheckBox2.Checked   := Ini.ReadBool( 'Manifesto','PAD', false) ;
 finally
  Ini.Free ;
 end;

end;

//------------------------------------------------------------------------------
// by Edson Lima - 2015-01-14T1041
// procedure que grava no arquivo GBNFe.ini o EMI da manifestação
//------------------------------------------------------------------------------
procedure TFrGBNFe.GravarEMI();
Var
 IniFile       : String ;
 Ini           : TIniFile ;
begin

 IniFile := gCamCert + 'GBNFe.Ini';
 Ini := TIniFile.Create( IniFile );

 try
  Ini.WriteInteger( 'Manifesto','EMI', FrConsManif.ComboBox2.ItemIndex ) ;
  Ini.WriteBool( 'Manifesto','PAD', FrConsManif.CheckBox2.Checked) ;
 finally
  Ini.Free ;
 end;

end;

//------------------------------------------------------------------------------
// by Edson Lima - 2014-01-14T1046
// procedure que ler o arquivo GBNFe.ini o EMI da manifestação
//------------------------------------------------------------------------------
procedure TFrGBNFe.LerEMI();
Var
 IniFile     : String ;
 Ini         : TIniFile ;
 Ok          : Boolean;
begin

 IniFile := gCamCert + 'GBNFe.Ini';
 Ini := TIniFile.Create( IniFile );

 try
  FrConsManif.ComboBox2.ItemIndex := Ini.ReadInteger( 'Manifesto','EMI', 0 ) ;
  FrConsManif.CheckBox2.Checked   := Ini.ReadBool( 'Manifesto','PAD', false) ;
 finally
  Ini.Free ;
 end;

end;

//------------------------------------------------------------------------------
// by Edson Lima - 2015-04-30T0913 - UCPX
// procedure que grava o arquivo GBNFe.ini o Ultimo Caminho da Pesquisa dos XMLs
//------------------------------------------------------------------------------
procedure TFrGBNFe.GravarPesXML();
Var
 IniFile       : String ;
 Ini           : TIniFile ;
begin

 IniFile := gCamCert + 'GBNFe.Ini';
 Ini := TIniFile.Create( IniFile );
 gCamPesXML := FrImportXML.DirectoryListBox1.Directory;

 try
  Ini.WriteString( 'ImportXML', 'CamPesXML', gCamPesXML);
 finally
  Ini.Free ;
 end;

end;

//------------------------------------------------------------------------------
// by Edson Lima - 2015-04-30T0913 - UCPX
// procedure que ler o arquivo GBNFe.ini o Ultimo Caminho da Pesquisa dos XMLs
//------------------------------------------------------------------------------
procedure TFrGBNFe.LerPesXML();
Var
 IniFile     : String ;
 Ini         : TIniFile ;
 Ok          : Boolean;
begin

 IniFile := gCamCert + 'GBNFe.Ini';
 Ini := TIniFile.Create( IniFile );

 try
  gCamPesXML := Ini.ReadString( 'ImportXML', 'CamPesXML', '') ;
 finally
  Ini.Free ;
 end;

end;

//------------------------------------------------------------------------------
// by Edson Lima ; 2015-10-9T1042 - Copia o arquivo xml pra pasta Log
// by Edson Lima 2015-10-14T1107 - trunk2 novo
//------------------------------------------------------------------------------
procedure TFrGBNFe.Copia_Xml_PathLog(var Aux, TpNot : String);
var
 NewFile, OldFile : String;
 vDate            : TDateTime;
 DtArq1, DtArq2   : TDateTime;
 vTA1, vTA2       : Longint;
begin

 vDate   := gDataEmi;
 NewFile := gCamLog + Aux + '-nfe.xml';
 OldFile := gCamXml + FormatDateTime('yyyymm', vDate) + TpNot + Aux + '-nfe.xml';

 if FileExists(NewFile) then
  DtArq1 := FileDateToDateTime(FileAge(pchar(NewFile)));
 if FileExists(OldFile) then
  DtArq2 := FileDateToDateTime(FileAge(pchar(OldFile)));

 vTA1 := (TamArq(NewFile));
 vTA2 := (TamArq(OldFile));

 if FileExists(OldFile) then
  begin
    if FileExists(NewFile) then
     DeleteFile(NewFile);
    CopyFile(pchar(OldFile), pchar(NewFile), True);
  end
 else if FileExists(NewFile) then
  CopyFile(pchar(NewFile), pchar(OldFile), True);

end;

procedure TFrGBNFe.dxTLTransCustomDrawCell(Sender: TObject;
  ACanvas: TCanvas; ARect: TRect; ANode: TdxTreeListNode;
  AColumn: TdxTreeListColumn; ASelected, AFocused, ANewItemRow: Boolean;
  var AText: String; var AColor: TColor; AFont: TFont;
  var AAlignment: TAlignment; var ADone: Boolean);
begin

 // by Edson Lima ; 2015-10-16T1353 ; Ajusta a cor conforme nfe modelo 65 e 55 NFCe e NFe
 if ANode.Values[dxTLCTransMaskMod.Index] = 65 then
  AFont.Color := $00FF8000
 else
  AFont.Color := clWindowFrame;

end;

procedure TFrGBNFe.dxTLCancCustomDrawCell(Sender: TObject;
  ACanvas: TCanvas; ARect: TRect; ANode: TdxTreeListNode;
  AColumn: TdxTreeListColumn; ASelected, AFocused, ANewItemRow: Boolean;
  var AText: String; var AColor: TColor; AFont: TFont;
  var AAlignment: TAlignment; var ADone: Boolean);
begin

 // by Edson Lima ; 2015-10-16T1353 ; Ajusta a cor conforme nfe modelo 65 e 55 NFCe e NFe
 if ANode.Values[dxTLCCancMaskMod.Index] = 65 then
  AFont.Color := $00FF8000
 else
  AFont.Color := clWindowFrame;

end;

procedure TFrGBNFe.dxTLContCustomDrawCell(Sender: TObject;
  ACanvas: TCanvas; ARect: TRect; ANode: TdxTreeListNode;
  AColumn: TdxTreeListColumn; ASelected, AFocused, ANewItemRow: Boolean;
  var AText: String; var AColor: TColor; AFont: TFont;
  var AAlignment: TAlignment; var ADone: Boolean);
begin

 // by Edson Lima ; 2015-10-16T1353 ; Ajusta a cor conforme nfe modelo 65 e 55 NFCe e NFe
 if ANode.Values[dxTLCContMaskMod.Index] = 65 then
  AFont.Color := $00FF8000
 else
  AFont.Color := clWindowFrame;

end;

procedure TFrGBNFe.dxTLDenegCustomDrawCell(Sender: TObject;
  ACanvas: TCanvas; ARect: TRect; ANode: TdxTreeListNode;
  AColumn: TdxTreeListColumn; ASelected, AFocused, ANewItemRow: Boolean;
  var AText: String; var AColor: TColor; AFont: TFont;
  var AAlignment: TAlignment; var ADone: Boolean);
begin

 // by Edson Lima ; 2015-10-16T1353 ; Ajusta a cor conforme nfe modelo 65 e 55 NFCe e NFe
 if ANode.Values[dxTLCDenegMaskMod.Index] = 65 then
  AFont.Color := $00FF8000
 else
  AFont.Color := clWindowFrame;

end;

procedure TFrGBNFe.dxTLInutCustomDrawCell(Sender: TObject;
  ACanvas: TCanvas; ARect: TRect; ANode: TdxTreeListNode;
  AColumn: TdxTreeListColumn; ASelected, AFocused, ANewItemRow: Boolean;
  var AText: String; var AColor: TColor; AFont: TFont;
  var AAlignment: TAlignment; var ADone: Boolean);
begin

 // by Edson Lima ; 2015-10-16T1353 ; Ajusta a cor conforme nfe modelo 65 e 55 NFCe e NFe
 if ANode.Values[dxTLCInutMaskModelo.Index] = 65 then
  AFont.Color := $00FF8000
 else
  AFont.Color := clWindowFrame;

end;

procedure TFrGBNFe.dxTLPendCustomDrawCell(Sender: TObject;
  ACanvas: TCanvas; ARect: TRect; ANode: TdxTreeListNode;
  AColumn: TdxTreeListColumn; ASelected, AFocused, ANewItemRow: Boolean;
  var AText: String; var AColor: TColor; AFont: TFont;
  var AAlignment: TAlignment; var ADone: Boolean);
begin

 // by Edson Lima ; 2015-10-16T1353 ; Ajusta a cor conforme nfe modelo 65 e 55 NFCe e NFe
 if ANode.Values[dxTLCPendMaskMod.Index] = 65 then
  AFont.Color := $00FF8000
 else
  AFont.Color := clWindowFrame;

end;

//------------------------------------------------------------------------------
// by Edson Lima ; 2015-10-9T1042 - Copia o arquivo xml pra pasta Log
// by Edson Lima 2015-10-14T1107 - trunk2 novo
//------------------------------------------------------------------------------
procedure TFrGBNFe.pDefineRel();
Var
 Ok         : Boolean;
begin

 ACBrNFe1.Configuracoes.Geral.VersaoDF        := ve310;

 ACBrNFeDANFERL1.Impressora                   := FrPar.edtImpNFe.Text;
 ACBrNFeDANFCeFortes1.Impressora              := FrPar.edtImpNFCe.Text;
 ACBrNFe1.DANFE.LogoemCima                    := True;

 ACBrNFe1.DANFE.Logo                          := FrPar.edtLogoMarca.Text;
 ACBrNFeDANFeRL1.Logo                         := FrPar.edtLogoMarca.Text;
 ACBrNFeDANFCeFortes1.Logo                    := FrPar.edtLogoMarca.Text;

 if gModelo = 65 then
  begin

   ACBrNFe1.DANFE                             := ACBrNFeDANFCeFortes1;
   ACBrNFeDANFCeFortes1.PathPDF               := gCamPdf;
   ACBrNFeDANFCeFortes1.Sistema               := gSistema;

   if ( gCpt = 1 ) then
    ACBrNFeDANFCeFortes1.NumCopias             := 1
   else
    ACBrNFeDANFCeFortes1.NumCopias             := strtoint(FrPar.ed_QtdCopNFCe.Text);

   if not FrPar.CheckBox2.Checked then
    ACBrNFeDANFCeFortes1.MostrarPreview       := false
   else
    ACBrNFeDANFCeFortes1.MostrarPreview       := true;

   // Utilizado o ACBrNFeDANFERL1 porque o ACBrNFeDANFCeFortes1 não aceita
   if FrPar.CheckBox8.Checked then
    ACBrNFeDANFERL1.ExibeCampoFatura          := True
   else
    ACBrNFeDANFERL1.ExibeCampoFatura          := False;

   if FrPar.CheckBox9.Checked then
    ACBrNFeDANFCeFortes1.ExpandirLogoMarca    := True
   else
    ACBrNFeDANFCeFortes1.ExpandirLogoMarca    := False;

   case FrPar.cbbTipoDANFCE.ItemIndex of
    0: ACBrNFeDANFCeFortes1.TipoDANFE         := tiSemGeracao;
    1: ACBrNFeDANFCeFortes1.TipoDANFE         := tiSimplificado;
    2: ACBrNFeDANFCeFortes1.TipoDANFE         := tiNFCe;
    3: ACBrNFeDANFCeFortes1.TipoDANFE         := tiMsgEletronica;
    4: ACBrNFeDANFCeFortes1.TipoDANFE         := tiNFCeA4;
   end;

   case FrPar.cbbTipoDANFCE.ItemIndex of
    0: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '0');
    1: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '3');
    2: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '4');
    3: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '5');
    4: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '6');
   end;

   // ACBrNFe1.DANFE.TipoDANFE                  := StrToTpImp(OK, '4');         // StrToEnumerado(ok, s, ['0', '1', '2', '3', '4', '5', '6'], [tiSemGeracao, tiRetrato, tiPaisagem, tiSimplificado, tiNFCe, tiMsgEletronica, tiNFCeA4]);

  end
 else
  begin

   ACBrNFe1.DANFE                             := ACBrNFeDANFeRL1;
   ACBrNFeDANFeRL1.PathPDF                    := gCamPdf;
   ACBrNFeDANFeRL1.Sistema                    := gSistema;

   if ( gCpt = 1 ) then
    ACBrNFeDANFeRL1.NumCopias                 := 1
   else
    ACBrNFeDANFeRL1.NumCopias                 := strtoint(FrPar.ed_QtdCopNFe.Text);

   if not FrPar.CheckBox2.Checked then
    ACBrNFeDANFERL1.MostrarPreview            := false
   else
    ACBrNFeDANFERL1.MostrarPreview            := true;

   if FrPar.CheckBox8.Checked then
    ACBrNFeDANFERL1.ExibeCampoFatura          := True
   else
    ACBrNFeDANFERL1.ExibeCampoFatura          := False;

   if FrPar.CheckBox9.Checked then
    ACBrNFeDANFERL1.ExpandirLogoMarca         := True
   else
    ACBrNFeDANFERL1.ExpandirLogoMarca         := False;

   case FrPar.cbbTipoDANF.ItemIndex of
    0: ACBrNFeDANFeRL1.TipoDANFE              := tiSemGeracao;
    1: ACBrNFeDANFeRL1.TipoDANFE              := tiRetrato;
    2: ACBrNFeDANFeRL1.TipoDANFE              := tiPaisagem;
    3: ACBrNFeDANFeRL1.TipoDANFE              := tiSimplificado;
    4: ACBrNFeDANFeRL1.TipoDANFE              := tiMsgEletronica;
   end;

   case FrPar.cbbTipoDANF.ItemIndex of
    0: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '0');
    1: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '1');
    2: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '2');
    3: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '3');
    4: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '5');
   end;

   //ACBrNFe1.DANFE.TipoDANFE                   := StrToTpImp(OK, '1');                             // StrToEnumerado(ok, s, ['0', '1', '2', '3', '4', '5', '6'], [tiSemGeracao, tiRetrato, tiPaisagem, tiSimplificado, tiNFCe, tiMsgEletronica, tiNFCeA4]);
   //ACBrNFeDANFeRL1.TipoDANFE                  := tiPaisagem;//ACBrNFe1.DANFE.TipoDANFE;           // EnumeradoToStr(t, ['0', '1', '2', '3', '4', '5', '4'],     [tiSemGeracao, tiRetrato, tiPaisagem, tiSimplificado, tiNFCe, tiMsgEletronica, tiNFCeA4]);

  end;

end;

//------------------------------------------------------------------------------
// by Edson Lima ; 2016-10-19T1126 - Copia o arquivo xml pra pasta Log
//------------------------------------------------------------------------------
procedure TFrGBNFe.pDefineRelFR();
Var
 Ok         : Boolean;
begin

 ACBrNFe1.Configuracoes.Geral.VersaoDF        := ve310;

 ACBrNFeDANFEFR1.Impressora                   := FrPar.edtImpNFe.Text;
 ACBrNFeDANFeESCPOS1.Impressora               := FrPar.edtImpNFCe.Text;
 ACBrNFe1.DANFE.LogoemCima                    := True;

 ACBrNFe1.DANFE.Logo                          := FrPar.edtLogoMarca.Text;
 ACBrNFeDANFeFR1.Logo                         := FrPar.edtLogoMarca.Text;
 ACBrNFeDANFEFR1.FastFileEvento               := gCamRep + 'EVENTOS.fr3';
 ACBrNFeDANFEFR1.FastFileInutilizacao         := gCamRep + 'INUTILIZACAO.fr3';
 ACBrNFeDANFeESCPOS1.Logo                     := FrPar.edtLogoMarca.Text;

 if gModelo = 65 then
  begin

   ACBrNFe1.DANFE                             := ACBrNFeDANFCeFortes1;
   ACBrNFeDANFCeFortes1.PathPDF               := gCamPdf;
   ACBrNFeDANFCeFortes1.Sistema               := gSistema;

   if ( gCpt = 1 ) then
    ACBrNFeDANFCeFortes1.NumCopias             := 1
   else
    ACBrNFeDANFCeFortes1.NumCopias             := strtoint(FrPar.ed_QtdCopNFCe.Text);

   if not FrPar.CheckBox2.Checked then
    ACBrNFeDANFCeFortes1.MostrarPreview       := false
   else
    ACBrNFeDANFCeFortes1.MostrarPreview       := true;

   // Utilizado o ACBrNFeDANFERL1 porque o ACBrNFeDANFCeFortes1 não aceita
   if FrPar.CheckBox8.Checked then
    ACBrNFeDANFERL1.ExibeCampoFatura          := True
   else
    ACBrNFeDANFERL1.ExibeCampoFatura          := False;

   if FrPar.CheckBox9.Checked then
    ACBrNFeDANFCeFortes1.ExpandirLogoMarca    := True
   else
    ACBrNFeDANFCeFortes1.ExpandirLogoMarca    := False;

   case FrPar.cbbTipoDANFCE.ItemIndex of
    0: ACBrNFeDANFCeFortes1.TipoDANFE         := tiSemGeracao;
    1: ACBrNFeDANFCeFortes1.TipoDANFE         := tiSimplificado;
    2: ACBrNFeDANFCeFortes1.TipoDANFE         := tiNFCe;
    3: ACBrNFeDANFCeFortes1.TipoDANFE         := tiMsgEletronica;
    4: ACBrNFeDANFCeFortes1.TipoDANFE         := tiNFCeA4;
   end;

   case FrPar.cbbTipoDANFCE.ItemIndex of
    0: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '0');
    1: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '3');
    2: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '4');
    3: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '5');
    4: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '6');
   end;

   // ACBrNFe1.DANFE.TipoDANFE                  := StrToTpImp(OK, '4');         // StrToEnumerado(ok, s, ['0', '1', '2', '3', '4', '5', '6'], [tiSemGeracao, tiRetrato, tiPaisagem, tiSimplificado, tiNFCe, tiMsgEletronica, tiNFCeA4]);

  end
 else
  begin

   ACBrNFe1.DANFE                             := ACBrNFeDANFEFR1;
   ACBrNFeDANFeFR1.PathPDF                    := gCamPdf;
   ACBrNFeDANFeFR1.Sistema                    := gSistema;

   if ( gCpt = 1 ) then
    ACBrNFeDANFeFR1.NumCopias                 := 1
   else
    ACBrNFeDANFeFR1.NumCopias                 := strtoint(FrPar.ed_QtdCopNFe.Text);

   if not FrPar.CheckBox2.Checked then
    ACBrNFeDANFEFR1.MostrarPreview            := false
   else
    ACBrNFeDANFEFR1.MostrarPreview            := true;

   if FrPar.CheckBox8.Checked then
    ACBrNFeDANFEFR1.ExibeCampoFatura          := True
   else
    ACBrNFeDANFEFR1.ExibeCampoFatura          := False;

   if FrPar.CheckBox9.Checked then
    ACBrNFeDANFEFR1.ExpandirLogoMarca         := True
   else
    ACBrNFeDANFERL1.ExpandirLogoMarca         := False;

   case FrPar.cbbTipoDANF.ItemIndex of
    0: ACBrNFeDANFeFR1.TipoDANFE              := tiSemGeracao;
    1: ACBrNFeDANFeFR1.TipoDANFE              := tiRetrato;
    2: ACBrNFeDANFeFR1.TipoDANFE              := tiPaisagem;
    3: ACBrNFeDANFeFR1.TipoDANFE              := tiSimplificado;
    4: ACBrNFeDANFeFR1.TipoDANFE              := tiMsgEletronica;
   end;

   case FrPar.cbbTipoDANF.ItemIndex of
    0: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '0');
    1: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '1');
    2: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '2');
    3: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '3');
    4: ACBrNFe1.DANFE.TipoDANFE               := StrToTpImp(OK, '5');
   end;

   case FrPar.cbbTipoDANF.ItemIndex of
    0: ACBrNFeDANFeFR1.FastFile               := gCamRep + 'DANFE.fr3';                // tiSemGeracao;
    1: ACBrNFeDANFeFR1.FastFile               := gCamRep + 'DANFeRetrato.fr3';         // tiRetrato;
    2: ACBrNFeDANFeFR1.FastFile               := gCamRep + 'DANFePaisagem.fr3';        // tiPaisagem;
    3: ACBrNFeDANFeFR1.FastFile               := gCamRep + 'DANFeRetratoFS_Basic.fr3'; // tiSimplificado;
    4: ACBrNFeDANFeFR1.FastFile               := gCamRep + 'DANFeRetrato_Basic.fr3';   // tiMsgEletronica;
   end;

  end;

end;

procedure TFrGBNFe.RadioGroup2Click(Sender: TObject);
begin
 pAtuNFe();
end;

//------------------------------------------------------------------------------
// by Edson Lima ; 2015-12-18T1604 - Deleta os xml das pastas log e xml quando
//                                   a situacao for null
//------------------------------------------------------------------------------
procedure TFrGBNFe.pEliminaXml(var Cha, TpNot : String);
var
 vFile1, vFile2   : String;
 vDate            : TDateTime;
begin

 vDate   := gDataEmi;
 vFile1  := gCamLog + Cha + '-nfe.xml';
 vFile2  := gCamXml + FormatDateTime('yyyymm', vDate) + TpNot + Cha + '-nfe.xml';

 if FileExists(vFile1) then
  if not DeleteFile(vFile1)then
   Application.Messagebox('Algo impediu a exclusão do xml da  pasta log!' + Chr(13) +
                          'Verifique se o xml está aberto? se sim, feche' + Chr(13) +
                          'e tente enviar novamente!', 'Atenção!', mb_iconstop+mb_ok);
 if FileExists(vFile2) then
  if not DeleteFile(vFile2)then
   Application.Messagebox('Algo impediu a exclusão do xml da  pasta xml!' + Chr(13) +
                          'Verifique se o xml está aberto? se sim, feche' + Chr(13) +
                          'e tente enviar novamente!', 'Atenção!', mb_iconstop+mb_ok);

end;

procedure TFrGBNFe.ConsultaWeb2Click(Sender: TObject);
var
 vUFCW : string;
begin

 vUFCW :=  VarToStr(DMNFe.ZQuery4['uf']);

 Case RadioGroup1.ItemIndex of

 2: // Transmitidas

  begin

   dxTLTransExit(Sender);
   pPegaChaveCW(DMNFe.ZQuery5, vUFCW);

  end;


 3: // Denegadas

  begin

   dxTLDenegExit(Sender);
   pPegaChaveCW(DMNFe.ZqryGeral, vUFCW);

  end;


 4: // Canceladas

  begin

   dxTLCancExit(Sender);
   pPegaChaveCW(DMNFe.ZQuery6, vUFCW);

  end;


 end;

 pAtuNFe();

end;

procedure TFrGBNFe.ConsultaWeb1Click(Sender: TObject);
begin

 ConsultaWeb2Click(Sender);

 //if ( FrConWeb = nil ) then
 //  FrConWeb := TFrConWeb.Create(Application);
 //FrConWeb.ShowModal;
 //FrConWeb.BringToFront;

end;

procedure TFrGBNFe.CopiaNChaveClipBoard1Click(Sender: TObject);
begin

 Case RadioGroup1.ItemIndex of

 0: // Pendentes

  begin
   // poderá ser usado para copiar outros dados para a área de trabalh
  end;

 1: // Contingências

  begin
   // poderá ser usado para copiar outros dados para a área de trabalho
  end;

 2: // Transmitidas

  begin

   dxTLTransExit(Sender);
   pCopiaNChave(DMNFe.ZQuery5);

  end;


 3: // Denegadas

  begin

   dxTLDenegExit(Sender);
   pCopiaNChave(DMNFe.ZqryGeral);

  end;


 4: // Canceladas

  begin

   dxTLCancExit(Sender);
   pCopiaNChave(DMNFe.ZQuery6);

  end;


 end;

 Application.Messagebox('Pronto, chaves já se encontram na área' + chr(13) + 'de transferência do windows!','Copia Nº Chave (Área de Transferência) NFe e NFCe:',MB_ICONINFORMATION+mb_ok);

 pAtuNFe();

end;

//------------------------------------------------------------------------------
// by Edson Lima ; 2016-01-5T0800 ; Copia a chave da nota selecionada para a
// área de transferência do windows
//------------------------------------------------------------------------------
procedure TFrGBNFe.pCopiaNChave(var ZQ: TZQuery);
var
 vAux : String;
begin

 vAux := '';

 try

  ZQ.first;

  while ((not ZQ.eof) and (ZQ['nfe_nnf'] <> Null)) do
   begin

    ZQ.FieldByName('Checado').ReadOnly := False;

    if ZQ['Checado'] = 'Y' then
     begin

      vAux := vAux + VarToStr(ZQ['nfe_chave_nfe']) + chr(13) + chr(10);

     end;

    ZQ.next;

   end;

 finally

  if ( vAux <> '' ) then
   Clipboard.AsText := vAux;

 end;

end;

//------------------------------------------------------------------------------
// by Edson Lima ; 2016-01-5T0800 ; Pega a chave e efetua a consulta no web
// service da sefaz
//------------------------------------------------------------------------------
procedure TFrGBNFe.pPegaChaveCW(var ZQ: TZQuery ; var UFCW : String);
var
 vAux : String;
begin

 vAux := '';

 try

  ZQ.first;

  while ((not ZQ.eof) and (ZQ['nfe_nnf'] <> Null)) do
   begin

    ZQ.FieldByName('Checado').ReadOnly := False;

    if ZQ['Checado'] = 'Y' then
     begin

      case Application.MessageBox( PChar('Deseja consultar a nota: ' + vartostr(ZQ['nfe_nnf']) + ',' + chr(13) +
                                         'no seu navegador web padrão? '), 'Consulta Web: NFe e NFCe', MB_ICONQUESTION + MB_YESNOCANCEL ) of

       IdYes:

        begin

         vAux := VarToStr(ZQ['nfe_chave_nfe']);
         if (StrToInt(ZQ['nfe_Modelo']) = 55) then
          begin
           If FrPar.rgTipoAmb.ItemIndex = 0 then
            ShellExecute(Handle, nil, PChar('http://www.nfe.fazenda.gov.br/portal/consulta.aspx?tipoConsulta=completa&tipoConteudo=XbSeqxE8pl8=&nfe=' + vAux + ''), nil, nil, SW_SHOWNORMAL)
           else
            ShellExecute(Handle, nil, PChar('http://hom.nfe.fazenda.gov.br/portal/consulta.aspx?tipoConsulta=completa&tipoConteudo=XbSeqxE8pl8=&nfe=' + vAux + ''), nil, nil, SW_SHOWNORMAL);
          end
         else
          if UFCW = 'AC' then
           ShellExecute(Handle, nil, PChar('http://hml.sefaznet.ac.gov.br/nfce/' + vAux + ''), nil, nil, SW_SHOWNORMAL)
          else if UFCW = 'AM' then
           ShellExecute(Handle, nil, PChar('http://homnfce.sefaz.am.gov.br/nfceweb/formConsulta.do' + vAux + ''), nil, nil, SW_SHOWNORMAL)
          else if UFCW = 'MA' then
           ShellExecute(Handle, nil, PChar('http://www.nfce.sefaz.ma.gov.br/portal/consultarNFCe.jsp' + vAux + ''), nil, nil, SW_SHOWNORMAL)
          else if UFCW = 'MT' then
           ShellExecute(Handle, nil, PChar('http://www.sefaz.mt.gov.br/nfce/consultanfce' + vAux + ''), nil, nil, SW_SHOWNORMAL)
          else if UFCW = 'PI' then
           ShellExecute(Handle, nil, PChar('http://webas.sefaz.pi.gov.br/nfceweb/consultarNFCe.jsf' + vAux + ''), nil, nil, SW_SHOWNORMAL)
          else if UFCW = 'RN' then
           ShellExecute(Handle, nil, PChar('http://nfce.set.rn.gov.br/consultarNFCe.aspx' + vAux + ''), nil, nil, SW_SHOWNORMAL)
          else if UFCW = 'RS' then
           ShellExecute(Handle, nil, PChar('https://www.sefaz.rs.gov.br/NFCE/NFCE-COM.aspx' + vAux + ''), nil, nil, SW_SHOWNORMAL)
          else if UFCW = 'SP' then
           ShellExecute(Handle, nil, PChar('https://www.nfce.fazenda.sp.gov.br/NFCeConsultaPublica/Paginas/ConsultaPublica.aspx' + vAux + ''), nil, nil, SW_SHOWNORMAL)
          else if UFCW = 'SE' then
           ShellExecute(Handle, nil, PChar('http://www.nfce.se.gov.br/portal/portalNoticias.jsp?jsp=barra-menu/servicos/consultaDANFENFCe.htm' + vAux + ''), nil, nil, SW_SHOWNORMAL)
          else if UFCW = 'RJ' then
           ShellExecute(Handle, nil, PChar('http://www4.fazenda.rj.gov.br/consultaDFe/paginas/consultaChaveAcesso.faces' + vAux + ''), nil, nil, SW_SHOWNORMAL)
          else if UFCW = 'PA' then
           ShellExecute(Handle, nil, PChar('https://appnfc.sefa.pa.gov.br/portal/view/consultas/nfce/consultanfce.seam' + vAux + ''), nil, nil, SW_SHOWNORMAL)
          else if UFCW = 'PR' then
           ShellExecute(Handle, nil, PChar('http://www.sped.fazenda.pr.gov.br/modules/conteudo/conteudo.php?conteudo=100' + vAux + ''), nil, nil, SW_SHOWNORMAL)
          else if UFCW = 'RO' then
           ShellExecute(Handle, nil, PChar('http://www.nfce.sefin.ro.gov.br/consultaAmbHomologacao.jsp' + vAux + ''), nil, nil, SW_SHOWNORMAL);


          // Tabela de Endereços de Consulta de NFC-e: Ambiente de Produção
          // AC - Acre                = http://hml.sefaznet.ac.gov.br/nfce/
          // AM - Amazonas            = http://homnfce.sefaz.am.gov.br/nfceweb/formConsulta.do
          // MA - Maranhão            = http://www.nfce.sefaz.ma.gov.br/portal/consultarNFCe.jsp
          // MT - Mato Grosso         = http://www.sefaz.mt.gov.br/nfce/consultanfce
          // PI - Piauí               = http://webas.sefaz.pi.gov.br/nfceweb/consultarNFCe.jsf
          // RN - Rio Grande do Norte = http://nfce.set.rn.gov.br/consultarNFCe.aspx
          // RS - Rio Grande do Sul   = https://www.sefaz.rs.gov.br/NFCE/NFCE-COM.aspx
          // SP - São Paulo           = https://www.nfce.fazenda.sp.gov.br/NFCeConsultaPublica/Paginas/ConsultaPublica.aspx
          // SE - Sergipe             = http://www.nfce.se.gov.br/portal/consultarNFCe.jsp
          //                          = http://www.nfce.se.gov.br/portal/portalNoticias.jsp?jsp=barra-menu/servicos/consultaDANFENFCe.htm
          // RJ - Rio de Janeiro      = http://www4.fazenda.rj.gov.br/consultaDFe/paginas/consultaChaveAcesso.faces
          // PA - Pará                = https://appnfc.sefa.pa.gov.br/portal/view/consultas/nfce/consultanfce.seam
          // PR - Paraná              = http://www.sped.fazenda.pr.gov.br/modules/conteudo/conteudo.php?conteudo=100
          // RO - Rondônia            = http://www.nfce.sefin.ro.gov.br/consultaAmbHomologacao.jsp

          // Tabela de Endereços de Consulta de NFC-e: Ambiente de Homologação
          // AC - Acre                = http://hml.sefaznet.ac.gov.br/nfce/
          // AM - Amazonas            = http://homnfce.sefaz.am.gov.br/nfceweb/formConsulta.do
          // MA - Maranhão            = http://www.nfce.sefaz.ma.gov.br/portal/consultarNFCe.jsp
          // MT - Mato Grosso         = http://www.sefaz.mt.gov.br/nfce/consultanfce
          // PI - Piauí               = http://webas.sefaz.pi.gov.br/nfceweb-homologacao/consultarNFCe.jsf
          // RN - Rio Grande do Norte = http://nfce.set.rn.gov.br/consultarNFCe.aspx
          // RS - Rio Grande do Sul   = https://www.sefaz.rs.gov.br/NFCE/NFCE-COM.aspx
          // SP - São Paulo           = https://www.nfce.fazenda.sp.gov.br/NFCeConsultaPublica/Paginas/ConsultaPublica.aspx
          // SE - Sergipe             = http://www.hom.nfe.se.gov.br/portal/consultarNFCe.jsp
          //                          = http://www.nfce.se.gov.br/portal/portalNoticias.jsp?jsp=barra-menu/servicos/consultaDANFENFCe.htm
          // RJ - Rio de Janeiro      = http://www4.fazenda.rj.gov.br/consultaDFe/paginas/consultaChaveAcesso.faces
          // PA - Pará                = https://appnfc.sefa.pa.gov.br/portal/view/consultas/nfce/consultanfce.seam
          // PR - Paraná              = http://www.sped.fazenda.pr.gov.br/modules/conteudo/conteudo.php?conteudo=100
          // RO - Rondônia            = http://www.nfce.sefin.ro.gov.br/consultaAmbHomologacao.jsp

        end;

       IdCancel:

        Exit;

      end;

     end;

    ZQ.next;

   end;

 finally


 end;

end;

//------------------------------------------------------------------------------
// by Edson Lima ; 2016-01-5T0800 ; Copia a chave da nota selecionada para a
// área de transferência do windows
//------------------------------------------------------------------------------
procedure TFrGBNFe.pCopiaNChaveMDFe(var ZQ: TZQuery);
var
 vAux : String;
begin

 vAux := '';

 try

  ZQ.first;

  while ((not ZQ.eof) and (ZQ['MDFe_Chave_nfe'] <> Null)) do
   begin

    ZQ.FieldByName('Checado').ReadOnly := False;

    if ZQ['Checado'] = 'Y' then
     begin

      vAux := vAux + VarToStr(ZQ['MDFe_Chave_nfe']) + chr(13) + chr(10);

     end;

    ZQ.next;

   end;

 finally

  if ( vAux <> '' ) then
   Clipboard.AsText := vAux;

 end;

end;


//******************************************************************************
// by Edson Lima ; 2016-01-5T0800 ; Pega a chave do manifesto e efetua a
//                                  consulta no web service da sefaz
//******************************************************************************
procedure TFrGBNFe.pPegaChaveCWM(var ZQ: TZQuery);
var
 vAux : String;
begin

 vAux := '';

 try

  ZQ.first;

  while ((not ZQ.eof) and (ZQ['MDFe_Chave_nfe'] <> Null)) do
   begin

    ZQ.FieldByName('Checado').ReadOnly := False;

    if ZQ['Checado'] = 'Y' then
     begin

      case Application.MessageBox( PChar('Deseja consultar a nota : ' + copy(ZQ.fieldByName('MDFe_Chave_nfe').AsString, 26, 9) + ',' + chr(13) +
                                         'de manifesto, no seu navegador web padrão? '), 'Consulta Web: NFe e NFCe', MB_ICONQUESTION + MB_YESNOCANCEL ) of

       IdYes:

        begin

         vAux := VarToStr(ZQ['MDFe_Chave_nfe']);
         If FrPar.rgTipoAmb.ItemIndex = 0 then
          ShellExecute(Handle, nil, PChar('http://www.nfe.fazenda.gov.br/portal/consulta.aspx?tipoConsulta=completa&tipoConteudo=XbSeqxE8pl8=&nfe=' + vAux + ''), nil, nil, SW_SHOWNORMAL)
         else
          ShellExecute(Handle, nil, PChar('http://hom.nfe.fazenda.gov.br/portal/consulta.aspx?tipoConsulta=completa&tipoConteudo=XbSeqxE8pl8=&nfe=' + vAux + ''), nil, nil, SW_SHOWNORMAL);
        end;

       IdCancel:

        Exit;

      end;

     end;

    ZQ.next;

   end;

 finally


 end;

end;


procedure TFrGBNFe.MarcaDesmarcaTodos3Click(Sender: TObject);
begin
 MarcaBloco( dxTLDeneg, True, True );
end;

procedure TFrGBNFe.DesmarcarTodas3Click(Sender: TObject);
begin
 MarcaBloco( dxTLDeneg, False, True );
end;

procedure TFrGBNFe.MenuItem5Click(Sender: TObject);
begin
 MarcaBloco( dxTLCanc, True, True );
end;

procedure TFrGBNFe.MenuItem6Click(Sender: TObject);
begin
 MarcaBloco( dxTLCanc, False, True );
end;

function TFrGBNFe.TamArq(const Arquivo: string): Integer;
var
  SR: TSearchRec;
begin
  if SysUtils.FindFirst(Arquivo, faAnyFile, SR) = 0 then
  try
    Result := SR.Size;
  finally
    SysUtils.FindClose(SR);
  end;
end;

procedure TFrGBNFe.dxSpinEdit1Exit(Sender: TObject);
begin

 if dxSpinEdit1.IntValue < 1 then
  begin
   dxSpinEdit1.Text := '001';
  end;

 DMNFe.ZQuery4.Close;
 DMNFe.ZQuery4.SQL.Clear;
 DMNFe.ZQuery4.SQL.Add( 'select * from emitente            ' );
 DMNFe.ZQuery4.SQL.Add( ' where codigo_loja =:codigo_loja  ' );
 DMNFe.ZQuery4.ParamByName('codigo_loja').AsInteger := dxSpinEdit1.IntValue;
 DMNFe.ZQuery4.Open;

 if DMNFe.ZQuery4.IsEmpty then
  begin
   dxSpinEdit1.IntValue := 0;
   Label1.Font.Color := clRed;
   Label1.Caption := ' NÃO EXISTE EMPRESA CADASTRADA !';
  end
 else
  begin
   gCodEmp                                 := StrZero(dxSpinEdit1.Text, 03);
   Label1.Font.Color                       := clBlue;
   Label1.Caption                          := ' ' + vartostr(DMNFe.ZQuery4['razao_social']) + ' - ' + vartostr(DMNFe.ZQuery4['nome_fantasia']);
   ACBrNFe1.Configuracoes.WebServices.UF   := DMNFe.ZQuery4['uf'];

   // Verifica e atualiza os caminhos
   LerConf1();                                                                  // Ler o arquivo ini e pega os parâmetros
   pAtrCam();                                                                   // Atribui caminhos do ini nas variáveis padrão e executavel
   LerConf2();                                                                  // Atribui dados nos parâmetros acbr
   pAtuNFe();                                                                   // Procedure de atualização

   pVerPas();

   // By Edson Lima ; 18/06/2012 ; 09:00
   ACBrNFe1.Configuracoes.Arquivos.Salvar                        := true;
   ACBrNFe1.Configuracoes.Arquivos.EmissaoPathNFe                := true;
   ACBrNFe1.Configuracoes.Arquivos.PathNFe                       := gCamXml;
   ACBrNFe1.Configuracoes.Arquivos.DownloadNFe.PathDownload      := gCamXml;
   //ACBrNFe1.Configuracoes.Arquivos.PathCan                       := gCamXml;              // trunk2
   ACBrNFe1.Configuracoes.Arquivos.PathInu                       := gCamXml;
   //ACBrNFe1.Configuracoes.Arquivos.PathDPEC                      := gCamXml;              // trunk2
   //ACBrNFe1.Configuracoes.Arquivos.PathCCe                       := gCamXml;              // trunk2
   ACBrNFe1.Configuracoes.Arquivos.PathEvento                    := gCamXml;
   ACBrNFe1.Configuracoes.Geral.Salvar                           := true;                   //ckSalvar.Checked;
   ACBrNFe1.Configuracoes.Arquivos.PathSalvar                    := gCamLog;                // trunk2
   ACBrNFe1.Configuracoes.Arquivos.PathSchemas                   := gCamSch;                // trunk2
  end;

end;

procedure TFrGBNFe.btn1MouseDown(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; X, Y: Integer);
begin
 if FrGBNFe.RadioButton1.Checked then
  gGeraXML := True;
end;

procedure TFrGBNFe.BitBtn2MouseDown(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; X, Y: Integer);
begin
 gGeraXML := False;
end;

procedure TFrGBNFe.btn2Click(Sender: TObject);
var
 vIndRG1 : integer;
begin

 // Faz a contestação da data inicial antiga
 if dxDateEdit1.Date < (Date - 73000) then                                      // 73000 dias aproximadamente 200 anos
  if Application.MessageBox( 'Data inicial muita antiga !', 'GBNFe - Período', mb_IconInformation + MB_OK ) = IdOk then
   begin
    dxDateEdit1.SetFocus;
    exit;
   end;

 // Faz a contestação da data final no período
 if dxDateEdit2.Date < dxDateEdit1.Date then
  if Application.MessageBox( 'A data inicial não pode ser maior que data final !', 'GBNFe - Período', mb_IconInformation + MB_OK ) = IdOk then
   begin
    dxDateEdit1.SetFocus;
    exit;
   end;

 vIndRG1 := RadioGroup1.ItemIndex;
 pAtuNFeT();
 RadioGroup1.ItemIndex := 0;         // Pendentes
 RadioGroup1.ItemIndex  := vIndRG1;

end;

//------------------------------------------------------------------------------
// by Edson Lima ; 2016-11-30T1711
// manda comandos de imprimir o danfe
//------------------------------------------------------------------------------
procedure TFrGBNFe.pImpr();
var
 c:Integer;

begin

 if ( gCpt = 1 ) then
  begin
   for c := 1 to ( StrToInt(FrPar.ed_QtdCopNFe.Text) ) do
    begin
     if ( gModelo = 55 ) then
      begin
       if ( ((FrPar.edtImpNFe.Text = 'doPDF v7')  or
             (FrPar.edtImpNFe.Text = 'Adobe PDF') or
             (FrPar.CheckBox2.Checked))           and
             (c = 1) ) then
        ACBrNFe1.NotasFiscais.Imprimir                                          // Imprime o DANFE normalmente
       else if ( ((FrPar.edtImpNFe.Text <> 'Adobe PDF') and
                  (FrPar.edtImpNFe.Text <> 'doPDF v7')) and
                  (not (FrPar.CheckBox2.Checked)) ) then
        ACBrNFe1.NotasFiscais.Imprimir;                                         // Imprime o DANFE normalmente
      end
     else
      begin
       if ( ((FrPar.edtImpNFe.Text = 'doPDF v7')  or
             (FrPar.edtImpNFe.Text = 'Adobe PDF') or
             (FrPar.CheckBox2.Checked))           and
             (c = 1) ) then
        ACBrNFe1.NotasFiscais.Imprimir                                          // Imprime o DANFE normalmente
       else if ( ((FrPar.edtImpNFe.Text <> 'Adobe PDF') and
                  (FrPar.edtImpNFe.Text <> 'doPDF v7')) and
                  (not (FrPar.CheckBox2.Checked)) ) then
        ACBrNFe1.NotasFiscais.Imprimir;                                         // Imprime o DANFE normalmente
      end;
    end;
  end
 else
  ACBrNFe1.NotasFiscais.Imprimir;                                               // Imprime o DANFE normalmente

end;

// -----------------------------------------------------------------------------
// By Edson Lima - 2016-6-30T0958
// Função global que valida um campo de email
//------------------------------------------------------------------------------
function fValidaEmail( CampoEmail: String ): Boolean;
var
 vpassou1 : boolean;
 vpassou2 : boolean;
 i        : Integer;
begin

 vpassou1 := False;
 vpassou2 := False;

 if ( trim(CampoEmail) <> '' ) then
  begin
   for i := 1 to length(CampoEmail) - 1 do
    begin
     if ( CampoEmail[i] = '@' ) then
      vpassou1 := True;
     if vpassou1 then
       if ( CampoEmail[i] = '.' ) then
         vpassou2 := True;
    end;
   end
  else
   begin
    vpassou1 := True;
    vpassou2 := True;
   end;

 if not ( vpassou1 and vpassou2 ) then
  Result := False
 else
  Result := True;

end;

procedure TFrGBNFe.GroupBox7MouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := GroupBox7.Hint;

end;

procedure TFrGBNFe.Panel7MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin

 StatusBar1.Panels[1].Text := Panel7.Hint;

end;

// Calcula se o ano é bi-sexto
function TFrGBNFe.AnoBi(Ano: Integer): Boolean;
begin
 Result := (Ano mod 4 = 0) and ((Ano mod 100 <> 0) or (Ano mod 400 = 0));
end;

//------------------------------------------------------------------------------
// by Edson Lima ; 2017-1-4T1029
// Efetua a leitura do gerente, Gerpa, Sisa ou Sisag
//------------------------------------------------------------------------------
function TFrGBNFe.fLerGer(): Boolean;
begin

 Result := True;

 if not ( fVerBDG ) then
  begin
   Result := False;
   Exit;
  end;

 // Ler o banco de dados Gerpa
 DMNFe.ZQryGer.Close;
 DMNFe.ZQryGer.SQL.Clear;
 DMNFe.ZQryGer.SQL.Add( 'Select *                                       ' );
 DMNFe.ZQryGer.SQL.Add( 'from TabMot                                    ' );
 DMNFe.ZQryGer.SQL.Add( 'where TipMot = ''C''                           ' );
 try
  DMNFe.ZQryGer.Open;
 except
  Application.Messagebox('Inconsistência na leitua da tabela TabMot do Gerente!','Atenção!',MB_ICONERROR+mb_ok);
  Result := False;
 end;

 DMNFe.ZQryGer.First;

 while not DMNFe.ZQryGer.Eof do
  begin

   if ( DMNFe.ZQryGer['CodMot'] = gCodMtC ) then
    if ( (DMNFe.ZQryGer['SitDcF'] = 'C') or (DMNFe.ZQryGer['SitDcF'] = 'E') ) then
     gNomMtC := DMNFe.ZQryGer['NomMot']
    else
     Application.Messagebox('Código do motivo do cancelamento não corresponde a um tipo válido!','Atenção!',MB_ICONINFORMATION+mb_ok);

   if ( DMNFe.ZQryGer['CodMot'] = gCodMtD ) then
    if ( DMNFe.ZQryGer['SitDcF'] = 'D' ) then
     gNomMtD := DMNFe.ZQryGer['NomMot']
    else
     Application.Messagebox('Código do motivo de denegação não corresponde a um tipo válido!','Atenção!',MB_ICONINFORMATION+mb_ok);

   if ( DMNFe.ZQryGer['CodMot'] = gCodMtI ) then
    if ( DMNFe.ZQryGer['SitDcF'] = 'I' ) then
     gNomMtI := DMNFe.ZQryGer['NomMot']
    else
     Application.Messagebox('Código do motivo de inutilização não corresponde a um tipo válido!','Atenção!',MB_ICONINFORMATION+mb_ok);

    DMNFe.ZQryGer.Next;

  end;

end;

//------------------------------------------------------------------------------
// by Edson Lima ; 2017-1-5T0834
// Efetua a gravação da chave no gerente, Gerpa, Sisa ou Sisag
//------------------------------------------------------------------------------
function TFrGBNFe.fGraGer(): Boolean;
begin

 Result := True;

 if not ( fVerBDG ) then
  begin
   Result := False;
   Exit;
  end;

 // Ler o banco de dados Gerpa
 DMNFe.ZQryGer.Close;
 DMNFe.ZQryGer.SQL.Clear;
 DMNFe.ZQryGer.SQL.Add( 'Update   MovPed                                ' );
 DMNFe.ZQryGer.SQL.Add( ' set     ChvNFe    = :sChvNFe                  ' );
 DMNFe.ZQryGer.SQL.Add( ' where   CodEmp    = :iCodEmp  and             ' );
 DMNFe.ZQryGer.SQL.Add( '         CodPed    = :iCodPed                  ' );
 DMNFe.ZQryGer.ParamByName('sChvNFe').AsString   := gChvNFe;
 DMNFe.ZQryGer.ParamByName('iCodEmp').AsInteger  := gCd_Emp;
 DMNFe.ZQryGer.ParamByName('iCodPed').AsInteger  := gCodPed;
 try
  DMNFe.ZConnectionGer.StartTransaction;
  DMNFe.ZQryGer.ExecSQL;
 except
  DMNFe.ZConnectionGer.Rollback;
  Application.Messagebox('Chave não gravada no pedido do gerpa!','Atenção!',MB_ICONERROR+mb_ok);
  Result := False;
 end;

 DMNFe.ZQryGer.Close;

end;

//------------------------------------------------------------------------------
// by Edson Lima ; 2017-1-9T1134
// Verifica a precisão adm do gerpa para cancelamento
//------------------------------------------------------------------------------
function TFrGBNFe.fVerPAG(iCodNot, iCodEmp, iCodPed: Integer): Boolean;
begin

 Result := True;

 if not ( fVerBDG ) then
  begin
   Result := False;
   Exit;
  end;

 try
  DMNFe.spVrfCanNot.Close;
   DMNFe.spVrfCanNot.ParamByName('CodEmp').AsInteger := iCodEmp;
   DMNFe.spVrfCanNot.ParamByName('CodPed').AsInteger := iCodPed;
  DMNFe.spVrfCanNot.ExecProc;

  if ( DMNFe.spVrfCanNot.Params[00].AsInteger > 0 ) then
   Result := False;
 except
  Application.Messagebox('Inconsistência na procedure de verificação da política de cancelamento do gerente!','Atenção!',MB_ICONERROR+mb_ok);
  Result := False;
 end;

 Case DMNFe.spVrfCanNot.Params[00].AsInteger of
  1:  Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', possui Título(s) a Receber Baixado(s)!'), 'Atenção', MB_ICONINFORMATION );
  2:  Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido de Entrada em Depósito Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', Exite(m) Pedido(s) de Saída em Depósito Pendente(s) ou Faturado(s) Vinculado(s)!'), 'Atenção', MB_ICONINFORMATION );
  3:  Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido de Transferência Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', a Entrada foi Confirmada e/ou Atualizada !'), 'Atenção', MB_ICONINFORMATION );
  4:  Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido de Entrada via Fat. Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', possui Título(s) a Pagar Baixado(s)!'), 'Atenção', MB_ICONINFORMATION );
  5:  Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Complementar de Preço Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', o Caixa está fechado!'), 'Atenção', MB_ICONINFORMATION );
  6:  Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', Posição Diferente de Faturado !'), 'Atenção', MB_ICONINFORMATION );
  7:  Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', Prazo para Cancelamento Excedido, Conforme Regras da Empresa!'), 'Atenção', MB_ICONINFORMATION );
  8:  Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', Pedido foi Devolvido!'), 'Atenção', MB_ICONINFORMATION );
  9:  Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', Comissão Normal Referente a este Faturamento já Fechada, deve-se Cancelar o Fechamento!'), 'Atenção', MB_ICONINFORMATION );
  10: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', possui Título(s) a Pagar Baixado(s)!'), 'Atenção', MB_ICONINFORMATION );
  11: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', pois se Refere a uma Ordem de Carregamento com Contas a Pagar Baixado !'), 'Atenção', MB_ICONINFORMATION );
  12: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', pois ele foi Agrupado, Originando Outro Pedido !'), 'Atenção', MB_ICONINFORMATION );
  13: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', pois se Refere a uma Devolução de Compra/Venda com Ordem de Pagamento Baixada via Caixa, e o Caixa está Fechado !'), 'Atenção', MB_ICONINFORMATION );
  14: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', pois se Refere a uma Devolução de Compra/Venda com Ordem de Pagamento Baixada !'), 'Atenção', MB_ICONINFORMATION );
 End;

end;

//------------------------------------------------------------------------------
// by Edson Lima ; 2017-1-11T0811
// Efetua o Cancelamento Administrativo do PEDIDO
//------------------------------------------------------------------------------
function TFrGBNFe.fCanCAP(iCodNot, iCodEmp, iCodPed, iCodMot: Integer): Boolean;
begin

 Result := True;

 if not ( fVerBDG ) then
  begin
   Result := False;
   Exit;
  end;

 try
  DMNFe.spCanNot.Close;
   DMNFe.spCanNot.ParamByName('CodEmp').AsInteger := iCodEmp;
   DMNFe.spCanNot.ParamByName('CodPed').AsInteger := iCodPed;
   DMNFe.spCanNot.ParamByName('CodMot').AsInteger := iCodMot;
  DMNFe.spCanNot.ExecProc;

  if ( DMNFe.spCanNot.Params[00].AsInteger > 0 ) then
   Result := False;
 except
  Application.Messagebox('Inconsistência na procedure de cancelamento do gerente!','Atenção!',MB_ICONERROR+mb_ok);
  Result := False;
 end;

 Case DMNFe.spCanNot.Params[00].AsInteger of
   1: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', possui Título(s) a Receber Baixado(s)!'), 'Atenção', MB_ICONINFORMATION );
   2: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido de Entrada em Depósito Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', Exite(m) Pedido(s) de Saída em Depósito Pendente(s) ou Faturado(s) Vinculado(s)!'), 'Atenção', MB_ICONINFORMATION );
   3: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido de Transferência Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', a Entrada foi Confirmada e/ou Atualizada !'), 'Atenção', MB_ICONINFORMATION );
   4: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido de Entrada via Fat. Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', possui Título(s) a Pagar Baixado(s)!'), 'Atenção', MB_ICONINFORMATION );
   5: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Complementar de Preço Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', o Caixa está fechado!'), 'Atenção', MB_ICONINFORMATION );
   6: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', Posição Diferente de Faturado !'), 'Atenção', MB_ICONINFORMATION );
   7: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', Prazo para Cancelamento Excedido, Conforme Regras da Empresa!'), 'Atenção', MB_ICONINFORMATION );
   8: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', Pedido foi Devolvido!'), 'Atenção', MB_ICONINFORMATION );
   9: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', Comissão Normal Referente a este Faturamento já Fechada, deve-se Cancelar o Fechamento!'), 'Atenção', MB_ICONINFORMATION );
  10: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', possui Título(s) a Pagar Baixado(s)!'), 'Atenção', MB_ICONINFORMATION );
  11: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', pois se Refere a uma Ordem de Carregamento com Contas a Pagar Baixado !'), 'Atenção', MB_ICONINFORMATION );
  12: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', pois ele foi Agrupado, Originando Outro Pedido !'), 'Atenção', MB_ICONINFORMATION );
  13: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', pois se Refere a uma Devolução de Compra/Venda com Ordem de Pagamento Baixada via Caixa, e o Caixa está Fechado !'), 'Atenção', MB_ICONINFORMATION );
  14: Application.MessageBox(PChar('Não será possível efetuar o cancelamento do Pedido Nº ' + IntToStr(iCodPed) + ', Nota nº ' + IntToStr(iCodNot) + ', pois se Refere a uma Devolução de Compra/Venda com Ordem de Pagamento Baixada !'), 'Atenção', MB_ICONINFORMATION );
 End;

end;

//------------------------------------------------------------------------------
// by Edson Lima ; 2017-1-16T1106
// Veririca a existencia do pedido para o cancelamento na inutilização
//------------------------------------------------------------------------------
function TFrGBNFe.fVrfInuNot(iCodEmp, iCodNot, iModNot, iSerNot: Integer): Boolean;
begin

 Result := True;

 if not ( fVerBDG ) then
  begin
   Result := False;
   Exit;
  end;

 try

  DMNFe.spVrfInuNot.Close;
   DMNFe.spVrfInuNot.ParamByName('CodEmp').AsInteger := iCodEmp;
   DMNFe.spVrfInuNot.ParamByName('CodNot').AsInteger := iCodNot;
   DMNFe.spVrfInuNot.ParamByName('ModNot').AsInteger := iModNot;
   DMNFe.spVrfInuNot.ParamByName('SerNot').AsInteger := iSerNot;
  DMNFe.spVrfInuNot.ExecProc;

  if ( DMNFe.spVrfInuNot.Params[00].AsInteger = -1 ) then
   Result := False
  else if ( DMNFe.spVrfInuNot.Params[00].AsInteger >= 0 ) then
   gCodPed := DMNFe.spVrfInuNot.Params[00].AsInteger;

 except

  Application.Messagebox('Inconsistência na procedure de verificação de pedidos no gerente!','Atenção!',MB_ICONERROR+mb_ok);
  Result := False;

 end;

 Case DMNFe.spVrfInuNot.Params[00].AsInteger of
  -1: Application.MessageBox(PChar('Não será possível efetuar a inutilização, nota nº ' + IntToStr(iCodNot) + ', fora da faixa'), 'Atenção', MB_ICONINFORMATION );
 End;

end;

//------------------------------------------------------------------------------
// by Edson Lima ; 2017-1-12T0811
// Abre o banco de dados gerente relativo e verifica a conecção
//------------------------------------------------------------------------------
function TFrGBNFe.fVerBDG(): Boolean;
begin

 Result := True;

 if ( Length(Trim(gDBERP)) > 0 ) then
  begin
   DMNFe.ZConnectionGer.Protocol         := 'ado';
   DMNFe.ZConnectionGer.Database         := 'Provider=MSDASQL.1;Persist Security Info=False;User ID=sa;Data Source=' + gDBERP + '';
   DMNFe.ZConnectionGer.Connected        := True;
   DMNFe.ZConnectionGer.DesignConnection := True;
  end
 else
  begin
   Application.MessageBox(PChar('Variável do banco de dados vazia!'), 'Atenção', MB_ICONINFORMATION );
   Result := False;
  end;

 if not ( DMNFe.ZConnectionGer.Connected ) then
  begin
   Application.MessageBox(PChar('Banco de dados não conectado!'), 'Atenção', MB_ICONINFORMATION );
   Result := False;
  end;

end;

procedure TFrGBNFe.BitBtn1MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin

 StatusBar1.Panels[1].Text := BitBtn1.Hint;

end;

procedure TFrGBNFe.BitBtn2MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin

 StatusBar1.Panels[1].Text := BitBtn2.Hint;

end;

procedure TFrGBNFe.BitBtn5MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin

 StatusBar1.Panels[1].Text := BitBtn5.Hint;

end;

procedure TFrGBNFe.BitBtn6MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin

 StatusBar1.Panels[1].Text := BitBtn6.Hint;

end;

procedure TFrGBNFe.BitBtn7MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin

 StatusBar1.Panels[1].Text := BitBtn7.Hint;

end;

procedure TFrGBNFe.btn1MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin

 StatusBar1.Panels[1].Text := Btn1.Hint;

end;

procedure TFrGBNFe.BitBtn8MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin

 StatusBar1.Panels[1].Text := BitBtn8.Hint;

end;

procedure TFrGBNFe.BitBtn9MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin

 StatusBar1.Panels[1].Text := BitBtn9.Hint;

end;

procedure TFrGBNFe.BitBtn11MouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := BitBtn11.Hint;

end;

procedure TFrGBNFe.BitBtn13MouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := BitBtn13.Hint;

end;

procedure TFrGBNFe.BitBtn4MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin

 StatusBar1.Panels[1].Text := BitBtn4.Hint;

end;

procedure TFrGBNFe.BitBtn15MouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := BitBtn15.Hint;

end;

procedure TFrGBNFe.BitBtn3MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin

 StatusBar1.Panels[1].Text := BitBtn3.Hint;

end;

procedure TFrGBNFe.BitBtn16MouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := BitBtn16.Hint;

end;

procedure TFrGBNFe.btn3MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin

 StatusBar1.Panels[1].Text := Btn3.Hint;

end;

procedure TFrGBNFe.BitBtn10MouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := BitBtn10.Hint;

end;

procedure TFrGBNFe.BitBtn14MouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := BitBtn14.Hint;

end;

procedure TFrGBNFe.BitBtn12MouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := BitBtn12.Hint;

end;

procedure TFrGBNFe.GroupBox2MouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := GroupBox2.Hint;

end;

procedure TFrGBNFe.GroupBox3MouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := GroupBox3.Hint;

end;

procedure TFrGBNFe.GroupBox9MouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := GroupBox9.Hint;

end;

procedure TFrGBNFe.GroupBox4MouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := GroupBox4.Hint;

end;

procedure TFrGBNFe.GroupBox1MouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := GroupBox1.Hint;

end;

procedure TFrGBNFe.dxTLCancMouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := Panel6.Hint;

end;

procedure TFrGBNFe.dxTLContMouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := Panel6.Hint;

end;

procedure TFrGBNFe.dxTLDenegMouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := Panel6.Hint;

end;

procedure TFrGBNFe.dxTLInutMouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := Panel6.Hint;

end;

procedure TFrGBNFe.dxTLPendMouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := Panel6.Hint;

end;

procedure TFrGBNFe.dxTLTransMouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin

 StatusBar1.Panels[1].Text := Panel6.Hint;

end;

procedure TFrGBNFe.ConsultaWeb5EnviaEmailParaDestinatrios1Click(
  Sender: TObject);
begin
 if ( FrEmail = nil ) then
   FrEmail := TFrEmail.Create(Application);
 FrEmail.ShowModal;
 FrEmail.BringToFront;
end;

procedure TFrGBNFe.ConsultaWeb5EnviaEmailParaDestinatrios6Click(
  Sender: TObject);
begin

 if ( FrEmail = nil ) then
   FrEmail := TFrEmail.Create(Application);
 FrEmail.ShowModal;
 FrEmail.BringToFront;

end;

end.

